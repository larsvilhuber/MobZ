
  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   14.2   Copyright 1985-2015 StataCorp LLC
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
                                      College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

8-user Stata network perpetual license:
       Serial number:  501406244326
         Licensed to:  ECCO Cornell University
                       Ithaca, NY

Notes:
      1.  Stata is running in batch mode.
      2.  Unicode is supported; see help unicode_advice.

. do 02_02_overall_loop.do 

. /**********************
> This is the do-file loop
> 
> It has three steps
> 
> 1. Calculate the aggregate data
>         (national level)
> 
> 2. Decide which czone defn to use
> 
> 3. Aggregate cty data to czone
> 
> 4. Run regressions of delM on delIPW, 
>         store regressions.
>         
> ***************************/
. 
. include "../config.do"

. /*  config.do */
. 
. 
. 
. if ( "`c(hostname)'" == "ecco.vrdc.cornell.edu" ) {
. global root "/ssgprojects/project0002/MobZ.new"
. }

. 
. if ( "`c(username)'" == "vilhuber" ) {
. global root "/home/vilhuber/Workspace/git/larsvilhuber/MobZ"
. }

. 
. if ( "`c(hostname)'" == "some.server.at.census" ) {
. global root "/made/up/path/Mobz"
. }

. 
. /* check if the author creates a log file. If not, adjust the following code 
> fragment */
. 
. local c_date = c(current_date)

. local cdate = subinstr("`c_date'", " ", "_", .)

. local c_time = c(current_time)

. local ctime = subinstr("`c_time'", ":", "_", .)

. 
. // log using "${root}/logfile_`cdate'-`ctime'.log", replace text
. 
. /* It will provide some info about how and when the program was run */
. /* See https://www.stata.com/manuals13/pcreturn.pdf#pcreturn */
. local variant = cond(c(MP),"MP",cond(c(SE),"SE",c(flavor)) )  

. // alternatively, you could use 
. // local variant = cond(c(stata_version)>13,c(real_flavor),"NA")  
. 
. di "=== SYSTEM DIAGNOSTICS ==="
=== SYSTEM DIAGNOSTICS ===

. di "Stata version: `c(stata_version)'"
Stata version: 14.2

. di "Updated as of: `c(born_date)'"
Updated as of: 19 Dec 2017

. di "Variant:       `variant'"
Variant:       IC

. di "Processors:    `c(processors)'"
Processors:    1

. di "OS:            `c(os)' `c(osdtl)'"
OS:            Unix 

. di "Machine type:  `c(machine_type)'"
Machine type:  PC (64-bit x86-64)

. di "=========================="
==========================

. 
. 
. 
. 
. /* define relative libraries */
. 
. global paperdir "${root}/paper"

. global interwrk "${root}/data/interwrk"

. global raw "${root}/raw"

. global temp "${root}/temp"

. global outputs "${root}/data"

. global programs "${root}/programs"

. global outgraphs "${root}/figures"

. global logdir "${programs}/logs"

. 
. cap mkdir "$logdir"

. log using "${logdir}/logfile_`cdate'-`ctime'.log", replace text
(note: file /ssgprojects/project0002/MobZ.new/programs/logs/logfile_20_Aug_2020
> -09_57_46.log not found)
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /ssgprojects/project0002/MobZ.new/programs/logs/logfile_20_Aug_202
> 0-09_57_46.log
  log type:  text
 opened on:  20 Aug 2020, 09:57:46

. cap mkdir "$temp"

. cap mkdir "${root}/data"

. cap mkdir "$interwrk"

. cap mkdir "$raw"

. cap mkdir "$outputs"

. 
. /* install any packages locally */
. capture mkdir "${programs}/ado"

. sysdir set PERSONAL "${programs}/ado/personal"

. sysdir set PLUS     "${programs}/ado/plus"

. sysdir set SITE     "${programs}/ado/site"

. sysdir
   STATA:  /usr/local/stata14/
    BASE:  /usr/local/stata14/ado/base/
    SITE:  /ssgprojects/project0002/MobZ.new/programs/ado/site/
    PLUS:  /ssgprojects/project0002/MobZ.new/programs/ado/plus/
PERSONAL:  /ssgprojects/project0002/MobZ.new/programs/ado/personal/
OLDPLACE:  ~/ado/

. 
. /* define data sources */
. 
. /* QCEW */
. /* data/working/mobz/qcew */
.     global qcewdata "${raw}/qcew"  

. /* /data/working/mobz/outputs */
.     global czonedata "$outputs"  

. 
. /* ADH */
.     global adhdata "${raw}/adh_data/Public Release Data/dta"

. /* CZONE */
.     global czonedata "${raw}/adh_data/"

. /* files provided separately by David Dorn */
.     global dorndata "${raw}/ddorn/"

. 
. /* CBP */
.     /* this is where the raw Stata versions of CBP data reside */
.    global cbpdata "/data/clean/cbp"

. 
. 
. include "$programs/config-bootstrap.do"

. /* Configuration written out by SAS -- config.sas            */
. /* -- any edits will be overwritten next time SAS is run! -- */
. global bootstrap_num 1000

. 
. 
. /* local configuration */
. local czonedataset = "${outputs}/bootclusters_jtw1990_moe_new.dta"

. global czone_iteration = "${interwrk}/czones.dta" 

. global dodir "${programs}/07_adh/"

. 
. 
. di "`czonedataset'" 
/ssgprojects/project0002/MobZ.new/data/bootclusters_jtw1990_moe_new.dta

. include "$dodir/zz_aggregatedata.do"

. 
. /*****************
> Prep Aggregate Data
> *******************/
. 
. /*********************
> Trade data
> ***********************/
. 
. /* source: Autor Dorn Hanson public data files */
. 
. use "$adhdata/sic87dd_trade_data.dta", clear
(SIC trade data for ADH post collapse of problem SIC industries)

. 
. bys year sic87dd: egen M_ucjt = sum(imports*(exporter=="CHN")*(importer=="USA
> "))

. 
. bys year sic87dd: egen M_ocjt = sum(imports*(exporter=="CHN")*(importer=="OTH
> "))

. 
. keep if year == 1991 | year == 2000 | year == 2007
(59,636 observations deleted)

. collapse (first) M*, by(sic87dd year) 

. 
. /* this is fixing an issue with two of the sic codes that only show up in 200
> 6 */
. expand 3 if year == 2007 & (sic87dd == 2992 | sic87dd==3273)
(4 observations created)

. bys sic87dd year: egen seq = seq() 

. replace year = 2000 if seq == 3
(2 real changes made)

. replace year = 1990 if seq == 2
(2 real changes made)

. replace M_ucjt = 0 if seq > 1
(4 real changes made)

. replace M_ocjt = 0 if seq > 1 
(4 real changes made)

. drop seq

. 
. sort sic87dd year 

. 
. gen del_M_ucjt = M_ucjt[_n+1]-M_ucjt if year<2007
(397 missing values generated)

. gen del_M_ocjt = M_ocjt[_n+1]-M_ocjt if year<2007
(397 missing values generated)

. 
. drop if year == 2007
(397 observations deleted)

. replace year = 1990 if year == 1991 
(395 real changes made)

. 
. keep del* M_* sic87dd year

. 
. sort sic87dd year

. 
. save "$interwrk/tmp_tradedata.dta", replace
file /ssgprojects/project0002/MobZ.new/data/interwrk/tmp_tradedata.dta saved

. 
. /*****************************
> National Industry Employment
> *****************************/
. use "$interwrk/industry_data.dta", clear

. 
. collapse (sum) emp, by(sic87dd year)

. 
. rename emp L_ujt 

. 
. sort sic87dd year

. 
. /* used nowhere else? */
. save "$interwrk/tmp_industrydata.dta", replace
file /ssgprojects/project0002/MobZ.new/data/interwrk/tmp_industrydata.dta saved

. 
. 
. 
. 
. 
. set more off

. #delimit ;
delimiter now ;
. use "`czonedataset'", clear ;

. des ;

Contains data from /ssgprojects/project0002/MobZ.new/data/bootclusters_jtw1990_
> moe_new.dta
  obs:         3,140                          
 vars:           103                          
 size:     3,862,200                          
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
fips            str10   %10s                  
clustername     str12   %12s                  
clustername_1   str12   %12s                  
clustername_2   str12   %12s                  
clustername_3   str12   %12s                  
clustername_4   str12   %12s                  
clustername_5   str12   %12s                  
clustername_6   str12   %12s                  
clustername_7   str12   %12s                  
clustername_8   str12   %12s                  
clustername_9   str12   %12s                  
clustername_10  str12   %12s                  
clustername_11  str12   %12s                  
clustername_12  str12   %12s                  
clustername_13  str12   %12s                  
clustername_14  str12   %12s                  
clustername_15  str12   %12s                  
clustername_16  str12   %12s                  
clustername_17  str12   %12s                  
clustername_18  str12   %12s                  
clustername_19  str12   %12s                  
clustername_20  str12   %12s                  
clustername_21  str12   %12s                  
clustername_22  str12   %12s                  
clustername_23  str12   %12s                  
clustername_24  str12   %12s                  
clustername_25  str12   %12s                  
clustername_26  str12   %12s                  
clustername_27  str12   %12s                  
clustername_28  str12   %12s                  
clustername_29  str12   %12s                  
clustername_30  str12   %12s                  
clustername_31  str12   %12s                  
clustername_32  str12   %12s                  
clustername_33  str12   %12s                  
clustername_34  str12   %12s                  
clustername_35  str12   %12s                  
clustername_36  str12   %12s                  
clustername_37  str12   %12s                  
clustername_38  str12   %12s                  
clustername_39  str12   %12s                  
clustername_40  str12   %12s                  
clustername_41  str12   %12s                  
clustername_42  str12   %12s                  
clustername_43  str12   %12s                  
clustername_44  str12   %12s                  
clustername_45  str12   %12s                  
clustername_46  str12   %12s                  
clustername_47  str12   %12s                  
clustername_48  str12   %12s                  
clustername_49  str12   %12s                  
clustername_50  str12   %12s                  
clustername_51  str12   %12s                  
clustername_52  str12   %12s                  
clustername_53  str12   %12s                  
clustername_54  str12   %12s                  
clustername_55  str12   %12s                  
clustername_56  str12   %12s                  
clustername_57  str12   %12s                  
clustername_58  str12   %12s                  
clustername_59  str12   %12s                  
clustername_60  str12   %12s                  
clustername_61  str12   %12s                  
clustername_62  str12   %12s                  
clustername_63  str12   %12s                  
clustername_64  str12   %12s                  
clustername_65  str12   %12s                  
clustername_66  str12   %12s                  
clustername_67  str12   %12s                  
clustername_68  str12   %12s                  
clustername_69  str12   %12s                  
clustername_70  str12   %12s                  
clustername_71  str12   %12s                  
clustername_72  str12   %12s                  
clustername_73  str12   %12s                  
clustername_74  str12   %12s                  
clustername_75  str12   %12s                  
clustername_76  str12   %12s                  
clustername_77  str12   %12s                  
clustername_78  str12   %12s                  
clustername_79  str12   %12s                  
clustername_80  str12   %12s                  
clustername_81  str12   %12s                  
clustername_82  str12   %12s                  
clustername_83  str12   %12s                  
clustername_84  str12   %12s                  
clustername_85  str12   %12s                  
clustername_86  str12   %12s                  
clustername_87  str12   %12s                  
clustername_88  str12   %12s                  
clustername_89  str12   %12s                  
clustername_90  str12   %12s                  
clustername_91  str12   %12s                  
clustername_92  str12   %12s                  
clustername_93  str12   %12s                  
clustername_94  str12   %12s                  
clustername_95  str12   %12s                  
clustername_96  str12   %12s                  
clustername_97  str12   %12s                  
clustername_98  str12   %12s                  
clustername_99  str12   %12s                  
clustername_100 str12   %12s                  
clus_switched   double  %12.0g                
-------------------------------------------------------------------------------
Sorted by: 

.  tempname czoneresults;

. tempfile ipw_regs;

. postfile `czoneresults' iteration beta_1990 se_1990 tstat_1990
>                                   beta_2000 se_2000 tstat_2000
>                                   beta_all se_all tstat_all
>                         using `ipw_regs', replace ;
(note: file /tmp/St29163.000001 not found)

.                         * first, run the legitimate regressions ;
.         * step2 ;
.         use "`czonedataset'", clear;

.                 *rename home_cty fips ;
.                 egen czone = group(clustername) ;

.                 keep fips czone;

.                 sort fips ;

.                 save "$czone_iteration", replace;
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

.                 *step3 ;
.         include "$dodir/zz_ctymerge.do";

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    893,250      100.00      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    297,750       33.33       33.33
          3 |    595,500       66.67      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(297,750 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(297,750 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(297,750 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000002 not found)
file /tmp/St29163.000002 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        750       20.00       20.00
       1980 |        750       20.00       40.00
       1990 |        750       20.00       60.00
       2000 |        750       20.00       80.00
       2007 |        750       20.00      100.00
------------+-----------------------------------
      Total |      3,750      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,000 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(750 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(749 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,500
        from master                     1,500  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,250  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,500       40.00       40.00
            matched (3) |      2,250       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,750      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       750          0 |       750 
      1980 |         0        750 |       750 
      1990 |         0        750 |       750 
      2000 |         0        750 |       750 
      2007 |       750          0 |       750 
-----------+----------------------+----------
     Total |     1,500      2,250 |     3,750 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,500 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. 
.                         *step4 ;
.         ivregress 2sls del_L_mprime (IPW_uit = IPW_oit ) if year == 1990 [wei
> ght=share_czpop];
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =      74.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9119

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8770238   .1014639    -8.64   0.000    -1.075889   -.6781581
       _cons |  -.4801703   .1287063    -3.73   0.000      -.73243   -.2279106
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit

.                 local beta90 = _b[IPW_uit] ;

.                 local se90 _se[IPW_uit] ;

.         ivregress 2sls del_L_mprime (IPW_uit = IPW_oit ) if year == 2000 [wei
> ght=share_czpop];
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =     174.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0906
                                                  Root MSE        =     2.2506

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.050352   .0795033   -13.21   0.000    -1.206175   -.8945284
       _cons |  -1.130059   .1688027    -6.69   0.000    -1.460906   -.7992115
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit

.                 local beta00 = _b[IPW_uit] ;

.                 local se00 = _se[IPW_uit] ;

.         ivregress 2sls del_L_mprime (IPW_uit = IPW_oit ) y2000 [weight=share_
> czpop] ;
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,498
                                                  Wald chi2(2)    =     497.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1447
                                                  Root MSE        =     2.0992

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.004355   .0619825   -16.20   0.000    -1.125838   -.8828711
       y2000 |  -.8708337   .1189859    -7.32   0.000    -1.104042   -.6376257
       _cons |  -.3445146   .1012129    -3.40   0.001    -.5428884   -.1461409
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit

.                 local betaall = _b[IPW_uit] ;

.                 local seall = _se[IPW_uit] ;

.         foreach yr in 90 00 all { ;
  2.                 local tstat`yr' = `beta`yr''/`se`yr'' ;
  3.                                          };

.         post `czoneresults' (0) (`beta90') (`se90') (`tstat90')
>                                 (`beta00') (`se00') (`tstat00')
>                                 (`betaall') (`seall') (`tstatall') ;

. /* 
> here we are estimating effects with our replicated CZs - we need to find
> the optimal level before running this for real.
> */      
>         
> forvalues i = 1/$bootstrap_num {;
  2.         di "ITERATION IS `i', TIME IS $S_TIME on $S_DATE" ;
  3.         * step2 ;
.         use "`czonedataset'", clear;
  4.                 egen czone = group(clustername_`i') ;
  5.                 *rename home_cty cty_fips ;
.                 keep fips czone;
  6.                 sort fips ;
  7.                 save "$czone_iteration", replace;
  8.                         *step3 ;
.         include "$dodir/zz_ctymerge.do";
  9.                         *step4 ;
.         ivregress 2sls del_L_mprime (IPW_uit = IPW_oit ) if year == 1990 [wei
> ght=share_czpop];
 10.                 local beta90 = _b[IPW_uit] ;
 11.                 local se90 _se[IPW_uit] ;
 12.         ivregress 2sls del_L_mprime (IPW_uit = IPW_oit ) if year == 2000 [
> weight=share_czpop];
 13.                 local beta00 = _b[IPW_uit] ;
 14.                 local se00 = _se[IPW_uit] ;
 15.         ivregress 2sls del_L_mprime (IPW_uit = IPW_oit ) y2000 [weight=sha
> re_czpop] ;
 16.                 local betaall = _b[IPW_uit] ;
 17.                 local seall = _se[IPW_uit] ;
 18.         foreach yr in 90 00 all { ;
 19.                 local tstat`yr' = `beta`yr''/`se`yr'' ;
 20.                                          };
 21.         post `czoneresults' (`i') (`beta90') (`se90') (`tstat90')
>                                 (`beta00') (`se00') (`tstat00')
>                                 (`betaall') (`seall') (`tstatall') ;
 22.                       } ;
ITERATION IS 1, TIME IS 09:58:25 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    903,969      100.00      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,323       33.33       33.33
          3 |    602,646       66.67      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,323 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,323 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,323 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000003 not found)
file /tmp/St29163.000003 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        759       20.00       20.00
       1980 |        759       20.00       40.00
       1990 |        759       20.00       60.00
       2000 |        759       20.00       80.00
       2007 |        759       20.00      100.00
------------+-----------------------------------
      Total |      3,795      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,036 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(759 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(754 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,518
        from master                     1,518  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,277  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,518       40.00       40.00
            matched (3) |      2,277       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,795      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       759          0 |       759 
      1980 |         0        759 |       759 
      1990 |         0        759 |       759 
      2000 |         0        759 |       759 
      2007 |       759          0 |       759 
-----------+----------------------+----------
     Total |     1,518      2,277 |     3,795 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,518 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =      72.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.932

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8527122   .1000728    -8.52   0.000    -1.048851    -.656573
       _cons |  -.5082713   .1278176    -3.98   0.000    -.7587892   -.2577533
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =     170.79
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0849
                                                  Root MSE        =     2.2834

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.041066   .0796601   -13.07   0.000    -1.197197    -.884935
       _cons |  -1.150419   .1694304    -6.79   0.000    -1.482497   -.8183421
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,516
                                                  Wald chi2(2)    =     487.41
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1341
                                                  Root MSE        =      2.129

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9908232   .0618966   -16.01   0.000    -1.112138   -.8695081
       y2000 |  -.8827707   .1197196    -7.37   0.000    -1.117417   -.6481246
       _cons |  -.3608326   .1017137    -3.55   0.000    -.5601879   -.1614773
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 2, TIME IS 09:58:58 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    900,396      100.00      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,132       33.33       33.33
          3 |    600,264       66.67      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,132 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,132 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,132 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000004 not found)
file /tmp/St29163.000004 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        756       20.00       20.00
       1980 |        756       20.00       40.00
       1990 |        756       20.00       60.00
       2000 |        756       20.00       80.00
       2007 |        756       20.00      100.00
------------+-----------------------------------
      Total |      3,780      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,024 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(756 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(755 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,512
        from master                     1,512  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,268  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,512       40.00       40.00
            matched (3) |      2,268       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,780      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       756          0 |       756 
      1980 |         0        756 |       756 
      1990 |         0        756 |       756 
      2000 |         0        756 |       756 
      2007 |       756          0 |       756 
-----------+----------------------+----------
     Total |     1,512      2,268 |     3,780 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,512 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =      72.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9148

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8656692   .1015238    -8.53   0.000    -1.064652   -.6666863
       _cons |  -.4989423   .1287325    -3.88   0.000    -.7512534   -.2466311
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =     182.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1130
                                                  Root MSE        =     2.2433

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.054905   .0780709   -13.51   0.000    -1.207921   -.9018888
       _cons |  -1.129164    .165893    -6.81   0.000    -1.454309   -.8040198
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,510
                                                  Wald chi2(2)    =     504.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1525
                                                  Root MSE        =     2.0994

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.005013   .0612833   -16.40   0.000    -1.125126   -.8849002
       y2000 |  -.8710712   .1182426    -7.37   0.000    -1.102822     -.63932
       _cons |  -.3503815   .1005307    -3.49   0.000    -.5474181    -.153345
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 3, TIME IS 09:59:31 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    899,205      100.00      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,735       33.33       33.33
          3 |    599,470       66.67      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,735 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,735 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,735 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000005 not found)
file /tmp/St29163.000005 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        755       20.00       20.00
       1980 |        755       20.00       40.00
       1990 |        755       20.00       60.00
       2000 |        755       20.00       80.00
       2007 |        755       20.00      100.00
------------+-----------------------------------
      Total |      3,775      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,020 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(755 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(753 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,510
        from master                     1,510  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,265  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,510       40.00       40.00
            matched (3) |      2,265       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,775      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       755          0 |       755 
      1980 |         0        755 |       755 
      1990 |         0        755 |       755 
      2000 |         0        755 |       755 
      2007 |       755          0 |       755 
-----------+----------------------+----------
     Total |     1,510      2,265 |     3,775 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,510 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =      73.47
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9226

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8448721   .0985657    -8.57   0.000    -1.038057   -.6516869
       _cons |  -.5084744   .1264345    -4.02   0.000    -.7562814   -.2606674
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =     167.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0922
                                                  Root MSE        =     2.2699

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.05886   .0818186   -12.94   0.000    -1.219222   -.8984988
       _cons |  -1.111401   .1728732    -6.43   0.000    -1.450226   -.7725752
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,508
                                                  Wald chi2(2)    =     485.41
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1386
                                                  Root MSE        =     2.1191

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.000476   .0629551   -15.89   0.000    -1.123866   -.8770864
       y2000 |  -.8774651   .1198723    -7.32   0.000    -1.112411   -.6425196
       _cons |  -.3422763   .1023568    -3.34   0.001    -.5428919   -.1416607
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 4, TIME IS 10:00:05 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    902,778      100.00      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,926       33.33       33.33
          3 |    601,852       66.67      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,926 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,926 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,926 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000006 not found)
file /tmp/St29163.000006 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        758       20.00       20.00
       1980 |        758       20.00       40.00
       1990 |        758       20.00       60.00
       2000 |        758       20.00       80.00
       2007 |        758       20.00      100.00
------------+-----------------------------------
      Total |      3,790      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,032 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(758 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(756 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,516
        from master                     1,516  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,274  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,516       40.00       40.00
            matched (3) |      2,274       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,790      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       758          0 |       758 
      1980 |         0        758 |       758 
      1990 |         0        758 |       758 
      2000 |         0        758 |       758 
      2007 |       758          0 |       758 
-----------+----------------------+----------
     Total |     1,516      2,274 |     3,790 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,516 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =      73.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9219

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8561558   .0997911    -8.58   0.000    -1.051743   -.6605689
       _cons |  -.5015127   .1272739    -3.94   0.000    -.7509649   -.2520606
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =     179.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1005
                                                  Root MSE        =     2.2605

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.036729   .0772914   -13.41   0.000    -1.188218   -.8852408
       _cons |  -1.158397   .1650426    -7.02   0.000    -1.481875   -.8349196
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,514
                                                  Wald chi2(2)    =     502.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1470
                                                  Root MSE        =     2.1108

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9887618   .0604725   -16.35   0.000    -1.107286   -.8702379
       y2000 |   -.887096   .1184477    -7.49   0.000    -1.119249   -.6549428
       _cons |  -.3601346    .100213    -3.59   0.000    -.5565484   -.1637208
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 5, TIME IS 10:00:37 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    894,441      100.00      100.00
------------+-----------------------------------
      Total |    894,441      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,147       33.33       33.33
          3 |    596,294       66.67      100.00
------------+-----------------------------------
      Total |    894,441      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,147 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,147 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,147 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000007 not found)
file /tmp/St29163.000007 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        751       20.00       20.00
       1980 |        751       20.00       40.00
       1990 |        751       20.00       60.00
       2000 |        751       20.00       80.00
       2007 |        751       20.00      100.00
------------+-----------------------------------
      Total |      3,755      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,004 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(751 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,004 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(749 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,004 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,502
        from master                     1,502  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,253  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,502       40.00       40.00
            matched (3) |      2,253       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,755      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       751          0 |       751 
      1980 |         0        751 |       751 
      1990 |         0        751 |       751 
      2000 |         0        751 |       751 
      2007 |       751          0 |       751 
-----------+----------------------+----------
     Total |     1,502      2,253 |     3,755 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,502 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        750
                                                  Wald chi2(1)    =      75.73
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9136

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8794141   .1010525    -8.70   0.000    -1.077473   -.6813549
       _cons |  -.4834056   .1281879    -3.77   0.000    -.7346493    -.232162
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        750
                                                  Wald chi2(1)    =     179.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0876
                                                  Root MSE        =     2.2675

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.071223   .0799021   -13.41   0.000    -1.227828   -.9146174
       _cons |  -1.092893   .1695919    -6.44   0.000    -1.425287   -.7604993
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,500
                                                  Wald chi2(2)    =     501.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1401
                                                  Root MSE        =     2.1105

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.020138   .0621146   -16.42   0.000     -1.14188   -.8983951
       y2000 |  -.8537741   .1194951    -7.14   0.000     -1.08798   -.6195681
       _cons |  -.3337468   .1015027    -3.29   0.001    -.5326884   -.1348052
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 6, TIME IS 10:01:10 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    902,778      100.00      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,926       33.33       33.33
          3 |    601,852       66.67      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,926 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,926 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,926 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000008 not found)
file /tmp/St29163.000008 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        758       20.00       20.00
       1980 |        758       20.00       40.00
       1990 |        758       20.00       60.00
       2000 |        758       20.00       80.00
       2007 |        758       20.00      100.00
------------+-----------------------------------
      Total |      3,790      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,032 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(758 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(754 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,516
        from master                     1,516  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,274  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,516       40.00       40.00
            matched (3) |      2,274       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,790      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       758          0 |       758 
      1980 |         0        758 |       758 
      1990 |         0        758 |       758 
      2000 |         0        758 |       758 
      2007 |       758          0 |       758 
-----------+----------------------+----------
     Total |     1,516      2,274 |     3,790 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,516 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =      74.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9263

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8600168   .0996299    -8.63   0.000    -1.055288   -.6647458
       _cons |  -.4957535   .1272999    -3.89   0.000    -.7452567   -.2462502
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =     176.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1056
                                                  Root MSE        =     2.2459

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.048845   .0789419   -13.29   0.000    -1.203568   -.8941214
       _cons |  -1.135547   .1674497    -6.78   0.000    -1.463743    -.807352
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,514
                                                  Wald chi2(2)    =     499.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1484
                                                  Root MSE        =      2.106

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9977378   .0615158   -16.22   0.000    -1.118306   -.8771692
       y2000 |  -.8814125   .1185333    -7.44   0.000    -1.113733   -.6490916
       _cons |  -.3487885   .1008388    -3.46   0.001     -.546429    -.151148
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 7, TIME IS 10:01:43 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    889,677      100.00      100.00
------------+-----------------------------------
      Total |    889,677      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    296,559       33.33       33.33
          3 |    593,118       66.67      100.00
------------+-----------------------------------
      Total |    889,677      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(296,559 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(296,559 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(296,559 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000009 not found)
file /tmp/St29163.000009 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        747       20.00       20.00
       1980 |        747       20.00       40.00
       1990 |        747       20.00       60.00
       2000 |        747       20.00       80.00
       2007 |        747       20.00      100.00
------------+-----------------------------------
      Total |      3,735      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,988 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(747 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(747 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,988 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(747 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(746 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,988 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(747 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,494
        from master                     1,494  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,241  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,494       40.00       40.00
            matched (3) |      2,241       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,735      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       747          0 |       747 
      1980 |         0        747 |       747 
      1990 |         0        747 |       747 
      2000 |         0        747 |       747 
      2007 |       747          0 |       747 
-----------+----------------------+----------
     Total |     1,494      2,241 |     3,735 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,494 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        746
                                                  Wald chi2(1)    =      74.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9022

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8641109   .1000622    -8.64   0.000    -1.060229   -.6679926
       _cons |  -.4909187   .1274692    -3.85   0.000    -.7407538   -.2410835
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        746
                                                  Wald chi2(1)    =     173.88
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0994
                                                  Root MSE        =     2.2424

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.041879   .0790123   -13.19   0.000     -1.19674    -.887018
       _cons |  -1.143355   .1678904    -6.81   0.000    -1.472414   -.8142956
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,492
                                                  Wald chi2(2)    =     497.24
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1517
                                                  Root MSE        =     2.0909

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9942391   .0614598   -16.18   0.000    -1.114698   -.8737801
       y2000 |  -.8795766   .1185649    -7.42   0.000     -1.11196   -.6471937
       _cons |  -.3520777   .1007996    -3.49   0.000    -.5496413   -.1545141
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 8, TIME IS 10:02:16 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    902,778      100.00      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,926       33.33       33.33
          3 |    601,852       66.67      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,926 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,926 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,926 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000a not found)
file /tmp/St29163.00000a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        758       20.00       20.00
       1980 |        758       20.00       40.00
       1990 |        758       20.00       60.00
       2000 |        758       20.00       80.00
       2007 |        758       20.00      100.00
------------+-----------------------------------
      Total |      3,790      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,032 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(758 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(758 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,516
        from master                     1,516  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,274  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,516       40.00       40.00
            matched (3) |      2,274       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,790      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       758          0 |       758 
      1980 |         0        758 |       758 
      1990 |         0        758 |       758 
      2000 |         0        758 |       758 
      2007 |       758          0 |       758 
-----------+----------------------+----------
     Total |     1,516      2,274 |     3,790 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,516 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =      75.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8996

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8653447   .0997176    -8.68   0.000    -1.060787   -.6699019
       _cons |  -.4895122   .1264923    -3.87   0.000    -.7374325   -.2415918
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =     179.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1049
                                                  Root MSE        =      2.257

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.053338   .0786223   -13.40   0.000    -1.207434   -.8992408
       _cons |  -1.127394   .1668995    -6.75   0.000    -1.454511   -.8002775
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,514
                                                  Wald chi2(2)    =     507.33
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1509
                                                  Root MSE        =     2.0994

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.003519   .0611712   -16.41   0.000    -1.123412   -.8836254
       y2000 |  -.8768435   .1181299    -7.42   0.000    -1.108374   -.6453131
       _cons |  -.3426506   .1002461    -3.42   0.001    -.5391293   -.1461719
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 9, TIME IS 10:02:49 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    900,396      100.00      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,132       33.33       33.33
          3 |    600,264       66.67      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,132 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,132 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,132 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000b not found)
file /tmp/St29163.00000b saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        756       20.00       20.00
       1980 |        756       20.00       40.00
       1990 |        756       20.00       60.00
       2000 |        756       20.00       80.00
       2007 |        756       20.00      100.00
------------+-----------------------------------
      Total |      3,780      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,024 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(756 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(755 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,512
        from master                     1,512  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,268  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,512       40.00       40.00
            matched (3) |      2,268       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,780      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       756          0 |       756 
      1980 |         0        756 |       756 
      1990 |         0        756 |       756 
      2000 |         0        756 |       756 
      2007 |       756          0 |       756 
-----------+----------------------+----------
     Total |     1,512      2,268 |     3,780 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,512 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =      74.94
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9146

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8532851   .0985672    -8.66   0.000    -1.046473   -.6600969
       _cons |  -.5082097   .1260757    -4.03   0.000    -.7553134   -.2611059
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =     172.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1136
                                                  Root MSE        =     2.2398

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.038309   .0790435   -13.14   0.000    -1.193232   -.8833871
       _cons |  -1.156153   .1674834    -6.90   0.000    -1.484414   -.8278912
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,510
                                                  Wald chi2(2)    =     495.65
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1530
                                                  Root MSE        =     2.0974

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9885222   .0614096   -16.10   0.000    -1.108883   -.8681615
       y2000 |  -.8842576   .1182261    -7.48   0.000    -1.115976   -.6525388
       _cons |  -.3640499   .1005583    -3.62   0.000    -.5611405   -.1669593
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 10, TIME IS 10:03:22 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    905,160      100.00      100.00
------------+-----------------------------------
      Total |    905,160      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,720       33.33       33.33
          3 |    603,440       66.67      100.00
------------+-----------------------------------
      Total |    905,160      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,720 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,720 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,720 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000c not found)
file /tmp/St29163.00000c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        760       20.00       20.00
       1980 |        760       20.00       40.00
       1990 |        760       20.00       60.00
       2000 |        760       20.00       80.00
       2007 |        760       20.00      100.00
------------+-----------------------------------
      Total |      3,800      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,040 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(760 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,040 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(759 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,040 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,520
        from master                     1,520  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,280  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,520       40.00       40.00
            matched (3) |      2,280       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,800      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       760          0 |       760 
      1980 |         0        760 |       760 
      1990 |         0        760 |       760 
      2000 |         0        760 |       760 
      2007 |       760          0 |       760 
-----------+----------------------+----------
     Total |     1,520      2,280 |     3,800 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,520 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        759
                                                  Wald chi2(1)    =      73.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9195

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8553364   .0997477    -8.58   0.000    -1.050838   -.6598346
       _cons |  -.5013897   .1270503    -3.95   0.000    -.7504038   -.2523756
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        759
                                                  Wald chi2(1)    =     172.19
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0990
                                                  Root MSE        =     2.2655

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.034499   .0788368   -13.12   0.000    -1.189016   -.8799817
       _cons |   -1.15992   .1676137    -6.92   0.000    -1.488437   -.8314032
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,518
                                                  Wald chi2(2)    =     494.25
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1464
                                                  Root MSE        =     2.1124

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9869507   .0613567   -16.09   0.000    -1.107208   -.8666938
       y2000 |  -.8868045   .1187116    -7.47   0.000    -1.119475   -.6541341
       _cons |  -.3612049   .1007459    -3.59   0.000    -.5586633   -.1637465
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 11, TIME IS 10:03:55 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    896,823      100.00      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,941       33.33       33.33
          3 |    597,882       66.67      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,941 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,941 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,941 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000d not found)
file /tmp/St29163.00000d saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        753       20.00       20.00
       1980 |        753       20.00       40.00
       1990 |        753       20.00       60.00
       2000 |        753       20.00       80.00
       2007 |        753       20.00      100.00
------------+-----------------------------------
      Total |      3,765      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,012 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(753 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(749 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,506
        from master                     1,506  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,259  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,506       40.00       40.00
            matched (3) |      2,259       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,765      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       753          0 |       753 
      1980 |         0        753 |       753 
      1990 |         0        753 |       753 
      2000 |         0        753 |       753 
      2007 |       753          0 |       753 
-----------+----------------------+----------
     Total |     1,506      2,259 |     3,765 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,506 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =      72.82
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9111

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8552246   .1002191    -8.53   0.000     -1.05165   -.6587989
       _cons |  -.5010883   .1275338    -3.93   0.000      -.75105   -.2511266
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =     168.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1004
                                                  Root MSE        =     2.2662

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.034147   .0795512   -13.00   0.000    -1.190065   -.8782299
       _cons |  -1.161704    .168932    -6.88   0.000    -1.492805   -.8306037
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,504
                                                  Wald chi2(2)    =     489.14
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1472
                                                  Root MSE        =     2.1089

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9864912   .0617871   -15.97   0.000    -1.107592   -.8653907
       y2000 |  -.8887792   .1191201    -7.46   0.000     -1.12225   -.6553082
       _cons |  -.3611908   .1012451    -3.57   0.000    -.5596275   -.1627541
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 12, TIME IS 10:04:28 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    903,969      100.00      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,323       33.33       33.33
          3 |    602,646       66.67      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,323 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,323 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,323 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000e not found)
file /tmp/St29163.00000e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        759       20.00       20.00
       1980 |        759       20.00       40.00
       1990 |        759       20.00       60.00
       2000 |        759       20.00       80.00
       2007 |        759       20.00      100.00
------------+-----------------------------------
      Total |      3,795      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,036 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(759 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(755 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,518
        from master                     1,518  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,277  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,518       40.00       40.00
            matched (3) |      2,277       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,795      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       759          0 |       759 
      1980 |         0        759 |       759 
      1990 |         0        759 |       759 
      2000 |         0        759 |       759 
      2007 |       759          0 |       759 
-----------+----------------------+----------
     Total |     1,518      2,277 |     3,795 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,518 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =      73.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9215

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8538654   .0993318    -8.60   0.000    -1.048552   -.6591786
       _cons |  -.5026709   .1268725    -3.96   0.000    -.7513365   -.2540053
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =     168.85
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0971
                                                  Root MSE        =     2.2593

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.028577   .0791557   -12.99   0.000    -1.183719   -.8734343
       _cons |  -1.174314   .1681078    -6.99   0.000      -1.5038   -.8448289
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,516
                                                  Wald chi2(2)    =     491.50
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1447
                                                  Root MSE        =     2.1099

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9819407   .0615156   -15.96   0.000    -1.102509   -.8613723
       y2000 |  -.8946955   .1186968    -7.54   0.000    -1.127337   -.6620541
       _cons |  -.3660603   .1008872    -3.63   0.000    -.5637955    -.168325
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 13, TIME IS 10:05:01 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    908,733      100.00      100.00
------------+-----------------------------------
      Total |    908,733      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    302,911       33.33       33.33
          3 |    605,822       66.67      100.00
------------+-----------------------------------
      Total |    908,733      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(302,911 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(302,911 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(302,911 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000f not found)
file /tmp/St29163.00000f saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        763       20.00       20.00
       1980 |        763       20.00       40.00
       1990 |        763       20.00       60.00
       2000 |        763       20.00       80.00
       2007 |        763       20.00      100.00
------------+-----------------------------------
      Total |      3,815      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,052 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(763 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(763 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,052 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(763 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(763 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,052 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(763 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,526
        from master                     1,526  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,289  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,526       40.00       40.00
            matched (3) |      2,289       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,815      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       763          0 |       763 
      1980 |         0        763 |       763 
      1990 |         0        763 |       763 
      2000 |         0        763 |       763 
      2007 |       763          0 |       763 
-----------+----------------------+----------
     Total |     1,526      2,289 |     3,815 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,526 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        762
                                                  Wald chi2(1)    =      76.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9174

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8813747    .100732    -8.75   0.000    -1.078806   -.6839436
       _cons |  -.4722871   .1277934    -3.70   0.000    -.7227575   -.2218166
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        762
                                                  Wald chi2(1)    =     173.19
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1042
                                                  Root MSE        =     2.2461

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.035196   .0786607   -13.16   0.000    -1.189368   -.8810235
       _cons |  -1.158131   .1669074    -6.94   0.000    -1.485264   -.8309985
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,524
                                                  Wald chi2(2)    =     501.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1494
                                                  Root MSE        =     2.0995

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9943911   .0614377   -16.19   0.000    -1.114807   -.8739754
       y2000 |  -.8817901   .1179496    -7.48   0.000    -1.112967    -.650613
       _cons |  -.3519372   .1003256    -3.51   0.000    -.5485717   -.1553027
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 14, TIME IS 10:05:34 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    907,542      100.00      100.00
------------+-----------------------------------
      Total |    907,542      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    302,514       33.33       33.33
          3 |    605,028       66.67      100.00
------------+-----------------------------------
      Total |    907,542      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(302,514 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(302,514 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(302,514 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000g not found)
file /tmp/St29163.00000g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        762       20.00       20.00
       1980 |        762       20.00       40.00
       1990 |        762       20.00       60.00
       2000 |        762       20.00       80.00
       2007 |        762       20.00      100.00
------------+-----------------------------------
      Total |      3,810      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,048 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(762 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(762 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,048 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(762 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(759 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,048 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(762 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,524
        from master                     1,524  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,286  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,524       40.00       40.00
            matched (3) |      2,286       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,810      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       762          0 |       762 
      1980 |         0        762 |       762 
      1990 |         0        762 |       762 
      2000 |         0        762 |       762 
      2007 |       762          0 |       762 
-----------+----------------------+----------
     Total |     1,524      2,286 |     3,810 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,524 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        761
                                                  Wald chi2(1)    =      75.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9264

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8705203   .1004095    -8.67   0.000    -1.067319   -.6737212
       _cons |  -.4864634    .127799    -3.81   0.000    -.7369449    -.235982
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        761
                                                  Wald chi2(1)    =     170.40
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0881
                                                  Root MSE        =     2.2646

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.03732   .0794647   -13.05   0.000    -1.193068    -.881572
       _cons |  -1.157485   .1686572    -6.86   0.000    -1.488047    -.826923
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,522
                                                  Wald chi2(2)    =     494.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1425
                                                  Root MSE        =     2.1133

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9926972   .0617945   -16.06   0.000    -1.113812   -.8715822
       y2000 |   -.883991   .1187787    -7.44   0.000    -1.116793    -.651189
       _cons |  -.3562258   .1010323    -3.53   0.000    -.5542455   -.1582061
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 15, TIME IS 10:06:07 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    901,587      100.00      100.00
------------+-----------------------------------
      Total |    901,587      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,529       33.33       33.33
          3 |    601,058       66.67      100.00
------------+-----------------------------------
      Total |    901,587      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,529 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,529 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,529 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000h not found)
file /tmp/St29163.00000h saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        757       20.00       20.00
       1980 |        757       20.00       40.00
       1990 |        757       20.00       60.00
       2000 |        757       20.00       80.00
       2007 |        757       20.00      100.00
------------+-----------------------------------
      Total |      3,785      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,028 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(757 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,028 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(755 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,028 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,514
        from master                     1,514  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,271  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,514       40.00       40.00
            matched (3) |      2,271       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,785      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       757          0 |       757 
      1980 |         0        757 |       757 
      1990 |         0        757 |       757 
      2000 |         0        757 |       757 
      2007 |       757          0 |       757 
-----------+----------------------+----------
     Total |     1,514      2,271 |     3,785 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,514 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        756
                                                  Wald chi2(1)    =      77.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.914

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8779377   .0998491    -8.79   0.000    -1.073638   -.6822371
       _cons |  -.4786474   .1271325    -3.76   0.000    -.7278225   -.2294723
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        756
                                                  Wald chi2(1)    =     177.57
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1056
                                                  Root MSE        =     2.2436

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.035977   .0777447   -13.33   0.000    -1.188354   -.8836005
       _cons |  -1.155681   .1655319    -6.98   0.000    -1.480117   -.8312443
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,512
                                                  Wald chi2(2)    =     504.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1523
                                                  Root MSE        =     2.0966

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9941314   .0607588   -16.36   0.000    -1.113216   -.8750464
       y2000 |  -.8783463   .1179654    -7.45   0.000    -1.109554   -.6471384
       _cons |  -.3548538   .1000238    -3.55   0.000    -.5508969   -.1588107
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 16, TIME IS 10:06:40 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    896,823      100.00      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,941       33.33       33.33
          3 |    597,882       66.67      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,941 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,941 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,941 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000i not found)
file /tmp/St29163.00000i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        753       20.00       20.00
       1980 |        753       20.00       40.00
       1990 |        753       20.00       60.00
       2000 |        753       20.00       80.00
       2007 |        753       20.00      100.00
------------+-----------------------------------
      Total |      3,765      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,012 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(753 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(752 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,506
        from master                     1,506  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,259  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,506       40.00       40.00
            matched (3) |      2,259       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,765      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       753          0 |       753 
      1980 |         0        753 |       753 
      1990 |         0        753 |       753 
      2000 |         0        753 |       753 
      2007 |       753          0 |       753 
-----------+----------------------+----------
     Total |     1,506      2,259 |     3,765 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,506 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =      74.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9161

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8666042   .1005224    -8.62   0.000    -1.063625   -.6695839
       _cons |   -.488225   .1280253    -3.81   0.000    -.7391499      -.2373
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =     176.34
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0966
                                                  Root MSE        =     2.2538

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.04203   .0784698   -13.28   0.000    -1.195828   -.8882324
       _cons |  -1.144994   .1671681    -6.85   0.000    -1.472638    -.817351
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,504
                                                  Wald chi2(2)    =     499.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1461
                                                  Root MSE        =     2.1038

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9951323   .0612427   -16.25   0.000    -1.115166   -.8750988
       y2000 |  -.8809336   .1187421    -7.42   0.000    -1.113664   -.6482034
       _cons |  -.3510617   .1007828    -3.48   0.000    -.5485923    -.153531
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 17, TIME IS 10:07:13 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    907,542      100.00      100.00
------------+-----------------------------------
      Total |    907,542      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    302,514       33.33       33.33
          3 |    605,028       66.67      100.00
------------+-----------------------------------
      Total |    907,542      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(302,514 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(302,514 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(302,514 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000j not found)
file /tmp/St29163.00000j saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        762       20.00       20.00
       1980 |        762       20.00       40.00
       1990 |        762       20.00       60.00
       2000 |        762       20.00       80.00
       2007 |        762       20.00      100.00
------------+-----------------------------------
      Total |      3,810      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,048 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(762 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(762 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,048 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(762 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(760 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,048 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(762 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,524
        from master                     1,524  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,286  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,524       40.00       40.00
            matched (3) |      2,286       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,810      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       762          0 |       762 
      1980 |         0        762 |       762 
      1990 |         0        762 |       762 
      2000 |         0        762 |       762 
      2007 |       762          0 |       762 
-----------+----------------------+----------
     Total |     1,524      2,286 |     3,810 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,524 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        761
                                                  Wald chi2(1)    =      73.47
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9086

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8655171    .100979    -8.57   0.000    -1.063432   -.6676019
       _cons |  -.4910007   .1277922    -3.84   0.000    -.7414688   -.2405325
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        761
                                                  Wald chi2(1)    =     177.07
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1060
                                                  Root MSE        =     2.2582

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.039144   .0780917   -13.31   0.000    -1.192201   -.8860868
       _cons |  -1.156106   .1660367    -6.96   0.000    -1.481532   -.8306805
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,522
                                                  Wald chi2(2)    =     503.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1527
                                                  Root MSE        =     2.1029

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9938982    .061088   -16.27   0.000    -1.113629   -.8741679
       y2000 |  -.8853998   .1180093    -7.50   0.000    -1.116694   -.6541059
       _cons |  -.3544018   .1001786    -3.54   0.000    -.5507483   -.1580553
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 18, TIME IS 10:07:46 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    889,677      100.00      100.00
------------+-----------------------------------
      Total |    889,677      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    296,559       33.33       33.33
          3 |    593,118       66.67      100.00
------------+-----------------------------------
      Total |    889,677      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(296,559 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(296,559 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(296,559 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000k not found)
file /tmp/St29163.00000k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        747       20.00       20.00
       1980 |        747       20.00       40.00
       1990 |        747       20.00       60.00
       2000 |        747       20.00       80.00
       2007 |        747       20.00      100.00
------------+-----------------------------------
      Total |      3,735      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,988 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(747 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(747 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,988 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(747 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(744 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,988 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(747 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,494
        from master                     1,494  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,241  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,494       40.00       40.00
            matched (3) |      2,241       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,735      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       747          0 |       747 
      1980 |         0        747 |       747 
      1990 |         0        747 |       747 
      2000 |         0        747 |       747 
      2007 |       747          0 |       747 
-----------+----------------------+----------
     Total |     1,494      2,241 |     3,735 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,494 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        746
                                                  Wald chi2(1)    =      72.42
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.918

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8609622   .1011713    -8.51   0.000    -1.059254   -.6626701
       _cons |  -.5013489   .1289181    -3.89   0.000    -.7540238   -.2486741
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        746
                                                  Wald chi2(1)    =     179.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1065
                                                  Root MSE        =      2.245

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.06299   .0793824   -13.39   0.000    -1.218577   -.9074038
       _cons |  -1.116199   .1683422    -6.63   0.000    -1.446144   -.7862545
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,492
                                                  Wald chi2(2)    =     497.95
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1504
                                                  Root MSE        =     2.1022

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.009021   .0620084   -16.27   0.000    -1.130556   -.8874872
       y2000 |  -.8729504   .1191604    -7.33   0.000      -1.1065   -.6394003
       _cons |  -.3431282   .1015613    -3.38   0.001    -.5421847   -.1440717
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 19, TIME IS 10:08:19 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    911,115      100.00      100.00
------------+-----------------------------------
      Total |    911,115      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    303,705       33.33       33.33
          3 |    607,410       66.67      100.00
------------+-----------------------------------
      Total |    911,115      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(303,705 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(303,705 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(303,705 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000l not found)
file /tmp/St29163.00000l saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        765       20.00       20.00
       1980 |        765       20.00       40.00
       1990 |        765       20.00       60.00
       2000 |        765       20.00       80.00
       2007 |        765       20.00      100.00
------------+-----------------------------------
      Total |      3,825      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,060 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(765 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(765 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,060 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(765 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(765 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,060 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(765 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,530
        from master                     1,530  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,295  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,530       40.00       40.00
            matched (3) |      2,295       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,825      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       765          0 |       765 
      1980 |         0        765 |       765 
      1990 |         0        765 |       765 
      2000 |         0        765 |       765 
      2007 |       765          0 |       765 
-----------+----------------------+----------
     Total |     1,530      2,295 |     3,825 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,530 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        764
                                                  Wald chi2(1)    =      78.65
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9309

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8948616   .1009037    -8.87   0.000    -1.092629    -.697094
       _cons |  -.4671703   .1280435    -3.65   0.000     -.718131   -.2162096
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        764
                                                  Wald chi2(1)    =     178.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0861
                                                  Root MSE        =     2.2898

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.074001   .0804299   -13.35   0.000     -1.23164   -.9163608
       _cons |  -1.086086   .1705761    -6.37   0.000     -1.42041   -.7517634
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,528
                                                  Wald chi2(2)    =     502.43
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1375
                                                  Root MSE        =     2.1295

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.026221   .0623654   -16.45   0.000    -1.148455   -.9039867
       y2000 |  -.8471908   .1195885    -7.08   0.000     -1.08158   -.6128017
       _cons |   -.327475   .1016583    -3.22   0.001    -.5267216   -.1282283
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 20, TIME IS 10:08:52 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    896,823      100.00      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,941       33.33       33.33
          3 |    597,882       66.67      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,941 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,941 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,941 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000m not found)
file /tmp/St29163.00000m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        753       20.00       20.00
       1980 |        753       20.00       40.00
       1990 |        753       20.00       60.00
       2000 |        753       20.00       80.00
       2007 |        753       20.00      100.00
------------+-----------------------------------
      Total |      3,765      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,012 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(753 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(751 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,506
        from master                     1,506  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,259  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,506       40.00       40.00
            matched (3) |      2,259       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,765      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       753          0 |       753 
      1980 |         0        753 |       753 
      1990 |         0        753 |       753 
      2000 |         0        753 |       753 
      2007 |       753          0 |       753 
-----------+----------------------+----------
     Total |     1,506      2,259 |     3,765 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,506 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =      74.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9152

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8613286   .1000208    -8.61   0.000    -1.057366   -.6652914
       _cons |  -.5005221   .1274904    -3.93   0.000    -.7503987   -.2506455
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =     175.82
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0901
                                                  Root MSE        =     2.2659

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.041639   .0785558   -13.26   0.000    -1.195606   -.8876727
       _cons |  -1.144947   .1675303    -6.83   0.000    -1.473301   -.8165939
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,504
                                                  Wald chi2(2)    =     496.40
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1437
                                                  Root MSE        =     2.1094

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.99363   .0611525   -16.25   0.000    -1.113487   -.8737732
       y2000 |  -.8745725   .1190007    -7.35   0.000     -1.10781   -.6413355
       _cons |  -.3594406   .1008444    -3.56   0.000    -.5570919   -.1617893
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 21, TIME IS 10:09:25 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    903,969      100.00      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,323       33.33       33.33
          3 |    602,646       66.67      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,323 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,323 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,323 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000n not found)
file /tmp/St29163.00000n saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        759       20.00       20.00
       1980 |        759       20.00       40.00
       1990 |        759       20.00       60.00
       2000 |        759       20.00       80.00
       2007 |        759       20.00      100.00
------------+-----------------------------------
      Total |      3,795      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,036 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(759 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(757 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,518
        from master                     1,518  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,277  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,518       40.00       40.00
            matched (3) |      2,277       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,795      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       759          0 |       759 
      1980 |         0        759 |       759 
      1990 |         0        759 |       759 
      2000 |         0        759 |       759 
      2007 |       759          0 |       759 
-----------+----------------------+----------
     Total |     1,518      2,277 |     3,795 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,518 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =      73.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9056

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8435703   .0986673    -8.55   0.000    -1.036955   -.6501859
       _cons |  -.5129931    .125937    -4.07   0.000    -.7598252   -.2661611
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =     170.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1092
                                                  Root MSE        =     2.2422

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.020528   .0781896   -13.05   0.000    -1.173777   -.8672794
       _cons |  -1.185599   .1661368    -7.14   0.000    -1.511221   -.8599767
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,516
                                                  Wald chi2(2)    =     494.96
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1530
                                                  Root MSE        =     2.0938

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9734302   .0608569   -16.00   0.000    -1.092707   -.8541529
       y2000 |  -.8983029   .1177018    -7.63   0.000    -1.128994   -.6676115
       _cons |  -.3745208   .0999746    -3.75   0.000    -.5704674   -.1785743
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 22, TIME IS 10:09:58 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    896,823      100.00      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,941       33.33       33.33
          3 |    597,882       66.67      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,941 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,941 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,941 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000o not found)
file /tmp/St29163.00000o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        753       20.00       20.00
       1980 |        753       20.00       40.00
       1990 |        753       20.00       60.00
       2000 |        753       20.00       80.00
       2007 |        753       20.00      100.00
------------+-----------------------------------
      Total |      3,765      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,012 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(753 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(750 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,506
        from master                     1,506  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,259  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,506       40.00       40.00
            matched (3) |      2,259       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,765      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       753          0 |       753 
      1980 |         0        753 |       753 
      1990 |         0        753 |       753 
      2000 |         0        753 |       753 
      2007 |       753          0 |       753 
-----------+----------------------+----------
     Total |     1,506      2,259 |     3,765 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,506 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =      71.81
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9149

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8559811   .1010098    -8.47   0.000    -1.053957   -.6580056
       _cons |  -.5072097   .1281476    -3.96   0.000    -.7583742   -.2560451
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =     180.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1062
                                                  Root MSE        =     2.2467

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.046747   .0779452   -13.43   0.000    -1.199517   -.8939776
       _cons |  -1.146214   .1656875    -6.92   0.000    -1.470955   -.8214724
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,504
                                                  Wald chi2(2)    =     501.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1519
                                                  Root MSE        =     2.1008

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9961935   .0610911   -16.31   0.000     -1.11593   -.8764571
       y2000 |  -.8815612    .118453    -7.44   0.000    -1.113725   -.6493975
       _cons |  -.3580577   .1004596    -3.56   0.000    -.5549548   -.1611606
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 23, TIME IS 10:10:31 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    901,587      100.00      100.00
------------+-----------------------------------
      Total |    901,587      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,529       33.33       33.33
          3 |    601,058       66.67      100.00
------------+-----------------------------------
      Total |    901,587      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,529 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,529 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,529 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000p not found)
file /tmp/St29163.00000p saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        757       20.00       20.00
       1980 |        757       20.00       40.00
       1990 |        757       20.00       60.00
       2000 |        757       20.00       80.00
       2007 |        757       20.00      100.00
------------+-----------------------------------
      Total |      3,785      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,028 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(757 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,028 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(754 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,028 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,514
        from master                     1,514  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,271  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,514       40.00       40.00
            matched (3) |      2,271       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,785      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       757          0 |       757 
      1980 |         0        757 |       757 
      1990 |         0        757 |       757 
      2000 |         0        757 |       757 
      2007 |       757          0 |       757 
-----------+----------------------+----------
     Total |     1,514      2,271 |     3,785 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,514 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        756
                                                  Wald chi2(1)    =      73.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9396

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8603145   .1001572    -8.59   0.000    -1.056619     -.66401
       _cons |  -.4978358   .1280971    -3.89   0.000    -.7489016   -.2467701
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        756
                                                  Wald chi2(1)    =     176.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0947
                                                  Root MSE        =     2.2575

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.05838   .0795685   -13.30   0.000    -1.214331   -.9024283
       _cons |  -1.119214   .1688001    -6.63   0.000    -1.450056   -.7883719
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,512
                                                  Wald chi2(2)    =     495.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1375
                                                  Root MSE        =     2.1198

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.005062    .062044   -16.20   0.000    -1.126666   -.8834576
       y2000 |  -.8747325   .1194384    -7.32   0.000    -1.108827   -.6406375
       _cons |  -.3433105   .1016402    -3.38   0.001    -.5425216   -.1440994
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 24, TIME IS 10:11:04 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    893,250      100.00      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    297,750       33.33       33.33
          3 |    595,500       66.67      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(297,750 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(297,750 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(297,750 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000q not found)
file /tmp/St29163.00000q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        750       20.00       20.00
       1980 |        750       20.00       40.00
       1990 |        750       20.00       60.00
       2000 |        750       20.00       80.00
       2007 |        750       20.00      100.00
------------+-----------------------------------
      Total |      3,750      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,000 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(750 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(748 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,500
        from master                     1,500  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,250  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,500       40.00       40.00
            matched (3) |      2,250       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,750      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       750          0 |       750 
      1980 |         0        750 |       750 
      1990 |         0        750 |       750 
      2000 |         0        750 |       750 
      2007 |       750          0 |       750 
-----------+----------------------+----------
     Total |     1,500      2,250 |     3,750 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,500 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =      73.72
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8969

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8543704   .0995069    -8.59   0.000      -1.0494   -.6593404
       _cons |  -.5040623   .1267067    -3.98   0.000    -.7524029   -.2557217
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =     167.21
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0985
                                                  Root MSE        =     2.2538

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.019653   .0788533   -12.93   0.000    -1.174203   -.8651036
       _cons |  -1.186918   .1677363    -7.08   0.000    -1.515675   -.8581613
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,498
                                                  Wald chi2(2)    =     489.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1487
                                                  Root MSE        =     2.0945

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9760425    .061242   -15.94   0.000    -1.096075   -.8560104
       y2000 |   -.893369   .1184851    -7.54   0.000    -1.125595   -.6611424
       _cons |  -.3743681   .1005911    -3.72   0.000    -.5715231   -.1772131
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 25, TIME IS 10:11:37 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    896,823      100.00      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,941       33.33       33.33
          3 |    597,882       66.67      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,941 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,941 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,941 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000r not found)
file /tmp/St29163.00000r saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        753       20.00       20.00
       1980 |        753       20.00       40.00
       1990 |        753       20.00       60.00
       2000 |        753       20.00       80.00
       2007 |        753       20.00      100.00
------------+-----------------------------------
      Total |      3,765      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,012 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(753 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(751 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,506
        from master                     1,506  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,259  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,506       40.00       40.00
            matched (3) |      2,259       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,765      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       753          0 |       753 
      1980 |         0        753 |       753 
      1990 |         0        753 |       753 
      2000 |         0        753 |       753 
      2007 |       753          0 |       753 
-----------+----------------------+----------
     Total |     1,506      2,259 |     3,765 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,506 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =      73.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9378

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8633577   .1009804    -8.55   0.000    -1.061276   -.6654397
       _cons |  -.4953384   .1288202    -3.85   0.000    -.7478213   -.2428555
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =     169.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1025
                                                  Root MSE        =     2.2564

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.045069   .0803521   -13.01   0.000    -1.202556   -.8875815
       _cons |  -1.144574   .1700415    -6.73   0.000     -1.47785   -.8112993
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,504
                                                  Wald chi2(2)    =     484.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1411
                                                  Root MSE        =     2.1183

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9966398   .0626631   -15.90   0.000    -1.119457   -.8738224
       y2000 |  -.8810865   .1198129    -7.35   0.000    -1.115916   -.6462574
       _cons |  -.3531749    .102148    -3.46   0.001    -.5533813   -.1529685
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 26, TIME IS 10:12:09 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    906,351      100.00      100.00
------------+-----------------------------------
      Total |    906,351      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    302,117       33.33       33.33
          3 |    604,234       66.67      100.00
------------+-----------------------------------
      Total |    906,351      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(302,117 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(302,117 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(302,117 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000s not found)
file /tmp/St29163.00000s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        761       20.00       20.00
       1980 |        761       20.00       40.00
       1990 |        761       20.00       60.00
       2000 |        761       20.00       80.00
       2007 |        761       20.00      100.00
------------+-----------------------------------
      Total |      3,805      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,044 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(761 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,044 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(756 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,044 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,522
        from master                     1,522  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,283  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,522       40.00       40.00
            matched (3) |      2,283       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,805      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       761          0 |       761 
      1980 |         0        761 |       761 
      1990 |         0        761 |       761 
      2000 |         0        761 |       761 
      2007 |       761          0 |       761 
-----------+----------------------+----------
     Total |     1,522      2,283 |     3,805 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,522 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        760
                                                  Wald chi2(1)    =      75.29
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9313

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8948954   .1031324    -8.68   0.000    -1.097031   -.6927596
       _cons |  -.4682216   .1300133    -3.60   0.000    -.7230431   -.2134001
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        760
                                                  Wald chi2(1)    =     185.46
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1018
                                                  Root MSE        =     2.2439

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.047379   .0769094   -13.62   0.000    -1.198118    -.896639
       _cons |  -1.145877   .1637016    -7.00   0.000    -1.466726   -.8250276
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,520
                                                  Wald chi2(2)    =     511.09
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1465
                                                  Root MSE        =     2.1046

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.007778   .0608559   -16.56   0.000    -1.127053   -.8885029
       y2000 |  -.8706654   .1180537    -7.38   0.000    -1.102046   -.6392843
       _cons |  -.3483433    .100023    -3.48   0.000    -.5443848   -.1523017
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 27, TIME IS 10:12:42 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    909,924      100.00      100.00
------------+-----------------------------------
      Total |    909,924      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    303,308       33.33       33.33
          3 |    606,616       66.67      100.00
------------+-----------------------------------
      Total |    909,924      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(303,308 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(303,308 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(303,308 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000t not found)
file /tmp/St29163.00000t saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        764       20.00       20.00
       1980 |        764       20.00       40.00
       1990 |        764       20.00       60.00
       2000 |        764       20.00       80.00
       2007 |        764       20.00      100.00
------------+-----------------------------------
      Total |      3,820      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,056 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(764 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,056 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(762 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,056 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,528
        from master                     1,528  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,292  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,528       40.00       40.00
            matched (3) |      2,292       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,820      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       764          0 |       764 
      1980 |         0        764 |       764 
      1990 |         0        764 |       764 
      2000 |         0        764 |       764 
      2007 |       764          0 |       764 
-----------+----------------------+----------
     Total |     1,528      2,292 |     3,820 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,528 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        763
                                                  Wald chi2(1)    =      73.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9192

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8483213   .0990739    -8.56   0.000    -1.042503     -.65414
       _cons |  -.5049516   .1263771    -4.00   0.000    -.7526463    -.257257
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        763
                                                  Wald chi2(1)    =     172.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0995
                                                  Root MSE        =     2.2522

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.02245   .0777535   -13.15   0.000    -1.174844    -.870056
       _cons |  -1.181973   .1654988    -7.14   0.000    -1.506345   -.8576016
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,526
                                                  Wald chi2(2)    =     497.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1450
                                                  Root MSE        =     2.1055

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9764404   .0607065   -16.08   0.000    -1.095423   -.8574579
       y2000 |  -.8987548   .1179055    -7.62   0.000    -1.129845   -.6676644
       _cons |  -.3684413   .0999701    -3.69   0.000     -.564379   -.1725036
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 28, TIME IS 10:13:16 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    903,969      100.00      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,323       33.33       33.33
          3 |    602,646       66.67      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,323 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,323 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,323 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000u not found)
file /tmp/St29163.00000u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        759       20.00       20.00
       1980 |        759       20.00       40.00
       1990 |        759       20.00       60.00
       2000 |        759       20.00       80.00
       2007 |        759       20.00      100.00
------------+-----------------------------------
      Total |      3,795      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,036 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(759 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(756 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,518
        from master                     1,518  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,277  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,518       40.00       40.00
            matched (3) |      2,277       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,795      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       759          0 |       759 
      1980 |         0        759 |       759 
      1990 |         0        759 |       759 
      2000 |         0        759 |       759 
      2007 |       759          0 |       759 
-----------+----------------------+----------
     Total |     1,518      2,277 |     3,795 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,518 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =      74.21
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9577

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8641624   .1003117    -8.61   0.000     -1.06077   -.6675551
       _cons |  -.4968934   .1284613    -3.87   0.000     -.748673   -.2451138
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =     166.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0976
                                                  Root MSE        =      2.269

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.000641   .0775444   -12.90   0.000    -1.152625   -.8486572
       _cons |  -1.226545   .1654312    -7.41   0.000    -1.550784   -.9023056
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,516
                                                  Wald chi2(2)    =     480.95
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1351
                                                  Root MSE        =     2.1309

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9646653   .0608618   -15.85   0.000    -1.083952   -.8453783
       y2000 |  -.9033892   .1193851    -7.57   0.000     -1.13738   -.6693986
       _cons |  -.3897039   .1010128    -3.86   0.000    -.5876853   -.1917225
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 29, TIME IS 10:13:48 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    902,778      100.00      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,926       33.33       33.33
          3 |    601,852       66.67      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,926 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,926 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,926 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000v not found)
file /tmp/St29163.00000v saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        758       20.00       20.00
       1980 |        758       20.00       40.00
       1990 |        758       20.00       60.00
       2000 |        758       20.00       80.00
       2007 |        758       20.00      100.00
------------+-----------------------------------
      Total |      3,790      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,032 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(758 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(753 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,516
        from master                     1,516  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,274  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,516       40.00       40.00
            matched (3) |      2,274       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,790      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       758          0 |       758 
      1980 |         0        758 |       758 
      1990 |         0        758 |       758 
      2000 |         0        758 |       758 
      2007 |       758          0 |       758 
-----------+----------------------+----------
     Total |     1,516      2,274 |     3,790 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,516 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =      75.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =       1.91

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8681057   .0998204    -8.70   0.000     -1.06375   -.6724613
       _cons |  -.4885174    .127147    -3.84   0.000    -.7377209   -.2393139
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =     179.65
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0914
                                                  Root MSE        =     2.2734

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.069531   .0797952   -13.40   0.000    -1.225926   -.9131351
       _cons |  -1.098498   .1693863    -6.49   0.000    -1.430489   -.7665075
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,514
                                                  Wald chi2(2)    =     505.14
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1442
                                                  Root MSE        =     2.1125

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.015343   .0618052   -16.43   0.000    -1.136479   -.8942068
       y2000 |  -.8675194   .1189543    -7.29   0.000    -1.100666   -.6343734
       _cons |  -.3313923   .1012204    -3.27   0.001    -.5297807   -.1330039
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 30, TIME IS 10:14:21 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    905,160      100.00      100.00
------------+-----------------------------------
      Total |    905,160      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,720       33.33       33.33
          3 |    603,440       66.67      100.00
------------+-----------------------------------
      Total |    905,160      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,720 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,720 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,720 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000w not found)
file /tmp/St29163.00000w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        760       20.00       20.00
       1980 |        760       20.00       40.00
       1990 |        760       20.00       60.00
       2000 |        760       20.00       80.00
       2007 |        760       20.00      100.00
------------+-----------------------------------
      Total |      3,800      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,040 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(760 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,040 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(756 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,040 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,520
        from master                     1,520  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,280  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,520       40.00       40.00
            matched (3) |      2,280       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,800      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       760          0 |       760 
      1980 |         0        760 |       760 
      1990 |         0        760 |       760 
      2000 |         0        760 |       760 
      2007 |       760          0 |       760 
-----------+----------------------+----------
     Total |     1,520      2,280 |     3,800 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,520 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        759
                                                  Wald chi2(1)    =      75.12
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8917

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8503985   .0981185    -8.67   0.000    -1.042707   -.6580898
       _cons |  -.5085308   .1249289    -4.07   0.000     -.753387   -.2636747
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        759
                                                  Wald chi2(1)    =     176.76
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1024
                                                  Root MSE        =     2.2477

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.035599   .0778938   -13.29   0.000    -1.188268   -.8829295
       _cons |  -1.161299   .1656731    -7.01   0.000    -1.486012   -.8365855
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,518
                                                  Wald chi2(2)    =     506.76
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1532
                                                  Root MSE        =     2.0903

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9865699   .0605018   -16.31   0.000    -1.105151   -.8679885
       y2000 |  -.8883702   .1173996    -7.57   0.000    -1.118469   -.6582712
       _cons |  -.3636867   .0994891    -3.66   0.000    -.5586818   -.1686917
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 31, TIME IS 10:14:54 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    895,632      100.00      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,544       33.33       33.33
          3 |    597,088       66.67      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,544 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,544 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,544 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00000x not found)
file /tmp/St29163.00000x saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        752       20.00       20.00
       1980 |        752       20.00       40.00
       1990 |        752       20.00       60.00
       2000 |        752       20.00       80.00
       2007 |        752       20.00      100.00
------------+-----------------------------------
      Total |      3,760      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,008 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(752 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(750 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,504
        from master                     1,504  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,256  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,504       40.00       40.00
            matched (3) |      2,256       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,760      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       752          0 |       752 
      1980 |         0        752 |       752 
      1990 |         0        752 |       752 
      2000 |         0        752 |       752 
      2007 |       752          0 |       752 
-----------+----------------------+----------
     Total |     1,504      2,256 |     3,760 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,504 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =      73.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9354

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8749984   .1019708    -8.58   0.000    -1.074858   -.6751392
       _cons |  -.4834596   .1296889    -3.73   0.000    -.7376452   -.2292741
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =     174.06
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0901
                                                  Root MSE        =      2.258

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.05373   .0798698   -13.19   0.000    -1.210272   -.8971878
       _cons |  -1.125773   .1695177    -6.64   0.000    -1.458022   -.7935244
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,502
                                                  Wald chi2(2)    =     492.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1421
                                                  Root MSE        =     2.1144

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.005909   .0623631   -16.13   0.000    -1.128138   -.8836796
       y2000 |  -.8706557   .1196733    -7.28   0.000    -1.105211   -.6361004
       _cons |  -.3438171   .1018736    -3.37   0.001    -.5434857   -.1441484
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 32, TIME IS 10:15:27 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    900,396      100.00      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,132       33.33       33.33
          3 |    600,264       66.67      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,132 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,132 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,132 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000010 not found)
file /tmp/St29163.000010 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        756       20.00       20.00
       1980 |        756       20.00       40.00
       1990 |        756       20.00       60.00
       2000 |        756       20.00       80.00
       2007 |        756       20.00      100.00
------------+-----------------------------------
      Total |      3,780      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,024 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(756 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(754 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,512
        from master                     1,512  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,268  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,512       40.00       40.00
            matched (3) |      2,268       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,780      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       756          0 |       756 
      1980 |         0        756 |       756 
      1990 |         0        756 |       756 
      2000 |         0        756 |       756 
      2007 |       756          0 |       756 
-----------+----------------------+----------
     Total |     1,512      2,268 |     3,780 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,512 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =      75.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9125

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8632519    .099295    -8.69   0.000    -1.057867   -.6686373
       _cons |  -.4918181   .1265708    -3.89   0.000    -.7398922   -.2437439
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =     177.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1034
                                                  Root MSE        =     2.2552

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.032438   .0775962   -13.31   0.000    -1.184523    -.880352
       _cons |  -1.165875   .1654035    -7.05   0.000     -1.49006   -.8416906
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,510
                                                  Wald chi2(2)    =     502.94
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1511
                                                  Root MSE        =     2.1029

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9876731   .0605475   -16.31   0.000    -1.106344   -.8690022
       y2000 |  -.8893666   .1182339    -7.52   0.000    -1.121101   -.6576324
       _cons |  -.3593528   .1000627    -3.59   0.000    -.5554721   -.1632335
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 33, TIME IS 10:16:01 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    900,396      100.00      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,132       33.33       33.33
          3 |    600,264       66.67      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,132 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,132 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,132 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000011 not found)
file /tmp/St29163.000011 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        756       20.00       20.00
       1980 |        756       20.00       40.00
       1990 |        756       20.00       60.00
       2000 |        756       20.00       80.00
       2007 |        756       20.00      100.00
------------+-----------------------------------
      Total |      3,780      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,024 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(756 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(753 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,512
        from master                     1,512  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,268  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,512       40.00       40.00
            matched (3) |      2,268       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,780      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       756          0 |       756 
      1980 |         0        756 |       756 
      1990 |         0        756 |       756 
      2000 |         0        756 |       756 
      2007 |       756          0 |       756 
-----------+----------------------+----------
     Total |     1,512      2,268 |     3,780 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,512 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =      75.30
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9342

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8806831   .1014874    -8.68   0.000    -1.079595   -.6817715
       _cons |  -.4766414   .1291785    -3.69   0.000    -.7298266   -.2234561
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =     166.21
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0987
                                                  Root MSE        =     2.2576

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.025438   .0795382   -12.89   0.000    -1.181331   -.8695463
       _cons |  -1.176942   .1689786    -6.97   0.000    -1.508135   -.8457504
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,510
                                                  Wald chi2(2)    =     486.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1413
                                                  Root MSE        =     2.1132

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9869849   .0621033   -15.89   0.000    -1.108705   -.8652647
       y2000 |  -.8851397    .119297    -7.42   0.000    -1.118957   -.6513219
       _cons |    -.36319   .1015277    -3.58   0.000    -.5621806   -.1641993
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 34, TIME IS 10:16:34 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    902,778      100.00      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,926       33.33       33.33
          3 |    601,852       66.67      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,926 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,926 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,926 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000012 not found)
file /tmp/St29163.000012 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        758       20.00       20.00
       1980 |        758       20.00       40.00
       1990 |        758       20.00       60.00
       2000 |        758       20.00       80.00
       2007 |        758       20.00      100.00
------------+-----------------------------------
      Total |      3,790      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,032 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(758 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(754 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,516
        from master                     1,516  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,274  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,516       40.00       40.00
            matched (3) |      2,274       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,790      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       758          0 |       758 
      1980 |         0        758 |       758 
      1990 |         0        758 |       758 
      2000 |         0        758 |       758 
      2007 |       758          0 |       758 
-----------+----------------------+----------
     Total |     1,516      2,274 |     3,790 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,516 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =      73.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9178

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8673845   .1008416    -8.60   0.000     -1.06503   -.6697385
       _cons |  -.4956183   .1279687    -3.87   0.000    -.7464325   -.2448042
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =     172.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1177
                                                  Root MSE        =     2.2307

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.019939   .0776916   -13.13   0.000    -1.172211   -.8676658
       _cons |  -1.194153   .1649924    -7.24   0.000    -1.517532   -.8707738
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,514
                                                  Wald chi2(2)    =     496.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1563
                                                  Root MSE        =      2.092

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9796859   .0609859   -16.06   0.000    -1.099216   -.8601557
       y2000 |  -.8925004   .1177152    -7.58   0.000    -1.123218   -.6617829
       _cons |   -.376104    .099969    -3.76   0.000    -.5720395   -.1801684
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 35, TIME IS 10:17:07 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    898,014      100.00      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,338       33.33       33.33
          3 |    598,676       66.67      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,338 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,338 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,338 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000013 not found)
file /tmp/St29163.000013 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        754       20.00       20.00
       1980 |        754       20.00       40.00
       1990 |        754       20.00       60.00
       2000 |        754       20.00       80.00
       2007 |        754       20.00      100.00
------------+-----------------------------------
      Total |      3,770      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,016 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(754 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(751 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,508
        from master                     1,508  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,262  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,508       40.00       40.00
            matched (3) |      2,262       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,770      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       754          0 |       754 
      1980 |         0        754 |       754 
      1990 |         0        754 |       754 
      2000 |         0        754 |       754 
      2007 |       754          0 |       754 
-----------+----------------------+----------
     Total |     1,508      2,262 |     3,770 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,508 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =      76.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9193

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8838502   .1007311    -8.77   0.000     -1.08128   -.6864208
       _cons |  -.4737123   .1281526    -3.70   0.000    -.7248869   -.2225377
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =     179.28
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1069
                                                  Root MSE        =     2.2368

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.044769   .0780297   -13.39   0.000    -1.197705   -.8918339
       _cons |  -1.140921   .1658231    -6.88   0.000    -1.465928   -.8159139
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,506
                                                  Wald chi2(2)    =     504.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1526
                                                  Root MSE        =     2.0953

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.002021   .0611127   -16.40   0.000    -1.121799   -.8822421
       y2000 |  -.8722958   .1181544    -7.38   0.000    -1.103874   -.6407175
       _cons |  -.3477378   .1003742    -3.46   0.001    -.5444677    -.151008
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 36, TIME IS 10:17:40 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    893,250      100.00      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    297,750       33.33       33.33
          3 |    595,500       66.67      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(297,750 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(297,750 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(297,750 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000014 not found)
file /tmp/St29163.000014 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        750       20.00       20.00
       1980 |        750       20.00       40.00
       1990 |        750       20.00       60.00
       2000 |        750       20.00       80.00
       2007 |        750       20.00      100.00
------------+-----------------------------------
      Total |      3,750      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,000 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(750 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(748 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,500
        from master                     1,500  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,250  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,500       40.00       40.00
            matched (3) |      2,250       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,750      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       750          0 |       750 
      1980 |         0        750 |       750 
      1990 |         0        750 |       750 
      2000 |         0        750 |       750 
      2007 |       750          0 |       750 
-----------+----------------------+----------
     Total |     1,500      2,250 |     3,750 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,500 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =      73.72
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9239

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8547996   .0995589    -8.59   0.000    -1.049931   -.6596678
       _cons |    -.50323   .1274528    -3.95   0.000    -.7530329   -.2534271
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =     172.87
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0897
                                                  Root MSE        =     2.2576

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.061311   .0807203   -13.15   0.000     -1.21952   -.9031026
       _cons |  -1.107459   .1709349    -6.48   0.000    -1.442485   -.7724327
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,498
                                                  Wald chi2(2)    =     489.44
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1342
                                                  Root MSE        =     2.1132

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.004987   .0625226   -16.07   0.000    -1.127529   -.8824445
       y2000 |  -.8690725    .119768    -7.26   0.000    -1.103813   -.6343317
       _cons |  -.3428535   .1020759    -3.36   0.001    -.5429185   -.1427885
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 37, TIME IS 10:18:13 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    895,632      100.00      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,544       33.33       33.33
          3 |    597,088       66.67      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,544 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,544 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,544 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000015 not found)
file /tmp/St29163.000015 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        752       20.00       20.00
       1980 |        752       20.00       40.00
       1990 |        752       20.00       60.00
       2000 |        752       20.00       80.00
       2007 |        752       20.00      100.00
------------+-----------------------------------
      Total |      3,760      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,008 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(752 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(750 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,504
        from master                     1,504  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,256  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,504       40.00       40.00
            matched (3) |      2,256       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,760      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       752          0 |       752 
      1980 |         0        752 |       752 
      1990 |         0        752 |       752 
      2000 |         0        752 |       752 
      2007 |       752          0 |       752 
-----------+----------------------+----------
     Total |     1,504      2,256 |     3,760 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,504 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =      76.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9202

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8772033    .100222    -8.75   0.000    -1.073635   -.6807717
       _cons |  -.4810644   .1276958    -3.77   0.000    -.7313435   -.2307852
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =     173.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1001
                                                  Root MSE        =     2.2405

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.041863   .0790664   -13.18   0.000     -1.19683   -.8868958
       _cons |  -1.145607    .167898    -6.82   0.000    -1.474681   -.8165329
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,502
                                                  Wald chi2(2)    =     497.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1483
                                                  Root MSE        =     2.0978

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9979273   .0616409   -16.19   0.000    -1.118741   -.8771133
       y2000 |  -.8746233   .1186971    -7.37   0.000    -1.107265   -.6419813
       _cons |  -.3524728    .100852    -3.49   0.000    -.5501391   -.1548066
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 38, TIME IS 10:18:46 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    905,160      100.00      100.00
------------+-----------------------------------
      Total |    905,160      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,720       33.33       33.33
          3 |    603,440       66.67      100.00
------------+-----------------------------------
      Total |    905,160      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,720 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,720 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,720 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000016 not found)
file /tmp/St29163.000016 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        760       20.00       20.00
       1980 |        760       20.00       40.00
       1990 |        760       20.00       60.00
       2000 |        760       20.00       80.00
       2007 |        760       20.00      100.00
------------+-----------------------------------
      Total |      3,800      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,040 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(760 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,040 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(758 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,040 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,520
        from master                     1,520  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,280  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,520       40.00       40.00
            matched (3) |      2,280       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,800      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       760          0 |       760 
      1980 |         0        760 |       760 
      1990 |         0        760 |       760 
      2000 |         0        760 |       760 
      2007 |       760          0 |       760 
-----------+----------------------+----------
     Total |     1,520      2,280 |     3,800 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,520 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        759
                                                  Wald chi2(1)    =      73.26
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9236

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8446131   .0986775    -8.56   0.000    -1.038017   -.6512089
       _cons |  -.5118944   .1262264    -4.06   0.000    -.7592935   -.2644952
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        759
                                                  Wald chi2(1)    =     172.09
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1021
                                                  Root MSE        =     2.2625

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.04567   .0797108   -13.12   0.000      -1.2019   -.8894394
       _cons |  -1.139041   .1688662    -6.75   0.000    -1.470013   -.8080697
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,518
                                                  Wald chi2(2)    =     492.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1465
                                                  Root MSE        =     2.1144

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9914453   .0617676   -16.05   0.000    -1.112508   -.8703831
       y2000 |  -.8839947   .1188854    -7.44   0.000    -1.117006   -.6509837
       _cons |  -.3554207   .1011079    -3.52   0.000    -.5535885   -.1572529
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 39, TIME IS 10:19:24 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    902,778      100.00      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,926       33.33       33.33
          3 |    601,852       66.67      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,926 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,926 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,926 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000017 not found)
file /tmp/St29163.000017 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        758       20.00       20.00
       1980 |        758       20.00       40.00
       1990 |        758       20.00       60.00
       2000 |        758       20.00       80.00
       2007 |        758       20.00      100.00
------------+-----------------------------------
      Total |      3,790      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,032 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(758 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(755 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,516
        from master                     1,516  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,274  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,516       40.00       40.00
            matched (3) |      2,274       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,790      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       758          0 |       758 
      1980 |         0        758 |       758 
      1990 |         0        758 |       758 
      2000 |         0        758 |       758 
      2007 |       758          0 |       758 
-----------+----------------------+----------
     Total |     1,516      2,274 |     3,790 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,516 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =      75.18
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9277

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8618493   .0994008    -8.67   0.000    -1.056671   -.6670273
       _cons |  -.4961012   .1270902    -3.90   0.000    -.7451933   -.2470091
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =     171.57
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1115
                                                  Root MSE        =     2.2369

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.034225   .0789571   -13.10   0.000    -1.188978   -.8794718
       _cons |  -1.164882   .1672094    -6.97   0.000    -1.492607   -.8371579
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,514
                                                  Wald chi2(2)    =     494.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1510
                                                  Root MSE        =     2.1012

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9876325   .0615378   -16.05   0.000    -1.108244   -.8670206
       y2000 |  -.8891792   .1182859    -7.52   0.000    -1.121015    -.657343
       _cons |  -.3619242    .100706    -3.59   0.000    -.5593043   -.1645442
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 40, TIME IS 10:19:57 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    899,205      100.00      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,735       33.33       33.33
          3 |    599,470       66.67      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,735 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,735 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,735 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000018 not found)
file /tmp/St29163.000018 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        755       20.00       20.00
       1980 |        755       20.00       40.00
       1990 |        755       20.00       60.00
       2000 |        755       20.00       80.00
       2007 |        755       20.00      100.00
------------+-----------------------------------
      Total |      3,775      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,020 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(755 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(753 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,510
        from master                     1,510  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,265  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,510       40.00       40.00
            matched (3) |      2,265       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,775      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       755          0 |       755 
      1980 |         0        755 |       755 
      1990 |         0        755 |       755 
      2000 |         0        755 |       755 
      2007 |       755          0 |       755 
-----------+----------------------+----------
     Total |     1,510      2,265 |     3,775 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,510 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =      73.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9393

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8601679   .1006627    -8.55   0.000    -1.057463   -.6628726
       _cons |  -.4993203   .1285657    -3.88   0.000    -.7513044   -.2473361
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =     167.94
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0903
                                                  Root MSE        =     2.2728

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.037156   .0800327   -12.96   0.000    -1.194017   -.8802948
       _cons |  -1.151696   .1700397    -6.77   0.000    -1.484968   -.8184242
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,508
                                                  Wald chi2(2)    =     482.42
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1362
                                                  Root MSE        =     2.1256

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9899344   .0622748   -15.90   0.000    -1.111991   -.8678781
       y2000 |  -.8785049   .1199863    -7.32   0.000    -1.113674    -.643336
       _cons |  -.3608307   .1020256    -3.54   0.000    -.5607972   -.1608641
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 41, TIME IS 10:20:30 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    890,868      100.00      100.00
------------+-----------------------------------
      Total |    890,868      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    296,956       33.33       33.33
          3 |    593,912       66.67      100.00
------------+-----------------------------------
      Total |    890,868      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(296,956 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(296,956 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(296,956 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000019 not found)
file /tmp/St29163.000019 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        748       20.00       20.00
       1980 |        748       20.00       40.00
       1990 |        748       20.00       60.00
       2000 |        748       20.00       80.00
       2007 |        748       20.00      100.00
------------+-----------------------------------
      Total |      3,740      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,992 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(748 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(748 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,992 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(748 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(747 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,992 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(748 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,496
        from master                     1,496  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,244  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,496       40.00       40.00
            matched (3) |      2,244       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,740      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       748          0 |       748 
      1980 |         0        748 |       748 
      1990 |         0        748 |       748 
      2000 |         0        748 |       748 
      2007 |       748          0 |       748 
-----------+----------------------+----------
     Total |     1,496      2,244 |     3,740 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,496 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        747
                                                  Wald chi2(1)    =      73.09
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.915

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8739173   .1022237    -8.55   0.000    -1.074272   -.6735624
       _cons |  -.4822343   .1295018    -3.72   0.000    -.7360531   -.2284155
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        747
                                                  Wald chi2(1)    =     177.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1074
                                                  Root MSE        =     2.2483

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.060338   .0795566   -13.33   0.000    -1.216266   -.9044095
       _cons |  -1.116097   .1686523    -6.62   0.000    -1.446649   -.7855445
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,494
                                                  Wald chi2(2)    =     498.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1519
                                                  Root MSE        =     2.1012

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.011094   .0622198   -16.25   0.000    -1.133043   -.8891455
       y2000 |  -.8711435   .1191975    -7.31   0.000    -1.104766   -.6375207
       _cons |  -.3360856   .1015124    -3.31   0.001    -.5350463   -.1371249
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 42, TIME IS 10:21:02 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    908,733      100.00      100.00
------------+-----------------------------------
      Total |    908,733      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    302,911       33.33       33.33
          3 |    605,822       66.67      100.00
------------+-----------------------------------
      Total |    908,733      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(302,911 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(302,911 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(302,911 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001a not found)
file /tmp/St29163.00001a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        763       20.00       20.00
       1980 |        763       20.00       40.00
       1990 |        763       20.00       60.00
       2000 |        763       20.00       80.00
       2007 |        763       20.00      100.00
------------+-----------------------------------
      Total |      3,815      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,052 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(763 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(763 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,052 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(763 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(762 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,052 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(763 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,526
        from master                     1,526  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,289  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,526       40.00       40.00
            matched (3) |      2,289       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,815      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       763          0 |       763 
      1980 |         0        763 |       763 
      1990 |         0        763 |       763 
      2000 |         0        763 |       763 
      2007 |       763          0 |       763 
-----------+----------------------+----------
     Total |     1,526      2,289 |     3,815 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,526 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        762
                                                  Wald chi2(1)    =      75.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9225

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8598263    .099266    -8.66   0.000    -1.054384   -.6652685
       _cons |  -.4965439   .1268706    -3.91   0.000    -.7452057    -.247882
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        762
                                                  Wald chi2(1)    =     174.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1064
                                                  Root MSE        =     2.2362

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.011576   .0765703   -13.21   0.000    -1.161651   -.8615008
       _cons |   -1.20277   .1633361    -7.36   0.000    -1.522903   -.8826368
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,524
                                                  Wald chi2(2)    =     500.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1510
                                                  Root MSE        =     2.0964

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9711332   .0600386   -16.18   0.000    -1.088807   -.8534596
       y2000 |  -.9000483   .1172656    -7.68   0.000    -1.129885    -.670212
       _cons |  -.3776332   .0994072    -3.80   0.000    -.5724678   -.1827986
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 43, TIME IS 10:21:35 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    898,014      100.00      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,338       33.33       33.33
          3 |    598,676       66.67      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,338 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,338 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,338 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001b not found)
file /tmp/St29163.00001b saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        754       20.00       20.00
       1980 |        754       20.00       40.00
       1990 |        754       20.00       60.00
       2000 |        754       20.00       80.00
       2007 |        754       20.00      100.00
------------+-----------------------------------
      Total |      3,770      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,016 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(754 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(751 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,508
        from master                     1,508  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,262  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,508       40.00       40.00
            matched (3) |      2,262       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,770      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       754          0 |       754 
      1980 |         0        754 |       754 
      1990 |         0        754 |       754 
      2000 |         0        754 |       754 
      2007 |       754          0 |       754 
-----------+----------------------+----------
     Total |     1,508      2,262 |     3,770 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,508 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =      74.15
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8911

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8447081    .098096    -8.61   0.000    -1.036973   -.6524434
       _cons |  -.5123159   .1252448    -4.09   0.000    -.7577913   -.2668406
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =     176.94
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1171
                                                  Root MSE        =     2.2222

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.033152   .0776689   -13.30   0.000    -1.185381    -.880924
       _cons |  -1.166272   .1648165    -7.08   0.000    -1.489306   -.8432374
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,506
                                                  Wald chi2(2)    =     505.30
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1600
                                                  Root MSE        =     2.0771

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9829615   .0604999   -16.25   0.000    -1.101539   -.8643839
       y2000 |  -.8941114   .1170375    -7.64   0.000    -1.123501   -.6647222
       _cons |  -.3649244   .0994457    -3.67   0.000    -.5598343   -.1700145
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 44, TIME IS 10:22:09 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    901,587      100.00      100.00
------------+-----------------------------------
      Total |    901,587      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,529       33.33       33.33
          3 |    601,058       66.67      100.00
------------+-----------------------------------
      Total |    901,587      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,529 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,529 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,529 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001c not found)
file /tmp/St29163.00001c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        757       20.00       20.00
       1980 |        757       20.00       40.00
       1990 |        757       20.00       60.00
       2000 |        757       20.00       80.00
       2007 |        757       20.00      100.00
------------+-----------------------------------
      Total |      3,785      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,028 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(757 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,028 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(753 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,028 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,514
        from master                     1,514  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,271  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,514       40.00       40.00
            matched (3) |      2,271       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,785      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       757          0 |       757 
      1980 |         0        757 |       757 
      1990 |         0        757 |       757 
      2000 |         0        757 |       757 
      2007 |       757          0 |       757 
-----------+----------------------+----------
     Total |     1,514      2,271 |     3,785 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,514 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        756
                                                  Wald chi2(1)    =      72.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9383

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8547476   .1004718    -8.51   0.000    -1.051669   -.6578264
       _cons |  -.5065165   .1281785    -3.95   0.000    -.7577418   -.2552913
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        756
                                                  Wald chi2(1)    =     173.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0861
                                                  Root MSE        =     2.2705

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.050341   .0798383   -13.16   0.000    -1.206821   -.8938608
       _cons |  -1.134864    .169363    -6.70   0.000    -1.466809   -.8029185
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,512
                                                  Wald chi2(2)    =     488.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1300
                                                  Root MSE        =     2.1264

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9979599   .0621981   -16.04   0.000    -1.119866   -.8760538
       y2000 |  -.8779534   .1198151    -7.33   0.000    -1.112787   -.6431201
       _cons |  -.3539248   .1018477    -3.48   0.001    -.5535427   -.1543069
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 45, TIME IS 10:22:42 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    907,542      100.00      100.00
------------+-----------------------------------
      Total |    907,542      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    302,514       33.33       33.33
          3 |    605,028       66.67      100.00
------------+-----------------------------------
      Total |    907,542      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(302,514 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(302,514 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(302,514 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001d not found)
file /tmp/St29163.00001d saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        762       20.00       20.00
       1980 |        762       20.00       40.00
       1990 |        762       20.00       60.00
       2000 |        762       20.00       80.00
       2007 |        762       20.00      100.00
------------+-----------------------------------
      Total |      3,810      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,048 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(762 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(762 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,048 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(762 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(761 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,048 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(762 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,524
        from master                     1,524  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,286  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,524       40.00       40.00
            matched (3) |      2,286       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,810      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       762          0 |       762 
      1980 |         0        762 |       762 
      1990 |         0        762 |       762 
      2000 |         0        762 |       762 
      2007 |       762          0 |       762 
-----------+----------------------+----------
     Total |     1,524      2,286 |     3,810 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,524 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        761
                                                  Wald chi2(1)    =      74.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9292

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8751892    .101064    -8.66   0.000    -1.073271   -.6771074
       _cons |  -.4822405   .1282981    -3.76   0.000    -.7337001   -.2307809
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        761
                                                  Wald chi2(1)    =     172.79
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0876
                                                  Root MSE        =     2.2605

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.040015   .0791197   -13.14   0.000    -1.195086    -.884943
       _cons |  -1.148467   .1679478    -6.84   0.000    -1.477638   -.8192949
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,522
                                                  Wald chi2(2)    =     495.81
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1398
                                                  Root MSE        =     2.1124

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9962219   .0617441   -16.13   0.000    -1.117238   -.8752056
       y2000 |  -.8761865   .1187372    -7.38   0.000    -1.108907   -.6434658
       _cons |  -.3534243   .1009072    -3.50   0.000    -.5511989   -.1556497
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 46, TIME IS 10:23:15 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    896,823      100.00      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,941       33.33       33.33
          3 |    597,882       66.67      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,941 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,941 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,941 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001e not found)
file /tmp/St29163.00001e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        753       20.00       20.00
       1980 |        753       20.00       40.00
       1990 |        753       20.00       60.00
       2000 |        753       20.00       80.00
       2007 |        753       20.00      100.00
------------+-----------------------------------
      Total |      3,765      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,012 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(753 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(751 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,506
        from master                     1,506  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,259  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,506       40.00       40.00
            matched (3) |      2,259       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,765      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       753          0 |       753 
      1980 |         0        753 |       753 
      1990 |         0        753 |       753 
      2000 |         0        753 |       753 
      2007 |       753          0 |       753 
-----------+----------------------+----------
     Total |     1,506      2,259 |     3,765 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,506 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =      75.82
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9214

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8747895   .1004668    -8.71   0.000    -1.071701   -.6778781
       _cons |  -.4803495    .128173    -3.75   0.000     -.731564    -.229135
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =     171.94
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1115
                                                  Root MSE        =     2.2329

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.023764   .0780755   -13.11   0.000     -1.17679    -.870739
       _cons |  -1.182685   .1660049    -7.12   0.000    -1.508049   -.8573213
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,504
                                                  Wald chi2(2)    =     496.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1533
                                                  Root MSE        =     2.0946

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9843437   .0611598   -16.09   0.000    -1.104215   -.8644726
       y2000 |  -.8924104   .1181972    -7.55   0.000    -1.124073   -.6607481
       _cons |  -.3633152   .1005126    -3.61   0.000    -.5603163   -.1663142
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 47, TIME IS 10:23:48 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    899,205      100.00      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,735       33.33       33.33
          3 |    599,470       66.67      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,735 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,735 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,735 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001f not found)
file /tmp/St29163.00001f saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        755       20.00       20.00
       1980 |        755       20.00       40.00
       1990 |        755       20.00       60.00
       2000 |        755       20.00       80.00
       2007 |        755       20.00      100.00
------------+-----------------------------------
      Total |      3,775      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,020 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(755 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(754 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,510
        from master                     1,510  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,265  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,510       40.00       40.00
            matched (3) |      2,265       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,775      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       755          0 |       755 
      1980 |         0        755 |       755 
      1990 |         0        755 |       755 
      2000 |         0        755 |       755 
      2007 |       755          0 |       755 
-----------+----------------------+----------
     Total |     1,510      2,265 |     3,775 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,510 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =      74.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.921

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8677304   .1004518    -8.64   0.000    -1.064612   -.6708484
       _cons |  -.4916102   .1279469    -3.84   0.000    -.7423816   -.2408389
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =     172.80
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1078
                                                  Root MSE        =     2.2421

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.03999   .0791155   -13.15   0.000    -1.195053   -.8849262
       _cons |   -1.15192   .1677412    -6.87   0.000    -1.480687   -.8231534
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,508
                                                  Wald chi2(2)    =     495.12
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1512
                                                  Root MSE        =     2.1002

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9939696   .0617275   -16.10   0.000    -1.114953    -.872986
       y2000 |  -.8801694   .1185374    -7.43   0.000    -1.112499   -.6478404
       _cons |   -.356983   .1009117    -3.54   0.000    -.5547662   -.1591997
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 48, TIME IS 10:24:21 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    906,351      100.00      100.00
------------+-----------------------------------
      Total |    906,351      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    302,117       33.33       33.33
          3 |    604,234       66.67      100.00
------------+-----------------------------------
      Total |    906,351      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(302,117 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(302,117 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(302,117 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001g not found)
file /tmp/St29163.00001g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        761       20.00       20.00
       1980 |        761       20.00       40.00
       1990 |        761       20.00       60.00
       2000 |        761       20.00       80.00
       2007 |        761       20.00      100.00
------------+-----------------------------------
      Total |      3,805      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,044 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(761 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,044 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(759 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,044 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,522
        from master                     1,522  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,283  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,522       40.00       40.00
            matched (3) |      2,283       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,805      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       761          0 |       761 
      1980 |         0        761 |       761 
      1990 |         0        761 |       761 
      2000 |         0        761 |       761 
      2007 |       761          0 |       761 
-----------+----------------------+----------
     Total |     1,522      2,283 |     3,805 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,522 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        760
                                                  Wald chi2(1)    =      73.00
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9193

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8507629   .0995717    -8.54   0.000     -1.04592   -.6556059
       _cons |  -.5075712   .1268923    -4.00   0.000    -.7562757   -.2588668
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        760
                                                  Wald chi2(1)    =     173.28
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0922
                                                  Root MSE        =     2.2715

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.043097   .0792402   -13.16   0.000    -1.198405   -.8877889
       _cons |  -1.140677   .1685655    -6.77   0.000    -1.471059   -.8102943
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,520
                                                  Wald chi2(2)    =     494.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1441
                                                  Root MSE        =     2.1153

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9919362   .0615278   -16.12   0.000    -1.112528   -.8713438
       y2000 |  -.8784632   .1189106    -7.39   0.000    -1.111524   -.6454028
       _cons |  -.3571579   .1009204    -3.54   0.000    -.5549582   -.1593576
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 49, TIME IS 10:24:54 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    911,115      100.00      100.00
------------+-----------------------------------
      Total |    911,115      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    303,705       33.33       33.33
          3 |    607,410       66.67      100.00
------------+-----------------------------------
      Total |    911,115      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(303,705 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(303,705 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(303,705 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001h not found)
file /tmp/St29163.00001h saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        765       20.00       20.00
       1980 |        765       20.00       40.00
       1990 |        765       20.00       60.00
       2000 |        765       20.00       80.00
       2007 |        765       20.00      100.00
------------+-----------------------------------
      Total |      3,825      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,060 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(765 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(765 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,060 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(765 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(763 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,060 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(765 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,530
        from master                     1,530  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,295  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,530       40.00       40.00
            matched (3) |      2,295       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,825      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       765          0 |       765 
      1980 |         0        765 |       765 
      1990 |         0        765 |       765 
      2000 |         0        765 |       765 
      2007 |       765          0 |       765 
-----------+----------------------+----------
     Total |     1,530      2,295 |     3,825 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,530 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        764
                                                  Wald chi2(1)    =      75.82
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9203

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8708798   .1000127    -8.71   0.000    -1.066901   -.6748586
       _cons |  -.4848608   .1271228    -3.81   0.000     -.734017   -.2357047
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        764
                                                  Wald chi2(1)    =     173.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0900
                                                  Root MSE        =     2.2821

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.055328   .0801608   -13.17   0.000     -1.21244   -.8982153
       _cons |  -1.119452   .1699412    -6.59   0.000    -1.452531   -.7863732
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,528
                                                  Wald chi2(2)    =     497.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1401
                                                  Root MSE        =     2.1215

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.00593   .0620717   -16.21   0.000    -1.127588   -.8842712
       y2000 |  -.8698811   .1190722    -7.31   0.000    -1.103258   -.6365039
       _cons |  -.3411049   .1012766    -3.37   0.001    -.5396034   -.1426063
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 50, TIME IS 10:25:27 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    902,778      100.00      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,926       33.33       33.33
          3 |    601,852       66.67      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,926 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,926 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,926 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001i not found)
file /tmp/St29163.00001i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        758       20.00       20.00
       1980 |        758       20.00       40.00
       1990 |        758       20.00       60.00
       2000 |        758       20.00       80.00
       2007 |        758       20.00      100.00
------------+-----------------------------------
      Total |      3,790      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,032 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(758 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(757 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,516
        from master                     1,516  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,274  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,516       40.00       40.00
            matched (3) |      2,274       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,790      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       758          0 |       758 
      1980 |         0        758 |       758 
      1990 |         0        758 |       758 
      2000 |         0        758 |       758 
      2007 |       758          0 |       758 
-----------+----------------------+----------
     Total |     1,516      2,274 |     3,790 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,516 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =      75.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.925

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8777775   .1012895    -8.67   0.000    -1.076301   -.6792537
       _cons |   -.479878   .1284862    -3.73   0.000    -.7317063   -.2280497
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =     179.39
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1067
                                                  Root MSE        =     2.2306

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.048912   .0783151   -13.39   0.000    -1.202407   -.8954178
       _cons |  -1.133523   .1660543    -6.83   0.000    -1.458983   -.8080627
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,514
                                                  Wald chi2(2)    =     504.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1514
                                                  Root MSE        =     2.0954

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.00374   .0614767   -16.33   0.000    -1.124232   -.8832478
       y2000 |   -.871251   .1180627    -7.38   0.000     -1.10265   -.6398524
       _cons |  -.3458623   .1003916    -3.45   0.001    -.5426263   -.1490983
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 51, TIME IS 10:26:00 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    888,486      100.00      100.00
------------+-----------------------------------
      Total |    888,486      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    296,162       33.33       33.33
          3 |    592,324       66.67      100.00
------------+-----------------------------------
      Total |    888,486      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(296,162 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(296,162 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(296,162 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001j not found)
file /tmp/St29163.00001j saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        746       20.00       20.00
       1980 |        746       20.00       40.00
       1990 |        746       20.00       60.00
       2000 |        746       20.00       80.00
       2007 |        746       20.00      100.00
------------+-----------------------------------
      Total |      3,730      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,984 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(746 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(746 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,984 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(746 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(743 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,984 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(746 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,492
        from master                     1,492  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,238  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,492       40.00       40.00
            matched (3) |      2,238       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,730      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       746          0 |       746 
      1980 |         0        746 |       746 
      1990 |         0        746 |       746 
      2000 |         0        746 |       746 
      2007 |       746          0 |       746 
-----------+----------------------+----------
     Total |     1,492      2,238 |     3,730 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,492 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        745
                                                  Wald chi2(1)    =      74.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9126

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8672045   .1003307    -8.64   0.000    -1.063849   -.6705599
       _cons |  -.4908608   .1277954    -3.84   0.000    -.7413351   -.2403865
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        745
                                                  Wald chi2(1)    =     172.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0985
                                                  Root MSE        =      2.245

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.039025       .079   -13.15   0.000    -1.193862   -.8841877
       _cons |  -1.151008    .168172    -6.84   0.000    -1.480619   -.8213972
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,490
                                                  Wald chi2(2)    =     495.28
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1488
                                                  Root MSE        =     2.0972

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9934144   .0615734   -16.13   0.000    -1.114096   -.8727327
       y2000 |  -.8792746   .1190901    -7.38   0.000    -1.112687   -.6458623
       _cons |  -.3564223   .1010207    -3.53   0.000    -.5544193   -.1584253
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 52, TIME IS 10:26:33 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    896,823      100.00      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,941       33.33       33.33
          3 |    597,882       66.67      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,941 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,941 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,941 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001k not found)
file /tmp/St29163.00001k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        753       20.00       20.00
       1980 |        753       20.00       40.00
       1990 |        753       20.00       60.00
       2000 |        753       20.00       80.00
       2007 |        753       20.00      100.00
------------+-----------------------------------
      Total |      3,765      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,012 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(753 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(751 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,506
        from master                     1,506  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,259  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,506       40.00       40.00
            matched (3) |      2,259       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,765      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       753          0 |       753 
      1980 |         0        753 |       753 
      1990 |         0        753 |       753 
      2000 |         0        753 |       753 
      2007 |       753          0 |       753 
-----------+----------------------+----------
     Total |     1,506      2,259 |     3,765 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,506 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =      75.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9353

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.880452   .1013251    -8.69   0.000    -1.079045   -.6818584
       _cons |  -.4780335   .1290169    -3.71   0.000    -.7309021    -.225165
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =     173.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1032
                                                  Root MSE        =     2.2554

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.050392   .0796365   -13.19   0.000    -1.206477   -.8943078
       _cons |  -1.133587   .1689565    -6.71   0.000    -1.464736   -.8024386
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,504
                                                  Wald chi2(2)    =     494.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1496
                                                  Root MSE        =     2.1128

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.004711   .0621253   -16.17   0.000    -1.126474   -.8829477
       y2000 |  -.8726634   .1194342    -7.31   0.000     -1.10675   -.6385768
       _cons |  -.3455831   .1015934    -3.40   0.001    -.5447024   -.1464637
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 53, TIME IS 10:27:10 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    898,014      100.00      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,338       33.33       33.33
          3 |    598,676       66.67      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,338 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,338 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,338 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001l not found)
file /tmp/St29163.00001l saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        754       20.00       20.00
       1980 |        754       20.00       40.00
       1990 |        754       20.00       60.00
       2000 |        754       20.00       80.00
       2007 |        754       20.00      100.00
------------+-----------------------------------
      Total |      3,770      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,016 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(754 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(752 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,508
        from master                     1,508  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,262  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,508       40.00       40.00
            matched (3) |      2,262       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,770      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       754          0 |       754 
      1980 |         0        754 |       754 
      1990 |         0        754 |       754 
      2000 |         0        754 |       754 
      2007 |       754          0 |       754 
-----------+----------------------+----------
     Total |     1,508      2,262 |     3,770 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,508 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =      72.73
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.904

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8673778   .1017069    -8.53   0.000     -1.06672   -.6680361
       _cons |  -.4898434    .128629    -3.81   0.000    -.7419517   -.2377352
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =     173.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0953
                                                  Root MSE        =     2.2454

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.047268   .0794432   -13.18   0.000    -1.202974   -.8915626
       _cons |  -1.135943   .1686087    -6.74   0.000     -1.46641   -.8054764
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,506
                                                  Wald chi2(2)    =     498.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1487
                                                  Root MSE        =     2.0931

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9997189   .0619811   -16.13   0.000      -1.1212   -.8782381
       y2000 |  -.8752692   .1184862    -7.39   0.000    -1.107498   -.6430406
       _cons |  -.3489117   .1008707    -3.46   0.001    -.5466146   -.1512087
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 54, TIME IS 10:27:43 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    888,486      100.00      100.00
------------+-----------------------------------
      Total |    888,486      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    296,162       33.33       33.33
          3 |    592,324       66.67      100.00
------------+-----------------------------------
      Total |    888,486      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(296,162 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(296,162 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(296,162 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001m not found)
file /tmp/St29163.00001m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        746       20.00       20.00
       1980 |        746       20.00       40.00
       1990 |        746       20.00       60.00
       2000 |        746       20.00       80.00
       2007 |        746       20.00      100.00
------------+-----------------------------------
      Total |      3,730      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,984 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(746 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(746 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,984 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(746 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(744 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,984 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(746 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,492
        from master                     1,492  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,238  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,492       40.00       40.00
            matched (3) |      2,238       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,730      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       746          0 |       746 
      1980 |         0        746 |       746 
      1990 |         0        746 |       746 
      2000 |         0        746 |       746 
      2007 |       746          0 |       746 
-----------+----------------------+----------
     Total |     1,492      2,238 |     3,730 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,492 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        745
                                                  Wald chi2(1)    =      75.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9308

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8856614   .1019078    -8.69   0.000    -1.085397   -.6859258
       _cons |  -.4724303   .1295612    -3.65   0.000    -.7263657   -.2184949
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        745
                                                  Wald chi2(1)    =     173.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1027
                                                  Root MSE        =     2.2441

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.053406   .0800152   -13.17   0.000    -1.210233   -.8965794
       _cons |  -1.126944   .1695213    -6.65   0.000      -1.4592   -.7946889
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,490
                                                  Wald chi2(2)    =     492.84
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1483
                                                  Root MSE        =     2.1051

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.008195   .0624749   -16.14   0.000    -1.130644   -.8857467
       y2000 |  -.8687953   .1196588    -7.26   0.000    -1.103322   -.6342684
       _cons |  -.3419142   .1018662    -3.36   0.001    -.5415682   -.1422602
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 55, TIME IS 10:28:15 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    902,778      100.00      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,926       33.33       33.33
          3 |    601,852       66.67      100.00
------------+-----------------------------------
      Total |    902,778      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,926 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,926 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,926 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001n not found)
file /tmp/St29163.00001n saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        758       20.00       20.00
       1980 |        758       20.00       40.00
       1990 |        758       20.00       60.00
       2000 |        758       20.00       80.00
       2007 |        758       20.00      100.00
------------+-----------------------------------
      Total |      3,790      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,032 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(758 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(756 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,032 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(758 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,516
        from master                     1,516  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,274  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,516       40.00       40.00
            matched (3) |      2,274       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,790      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       758          0 |       758 
      1980 |         0        758 |       758 
      1990 |         0        758 |       758 
      2000 |         0        758 |       758 
      2007 |       758          0 |       758 
-----------+----------------------+----------
     Total |     1,516      2,274 |     3,790 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,516 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =      75.20
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8992

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8586241   .0990149    -8.67   0.000     -1.05269   -.6645584
       _cons |  -.5004797   .1260951    -3.97   0.000    -.7476216   -.2533379
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        757
                                                  Wald chi2(1)    =     170.17
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0865
                                                  Root MSE        =     2.2648

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.029562   .0789252   -13.04   0.000    -1.184252   -.8748713
       _cons |  -1.169177   .1680151    -6.96   0.000     -1.49848   -.8398735
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,514
                                                  Wald chi2(2)    =     496.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1435
                                                  Root MSE        =     2.1011

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9841618   .0611395   -16.10   0.000    -1.103993   -.8643306
       y2000 |  -.8867397   .1183079    -7.50   0.000    -1.118619   -.6548604
       _cons |  -.3666907   .1003857    -3.65   0.000     -.563443   -.1699383
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 56, TIME IS 10:28:49 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    901,587      100.00      100.00
------------+-----------------------------------
      Total |    901,587      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,529       33.33       33.33
          3 |    601,058       66.67      100.00
------------+-----------------------------------
      Total |    901,587      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,529 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,529 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,529 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001o not found)
file /tmp/St29163.00001o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        757       20.00       20.00
       1980 |        757       20.00       40.00
       1990 |        757       20.00       60.00
       2000 |        757       20.00       80.00
       2007 |        757       20.00      100.00
------------+-----------------------------------
      Total |      3,785      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,028 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(757 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,028 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(755 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,028 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(757 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,514
        from master                     1,514  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,271  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,514       40.00       40.00
            matched (3) |      2,271       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,785      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       757          0 |       757 
      1980 |         0        757 |       757 
      1990 |         0        757 |       757 
      2000 |         0        757 |       757 
      2007 |       757          0 |       757 
-----------+----------------------+----------
     Total |     1,514      2,271 |     3,785 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,514 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        756
                                                  Wald chi2(1)    =      73.73
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9211

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8655748   .1008024    -8.59   0.000    -1.063144   -.6680058
       _cons |  -.4967104   .1281559    -3.88   0.000    -.7478914   -.2455294
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        756
                                                  Wald chi2(1)    =     176.40
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0882
                                                  Root MSE        =     2.2695

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.046409   .0787863   -13.28   0.000    -1.200827   -.8919909
       _cons |  -1.140872   .1678806    -6.80   0.000    -1.469912   -.8118317
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,512
                                                  Wald chi2(2)    =     498.22
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1424
                                                  Root MSE        =     2.1139

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.998165   .0614079   -16.25   0.000    -1.118522   -.8778076
       y2000 |  -.8749926   .1190526    -7.35   0.000    -1.108331   -.6416538
       _cons |  -.3553965   .1009672    -3.52   0.000    -.5532886   -.1575045
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 57, TIME IS 10:29:23 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    905,160      100.00      100.00
------------+-----------------------------------
      Total |    905,160      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,720       33.33       33.33
          3 |    603,440       66.67      100.00
------------+-----------------------------------
      Total |    905,160      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,720 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,720 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,720 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001p not found)
file /tmp/St29163.00001p saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        760       20.00       20.00
       1980 |        760       20.00       40.00
       1990 |        760       20.00       60.00
       2000 |        760       20.00       80.00
       2007 |        760       20.00      100.00
------------+-----------------------------------
      Total |      3,800      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,040 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(760 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,040 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(760 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,040 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,520
        from master                     1,520  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,280  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,520       40.00       40.00
            matched (3) |      2,280       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,800      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       760          0 |       760 
      1980 |         0        760 |       760 
      1990 |         0        760 |       760 
      2000 |         0        760 |       760 
      2007 |       760          0 |       760 
-----------+----------------------+----------
     Total |     1,520      2,280 |     3,800 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,520 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        759
                                                  Wald chi2(1)    =      76.65
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9249

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8724956   .0996575    -8.75   0.000    -1.067821   -.6771705
       _cons |  -.4819322    .127455    -3.78   0.000    -.7317395    -.232125
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        759
                                                  Wald chi2(1)    =     170.40
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1042
                                                  Root MSE        =     2.2616

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.044141   .0799887   -13.05   0.000    -1.200916   -.8873657
       _cons |  -1.143761   .1693439    -6.75   0.000    -1.475669    -.811853
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,518
                                                  Wald chi2(2)    =     493.70
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1484
                                                  Root MSE        =     2.1125

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9978027   .0620242   -16.09   0.000    -1.119368   -.8762374
       y2000 |  -.8816668   .1187961    -7.42   0.000    -1.114503   -.6488307
       _cons |   -.347899   .1013963    -3.43   0.001     -.546632    -.149166
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 58, TIME IS 10:29:58 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    894,441      100.00      100.00
------------+-----------------------------------
      Total |    894,441      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,147       33.33       33.33
          3 |    596,294       66.67      100.00
------------+-----------------------------------
      Total |    894,441      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,147 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,147 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,147 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001q not found)
file /tmp/St29163.00001q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        751       20.00       20.00
       1980 |        751       20.00       40.00
       1990 |        751       20.00       60.00
       2000 |        751       20.00       80.00
       2007 |        751       20.00      100.00
------------+-----------------------------------
      Total |      3,755      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,004 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(751 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,004 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(748 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,004 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,502
        from master                     1,502  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,253  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,502       40.00       40.00
            matched (3) |      2,253       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,755      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       751          0 |       751 
      1980 |         0        751 |       751 
      1990 |         0        751 |       751 
      2000 |         0        751 |       751 
      2007 |       751          0 |       751 
-----------+----------------------+----------
     Total |     1,502      2,253 |     3,755 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,502 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        750
                                                  Wald chi2(1)    =      73.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9262

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8730787    .101926    -8.57   0.000     -1.07285   -.6733074
       _cons |  -.4888587   .1295099    -3.77   0.000    -.7426935    -.235024
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        750
                                                  Wald chi2(1)    =     175.26
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0903
                                                  Root MSE        =     2.2594

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.040964   .0786318   -13.24   0.000     -1.19508    -.886849
       _cons |  -1.150576   .1674796    -6.87   0.000     -1.47883   -.8223224
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,500
                                                  Wald chi2(2)    =     493.80
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1420
                                                  Root MSE        =     2.1107

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9965258   .0615734   -16.18   0.000    -1.117208   -.8758441
       y2000 |   -.875794    .119274    -7.34   0.000    -1.109567   -.6420212
       _cons |  -.3571519   .1012704    -3.53   0.000    -.5556382   -.1586655
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 59, TIME IS 10:30:33 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    900,396      100.00      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,132       33.33       33.33
          3 |    600,264       66.67      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,132 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,132 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,132 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001r not found)
file /tmp/St29163.00001r saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        756       20.00       20.00
       1980 |        756       20.00       40.00
       1990 |        756       20.00       60.00
       2000 |        756       20.00       80.00
       2007 |        756       20.00      100.00
------------+-----------------------------------
      Total |      3,780      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,024 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(756 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(754 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,512
        from master                     1,512  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,268  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,512       40.00       40.00
            matched (3) |      2,268       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,780      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       756          0 |       756 
      1980 |         0        756 |       756 
      1990 |         0        756 |       756 
      2000 |         0        756 |       756 
      2007 |       756          0 |       756 
-----------+----------------------+----------
     Total |     1,512      2,268 |     3,780 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,512 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =      77.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9288

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8886771   .1006448    -8.83   0.000    -1.085937   -.6914169
       _cons |  -.4704777   .1280776    -3.67   0.000    -.7215052   -.2194502
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =     171.87
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1102
                                                  Root MSE        =       2.25

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.041597     .07945   -13.11   0.000    -1.197316   -.8858774
       _cons |  -1.150249    .168259    -6.84   0.000    -1.480031   -.8204678
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,510
                                                  Wald chi2(2)    =     495.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1524
                                                  Root MSE        =     2.1068

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.001056   .0619556   -16.16   0.000    -1.122487   -.8796258
       y2000 |   -.874394   .1188592    -7.36   0.000    -1.107354   -.6414343
       _cons |  -.3508582    .101134    -3.47   0.001    -.5490772   -.1526392
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 60, TIME IS 10:31:07 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    900,396      100.00      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,132       33.33       33.33
          3 |    600,264       66.67      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,132 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,132 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,132 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001s not found)
file /tmp/St29163.00001s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        756       20.00       20.00
       1980 |        756       20.00       40.00
       1990 |        756       20.00       60.00
       2000 |        756       20.00       80.00
       2007 |        756       20.00      100.00
------------+-----------------------------------
      Total |      3,780      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,024 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(756 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(753 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,512
        from master                     1,512  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,268  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,512       40.00       40.00
            matched (3) |      2,268       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,780      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       756          0 |       756 
      1980 |         0        756 |       756 
      1990 |         0        756 |       756 
      2000 |         0        756 |       756 
      2007 |       756          0 |       756 
-----------+----------------------+----------
     Total |     1,512      2,268 |     3,780 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,512 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =      72.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8994

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8532852   .0998828    -8.54   0.000    -1.049052   -.6575186
       _cons |  -.5041342   .1269772    -3.97   0.000    -.7530049   -.2552636
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =     173.50
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1042
                                                  Root MSE        =      2.253

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.027193   .0779845   -13.17   0.000     -1.18004   -.8743462
       _cons |  -1.176017   .1661987    -7.08   0.000    -1.501761   -.8502737
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,510
                                                  Wald chi2(2)    =     499.18
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1544
                                                  Root MSE        =     2.0955

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9813762   .0608016   -16.14   0.000    -1.100545   -.8622074
       y2000 |  -.8934077    .117999    -7.57   0.000    -1.124682   -.6621338
       _cons |  -.3675427   .1000982    -3.67   0.000    -.5637316   -.1713539
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 61, TIME IS 10:31:41 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    890,868      100.00      100.00
------------+-----------------------------------
      Total |    890,868      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    296,956       33.33       33.33
          3 |    593,912       66.67      100.00
------------+-----------------------------------
      Total |    890,868      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(296,956 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(296,956 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(296,956 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001t not found)
file /tmp/St29163.00001t saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        748       20.00       20.00
       1980 |        748       20.00       40.00
       1990 |        748       20.00       60.00
       2000 |        748       20.00       80.00
       2007 |        748       20.00      100.00
------------+-----------------------------------
      Total |      3,740      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,992 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(748 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(748 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,992 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(748 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(744 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,992 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(748 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,496
        from master                     1,496  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,244  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,496       40.00       40.00
            matched (3) |      2,244       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,740      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       748          0 |       748 
      1980 |         0        748 |       748 
      1990 |         0        748 |       748 
      2000 |         0        748 |       748 
      2007 |       748          0 |       748 
-----------+----------------------+----------
     Total |     1,496      2,244 |     3,740 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,496 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        747
                                                  Wald chi2(1)    =      72.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9099

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8627741   .1014633    -8.50   0.000    -1.061639   -.6639097
       _cons |  -.4971293   .1285169    -3.87   0.000    -.7490177   -.2452409
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        747
                                                  Wald chi2(1)    =     176.22
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1026
                                                  Root MSE        =     2.2435

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.048842    .079011   -13.27   0.000    -1.203701   -.8939834
       _cons |  -1.135521   .1677043    -6.77   0.000    -1.464216   -.8068271
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,494
                                                  Wald chi2(2)    =     497.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1524
                                                  Root MSE        =     2.0955

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9992308   .0617269   -16.19   0.000    -1.120213   -.8782483
       y2000 |  -.8752775   .1188337    -7.37   0.000    -1.108187   -.6423677
       _cons |  -.3520705   .1009151    -3.49   0.000    -.5498605   -.1542805
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 62, TIME IS 10:32:15 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    892,059      100.00      100.00
------------+-----------------------------------
      Total |    892,059      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    297,353       33.33       33.33
          3 |    594,706       66.67      100.00
------------+-----------------------------------
      Total |    892,059      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(297,353 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(297,353 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(297,353 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001u not found)
file /tmp/St29163.00001u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        749       20.00       20.00
       1980 |        749       20.00       40.00
       1990 |        749       20.00       60.00
       2000 |        749       20.00       80.00
       2007 |        749       20.00      100.00
------------+-----------------------------------
      Total |      3,745      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,996 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(749 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(749 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,996 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(749 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(747 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,996 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(749 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,498
        from master                     1,498  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,247  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,498       40.00       40.00
            matched (3) |      2,247       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,745      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       749          0 |       749 
      1980 |         0        749 |       749 
      1990 |         0        749 |       749 
      2000 |         0        749 |       749 
      2007 |       749          0 |       749 
-----------+----------------------+----------
     Total |     1,498      2,247 |     3,745 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,498 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        748
                                                  Wald chi2(1)    =      73.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9238

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8593567   .1000455    -8.59   0.000    -1.055442   -.6632711
       _cons |  -.4977848   .1279402    -3.89   0.000     -.748543   -.2470267
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        748
                                                  Wald chi2(1)    =     174.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1125
                                                  Root MSE        =     2.2339

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.037561   .0785209   -13.21   0.000    -1.191459   -.8836624
       _cons |  -1.156058    .166717    -6.93   0.000    -1.482818   -.8292992
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,496
                                                  Wald chi2(2)    =     494.13
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1514
                                                  Root MSE        =     2.0984

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9893776   .0613746   -16.12   0.000     -1.10967   -.8690856
       y2000 |  -.8863455   .1186667    -7.47   0.000    -1.118928   -.6537631
       _cons |  -.3588972   .1009209    -3.56   0.000    -.5566985   -.1610959
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 63, TIME IS 10:32:49 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    896,823      100.00      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,941       33.33       33.33
          3 |    597,882       66.67      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,941 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,941 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,941 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001v not found)
file /tmp/St29163.00001v saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        753       20.00       20.00
       1980 |        753       20.00       40.00
       1990 |        753       20.00       60.00
       2000 |        753       20.00       80.00
       2007 |        753       20.00      100.00
------------+-----------------------------------
      Total |      3,765      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,012 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(753 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(753 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,506
        from master                     1,506  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,259  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,506       40.00       40.00
            matched (3) |      2,259       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,765      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       753          0 |       753 
      1980 |         0        753 |       753 
      1990 |         0        753 |       753 
      2000 |         0        753 |       753 
      2007 |       753          0 |       753 
-----------+----------------------+----------
     Total |     1,506      2,259 |     3,765 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,506 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =      73.59
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9113

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8640829   .1007283    -8.58   0.000    -1.061507    -.666659
       _cons |  -.4909295   .1278562    -3.84   0.000    -.7415231   -.2403359
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =     174.19
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0929
                                                  Root MSE        =     2.2641

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.042618   .0789984   -13.20   0.000    -1.197452    -.887784
       _cons |  -1.142682   .1680968    -6.80   0.000    -1.472146   -.8132182
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,504
                                                  Wald chi2(2)    =     496.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1477
                                                  Root MSE        =     2.1065

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.995585   .0615333   -16.18   0.000    -1.116188   -.8749819
       y2000 |  -.8788657   .1190007    -7.39   0.000    -1.112103   -.6456287
       _cons |  -.3509919   .1009389    -3.48   0.001    -.5488286   -.1531552
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 64, TIME IS 10:33:23 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    903,969      100.00      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,323       33.33       33.33
          3 |    602,646       66.67      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,323 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,323 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,323 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001w not found)
file /tmp/St29163.00001w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        759       20.00       20.00
       1980 |        759       20.00       40.00
       1990 |        759       20.00       60.00
       2000 |        759       20.00       80.00
       2007 |        759       20.00      100.00
------------+-----------------------------------
      Total |      3,795      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,036 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(759 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(756 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,518
        from master                     1,518  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,277  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,518       40.00       40.00
            matched (3) |      2,277       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,795      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       759          0 |       759 
      1980 |         0        759 |       759 
      1990 |         0        759 |       759 
      2000 |         0        759 |       759 
      2007 |       759          0 |       759 
-----------+----------------------+----------
     Total |     1,518      2,277 |     3,795 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,518 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =      74.04
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9202

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8605724   .1000133    -8.60   0.000    -1.056595     -.66455
       _cons |  -.4986023   .1274738    -3.91   0.000    -.7484464   -.2487582
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =     175.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1152
                                                  Root MSE        =     2.2251

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.021092   .0771638   -13.23   0.000    -1.172331   -.8698539
       _cons |  -1.183651   .1643141    -7.20   0.000      -1.5057   -.8616009
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,516
                                                  Wald chi2(2)    =     499.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1538
                                                  Root MSE        =     2.0909

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9786727   .0606168   -16.15   0.000    -1.097479    -.859866
       y2000 |  -.8896947   .1175257    -7.57   0.000    -1.120041   -.6593485
       _cons |  -.3726027   .0997508    -3.74   0.000    -.5681106   -.1770948
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 65, TIME IS 10:34:01 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    898,014      100.00      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,338       33.33       33.33
          3 |    598,676       66.67      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,338 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,338 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,338 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00001x not found)
file /tmp/St29163.00001x saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        754       20.00       20.00
       1980 |        754       20.00       40.00
       1990 |        754       20.00       60.00
       2000 |        754       20.00       80.00
       2007 |        754       20.00      100.00
------------+-----------------------------------
      Total |      3,770      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,016 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(754 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(752 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,508
        from master                     1,508  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,262  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,508       40.00       40.00
            matched (3) |      2,262       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,770      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       754          0 |       754 
      1980 |         0        754 |       754 
      1990 |         0        754 |       754 
      2000 |         0        754 |       754 
      2007 |       754          0 |       754 
-----------+----------------------+----------
     Total |     1,508      2,262 |     3,770 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,508 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =      70.43
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9098

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.830785   .0989952    -8.39   0.000    -1.024812    -.636758
       _cons |  -.5352228   .1263536    -4.24   0.000    -.7828714   -.2875742
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =     172.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1019
                                                  Root MSE        =     2.2576

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.043489   .0793384   -13.15   0.000    -1.198989   -.8879885
       _cons |  -1.142226    .168503    -6.78   0.000    -1.472486    -.811966
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,506
                                                  Wald chi2(2)    =     489.70
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1484
                                                  Root MSE        =     2.1056

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9866283   .0615679   -16.03   0.000    -1.107299   -.8659575
       y2000 |  -.8784134   .1188723    -7.39   0.000    -1.111399    -.645428
       _cons |  -.3692028   .1009441    -3.66   0.000    -.5670496    -.171356
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 66, TIME IS 10:34:34 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    895,632      100.00      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,544       33.33       33.33
          3 |    597,088       66.67      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,544 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,544 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,544 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000020 not found)
file /tmp/St29163.000020 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        752       20.00       20.00
       1980 |        752       20.00       40.00
       1990 |        752       20.00       60.00
       2000 |        752       20.00       80.00
       2007 |        752       20.00      100.00
------------+-----------------------------------
      Total |      3,760      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,008 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(752 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(751 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,504
        from master                     1,504  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,256  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,504       40.00       40.00
            matched (3) |      2,256       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,760      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       752          0 |       752 
      1980 |         0        752 |       752 
      1990 |         0        752 |       752 
      2000 |         0        752 |       752 
      2007 |       752          0 |       752 
-----------+----------------------+----------
     Total |     1,504      2,256 |     3,760 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,504 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =      73.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9323

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8645894   .1005829    -8.60   0.000    -1.061728   -.6674505
       _cons |  -.4904488   .1283908    -3.82   0.000    -.7420902   -.2388074
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =     171.83
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1085
                                                  Root MSE        =     2.2482

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.034424   .0789128   -13.11   0.000     -1.18909    -.879758
       _cons |  -1.163109   .1674912    -6.94   0.000    -1.491386   -.8348328
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,502
                                                  Wald chi2(2)    =     491.18
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1506
                                                  Root MSE        =     2.1088

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9892211   .0616778   -16.04   0.000    -1.110107   -.8683349
       y2000 |  -.8892566   .1190778    -7.47   0.000    -1.122645   -.6558684
       _cons |   -.357499   .1012441    -3.53   0.000    -.5559339   -.1590642
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 67, TIME IS 10:35:07 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    895,632      100.00      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,544       33.33       33.33
          3 |    597,088       66.67      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,544 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,544 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,544 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000021 not found)
file /tmp/St29163.000021 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        752       20.00       20.00
       1980 |        752       20.00       40.00
       1990 |        752       20.00       60.00
       2000 |        752       20.00       80.00
       2007 |        752       20.00      100.00
------------+-----------------------------------
      Total |      3,760      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,008 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(752 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(751 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,504
        from master                     1,504  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,256  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,504       40.00       40.00
            matched (3) |      2,256       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,760      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       752          0 |       752 
      1980 |         0        752 |       752 
      1990 |         0        752 |       752 
      2000 |         0        752 |       752 
      2007 |       752          0 |       752 
-----------+----------------------+----------
     Total |     1,504      2,256 |     3,760 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,504 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =      74.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9001

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8563791   .0991976    -8.63   0.000    -1.050803   -.6619553
       _cons |    -.50233   .1264172    -3.97   0.000    -.7501031   -.2545568
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =     176.88
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0900
                                                  Root MSE        =     2.2619

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.057364   .0795027   -13.30   0.000    -1.213187   -.9015419
       _cons |  -1.116237   .1689623    -6.61   0.000    -1.447397   -.7850773
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,502
                                                  Wald chi2(2)    =     500.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1444
                                                  Root MSE        =     2.1018

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.003707   .0615691   -16.30   0.000     -1.12438   -.8830341
       y2000 |   -.870403   .1188426    -7.32   0.000     -1.10333   -.6374757
       _cons |  -.3453364   .1009302    -3.42   0.001    -.5431561   -.1475168
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 68, TIME IS 10:35:40 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    903,969      100.00      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,323       33.33       33.33
          3 |    602,646       66.67      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,323 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,323 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,323 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000022 not found)
file /tmp/St29163.000022 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        759       20.00       20.00
       1980 |        759       20.00       40.00
       1990 |        759       20.00       60.00
       2000 |        759       20.00       80.00
       2007 |        759       20.00      100.00
------------+-----------------------------------
      Total |      3,795      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,036 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(759 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(755 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,518
        from master                     1,518  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,277  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,518       40.00       40.00
            matched (3) |      2,277       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,795      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       759          0 |       759 
      1980 |         0        759 |       759 
      1990 |         0        759 |       759 
      2000 |         0        759 |       759 
      2007 |       759          0 |       759 
-----------+----------------------+----------
     Total |     1,518      2,277 |     3,795 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,518 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =      74.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9145

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8673299   .1004492    -8.63   0.000    -1.064207    -.670453
       _cons |   -.493361   .1275057    -3.87   0.000    -.7432676   -.2434545
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =     178.04
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0895
                                                  Root MSE        =     2.2678

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.056762   .0791986   -13.34   0.000    -1.211988   -.9015352
       _cons |  -1.118476   .1683851    -6.64   0.000    -1.448505   -.7884473
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,516
                                                  Wald chi2(2)    =     501.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1433
                                                  Root MSE        =     2.1105

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.006183   .0615878   -16.34   0.000    -1.126892   -.8854727
       y2000 |  -.8666405   .1188384    -7.29   0.000    -1.099559   -.6337216
       _cons |  -.3456276   .1008474    -3.43   0.001    -.5432848   -.1479704
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 69, TIME IS 10:36:14 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    912,306      100.00      100.00
------------+-----------------------------------
      Total |    912,306      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    304,102       33.33       33.33
          3 |    608,204       66.67      100.00
------------+-----------------------------------
      Total |    912,306      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(304,102 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(304,102 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(304,102 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000023 not found)
file /tmp/St29163.000023 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        766       20.00       20.00
       1980 |        766       20.00       40.00
       1990 |        766       20.00       60.00
       2000 |        766       20.00       80.00
       2007 |        766       20.00      100.00
------------+-----------------------------------
      Total |      3,830      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,064 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(766 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(766 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,064 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(766 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(764 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,064 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(766 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,532
        from master                     1,532  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,298  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,532       40.00       40.00
            matched (3) |      2,298       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,830      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       766          0 |       766 
      1980 |         0        766 |       766 
      1990 |         0        766 |       766 
      2000 |         0        766 |       766 
      2007 |       766          0 |       766 
-----------+----------------------+----------
     Total |     1,532      2,298 |     3,830 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,532 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        765
                                                  Wald chi2(1)    =      76.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9353

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.877147     .10016    -8.76   0.000    -1.073457    -.680837
       _cons |  -.4774609   .1277125    -3.74   0.000    -.7277727    -.227149
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        765
                                                  Wald chi2(1)    =     173.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1115
                                                  Root MSE        =     2.2372

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.010996   .0766747   -13.19   0.000    -1.161275   -.8607159
       _cons |  -1.208444   .1632479    -7.40   0.000    -1.528404    -.888484
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,530
                                                  Wald chi2(2)    =     501.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1493
                                                  Root MSE        =     2.1026

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9757688   .0603287   -16.17   0.000    -1.094011   -.8575267
       y2000 |  -.9013296   .1174209    -7.68   0.000     -1.13147   -.6711889
       _cons |  -.3722622   .0996001    -3.74   0.000    -.5674748   -.1770496
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 70, TIME IS 10:36:48 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    898,014      100.00      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,338       33.33       33.33
          3 |    598,676       66.67      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,338 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,338 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,338 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000024 not found)
file /tmp/St29163.000024 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        754       20.00       20.00
       1980 |        754       20.00       40.00
       1990 |        754       20.00       60.00
       2000 |        754       20.00       80.00
       2007 |        754       20.00      100.00
------------+-----------------------------------
      Total |      3,770      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,016 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(754 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(751 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,508
        from master                     1,508  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,262  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,508       40.00       40.00
            matched (3) |      2,262       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,770      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       754          0 |       754 
      1980 |         0        754 |       754 
      1990 |         0        754 |       754 
      2000 |         0        754 |       754 
      2007 |       754          0 |       754 
-----------+----------------------+----------
     Total |     1,508      2,262 |     3,770 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,508 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =      75.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9318

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8670694    .100016    -8.67   0.000    -1.063097   -.6710417
       _cons |  -.4930631   .1278384    -3.86   0.000    -.7436218   -.2425044
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =     172.82
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1094
                                                  Root MSE        =     2.2447

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.024368   .0779211   -13.15   0.000     -1.17709   -.8716453
       _cons |   -1.18287   .1659855    -7.13   0.000    -1.508196   -.8575445
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,506
                                                  Wald chi2(2)    =     494.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1513
                                                  Root MSE        =     2.1059

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.982637   .0610036   -16.11   0.000    -1.102202   -.8630722
       y2000 |  -.8904579   .1186667    -7.50   0.000     -1.12304   -.6578755
       _cons |  -.3697617   .1006266    -3.67   0.000    -.5669863   -.1725371
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 71, TIME IS 10:37:21 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    893,250      100.00      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    297,750       33.33       33.33
          3 |    595,500       66.67      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(297,750 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(297,750 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(297,750 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000025 not found)
file /tmp/St29163.000025 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        750       20.00       20.00
       1980 |        750       20.00       40.00
       1990 |        750       20.00       60.00
       2000 |        750       20.00       80.00
       2007 |        750       20.00      100.00
------------+-----------------------------------
      Total |      3,750      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,000 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(750 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(746 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,500
        from master                     1,500  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,250  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,500       40.00       40.00
            matched (3) |      2,250       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,750      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       750          0 |       750 
      1980 |         0        750 |       750 
      1990 |         0        750 |       750 
      2000 |         0        750 |       750 
      2007 |       750          0 |       750 
-----------+----------------------+----------
     Total |     1,500      2,250 |     3,750 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,500 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =      75.42
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9112

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8701804   .1002024    -8.68   0.000    -1.066574   -.6737873
       _cons |  -.4878354   .1275676    -3.82   0.000    -.7378632   -.2378076
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =     177.76
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1026
                                                  Root MSE        =     2.2484

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.049224   .0786963   -13.33   0.000    -1.203466   -.8949826
       _cons |  -1.133855   .1672184    -6.78   0.000    -1.461597   -.8061129
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,498
                                                  Wald chi2(2)    =     500.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1482
                                                  Root MSE        =     2.0997

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.001724    .061389   -16.32   0.000    -1.122045   -.8814042
       y2000 |  -.8740758   .1187316    -7.36   0.000    -1.106785   -.6413661
       _cons |  -.3476895   .1008167    -3.45   0.001    -.5452865   -.1500924
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 72, TIME IS 10:37:54 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    903,969      100.00      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,323       33.33       33.33
          3 |    602,646       66.67      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,323 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,323 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,323 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000026 not found)
file /tmp/St29163.000026 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        759       20.00       20.00
       1980 |        759       20.00       40.00
       1990 |        759       20.00       60.00
       2000 |        759       20.00       80.00
       2007 |        759       20.00      100.00
------------+-----------------------------------
      Total |      3,795      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,036 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(759 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(759 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,518
        from master                     1,518  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,277  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,518       40.00       40.00
            matched (3) |      2,277       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,795      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       759          0 |       759 
      1980 |         0        759 |       759 
      1990 |         0        759 |       759 
      2000 |         0        759 |       759 
      2007 |       759          0 |       759 
-----------+----------------------+----------
     Total |     1,518      2,277 |     3,795 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,518 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =      73.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.926

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8534887   .0998214    -8.55   0.000    -1.049135   -.6578423
       _cons |  -.5058712   .1273248    -3.97   0.000    -.7554232   -.2563192
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =     172.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1012
                                                  Root MSE        =     2.2617

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.044363   .0794745   -13.14   0.000     -1.20013   -.8885955
       _cons |  -1.145082   .1682647    -6.81   0.000    -1.474875   -.8152891
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,516
                                                  Wald chi2(2)    =     491.38
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1443
                                                  Root MSE        =     2.1149

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9929042   .0618046   -16.07   0.000    -1.114039   -.8717695
       y2000 |  -.8828764   .1189029    -7.43   0.000    -1.115922   -.6498311
       _cons |  -.3572877   .1011915    -3.53   0.000    -.5556195    -.158956
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 73, TIME IS 10:38:27 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    898,014      100.00      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,338       33.33       33.33
          3 |    598,676       66.67      100.00
------------+-----------------------------------
      Total |    898,014      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,338 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,338 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,338 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000027 not found)
file /tmp/St29163.000027 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        754       20.00       20.00
       1980 |        754       20.00       40.00
       1990 |        754       20.00       60.00
       2000 |        754       20.00       80.00
       2007 |        754       20.00      100.00
------------+-----------------------------------
      Total |      3,770      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,016 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(754 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(752 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,016 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(754 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,508
        from master                     1,508  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,262  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,508       40.00       40.00
            matched (3) |      2,262       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,770      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       754          0 |       754 
      1980 |         0        754 |       754 
      1990 |         0        754 |       754 
      2000 |         0        754 |       754 
      2007 |       754          0 |       754 
-----------+----------------------+----------
     Total |     1,508      2,262 |     3,770 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,508 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =      74.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9175

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8713709   .1012188    -8.61   0.000    -1.069756   -.6729857
       _cons |  -.4879112   .1283249    -3.80   0.000    -.7394233    -.236399
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        753
                                                  Wald chi2(1)    =     178.76
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1037
                                                  Root MSE        =     2.2446

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.048068   .0783888   -13.37   0.000    -1.201707   -.8944288
       _cons |  -1.142017    .166459    -6.86   0.000    -1.468271   -.8157632
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,506
                                                  Wald chi2(2)    =     503.12
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1519
                                                  Root MSE        =     2.0996

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.001517   .0613948   -16.31   0.000    -1.121848   -.8811854
       y2000 |  -.8785893   .1184811    -7.42   0.000    -1.110808   -.6463706
       _cons |  -.3495208   .1005798    -3.48   0.001    -.5466535    -.152388
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 74, TIME IS 10:38:59 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    899,205      100.00      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,735       33.33       33.33
          3 |    599,470       66.67      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,735 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,735 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,735 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000028 not found)
file /tmp/St29163.000028 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        755       20.00       20.00
       1980 |        755       20.00       40.00
       1990 |        755       20.00       60.00
       2000 |        755       20.00       80.00
       2007 |        755       20.00      100.00
------------+-----------------------------------
      Total |      3,775      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,020 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(755 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(754 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,510
        from master                     1,510  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,265  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,510       40.00       40.00
            matched (3) |      2,265       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,775      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       755          0 |       755 
      1980 |         0        755 |       755 
      1990 |         0        755 |       755 
      2000 |         0        755 |       755 
      2007 |       755          0 |       755 
-----------+----------------------+----------
     Total |     1,510      2,265 |     3,775 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,510 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =      74.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9104

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.846322   .0980254    -8.63   0.000    -1.038448   -.6541959
       _cons |  -.5146527   .1256855    -4.09   0.000    -.7609918   -.2683137
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =     172.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1032
                                                  Root MSE        =     2.2552

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.043161   .0793818   -13.14   0.000    -1.198746   -.8875751
       _cons |  -1.149437   .1684697    -6.82   0.000    -1.479632   -.8192424
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,508
                                                  Wald chi2(2)    =     495.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1509
                                                  Root MSE        =     2.1037

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9901345   .0614211   -16.12   0.000    -1.110518   -.8697514
       y2000 |   -.886606   .1185964    -7.48   0.000    -1.119051   -.6541613
       _cons |  -.3610877   .1008525    -3.58   0.000     -.558755   -.1634204
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 75, TIME IS 10:39:33 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    895,632      100.00      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,544       33.33       33.33
          3 |    597,088       66.67      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,544 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,544 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,544 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000029 not found)
file /tmp/St29163.000029 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        752       20.00       20.00
       1980 |        752       20.00       40.00
       1990 |        752       20.00       60.00
       2000 |        752       20.00       80.00
       2007 |        752       20.00      100.00
------------+-----------------------------------
      Total |      3,760      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,008 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(752 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(749 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,504
        from master                     1,504  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,256  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,504       40.00       40.00
            matched (3) |      2,256       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,760      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       752          0 |       752 
      1980 |         0        752 |       752 
      1990 |         0        752 |       752 
      2000 |         0        752 |       752 
      2007 |       752          0 |       752 
-----------+----------------------+----------
     Total |     1,504      2,256 |     3,760 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,504 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =      72.41
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9176

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8510277   .1000137    -8.51   0.000    -1.047051   -.6550045
       _cons |  -.5098557   .1275208    -4.00   0.000    -.7597919   -.2599196
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =     174.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0984
                                                  Root MSE        =     2.2487

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.038522    .078614   -13.21   0.000    -1.192602   -.8844413
       _cons |  -1.147829   .1672732    -6.86   0.000    -1.475679   -.8199794
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,502
                                                  Wald chi2(2)    =     493.22
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1482
                                                  Root MSE        =     2.1019

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9880118   .0612717   -16.13   0.000    -1.108102   -.8679214
       y2000 |  -.8776431   .1187343    -7.39   0.000    -1.110358   -.6449283
       _cons |  -.3638398   .1007385    -3.61   0.000    -.5612837    -.166396
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 76, TIME IS 10:40:06 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    899,205      100.00      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,735       33.33       33.33
          3 |    599,470       66.67      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,735 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,735 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,735 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002a not found)
file /tmp/St29163.00002a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        755       20.00       20.00
       1980 |        755       20.00       40.00
       1990 |        755       20.00       60.00
       2000 |        755       20.00       80.00
       2007 |        755       20.00      100.00
------------+-----------------------------------
      Total |      3,775      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,020 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(755 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(754 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,510
        from master                     1,510  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,265  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,510       40.00       40.00
            matched (3) |      2,265       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,775      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       755          0 |       755 
      1980 |         0        755 |       755 
      1990 |         0        755 |       755 
      2000 |         0        755 |       755 
      2007 |       755          0 |       755 
-----------+----------------------+----------
     Total |     1,510      2,265 |     3,775 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,510 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =      74.28
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9096

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8503452   .0986615    -8.62   0.000    -1.043718   -.6569723
       _cons |  -.5103391   .1260463    -4.05   0.000    -.7573854   -.2632928
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =     172.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0891
                                                  Root MSE        =     2.2837

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.055109   .0803279   -13.14   0.000    -1.212549   -.8976691
       _cons |   -1.12343   .1705469    -6.59   0.000    -1.457696    -.789164
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,508
                                                  Wald chi2(2)    =     493.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1439
                                                  Root MSE        =     2.1176

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9998247   .0618814   -16.16   0.000     -1.12111   -.8785395
       y2000 |  -.8748361   .1194701    -7.32   0.000    -1.108993   -.6406789
       _cons |  -.3510671   .1014639    -3.46   0.001    -.5499327   -.1522015
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 77, TIME IS 10:40:39 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    893,250      100.00      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    297,750       33.33       33.33
          3 |    595,500       66.67      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(297,750 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(297,750 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(297,750 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002b not found)
file /tmp/St29163.00002b saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        750       20.00       20.00
       1980 |        750       20.00       40.00
       1990 |        750       20.00       60.00
       2000 |        750       20.00       80.00
       2007 |        750       20.00      100.00
------------+-----------------------------------
      Total |      3,750      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,000 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(750 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(747 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,500
        from master                     1,500  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,250  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,500       40.00       40.00
            matched (3) |      2,250       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,750      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       750          0 |       750 
      1980 |         0        750 |       750 
      1990 |         0        750 |       750 
      2000 |         0        750 |       750 
      2007 |       750          0 |       750 
-----------+----------------------+----------
     Total |     1,500      2,250 |     3,750 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,500 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =      73.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8908

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8498827   .0989467    -8.59   0.000    -1.043815   -.6559508
       _cons |  -.5061842   .1260323    -4.02   0.000    -.7532029   -.2591655
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =     176.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1183
                                                  Root MSE        =     2.2264

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.035335   .0780363   -13.27   0.000    -1.188283   -.8823863
       _cons |   -1.15953   .1657685    -6.99   0.000     -1.48443   -.8346298
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,498
                                                  Wald chi2(2)    =     502.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1601
                                                  Root MSE        =     2.0792

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9860008   .0608177   -16.21   0.000    -1.105201   -.8668004
       y2000 |  -.8896625   .1175825    -7.57   0.000     -1.12012    -.659205
       _cons |  -.3611775   .0998459    -3.62   0.000    -.5568719   -.1654831
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 78, TIME IS 10:41:11 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    900,396      100.00      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,132       33.33       33.33
          3 |    600,264       66.67      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,132 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,132 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,132 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002c not found)
file /tmp/St29163.00002c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        756       20.00       20.00
       1980 |        756       20.00       40.00
       1990 |        756       20.00       60.00
       2000 |        756       20.00       80.00
       2007 |        756       20.00      100.00
------------+-----------------------------------
      Total |      3,780      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,024 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(756 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(754 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,512
        from master                     1,512  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,268  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,512       40.00       40.00
            matched (3) |      2,268       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,780      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       756          0 |       756 
      1980 |         0        756 |       756 
      1990 |         0        756 |       756 
      2000 |         0        756 |       756 
      2007 |       756          0 |       756 
-----------+----------------------+----------
     Total |     1,512      2,268 |     3,780 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,512 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =      75.17
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9219

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8785741   .1013344    -8.67   0.000    -1.077186   -.6799622
       _cons |  -.4829809   .1286481    -3.75   0.000    -.7351265   -.2308353
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =     173.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1086
                                                  Root MSE        =     2.2523

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.03303   .0784182   -13.17   0.000    -1.186727   -.8793332
       _cons |  -1.168507   .1667651    -7.01   0.000     -1.49536   -.8416532
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,510
                                                  Wald chi2(2)    =     496.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1533
                                                  Root MSE        =     2.1046

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9921071   .0613624   -16.17   0.000    -1.112375   -.8718391
       y2000 |   -.882283   .1185854    -7.44   0.000    -1.114706   -.6498599
       _cons |  -.3620121   .1007046    -3.59   0.000    -.5593896   -.1646347
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 79, TIME IS 10:41:45 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    914,688      100.00      100.00
------------+-----------------------------------
      Total |    914,688      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    304,896       33.33       33.33
          3 |    609,792       66.67      100.00
------------+-----------------------------------
      Total |    914,688      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(304,896 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(304,896 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(304,896 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002d not found)
file /tmp/St29163.00002d saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        768       20.00       20.00
       1980 |        768       20.00       40.00
       1990 |        768       20.00       60.00
       2000 |        768       20.00       80.00
       2007 |        768       20.00      100.00
------------+-----------------------------------
      Total |      3,840      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,072 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(768 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(768 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,072 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(768 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(764 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,072 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(768 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,536
        from master                     1,536  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,304  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,536       40.00       40.00
            matched (3) |      2,304       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,840      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       768          0 |       768 
      1980 |         0        768 |       768 
      1990 |         0        768 |       768 
      2000 |         0        768 |       768 
      2007 |       768          0 |       768 
-----------+----------------------+----------
     Total |     1,536      2,304 |     3,840 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,536 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        767
                                                  Wald chi2(1)    =      73.85
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.925

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8621246    .100325    -8.59   0.000    -1.058758   -.6654912
       _cons |  -.4973019   .1274114    -3.90   0.000    -.7470237   -.2475802
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        767
                                                  Wald chi2(1)    =     177.17
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1034
                                                  Root MSE        =     2.2604

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.037772   .0779673   -13.31   0.000    -1.190585   -.8849593
       _cons |  -1.158349   .1656389    -6.99   0.000    -1.482995   -.8337029
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,534
                                                  Wald chi2(2)    =     501.83
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1501
                                                  Root MSE        =     2.1118

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9915925   .0609913   -16.26   0.000    -1.111133   -.8720517
       y2000 |  -.8842167   .1179706    -7.50   0.000    -1.115435   -.6529985
       _cons |  -.3595029   .1001424    -3.59   0.000    -.5557784   -.1632274
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 80, TIME IS 10:42:18 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    906,351      100.00      100.00
------------+-----------------------------------
      Total |    906,351      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    302,117       33.33       33.33
          3 |    604,234       66.67      100.00
------------+-----------------------------------
      Total |    906,351      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(302,117 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(302,117 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(302,117 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002e not found)
file /tmp/St29163.00002e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        761       20.00       20.00
       1980 |        761       20.00       40.00
       1990 |        761       20.00       60.00
       2000 |        761       20.00       80.00
       2007 |        761       20.00      100.00
------------+-----------------------------------
      Total |      3,805      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,044 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(761 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,044 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(758 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,044 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,522
        from master                     1,522  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,283  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,522       40.00       40.00
            matched (3) |      2,283       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,805      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       761          0 |       761 
      1980 |         0        761 |       761 
      1990 |         0        761 |       761 
      2000 |         0        761 |       761 
      2007 |       761          0 |       761 
-----------+----------------------+----------
     Total |     1,522      2,283 |     3,805 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,522 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        760
                                                  Wald chi2(1)    =      73.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9313

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8546716   .0994055    -8.60   0.000    -1.049503   -.6598403
       _cons |  -.5051524   .1270653    -3.98   0.000    -.7541958    -.256109
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        760
                                                  Wald chi2(1)    =     170.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0887
                                                  Root MSE        =     2.2857

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.048413    .080176   -13.08   0.000    -1.205555   -.8912704
       _cons |  -1.133747   .1703031    -6.66   0.000    -1.467535   -.7999588
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,520
                                                  Wald chi2(2)    =     488.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1342
                                                  Root MSE        =     2.1307

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9967078   .0621201   -16.04   0.000    -1.118461   -.8749547
       y2000 |   -.875997   .1197877    -7.31   0.000    -1.110777   -.6412175
       _cons |  -.3536827   .1017938    -3.47   0.001    -.5531949   -.1541704
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 81, TIME IS 10:42:51 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    886,104      100.00      100.00
------------+-----------------------------------
      Total |    886,104      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    295,368       33.33       33.33
          3 |    590,736       66.67      100.00
------------+-----------------------------------
      Total |    886,104      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(295,368 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(295,368 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(295,368 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002f not found)
file /tmp/St29163.00002f saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        744       20.00       20.00
       1980 |        744       20.00       40.00
       1990 |        744       20.00       60.00
       2000 |        744       20.00       80.00
       2007 |        744       20.00      100.00
------------+-----------------------------------
      Total |      3,720      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,976 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(744 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(744 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,976 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(744 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(742 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,976 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(744 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,488
        from master                     1,488  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,232  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,488       40.00       40.00
            matched (3) |      2,232       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,720      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       744          0 |       744 
      1980 |         0        744 |       744 
      1990 |         0        744 |       744 
      2000 |         0        744 |       744 
      2007 |       744          0 |       744 
-----------+----------------------+----------
     Total |     1,488      2,232 |     3,720 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,488 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        743
                                                  Wald chi2(1)    =      73.25
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9181

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8705252   .1017151    -8.56   0.000    -1.069883   -.6711674
       _cons |  -.4878598   .1293573    -3.77   0.000    -.7413955   -.2343241
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        743
                                                  Wald chi2(1)    =     169.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1107
                                                  Root MSE        =     2.2433

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.02815   .0789738   -13.02   0.000    -1.182936   -.8733645
       _cons |  -1.177047   .1678049    -7.01   0.000    -1.505938   -.8481552
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,486
                                                  Wald chi2(2)    =     488.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1548
                                                  Root MSE        =     2.0983

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9865039   .0617961   -15.96   0.000    -1.107622   -.8653858
       y2000 |  -.8900699   .1191761    -7.47   0.000    -1.123651    -.656489
       _cons |   -.364095   .1013646    -3.59   0.000    -.5627659   -.1654241
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 82, TIME IS 10:43:23 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    906,351      100.00      100.00
------------+-----------------------------------
      Total |    906,351      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    302,117       33.33       33.33
          3 |    604,234       66.67      100.00
------------+-----------------------------------
      Total |    906,351      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(302,117 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(302,117 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(302,117 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002g not found)
file /tmp/St29163.00002g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        761       20.00       20.00
       1980 |        761       20.00       40.00
       1990 |        761       20.00       60.00
       2000 |        761       20.00       80.00
       2007 |        761       20.00      100.00
------------+-----------------------------------
      Total |      3,805      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,044 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(761 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,044 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(756 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,044 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,522
        from master                     1,522  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,283  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,522       40.00       40.00
            matched (3) |      2,283       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,805      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       761          0 |       761 
      1980 |         0        761 |       761 
      1990 |         0        761 |       761 
      2000 |         0        761 |       761 
      2007 |       761          0 |       761 
-----------+----------------------+----------
     Total |     1,522      2,283 |     3,805 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,522 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        760
                                                  Wald chi2(1)    =      73.04
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9024

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8474035   .0991542    -8.55   0.000    -1.041742   -.6530648
       _cons |  -.5083137   .1262412    -4.03   0.000     -.755742   -.2608855
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        760
                                                  Wald chi2(1)    =     168.72
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1071
                                                  Root MSE        =     2.2443

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.018459   .0784088   -12.99   0.000    -1.172137   -.8647804
       _cons |  -1.190682   .1664954    -7.15   0.000    -1.517007   -.8643575
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,520
                                                  Wald chi2(2)    =     495.24
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1546
                                                  Root MSE        =     2.0922

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9730212   .0609973   -15.95   0.000    -1.092574   -.8534687
       y2000 |  -.9004569   .1175549    -7.66   0.000     -1.13086   -.6700536
       _cons |  -.3743893    .099944    -3.75   0.000    -.5702759   -.1785027
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 83, TIME IS 10:43:56 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    906,351      100.00      100.00
------------+-----------------------------------
      Total |    906,351      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    302,117       33.33       33.33
          3 |    604,234       66.67      100.00
------------+-----------------------------------
      Total |    906,351      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(302,117 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(302,117 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(302,117 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002h not found)
file /tmp/St29163.00002h saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        761       20.00       20.00
       1980 |        761       20.00       40.00
       1990 |        761       20.00       60.00
       2000 |        761       20.00       80.00
       2007 |        761       20.00      100.00
------------+-----------------------------------
      Total |      3,805      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,044 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(761 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,044 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(760 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,044 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(761 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,522
        from master                     1,522  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,283  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,522       40.00       40.00
            matched (3) |      2,283       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,805      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       761          0 |       761 
      1980 |         0        761 |       761 
      1990 |         0        761 |       761 
      2000 |         0        761 |       761 
      2007 |       761          0 |       761 
-----------+----------------------+----------
     Total |     1,522      2,283 |     3,805 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,522 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        760
                                                  Wald chi2(1)    =      75.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9306

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8680687   .0997174    -8.71   0.000    -1.063511   -.6726262
       _cons |  -.4910395   .1272828    -3.86   0.000    -.7405092   -.2415697
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        760
                                                  Wald chi2(1)    =     176.41
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0940
                                                  Root MSE        =     2.2623

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.064686     .08016   -13.28   0.000    -1.221796   -.9075748
       _cons |  -1.103567   .1697607    -6.50   0.000    -1.436291   -.7708418
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,520
                                                  Wald chi2(2)    =     498.18
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1383
                                                  Root MSE        =     2.1174

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.011813   .0622366   -16.26   0.000    -1.133794   -.8898313
       y2000 |  -.8637608   .1191778    -7.25   0.000    -1.097345   -.6301766
       _cons |  -.3378266   .1014866    -3.33   0.001    -.5367367   -.1389166
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 84, TIME IS 10:44:30 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    894,441      100.00      100.00
------------+-----------------------------------
      Total |    894,441      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,147       33.33       33.33
          3 |    596,294       66.67      100.00
------------+-----------------------------------
      Total |    894,441      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,147 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,147 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,147 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002i not found)
file /tmp/St29163.00002i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        751       20.00       20.00
       1980 |        751       20.00       40.00
       1990 |        751       20.00       60.00
       2000 |        751       20.00       80.00
       2007 |        751       20.00      100.00
------------+-----------------------------------
      Total |      3,755      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,004 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(751 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,004 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(748 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,004 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,502
        from master                     1,502  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,253  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,502       40.00       40.00
            matched (3) |      2,253       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,755      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       751          0 |       751 
      1980 |         0        751 |       751 
      1990 |         0        751 |       751 
      2000 |         0        751 |       751 
      2007 |       751          0 |       751 
-----------+----------------------+----------
     Total |     1,502      2,253 |     3,755 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,502 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        750
                                                  Wald chi2(1)    =      74.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9244

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.871736   .1013199    -8.60   0.000    -1.070319   -.6731527
       _cons |  -.4872405    .128728    -3.79   0.000    -.7395428   -.2349382
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        750
                                                  Wald chi2(1)    =     171.26
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0888
                                                  Root MSE        =     2.2637

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.056342   .0807183   -13.09   0.000    -1.214547   -.8981372
       _cons |  -1.120226   .1710887    -6.55   0.000    -1.455554   -.7848984
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,500
                                                  Wald chi2(2)    =     490.83
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1416
                                                  Root MSE        =     2.1131

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.006682   .0626837   -16.06   0.000     -1.12954   -.8838244
       y2000 |  -.8687968   .1198627    -7.25   0.000    -1.103723   -.6338703
       _cons |  -.3435873   .1020106    -3.37   0.001    -.5435244   -.1436502
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 85, TIME IS 10:45:03 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    896,823      100.00      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,941       33.33       33.33
          3 |    597,882       66.67      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,941 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,941 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,941 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002j not found)
file /tmp/St29163.00002j saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        753       20.00       20.00
       1980 |        753       20.00       40.00
       1990 |        753       20.00       60.00
       2000 |        753       20.00       80.00
       2007 |        753       20.00      100.00
------------+-----------------------------------
      Total |      3,765      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,012 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(753 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(751 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,506
        from master                     1,506  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,259  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,506       40.00       40.00
            matched (3) |      2,259       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,765      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       753          0 |       753 
      1980 |         0        753 |       753 
      1990 |         0        753 |       753 
      2000 |         0        753 |       753 
      2007 |       753          0 |       753 
-----------+----------------------+----------
     Total |     1,506      2,259 |     3,765 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,506 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =      72.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9308

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8607408   .1007915    -8.54   0.000    -1.058289   -.6631931
       _cons |  -.4999242   .1283254    -3.90   0.000    -.7514374    -.248411
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =     173.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1199
                                                  Root MSE        =     2.2195

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.021209   .0775012   -13.18   0.000    -1.173108   -.8693095
       _cons |  -1.189787    .164564    -7.23   0.000    -1.512327   -.8672476
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,504
                                                  Wald chi2(2)    =     494.19
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1556
                                                  Root MSE        =      2.093

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9789428   .0610429   -16.04   0.000    -1.098585   -.8593008
       y2000 |   -.893823   .1180799    -7.57   0.000    -1.125255   -.6623907
       _cons |  -.3741065   .1002347    -3.73   0.000    -.5705629   -.1776502
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 86, TIME IS 10:45:36 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    905,160      100.00      100.00
------------+-----------------------------------
      Total |    905,160      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,720       33.33       33.33
          3 |    603,440       66.67      100.00
------------+-----------------------------------
      Total |    905,160      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,720 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,720 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,720 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002k not found)
file /tmp/St29163.00002k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        760       20.00       20.00
       1980 |        760       20.00       40.00
       1990 |        760       20.00       60.00
       2000 |        760       20.00       80.00
       2007 |        760       20.00      100.00
------------+-----------------------------------
      Total |      3,800      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,040 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(760 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,040 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(756 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,040 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(760 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,520
        from master                     1,520  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,280  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,520       40.00       40.00
            matched (3) |      2,280       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,800      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       760          0 |       760 
      1980 |         0        760 |       760 
      1990 |         0        760 |       760 
      2000 |         0        760 |       760 
      2007 |       760          0 |       760 
-----------+----------------------+----------
     Total |     1,520      2,280 |     3,800 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,520 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        759
                                                  Wald chi2(1)    =      73.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.941

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8608276   .1003371    -8.58   0.000    -1.057485   -.6641706
       _cons |  -.4982016   .1282254    -3.89   0.000    -.7495188   -.2468843
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        759
                                                  Wald chi2(1)    =     173.57
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0877
                                                  Root MSE        =     2.2689

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.056081   .0801597   -13.17   0.000    -1.213191   -.8989709
       _cons |  -1.120317   .1700331    -6.59   0.000    -1.453576   -.7870579
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,518
                                                  Wald chi2(2)    =     491.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1326
                                                  Root MSE        =     2.1263

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.003355   .0623525   -16.09   0.000    -1.125564   -.8811466
       y2000 |  -.8721466    .119697    -7.29   0.000    -1.106748   -.6375447
       _cons |  -.3460161   .1019275    -3.39   0.001    -.5457904   -.1462419
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 87, TIME IS 10:46:09 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    900,396      100.00      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,132       33.33       33.33
          3 |    600,264       66.67      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,132 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,132 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,132 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002l not found)
file /tmp/St29163.00002l saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        756       20.00       20.00
       1980 |        756       20.00       40.00
       1990 |        756       20.00       60.00
       2000 |        756       20.00       80.00
       2007 |        756       20.00      100.00
------------+-----------------------------------
      Total |      3,780      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,024 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(756 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(754 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,512
        from master                     1,512  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,268  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,512       40.00       40.00
            matched (3) |      2,268       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,780      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       756          0 |       756 
      1980 |         0        756 |       756 
      1990 |         0        756 |       756 
      2000 |         0        756 |       756 
      2007 |       756          0 |       756 
-----------+----------------------+----------
     Total |     1,512      2,268 |     3,780 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,512 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =      76.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9108

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8796766   .1004813    -8.75   0.000    -1.076616   -.6827369
       _cons |   -.475346   .1276416    -3.72   0.000     -.725519    -.225173
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =     172.85
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0804
                                                  Root MSE        =     2.2736

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.033789   .0786308   -13.15   0.000    -1.187903   -.8796756
       _cons |  -1.158495   .1677259    -6.91   0.000    -1.487232   -.8297583
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,510
                                                  Wald chi2(2)    =     498.38
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1397
                                                  Root MSE        =     2.1099

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9934477   .0611988   -16.23   0.000    -1.113395   -.8735002
       y2000 |  -.8791918   .1188749    -7.40   0.000    -1.112182   -.6462013
       _cons |  -.3541543   .1007278    -3.52   0.000     -.551577   -.1567315
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 88, TIME IS 10:46:43 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    917,070      100.00      100.00
------------+-----------------------------------
      Total |    917,070      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    305,690       33.33       33.33
          3 |    611,380       66.67      100.00
------------+-----------------------------------
      Total |    917,070      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(305,690 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(305,690 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(305,690 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002m not found)
file /tmp/St29163.00002m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        770       20.00       20.00
       1980 |        770       20.00       40.00
       1990 |        770       20.00       60.00
       2000 |        770       20.00       80.00
       2007 |        770       20.00      100.00
------------+-----------------------------------
      Total |      3,850      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,080 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(770 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(770 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,080 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(770 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(766 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,080 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(770 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,540
        from master                     1,540  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,310  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,540       40.00       40.00
            matched (3) |      2,310       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,850      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       770          0 |       770 
      1980 |         0        770 |       770 
      1990 |         0        770 |       770 
      2000 |         0        770 |       770 
      2007 |       770          0 |       770 
-----------+----------------------+----------
     Total |     1,540      2,310 |     3,850 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,540 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        769
                                                  Wald chi2(1)    =      74.29
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9275

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8658981    .100461    -8.62   0.000    -1.062798   -.6689982
       _cons |  -.4916136   .1276256    -3.85   0.000    -.7417551   -.2414721
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        769
                                                  Wald chi2(1)    =     174.70
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1060
                                                  Root MSE        =     2.2478

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.037584   .0785012   -13.22   0.000    -1.191443   -.8837244
       _cons |  -1.153665   .1663789    -6.93   0.000    -1.479762   -.8275684
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,538
                                                  Wald chi2(2)    =     499.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1495
                                                  Root MSE        =     2.1062

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9918802   .0613771   -16.16   0.000    -1.112177   -.8715834
       y2000 |  -.8808726   .1177336    -7.48   0.000    -1.111626   -.6501191
       _cons |  -.3573852   .1002249    -3.57   0.000    -.5538223    -.160948
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 89, TIME IS 10:47:16 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    899,205      100.00      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,735       33.33       33.33
          3 |    599,470       66.67      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,735 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,735 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,735 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002n not found)
file /tmp/St29163.00002n saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        755       20.00       20.00
       1980 |        755       20.00       40.00
       1990 |        755       20.00       60.00
       2000 |        755       20.00       80.00
       2007 |        755       20.00      100.00
------------+-----------------------------------
      Total |      3,775      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,020 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(755 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(749 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,510
        from master                     1,510  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,265  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,510       40.00       40.00
            matched (3) |      2,265       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,775      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       755          0 |       755 
      1980 |         0        755 |       755 
      1990 |         0        755 |       755 
      2000 |         0        755 |       755 
      2007 |       755          0 |       755 
-----------+----------------------+----------
     Total |     1,510      2,265 |     3,775 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,510 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =      73.42
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9184

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8666168   .1011369    -8.57   0.000    -1.064841   -.6683922
       _cons |  -.4962567   .1283339    -3.87   0.000    -.7477866   -.2447269
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =     174.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0890
                                                  Root MSE        =      2.266

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.060794   .0802593   -13.22   0.000    -1.218099   -.9034883
       _cons |  -1.111846   .1702117    -6.53   0.000    -1.445455   -.7782371
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,508
                                                  Wald chi2(2)    =     495.21
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1450
                                                  Root MSE        =     2.1111

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.009157   .0623592   -16.18   0.000    -1.131379   -.8869353
       y2000 |  -.8630868   .1193782    -7.23   0.000    -1.097064   -.6291099
       _cons |  -.3445371   .1015695    -3.39   0.001    -.5436097   -.1454645
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 90, TIME IS 10:47:49 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    894,441      100.00      100.00
------------+-----------------------------------
      Total |    894,441      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,147       33.33       33.33
          3 |    596,294       66.67      100.00
------------+-----------------------------------
      Total |    894,441      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,147 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,147 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,147 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002o not found)
file /tmp/St29163.00002o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        751       20.00       20.00
       1980 |        751       20.00       40.00
       1990 |        751       20.00       60.00
       2000 |        751       20.00       80.00
       2007 |        751       20.00      100.00
------------+-----------------------------------
      Total |      3,755      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,004 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(751 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,004 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(749 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,004 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(751 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,502
        from master                     1,502  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,253  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,502       40.00       40.00
            matched (3) |      2,253       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,755      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       751          0 |       751 
      1980 |         0        751 |       751 
      1990 |         0        751 |       751 
      2000 |         0        751 |       751 
      2007 |       751          0 |       751 
-----------+----------------------+----------
     Total |     1,502      2,253 |     3,755 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,502 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        750
                                                  Wald chi2(1)    =      75.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9126

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8745853   .1006469    -8.69   0.000     -1.07185    -.677321
       _cons |  -.4845379   .1278389    -3.79   0.000    -.7350975   -.2339783
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        750
                                                  Wald chi2(1)    =     172.15
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1140
                                                  Root MSE        =      2.234

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.037645   .0790861   -13.12   0.000    -1.192651   -.8826394
       _cons |  -1.155555   .1676606    -6.89   0.000    -1.484163   -.8269457
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,500
                                                  Wald chi2(2)    =     496.26
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1542
                                                  Root MSE        =     2.0917

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9941024   .0617235   -16.11   0.000    -1.115078   -.8731266
       y2000 |   -.878816   .1184681    -7.42   0.000    -1.111009   -.6466228
       _cons |  -.3573854   .1007269    -3.55   0.000    -.5548065   -.1599643
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 91, TIME IS 10:48:22 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    896,823      100.00      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,941       33.33       33.33
          3 |    597,882       66.67      100.00
------------+-----------------------------------
      Total |    896,823      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,941 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,941 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,941 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002p not found)
file /tmp/St29163.00002p saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        753       20.00       20.00
       1980 |        753       20.00       40.00
       1990 |        753       20.00       60.00
       2000 |        753       20.00       80.00
       2007 |        753       20.00      100.00
------------+-----------------------------------
      Total |      3,765      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,012 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(753 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(750 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,012 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(753 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,506
        from master                     1,506  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,259  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,506       40.00       40.00
            matched (3) |      2,259       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,765      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       753          0 |       753 
      1980 |         0        753 |       753 
      1990 |         0        753 |       753 
      2000 |         0        753 |       753 
      2007 |       753          0 |       753 
-----------+----------------------+----------
     Total |     1,506      2,259 |     3,765 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,506 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =      72.00
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9351

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8531341   .1005461    -8.49   0.000    -1.050201   -.6560674
       _cons |  -.4970066   .1284758    -3.87   0.000    -.7488145   -.2451987
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        752
                                                  Wald chi2(1)    =     169.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0883
                                                  Root MSE        =     2.2507

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.031076   .0791658   -13.02   0.000    -1.186238   -.8759141
       _cons |  -1.167878   .1680998    -6.95   0.000    -1.497347   -.8384083
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,504
                                                  Wald chi2(2)    =     487.81
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1349
                                                  Root MSE        =     2.1129

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9837207    .061874   -15.90   0.000    -1.104992   -.8624498
       y2000 |  -.8980637   .1193093    -7.53   0.000    -1.131905   -.6642218
       _cons |  -.3575679   .1014983    -3.52   0.000    -.5565009    -.158635
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 92, TIME IS 10:48:55 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    893,250      100.00      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    297,750       33.33       33.33
          3 |    595,500       66.67      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(297,750 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(297,750 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(297,750 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002q not found)
file /tmp/St29163.00002q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        750       20.00       20.00
       1980 |        750       20.00       40.00
       1990 |        750       20.00       60.00
       2000 |        750       20.00       80.00
       2007 |        750       20.00      100.00
------------+-----------------------------------
      Total |      3,750      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,000 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(750 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(750 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,500
        from master                     1,500  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,250  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,500       40.00       40.00
            matched (3) |      2,250       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,750      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       750          0 |       750 
      1980 |         0        750 |       750 
      1990 |         0        750 |       750 
      2000 |         0        750 |       750 
      2007 |       750          0 |       750 
-----------+----------------------+----------
     Total |     1,500      2,250 |     3,750 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,500 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =      74.45
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9208

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8659965   .1003633    -8.63   0.000    -1.062705   -.6692879
       _cons |  -.4895661   .1280413    -3.82   0.000    -.7405225   -.2386097
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =     182.59
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1166
                                                  Root MSE        =     2.2258

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.064198   .0787558   -13.51   0.000    -1.218556   -.9098392
       _cons |  -1.109873   .1669677    -6.65   0.000    -1.437124   -.7826222
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,498
                                                  Wald chi2(2)    =     506.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1568
                                                  Root MSE        =     2.0932

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.011056   .0616308   -16.41   0.000     -1.13185    -.890262
       y2000 |  -.8734879   .1184808    -7.37   0.000    -1.105706   -.6412697
       _cons |  -.3347796   .1008704    -3.32   0.001    -.5324821   -.1370772
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 93, TIME IS 10:49:28 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    899,205      100.00      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,735       33.33       33.33
          3 |    599,470       66.67      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,735 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,735 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,735 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002r not found)
file /tmp/St29163.00002r saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        755       20.00       20.00
       1980 |        755       20.00       40.00
       1990 |        755       20.00       60.00
       2000 |        755       20.00       80.00
       2007 |        755       20.00      100.00
------------+-----------------------------------
      Total |      3,775      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,020 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(755 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(752 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,510
        from master                     1,510  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,265  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,510       40.00       40.00
            matched (3) |      2,265       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,775      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       755          0 |       755 
      1980 |         0        755 |       755 
      1990 |         0        755 |       755 
      2000 |         0        755 |       755 
      2007 |       755          0 |       755 
-----------+----------------------+----------
     Total |     1,510      2,265 |     3,775 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,510 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =      73.85
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =       1.93

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8671629   .1009061    -8.59   0.000    -1.064935   -.6693905
       _cons |  -.4926976   .1285553    -3.83   0.000    -.7446613   -.2407338
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =     167.70
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1040
                                                  Root MSE        =     2.2562

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.027817   .0793684   -12.95   0.000    -1.183376   -.8722575
       _cons |  -1.171772   .1685418    -6.95   0.000    -1.502108   -.8414365
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,508
                                                  Wald chi2(2)    =     486.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1467
                                                  Root MSE        =     2.1114

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9851118   .0619245   -15.91   0.000    -1.106482   -.8637421
       y2000 |  -.8840738   .1191732    -7.42   0.000    -1.117649   -.6504987
       _cons |  -.3668771    .101371    -3.62   0.000    -.5655606   -.1681936
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 94, TIME IS 10:50:01 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    899,205      100.00      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,735       33.33       33.33
          3 |    599,470       66.67      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,735 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,735 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,735 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002s not found)
file /tmp/St29163.00002s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        755       20.00       20.00
       1980 |        755       20.00       40.00
       1990 |        755       20.00       60.00
       2000 |        755       20.00       80.00
       2007 |        755       20.00      100.00
------------+-----------------------------------
      Total |      3,775      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,020 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(755 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(755 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,510
        from master                     1,510  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,265  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,510       40.00       40.00
            matched (3) |      2,265       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,775      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       755          0 |       755 
      1980 |         0        755 |       755 
      1990 |         0        755 |       755 
      2000 |         0        755 |       755 
      2007 |       755          0 |       755 
-----------+----------------------+----------
     Total |     1,510      2,265 |     3,775 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,510 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =      75.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9423

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8773081   .1008886    -8.70   0.000    -1.075046   -.6795701
       _cons |   -.481251    .128702    -3.74   0.000    -.7335023   -.2289997
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =     172.65
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0967
                                                  Root MSE        =     2.2617

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.048262   .0797778   -13.14   0.000    -1.204623   -.8919003
       _cons |  -1.134073    .169362    -6.70   0.000    -1.466017     -.80213
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,508
                                                  Wald chi2(2)    =     491.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1431
                                                  Root MSE        =     2.1202

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.002509   .0621966   -16.12   0.000    -1.124413   -.8806063
       y2000 |  -.8711238    .119719    -7.28   0.000    -1.105769   -.6364789
       _cons |  -.3478179   .1017617    -3.42   0.001    -.5472673   -.1483686
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 95, TIME IS 10:50:34 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    899,205      100.00      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,735       33.33       33.33
          3 |    599,470       66.67      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,735 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,735 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,735 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002t not found)
file /tmp/St29163.00002t saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        755       20.00       20.00
       1980 |        755       20.00       40.00
       1990 |        755       20.00       60.00
       2000 |        755       20.00       80.00
       2007 |        755       20.00      100.00
------------+-----------------------------------
      Total |      3,775      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,020 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(755 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(752 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,510
        from master                     1,510  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,265  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,510       40.00       40.00
            matched (3) |      2,265       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,775      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       755          0 |       755 
      1980 |         0        755 |       755 
      1990 |         0        755 |       755 
      2000 |         0        755 |       755 
      2007 |       755          0 |       755 
-----------+----------------------+----------
     Total |     1,510      2,265 |     3,775 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,510 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =      73.84
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9187

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8656991    .100747    -8.59   0.000     -1.06316   -.6682387
       _cons |  -.4918442   .1281365    -3.84   0.000     -.742987   -.2407013
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =     173.57
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0938
                                                  Root MSE        =     2.2517

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.025222   .0778182   -13.17   0.000    -1.177742   -.8727006
       _cons |  -1.178407   .1660018    -7.10   0.000    -1.503765   -.8530499
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,508
                                                  Wald chi2(2)    =     497.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1475
                                                  Root MSE        =     2.1024

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9833512    .060918   -16.14   0.000    -1.102748   -.8639542
       y2000 |  -.8896525   .1184569    -7.51   0.000    -1.121824   -.6574812
       _cons |  -.3664139   .1003987    -3.65   0.000    -.5631916   -.1696362
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 96, TIME IS 10:51:08 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    899,205      100.00      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    299,735       33.33       33.33
          3 |    599,470       66.67      100.00
------------+-----------------------------------
      Total |    899,205      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(299,735 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(299,735 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(299,735 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002u not found)
file /tmp/St29163.00002u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        755       20.00       20.00
       1980 |        755       20.00       40.00
       1990 |        755       20.00       60.00
       2000 |        755       20.00       80.00
       2007 |        755       20.00      100.00
------------+-----------------------------------
      Total |      3,775      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,020 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(755 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(753 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,020 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(755 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,510
        from master                     1,510  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,265  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,510       40.00       40.00
            matched (3) |      2,265       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,775      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       755          0 |       755 
      1980 |         0        755 |       755 
      1990 |         0        755 |       755 
      2000 |         0        755 |       755 
      2007 |       755          0 |       755 
-----------+----------------------+----------
     Total |     1,510      2,265 |     3,775 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,510 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =      76.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9181

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8795827   .1002983    -8.77   0.000    -1.076164   -.6830017
       _cons |  -.4776945   .1277436    -3.74   0.000    -.7280674   -.2273216
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(1)    =     175.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1043
                                                  Root MSE        =     2.2343

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.043852   .0787336   -13.26   0.000    -1.198167   -.8895373
       _cons |  -1.144205   .1669357    -6.85   0.000    -1.471393    -.817017
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,508
                                                  Wald chi2(2)    =     501.82
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1494
                                                  Root MSE        =     2.0939

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9998203   .0614685   -16.27   0.000    -1.120296   -.8793442
       y2000 |  -.8762444   .1181459    -7.42   0.000    -1.107806   -.6446828
       _cons |  -.3494792   .1005559    -3.48   0.001     -.546565   -.1523933
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 97, TIME IS 10:51:41 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    909,924      100.00      100.00
------------+-----------------------------------
      Total |    909,924      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    303,308       33.33       33.33
          3 |    606,616       66.67      100.00
------------+-----------------------------------
      Total |    909,924      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(303,308 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(303,308 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(303,308 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002v not found)
file /tmp/St29163.00002v saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        764       20.00       20.00
       1980 |        764       20.00       40.00
       1990 |        764       20.00       60.00
       2000 |        764       20.00       80.00
       2007 |        764       20.00      100.00
------------+-----------------------------------
      Total |      3,820      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,056 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(764 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,056 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(763 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,056 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,528
        from master                     1,528  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,292  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,528       40.00       40.00
            matched (3) |      2,292       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,820      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       764          0 |       764 
      1980 |         0        764 |       764 
      1990 |         0        764 |       764 
      2000 |         0        764 |       764 
      2007 |       764          0 |       764 
-----------+----------------------+----------
     Total |     1,528      2,292 |     3,820 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,528 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        763
                                                  Wald chi2(1)    =      74.20
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9418

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8553822   .0992987    -8.61   0.000    -1.050004   -.6607603
       _cons |  -.5036944    .127232    -3.96   0.000    -.7530645   -.2543242
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        763
                                                  Wald chi2(1)    =     170.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0924
                                                  Root MSE        =     2.2616

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.055974   .0807848   -13.07   0.000    -1.214309   -.8976383
       _cons |  -1.121924   .1707012    -6.57   0.000    -1.456492   -.7873558
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,526
                                                  Wald chi2(2)    =     489.46
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1343
                                                  Root MSE        =     2.1236

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.001765   .0626562   -15.99   0.000    -1.124569   -.8789608
       y2000 |  -.8750732   .1193629    -7.33   0.000     -1.10902   -.6411263
       _cons |  -.3473611    .101923    -3.41   0.001    -.5471265   -.1475956
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 98, TIME IS 10:52:14 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    895,632      100.00      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    298,544       33.33       33.33
          3 |    597,088       66.67      100.00
------------+-----------------------------------
      Total |    895,632      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(298,544 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(298,544 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(298,544 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002w not found)
file /tmp/St29163.00002w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        752       20.00       20.00
       1980 |        752       20.00       40.00
       1990 |        752       20.00       60.00
       2000 |        752       20.00       80.00
       2007 |        752       20.00      100.00
------------+-----------------------------------
      Total |      3,760      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,008 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(752 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(749 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,008 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(752 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,504
        from master                     1,504  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,256  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,504       40.00       40.00
            matched (3) |      2,256       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,760      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       752          0 |       752 
      1980 |         0        752 |       752 
      1990 |         0        752 |       752 
      2000 |         0        752 |       752 
      2007 |       752          0 |       752 
-----------+----------------------+----------
     Total |     1,504      2,256 |     3,760 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,504 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =      72.33
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9193

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8422271    .099031    -8.50   0.000    -1.036324   -.6481299
       _cons |  -.5144358   .1267762    -4.06   0.000    -.7629126   -.2659591
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        751
                                                  Wald chi2(1)    =     174.65
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1080
                                                  Root MSE        =     2.2392

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.02029   .0772048   -13.22   0.000    -1.171609   -.8689717
       _cons |  -1.186792   .1645919    -7.21   0.000    -1.509386    -.864198
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,502
                                                  Wald chi2(2)    =     494.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1481
                                                  Root MSE        =     2.0999

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9735364   .0604989   -16.09   0.000    -1.092112   -.8549608
       y2000 |  -.8990001   .1182813    -7.60   0.000    -1.130827    -.667173
       _cons |  -.3743166   .1001969    -3.74   0.000    -.5706988   -.1779343
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 99, TIME IS 10:52:47 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    903,969      100.00      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    301,323       33.33       33.33
          3 |    602,646       66.67      100.00
------------+-----------------------------------
      Total |    903,969      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(301,323 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(301,323 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(301,323 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.00002x not found)
file /tmp/St29163.00002x saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        759       20.00       20.00
       1980 |        759       20.00       40.00
       1990 |        759       20.00       60.00
       2000 |        759       20.00       80.00
       2007 |        759       20.00      100.00
------------+-----------------------------------
      Total |      3,795      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,036 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(759 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(758 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,036 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(759 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,518
        from master                     1,518  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,277  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,518       40.00       40.00
            matched (3) |      2,277       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,795      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       759          0 |       759 
      1980 |         0        759 |       759 
      1990 |         0        759 |       759 
      2000 |         0        759 |       759 
      2007 |       759          0 |       759 
-----------+----------------------+----------
     Total |     1,518      2,277 |     3,795 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,518 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =      72.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9169

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8511608   .1001471    -8.50   0.000    -1.047446   -.6548761
       _cons |  -.5084915   .1273878    -3.99   0.000    -.7581669    -.258816
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        758
                                                  Wald chi2(1)    =     171.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1109
                                                  Root MSE        =     2.2474

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.038287   .0791846   -13.11   0.000    -1.193486   -.8830878
       _cons |  -1.157921   .1677401    -6.90   0.000    -1.486686   -.8291568
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,516
                                                  Wald chi2(2)    =     494.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1529
                                                  Root MSE        =     2.1023

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9882797   .0617046   -16.02   0.000    -1.109218    -.867341
       y2000 |  -.8880329   .1183623    -7.50   0.000    -1.120019   -.6560471
       _cons |  -.3624308   .1007512    -3.60   0.000    -.5598995   -.1649621
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 100, TIME IS 10:53:20 on 20 Aug 2020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    900,396      100.00      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    300,132       33.33       33.33
          3 |    600,264       66.67      100.00
------------+-----------------------------------
      Total |    900,396      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(300,132 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(300,132 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(300,132 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St29163.000030 not found)
file /tmp/St29163.000030 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        756       20.00       20.00
       1980 |        756       20.00       40.00
       1990 |        756       20.00       60.00
       2000 |        756       20.00       80.00
       2007 |        756       20.00      100.00
------------+-----------------------------------
      Total |      3,780      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,024 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(756 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(756 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,024 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(756 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,512
        from master                     1,512  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,268  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,512       40.00       40.00
            matched (3) |      2,268       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,780      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       756          0 |       756 
      1980 |         0        756 |       756 
      1990 |         0        756 |       756 
      2000 |         0        756 |       756 
      2007 |       756          0 |       756 
-----------+----------------------+----------
     Total |     1,512      2,268 |     3,780 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,512 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =      76.01
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9148

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8697683   .0997617    -8.72   0.000    -1.065298   -.6742389
       _cons |  -.4876659   .1272287    -3.83   0.000    -.7370295   -.2383023
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        755
                                                  Wald chi2(1)    =     165.65
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0988
                                                  Root MSE        =     2.2588

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.022737   .0794629   -12.87   0.000    -1.178482   -.8669926
       _cons |  -1.180527   .1687547    -7.00   0.000     -1.51128   -.8497735
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,510
                                                  Wald chi2(2)    =     488.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1449
                                                  Root MSE        =     2.1049

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9818756   .0616708   -15.92   0.000    -1.102748   -.8610031
       y2000 |  -.8882641   .1187286    -7.48   0.000    -1.120968   -.6555602
       _cons |  -.3680477   .1009869    -3.64   0.000    -.5659784    -.170117
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
ITERATION IS 101, TIME IS 10:53:55 on 20 Aug 2020
variable clustername_101 not found
r(111);

end of do-file
r(111);
