
  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   14.2   Copyright 1985-2015 StataCorp LLC
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
                                      College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

8-user Stata network perpetual license:
       Serial number:  501406244326
         Licensed to:  ECCO Cornell University
                       Ithaca, NY

Notes:
      1.  Stata is running in batch mode.
      2.  Unicode is supported; see help unicode_advice.

. do 02_01_cutoff_loop.do 

. /**********************
> This is the do-file loop
> 
> It has three steps
> 
> 1. Calculate the aggregate data
>         (national level)
> 
> 2. Decide which czone defn to use
> 
> 3. Aggregate cty data to czone
> 
> 4. Run regressions of delM on delIPW, 
>         store regressions.
>         
> ***************************/
. 
. include "../config.do"

. /*  config.do */
. 
. 
. 
. if ( "`c(hostname)'" == "ecco.vrdc.cornell.edu" ) {
. global root "/ssgprojects/project0002/MobZ.new"
. }

. 
. if ( "`c(username)'" == "vilhuber" ) {
. global root "/home/vilhuber/Workspace/git/larsvilhuber/MobZ"
. }

. 
. if ( "`c(hostname)'" == "some.server.at.census" ) {
. global root "/made/up/path/Mobz"
. }

. 
. /* check if the author creates a log file. If not, adjust the following code 
> fragment */
. 
. local c_date = c(current_date)

. local cdate = subinstr("`c_date'", " ", "_", .)

. local c_time = c(current_time)

. local ctime = subinstr("`c_time'", ":", "_", .)

. 
. // log using "${root}/logfile_`cdate'-`ctime'.log", replace text
. 
. /* It will provide some info about how and when the program was run */
. /* See https://www.stata.com/manuals13/pcreturn.pdf#pcreturn */
. local variant = cond(c(MP),"MP",cond(c(SE),"SE",c(flavor)) )  

. // alternatively, you could use 
. // local variant = cond(c(stata_version)>13,c(real_flavor),"NA")  
. 
. di "=== SYSTEM DIAGNOSTICS ==="
=== SYSTEM DIAGNOSTICS ===

. di "Stata version: `c(stata_version)'"
Stata version: 14.2

. di "Updated as of: `c(born_date)'"
Updated as of: 19 Dec 2017

. di "Variant:       `variant'"
Variant:       IC

. di "Processors:    `c(processors)'"
Processors:    1

. di "OS:            `c(os)' `c(osdtl)'"
OS:            Unix 

. di "Machine type:  `c(machine_type)'"
Machine type:  PC (64-bit x86-64)

. di "=========================="
==========================

. 
. 
. 
. 
. /* define relative libraries */
. 
. global paperdir "${root}/paper"

. global interwrk "${root}/data/interwrk"

. global raw "${root}/raw"

. global temp "${root}/temp"

. global outputs "${root}/data"

. global programs "${root}/programs"

. global outgraphs "${root}/figures"

. global logdir "${programs}/logs"

. 
. cap mkdir "$logdir"

. log using "${logdir}/logfile_`cdate'-`ctime'.log", replace text
(note: file /ssgprojects/project0002/MobZ.new/programs/logs/logfile_23_Aug_2020
> -11_29_50.log not found)
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /ssgprojects/project0002/MobZ.new/programs/logs/logfile_23_Aug_202
> 0-11_29_50.log
  log type:  text
 opened on:  23 Aug 2020, 11:29:50

. cap mkdir "$temp"

. cap mkdir "${root}/data"

. cap mkdir "$interwrk"

. cap mkdir "$raw"

. cap mkdir "$outputs"

. 
. /* install any packages locally */
. capture mkdir "${programs}/ado"

. sysdir set PERSONAL "${programs}/ado/personal"

. sysdir set PLUS     "${programs}/ado/plus"

. sysdir set SITE     "${programs}/ado/site"

. sysdir
   STATA:  /usr/local/stata14/
    BASE:  /usr/local/stata14/ado/base/
    SITE:  /ssgprojects/project0002/MobZ.new/programs/ado/site/
    PLUS:  /ssgprojects/project0002/MobZ.new/programs/ado/plus/
PERSONAL:  /ssgprojects/project0002/MobZ.new/programs/ado/personal/
OLDPLACE:  ~/ado/

. 
. /* define data sources */
. 
. /* QCEW */
. /* data/working/mobz/qcew */
.     global qcewdata "${raw}/qcew"  

. /* /data/working/mobz/outputs */
.     global czonedata "$outputs"  

. 
. /* ADH */
.     global adhdata "${raw}/adh_data/Public Release Data/dta"

. /* CZONE */
.     global czonedata "${raw}/adh_data/"

. /* files provided separately by David Dorn */
.     global dorndata "${raw}/ddorn/"

. 
. /* CBP */
.     /* this is where the raw Stata versions of CBP data reside */
.    global cbpdata "/data/clean/cbp"

. 
. 
. cap log close

. log using cutoff_loop.log, replace 
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /ssgprojects/project0002/MobZ.new/programs/07_adh/cutoff_loop.log
  log type:  text
 opened on:  23 Aug 2020, 11:29:50

. 
. /* local macros */
. local czonedataset = "${outputs}/clusters_cutoff_jtw1990.dta"

. global czone_iteration = "${interwrk}/czones_cutoff.dta"

. global dodir "${programs}/07_adh/"

. global ipw_regs "${interwrk}/07_adh_cutoff_post.dta"

. 
. include "$dodir/zz_aggregatedata.do"

. 
. /*****************
> Prep Aggregate Data
> *******************/
. 
. /*********************
> Trade data
> ***********************/
. 
. /* source: Autor Dorn Hanson public data files */
. 
. use "$adhdata/sic87dd_trade_data.dta", clear
(SIC trade data for ADH post collapse of problem SIC industries)

. 
. bys year sic87dd: egen M_ucjt = sum(imports*(exporter=="CHN")*(importer=="USA
> "))

. 
. bys year sic87dd: egen M_ocjt = sum(imports*(exporter=="CHN")*(importer=="OTH
> "))

. 
. keep if year == 1991 | year == 2000 | year == 2007
(59,636 observations deleted)

. collapse (first) M*, by(sic87dd year) 

. 
. /* this is fixing an issue with two of the sic codes that only show up in 200
> 6 */
. expand 3 if year == 2007 & (sic87dd == 2992 | sic87dd==3273)
(4 observations created)

. bys sic87dd year: egen seq = seq() 

. replace year = 2000 if seq == 3
(2 real changes made)

. replace year = 1990 if seq == 2
(2 real changes made)

. replace M_ucjt = 0 if seq > 1
(4 real changes made)

. replace M_ocjt = 0 if seq > 1 
(4 real changes made)

. drop seq

. 
. sort sic87dd year 

. 
. gen del_M_ucjt = M_ucjt[_n+1]-M_ucjt if year<2007
(397 missing values generated)

. gen del_M_ocjt = M_ocjt[_n+1]-M_ocjt if year<2007
(397 missing values generated)

. 
. drop if year == 2007
(397 observations deleted)

. replace year = 1990 if year == 1991 
(395 real changes made)

. 
. keep del* M_* sic87dd year

. 
. sort sic87dd year

. 
. save "$interwrk/tmp_tradedata.dta", replace
file /ssgprojects/project0002/MobZ.new/data/interwrk/tmp_tradedata.dta saved

. 
. /*****************************
> National Industry Employment
> *****************************/
. use "$interwrk/industry_data.dta", clear

. 
. collapse (sum) emp, by(sic87dd year)

. 
. rename emp L_ujt 

. 
. sort sic87dd year

. 
. /* used nowhere else? */
. save "$interwrk/tmp_industrydata.dta", replace
file /ssgprojects/project0002/MobZ.new/data/interwrk/tmp_industrydata.dta saved

. 
. 
. 
. 
. 
. 
. 
. 
. set more off

. #delimit ;
delimiter now ;
. tempname czoneresults;

. use "`czonedataset'", clear ;

.  /***********************
> Creating string of values to 
> loop over
> ***********************/
> local values = "" ;

. foreach clus of varlist clus* { ;
  2.         di "`clus'" ;
  3.         local val = real(subinstr("`clus'","clus","",.)) ;
  4.         di "`val'" ;
  5.         local values = "`values' `val'" ;
  6. } ;
clus9000
9000
clus9005
9005
clus9010
9010
clus9015
9015
clus9020
9020
clus9025
9025
clus9030
9030
clus9035
9035
clus9040
9040
clus9045
9045
clus9050
9050
clus9055
9055
clus9060
9060
clus9065
9065
clus9070
9070
clus9075
9075
clus9080
9080
clus9085
9085
clus9090
9090
clus9095
9095
clus9100
9100
clus9105
9105
clus9110
9110
clus9115
9115
clus9120
9120
clus9125
9125
clus9130
9130
clus9135
9135
clus9140
9140
clus9145
9145
clus9150
9150
clus9155
9155
clus9160
9160
clus9165
9165
clus9170
9170
clus9175
9175
clus9180
9180
clus9185
9185
clus9190
9190
clus9195
9195
clus9200
9200
clus9205
9205
clus9210
9210
clus9215
9215
clus9220
9220
clus9225
9225
clus9230
9230
clus9235
9235
clus9240
9240
clus9245
9245
clus9250
9250
clus9255
9255
clus9260
9260
clus9265
9265
clus9270
9270
clus9275
9275
clus9280
9280
clus9285
9285
clus9290
9290
clus9295
9295
clus9300
9300
clus9305
9305
clus9310
9310
clus9315
9315
clus9320
9320
clus9325
9325
clus9330
9330
clus9335
9335
clus9340
9340
clus9345
9345
clus9350
9350
clus9355
9355
clus9360
9360
clus9365
9365
clus9370
9370
clus9375
9375
clus9380
9380
clus9385
9385
clus9390
9390
clus9395
9395
clus9400
9400
clus9405
9405
clus9410
9410
clus9415
9415
clus9420
9420
clus9425
9425
clus9430
9430
clus9435
9435
clus9440
9440
clus9445
9445
clus9450
9450
clus9455
9455
clus9460
9460
clus9465
9465
clus9470
9470
clus9475
9475
clus9480
9480
clus9485
9485
clus9490
9490
clus9495
9495
clus9500
9500
clus9505
9505
clus9510
9510
clus9515
9515
clus9520
9520
clus9525
9525
clus9530
9530
clus9535
9535
clus9540
9540
clus9545
9545
clus9550
9550
clus9555
9555
clus9560
9560
clus9565
9565
clus9570
9570
clus9575
9575
clus9580
9580
clus9585
9585
clus9590
9590
clus9595
9595
clus9600
9600
clus9605
9605
clus9610
9610
clus9615
9615
clus9620
9620
clus9625
9625
clus9630
9630
clus9635
9635
clus9640
9640
clus9645
9645
clus9650
9650
clus9655
9655
clus9660
9660
clus9665
9665
clus9670
9670
clus9675
9675
clus9680
9680
clus9685
9685
clus9690
9690
clus9695
9695
clus9700
9700

. postfile `czoneresults' cutoff beta_1990 se_1990 F_90 beta_2000 se_2000 beta_
> all se_all
>                                iqr_1990 iqr_2000 iqr_all
>                         using $ipw_regs, replace ;
(note: file /ssgprojects/project0002/MobZ.new/data/interwrk/07_adh_cutoff_post.
> dta not found)

.                         /* 
> missing step: estimate effects using our "replicated" Commuting Zones, which
> aren't exactly the same 
> */      
>         di "`values'" ;
 9000 9005 9010 9015 9020 9025 9030 9035 9040 9045 9050 9055 9060 9065 9070 907
> 5 9080 9085 9090 9095 9100 9105 9110 9115 9120 9125 9130 9135 9140 9145 9150 
> 9155 9160 9165 9170 9175 9180 9185 9190 9195 9200 9205 9210 9215 9220 9225 92
> 30 9235 9240 9245 9250 9255 9260 9265 9270 9275 9280 9285 9290 9295 9300 9305
>  9310 9315 9320 9325 9330 9335 9340 9345 9350 9355 9360 9365 9370 9375 9380 9
> 385 9390 9395 9400 9405 9410 9415 9420 9425 9430 9435 9440 9445 9450 9455 946
> 0 9465 9470 9475 9480 9485 9490 9495 9500 9505 9510 9515 9520 9525 9530 9535 
> 9540 9545 9550 9555 9560 9565 9570 9575 9580 9585 9590 9595 9600 9605 9610 96
> 15 9620 9625 9630 9635 9640 9645 9650 9655 9660 9665 9670 9675 9680 9685 9690
>  9695 9700

. foreach i in `values'  { ;
  2.         di "`i'" ;
  3.         local cutoff = `i'/10000 ;
  4.         * step2 ;
.         use "`czonedataset'", clear;
  5.                 egen czone = group(clus`i') ;
  6.                 keep fips czone;
  7.                 sort fips ;
  8.                 tempfile czone;
  9.                 save "$czone_iteration", replace;
 10.                         *step3 ;
.         include "$dodir/zz_ctymerge.do";
 11.                 qui sum IPW_uit if year == 1990, d;
 12.                 local iqr_1990 = r(p75) - r(p25) ;
 13.         qui sum IPW_uit if year == 2000, d;
 14.                 local iqr_2000 = r(p75) - r(p25) ;
 15.         qui sum IPW_uit if year>=1990 & year<=2000,d ;
 16.                 local iqr_all = r(p75) - r(p25) ;
 17.                 *step4 ;
.         ivregress 2sls del_L_mprime (IPW_uit = IPW_oit ) if year == 1990 [wei
> ght=share_czpop];
 18.                 local beta90 = _b[IPW_uit] ;
 19.                 local se90 = _se[IPW_uit] ;
 20.                 qui estat firststage;
 21.                 matrix A = r(singleresults);
 22.                 local F_90 = A[1,4] ;
 23.                                                         ivregress 2sls del
> _L_mprime (IPW_uit = IPW_oit ) if year == 2000 [weight=share_czpop];
 24.                 local beta00 = _b[IPW_uit] ;
 25.                 local se00 = _se[IPW_uit];
 26.         ivregress 2sls del_L_mprime (IPW_uit = IPW_oit ) y2000 [weight=sha
> re_czpop] ;
 27.                 local betaall = _b[IPW_uit] ;
 28.                 local seall = _se[IPW_uit] ;
 29.         post `czoneresults' (`cutoff') (`beta90') (`se90') (`F_90') (`beta
> 00') (`se00') (`betaall') (`seall')
>                                                                         (`iqr
> _1990') (`iqr_2000') (`iqr_all');
 30. } ;
9000
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,656,284      100.00      100.00
------------+-----------------------------------
      Total |  1,656,284      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    551,830       33.32       33.32
          3 |  1,104,454       66.68      100.00
------------+-----------------------------------
      Total |  1,656,284      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(551,830 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(551,830 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(551,830 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000002 not found)
file /tmp/St32493.000002 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,390       19.99       19.99
       1980 |      1,390       19.99       39.98
       1990 |      1,391       20.01       59.99
       2000 |      1,391       20.01       79.99
       2007 |      1,391       20.01      100.00
------------+-----------------------------------
      Total |      6,953      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,562 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,391 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,391 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,562 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,391 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,336 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,562 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,391 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,781
        from master                     2,781  (_merge==1)
        from using                          0  (_merge==2)

    matched                             4,172  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,781       40.00       40.00
            matched (3) |      4,172       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,953      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,390          0 |     1,390 
      1980 |         0      1,390 |     1,390 
      1990 |         0      1,391 |     1,391 
      2000 |         0      1,391 |     1,391 
      2007 |     1,391          0 |     1,391 
-----------+----------------------+----------
     Total |     2,781      4,172 |     6,953 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,780 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,389
                                                  Wald chi2(1)    =     103.87
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1238

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7761289   .0761549   -10.19   0.000    -.9253898    -.626868
       _cons |  -.5841228   .0990173    -5.90   0.000    -.7781932   -.3900525
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,390
                                                  Wald chi2(1)    =     232.76
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0670
                                                  Root MSE        =     2.5343

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9463564     .06203   -15.26   0.000    -1.067933   -.8247799
       _cons |  -1.319409   .1336546    -9.87   0.000    -1.581367   -1.057451
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,779
                                                  Wald chi2(2)    =     703.47
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1097
                                                  Root MSE        =     2.3517

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9002156   .0477843   -18.84   0.000    -.9938712     -.80656
       y2000 |  -.9528293   .0969123    -9.83   0.000    -1.142774   -.7628846
       _cons |    -.45218   .0810043    -5.58   0.000    -.6109456   -.2934144
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9005
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,646,756      100.00      100.00
------------+-----------------------------------
      Total |  1,646,756      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    548,654       33.32       33.32
          3 |  1,098,102       66.68      100.00
------------+-----------------------------------
      Total |  1,646,756      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(548,654 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(548,654 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(548,654 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000004 not found)
file /tmp/St32493.000004 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,382       19.99       19.99
       1980 |      1,382       19.99       39.98
       1990 |      1,383       20.01       59.99
       2000 |      1,383       20.01       79.99
       2007 |      1,383       20.01      100.00
------------+-----------------------------------
      Total |      6,913      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,530 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,383 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,530 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,329 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,530 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,765
        from master                     2,765  (_merge==1)
        from using                          0  (_merge==2)

    matched                             4,148  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,765       40.00       40.00
            matched (3) |      4,148       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,913      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,382          0 |     1,382 
      1980 |         0      1,382 |     1,382 
      1990 |         0      1,383 |     1,383 
      2000 |         0      1,383 |     1,383 
      2007 |     1,383          0 |     1,383 
-----------+----------------------+----------
     Total |     2,765      4,148 |     6,913 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,764 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,381
                                                  Wald chi2(1)    =     102.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1226

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7742736   .0763021   -10.15   0.000     -.923823   -.6247242
       _cons |  -.5858188   .0992222    -5.90   0.000    -.7802908   -.3913468
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,382
                                                  Wald chi2(1)    =     233.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0767
                                                  Root MSE        =     2.5201

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9462859   .0618786   -15.29   0.000    -1.067566   -.8250061
       _cons |  -1.319959   .1332898    -9.90   0.000    -1.581202   -1.058715
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,763
                                                  Wald chi2(2)    =     703.40
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1149
                                                  Root MSE        =     2.3442

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8996464   .0477765   -18.83   0.000    -.9932866   -.8060061
       y2000 |  -.9539515   .0968774    -9.85   0.000    -1.143828   -.7640753
       _cons |  -.4525072   .0809861    -5.59   0.000    -.6112371   -.2937773
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9010
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,639,610      100.00      100.00
------------+-----------------------------------
      Total |  1,639,610      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    546,272       33.32       33.32
          3 |  1,093,338       66.68      100.00
------------+-----------------------------------
      Total |  1,639,610      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(546,272 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(546,272 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(546,272 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000006 not found)
file /tmp/St32493.000006 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,382       19.99       19.99
       1980 |      1,382       19.99       39.98
       1990 |      1,383       20.01       59.99
       2000 |      1,383       20.01       79.99
       2007 |      1,383       20.01      100.00
------------+-----------------------------------
      Total |      6,913      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,530 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,383 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,530 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,329 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,530 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,827
        from master                     2,805  (_merge==1)
        from using                         22  (_merge==2)

    matched                             4,108  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,805       40.45       40.45
         using only (2) |         22        0.32       40.76
            matched (3) |      4,108       59.24      100.00
------------------------+-----------------------------------
                  Total |      6,935      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,382          0          0 |     1,382 
      1980 |        14          8      1,368 |     1,390 
      1990 |        13          7      1,370 |     1,390 
      2000 |        13          7      1,370 |     1,390 
      2007 |     1,383          0          0 |     1,383 
-----------+---------------------------------+----------
     Total |     2,805         22      4,108 |     6,935 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,786 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9839e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,368
                                                  Wald chi2(1)    =      21.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0771

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2194538   .0477743    -4.59   0.000    -.3130897   -.1258179
       _cons |  -1.141909   .0807364   -14.14   0.000     -1.30015   -.9836689
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9842e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,369
                                                  Wald chi2(1)    =      36.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0346
                                                  Root MSE        =     2.5772

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.3455849   .0571939    -6.04   0.000    -.4576829   -.2334869
       _cons |  -2.347769   .1393453   -16.85   0.000     -2.62088   -2.074657
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9968e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,737
                                                  Wald chi2(2)    =     404.20
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1084
                                                  Root MSE        =     2.3533

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2999823   .0386654    -7.76   0.000     -.375765   -.2241995
       y2000 |  -1.399861   .0964056   -14.52   0.000    -1.588812   -1.210909
       _cons |  -1.044136   .0790626   -13.21   0.000    -1.199095   -.8891758
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9015
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,639,610      100.00      100.00
------------+-----------------------------------
      Total |  1,639,610      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    546,272       33.32       33.32
          3 |  1,093,338       66.68      100.00
------------+-----------------------------------
      Total |  1,639,610      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(546,272 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(546,272 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(546,272 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000008 not found)
file /tmp/St32493.000008 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,366       19.99       19.99
       1980 |      1,366       19.99       39.98
       1990 |      1,367       20.01       59.99
       2000 |      1,367       20.01       79.99
       2007 |      1,367       20.01      100.00
------------+-----------------------------------
      Total |      6,833      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,466 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,367 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,367 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,466 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,367 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,314 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,466 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,367 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,813
        from master                     2,758  (_merge==1)
        from using                         55  (_merge==2)

    matched                             4,075  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,758       40.04       40.04
         using only (2) |         55        0.80       40.84
            matched (3) |      4,075       59.16      100.00
------------------------+-----------------------------------
                  Total |      6,888      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,366          0          0 |     1,366 
      1980 |         9         19      1,357 |     1,385 
      1990 |         8         18      1,359 |     1,385 
      2000 |         8         18      1,359 |     1,385 
      2007 |     1,367          0          0 |     1,367 
-----------+---------------------------------+----------
     Total |     2,758         55      4,075 |     6,888 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,787 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9406e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,358
                                                  Wald chi2(1)    =       2.77
                                                  Prob > chi2     =     0.0962
                                                  R-squared       =          .
                                                  Root MSE        =     2.0475

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1374163   .0826096    -1.66   0.096    -.2993282    .0244956
       _cons |  -1.257398   .1029816   -12.21   0.000    -1.459238   -1.055558
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9373e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,358
                                                  Wald chi2(1)    =       3.47
                                                  Prob > chi2     =     0.0625
                                                  R-squared       =     0.0074
                                                  Root MSE        =     2.6129

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0993925   .0533589    -1.86   0.063    -.2039741     .005189
       _cons |  -2.864664   .1298491   -22.06   0.000    -3.119163   -2.610164
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9878e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,716
                                                  Wald chi2(2)    =     348.83
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1136
                                                  Root MSE        =     2.3455

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1089378   .0430289    -2.53   0.011     -.193273   -.0246027
       y2000 |  -1.557915   .0995675   -15.65   0.000    -1.753064   -1.362766
       _cons |  -1.287289   .0780401   -16.50   0.000    -1.440245   -1.134333
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,627,700      100.00      100.00
------------+-----------------------------------
      Total |  1,627,700      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    542,302       33.32       33.32
          3 |  1,085,398       66.68      100.00
------------+-----------------------------------
      Total |  1,627,700      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(542,302 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(542,302 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(542,302 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000a not found)
file /tmp/St32493.00000a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,350       19.99       19.99
       1980 |      1,350       19.99       39.98
       1990 |      1,351       20.01       59.99
       2000 |      1,351       20.01       79.99
       2007 |      1,351       20.01      100.00
------------+-----------------------------------
      Total |      6,753      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,402 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,351 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,351 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,402 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,351 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,300 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,402 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,351 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,817
        from master                     2,735  (_merge==1)
        from using                         82  (_merge==2)

    matched                             4,018  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,735       40.01       40.01
         using only (2) |         82        1.20       41.21
            matched (3) |      4,018       58.79      100.00
------------------------+-----------------------------------
                  Total |      6,835      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,350          0          0 |     1,350 
      1980 |        12         28      1,338 |     1,378 
      1990 |        11         27      1,340 |     1,378 
      2000 |        11         27      1,340 |     1,378 
      2007 |     1,351          0          0 |     1,351 
-----------+---------------------------------+----------
     Total |     2,735         82      4,018 |     6,835 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,782 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9116e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,339
                                                  Wald chi2(1)    =       2.26
                                                  Prob > chi2     =     0.1326
                                                  R-squared       =     0.0014
                                                  Root MSE        =     2.0142

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0697497   .0463813     1.50   0.133     -.021156    .1606553
       _cons |  -1.486252   .0773407   -19.22   0.000    -1.637837   -1.334667
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9088e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,339
                                                  Wald chi2(1)    =       7.61
                                                  Prob > chi2     =     0.0058
                                                  R-squared       =          .
                                                  Root MSE        =     2.6328

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.158731   .0575356    -2.76   0.006    -.2714988   -.0459632
       _cons |  -2.755394   .1334276   -20.65   0.000    -3.016908   -2.493881
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9820e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,678
                                                  Wald chi2(2)    =     341.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1064
                                                  Root MSE        =     2.3411

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0767577    .038083    -2.02   0.044    -.1513991   -.0021164
       y2000 |   -1.60085   .0952471   -16.81   0.000    -1.787531   -1.414169
       _cons |  -1.314637     .07799   -16.86   0.000    -1.467494   -1.161779
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9025
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,596,734      100.00      100.00
------------+-----------------------------------
      Total |  1,596,734      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    531,980       33.32       33.32
          3 |  1,064,754       66.68      100.00
------------+-----------------------------------
      Total |  1,596,734      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(531,980 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(531,980 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(531,980 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000c not found)
file /tmp/St32493.00000c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,326       19.99       19.99
       1980 |      1,326       19.99       39.98
       1990 |      1,327       20.01       59.99
       2000 |      1,327       20.01       79.99
       2007 |      1,327       20.01      100.00
------------+-----------------------------------
      Total |      6,633      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,306 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,327 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,306 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,277 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,306 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,769
        from master                     2,690  (_merge==1)
        from using                         79  (_merge==2)

    matched                             3,943  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,690       40.08       40.08
         using only (2) |         79        1.18       41.25
            matched (3) |      3,943       58.75      100.00
------------------------+-----------------------------------
                  Total |      6,712      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,326          0          0 |     1,326 
      1980 |        13         27      1,313 |     1,353 
      1990 |        12         26      1,315 |     1,353 
      2000 |        12         26      1,315 |     1,353 
      2007 |     1,327          0          0 |     1,327 
-----------+---------------------------------+----------
     Total |     2,690         79      3,943 |     6,712 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,731 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.8548e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,314
                                                  Wald chi2(1)    =       9.97
                                                  Prob > chi2     =     0.0016
                                                  R-squared       =          .
                                                  Root MSE        =     2.0528

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2396651   .0758875    -3.16   0.002    -.3884019   -.0909283
       _cons |  -1.134645   .1022169   -11.10   0.000    -1.334986   -.9343033
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8457e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,314
                                                  Wald chi2(1)    =      11.11
                                                  Prob > chi2     =     0.0009
                                                  R-squared       =          .
                                                  Root MSE        =     2.6328

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1924509   .0577323    -3.33   0.001    -.3056042   -.0792977
       _cons |  -2.698635   .1400638   -19.27   0.000    -2.973155   -2.424115
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9700e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,628
                                                  Wald chi2(2)    =     360.09
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1099
                                                  Root MSE        =     2.3592

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2047247   .0444989    -4.60   0.000    -.2919409   -.1175085
       y2000 |  -1.499349   .1013421   -14.79   0.000    -1.697976   -1.300722
       _cons |  -1.173825   .0819983   -14.32   0.000    -1.334539   -1.013111
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9030
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,608,644      100.00      100.00
------------+-----------------------------------
      Total |  1,608,644      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    535,950       33.32       33.32
          3 |  1,072,694       66.68      100.00
------------+-----------------------------------
      Total |  1,608,644      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(535,950 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(535,950 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(535,950 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000e not found)
file /tmp/St32493.00000e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,313       19.99       19.99
       1980 |      1,313       19.99       39.98
       1990 |      1,314       20.01       59.99
       2000 |      1,314       20.01       79.99
       2007 |      1,314       20.01      100.00
------------+-----------------------------------
      Total |      6,568      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,254 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,314 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,314 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,254 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,314 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,267 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,254 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,314 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,830
        from master                     2,673  (_merge==1)
        from using                        157  (_merge==2)

    matched                             3,895  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,673       39.75       39.75
         using only (2) |        157        2.33       42.08
            matched (3) |      3,895       57.92      100.00
------------------------+-----------------------------------
                  Total |      6,725      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,313          0          0 |     1,313 
      1980 |        16         53      1,297 |     1,366 
      1990 |        15         52      1,299 |     1,366 
      2000 |        15         52      1,299 |     1,366 
      2007 |     1,314          0          0 |     1,314 
-----------+---------------------------------+----------
     Total |     2,673        157      3,895 |     6,725 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,783 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.8175e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,298
                                                  Wald chi2(1)    =       0.48
                                                  Prob > chi2     =     0.4878
                                                  R-squared       =          .
                                                  Root MSE        =     2.0342

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0522484   .0752983     0.69   0.488    -.0953336    .1998304
       _cons |  -1.462832   .0984434   -14.86   0.000    -1.655778   -1.269887
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8127e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,298
                                                  Wald chi2(1)    =       1.87
                                                  Prob > chi2     =     0.1710
                                                  R-squared       =     0.0001
                                                  Root MSE        =     2.6114

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0712548   .0520504    -1.37   0.171    -.1732716     .030762
       _cons |  -2.931148    .126287   -23.21   0.000    -3.178666    -2.68363
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9630e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,596
                                                  Wald chi2(2)    =     329.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1125
                                                  Root MSE        =     2.3401

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0412068   .0411101    -1.00   0.316     -.121781    .0393675
       y2000 |  -1.628103   .0992734   -16.40   0.000    -1.822675   -1.433531
       _cons |  -1.362744   .0784616   -17.37   0.000    -1.516526   -1.208963
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9035
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,556,240      100.00      100.00
------------+-----------------------------------
      Total |  1,556,240      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    518,482       33.32       33.32
          3 |  1,037,758       66.68      100.00
------------+-----------------------------------
      Total |  1,556,240      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(518,482 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(518,482 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(518,482 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000g not found)
file /tmp/St32493.00000g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,294       19.99       19.99
       1980 |      1,294       19.99       39.98
       1990 |      1,295       20.01       59.99
       2000 |      1,295       20.01       79.99
       2007 |      1,295       20.01      100.00
------------+-----------------------------------
      Total |      6,473      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,178 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,295 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,295 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,178 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,295 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,251 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,178 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,295 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,681
        from master                     2,617  (_merge==1)
        from using                         64  (_merge==2)

    matched                             3,856  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,617       40.03       40.03
         using only (2) |         64        0.98       41.01
            matched (3) |      3,856       58.99      100.00
------------------------+-----------------------------------
                  Total |      6,537      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,294          0          0 |     1,294 
      1980 |        10         22      1,284 |     1,316 
      1990 |         9         21      1,286 |     1,316 
      2000 |         9         21      1,286 |     1,316 
      2007 |     1,295          0          0 |     1,295 
-----------+---------------------------------+----------
     Total |     2,617         64      3,856 |     6,537 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,652 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9023e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,285
                                                  Wald chi2(1)    =       0.09
                                                  Prob > chi2     =     0.7670
                                                  R-squared       =          .
                                                  Root MSE        =     2.0292

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0166015   .0560271     0.30   0.767    -.0932096    .1264126
       _cons |  -1.426883   .0882285   -16.17   0.000    -1.599807   -1.253958
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9050e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,285
                                                  Wald chi2(1)    =       2.06
                                                  Prob > chi2     =     0.1517
                                                  R-squared       =          .
                                                  Root MSE        =      2.612

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0743595   .0518699     1.43   0.152    -.0273036    .1760226
       _cons |  -3.227673   .1320211   -24.45   0.000     -3.48643   -2.968917
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9807e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,570
                                                  Wald chi2(2)    =     327.25
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1103
                                                  Root MSE        =     2.3384

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0575056   .0379006     1.52   0.129    -.0167782    .1317893
       y2000 |   -1.71561   .0985521   -17.41   0.000    -1.908769   -1.522452
       _cons |  -1.476291    .079699   -18.52   0.000    -1.632498   -1.320084
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9040
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,587,206      100.00      100.00
------------+-----------------------------------
      Total |  1,587,206      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    528,804       33.32       33.32
          3 |  1,058,402       66.68      100.00
------------+-----------------------------------
      Total |  1,587,206      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(528,804 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(528,804 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(528,804 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000i not found)
file /tmp/St32493.00000i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,275       19.99       19.99
       1980 |      1,275       19.99       39.98
       1990 |      1,276       20.01       59.99
       2000 |      1,276       20.01       79.99
       2007 |      1,276       20.01      100.00
------------+-----------------------------------
      Total |      6,378      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,102 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,276 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,276 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,102 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,276 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,232 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,102 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,276 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,808
        from master                     2,594  (_merge==1)
        from using                        214  (_merge==2)

    matched                             3,784  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,594       39.35       39.35
         using only (2) |        214        3.25       42.60
            matched (3) |      3,784       57.40      100.00
------------------------+-----------------------------------
                  Total |      6,592      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,275          0          0 |     1,275 
      1980 |        15         72      1,260 |     1,347 
      1990 |        14         71      1,262 |     1,347 
      2000 |        14         71      1,262 |     1,347 
      2007 |     1,276          0          0 |     1,276 
-----------+---------------------------------+----------
     Total |     2,594        214      3,784 |     6,592 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,764 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9531e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,261
                                                  Wald chi2(1)    =       0.23
                                                  Prob > chi2     =     0.6306
                                                  R-squared       =          .
                                                  Root MSE        =     2.0173

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0392595   .0816381    -0.48   0.631    -.1992673    .1207483
       _cons |  -1.364643   .1075569   -12.69   0.000    -1.575451   -1.153835
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9483e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,261
                                                  Wald chi2(1)    =       1.66
                                                  Prob > chi2     =     0.1971
                                                  R-squared       =          .
                                                  Root MSE        =     2.5936

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0713405    .055304    -1.29   0.197    -.1797343    .0370533
       _cons |  -2.940217   .1317178   -22.32   0.000    -3.198379   -2.682055
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9901e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,522
                                                  Wald chi2(2)    =     328.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1125
                                                  Root MSE        =     2.3243

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0627907   .0441589    -1.42   0.155    -.1493405    .0237592
       y2000 |  -1.618845   .1001066   -16.17   0.000     -1.81505   -1.422639
       _cons |  -1.338318   .0819971   -16.32   0.000     -1.49903   -1.177607
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9045
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,514,555      100.00      100.00
------------+-----------------------------------
      Total |  1,514,555      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    504,587       33.32       33.32
          3 |  1,009,968       66.68      100.00
------------+-----------------------------------
      Total |  1,514,555      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(504,587 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(504,587 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(504,587 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000k not found)
file /tmp/St32493.00000k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,259       19.99       19.99
       1980 |      1,259       19.99       39.98
       1990 |      1,260       20.01       59.99
       2000 |      1,260       20.01       79.99
       2007 |      1,260       20.01      100.00
------------+-----------------------------------
      Total |      6,298      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,038 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,260 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,260 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,038 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,260 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,217 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,038 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,260 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,605
        from master                     2,544  (_merge==1)
        from using                         61  (_merge==2)

    matched                             3,754  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,544       40.01       40.01
         using only (2) |         61        0.96       40.97
            matched (3) |      3,754       59.03      100.00
------------------------+-----------------------------------
                  Total |      6,359      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,259          0          0 |     1,259 
      1980 |         9         21      1,250 |     1,280 
      1990 |         8         20      1,252 |     1,280 
      2000 |         8         20      1,252 |     1,280 
      2007 |     1,260          0          0 |     1,260 
-----------+---------------------------------+----------
     Total |     2,544         61      3,754 |     6,359 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,579 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9615e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,251
                                                  Wald chi2(1)    =       1.38
                                                  Prob > chi2     =     0.2405
                                                  R-squared       =     0.0008
                                                  Root MSE        =     2.0048

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0755808   .0643996    -1.17   0.241    -.2018017    .0506401
       _cons |  -1.326935   .0918901   -14.44   0.000    -1.507036   -1.146834
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9621e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,251
                                                  Wald chi2(1)    =       6.36
                                                  Prob > chi2     =     0.0117
                                                  R-squared       =          .
                                                  Root MSE        =     2.6031

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1532295   .0607781    -2.52   0.012    -.2723523   -.0341066
       _cons |  -2.762466   .1448493   -19.07   0.000    -3.046366   -2.478567
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9924e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,502
                                                  Wald chi2(2)    =     329.88
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1117
                                                  Root MSE        =      2.323

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1278465    .043908    -2.91   0.004    -.2139045   -.0417884
       y2000 |  -1.546333   .1014567   -15.24   0.000    -1.745185   -1.347482
       _cons |  -1.268237   .0821309   -15.44   0.000     -1.42921   -1.107263
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9050
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,571,723      100.00      100.00
------------+-----------------------------------
      Total |  1,571,723      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    523,643       33.32       33.32
          3 |  1,048,080       66.68      100.00
------------+-----------------------------------
      Total |  1,571,723      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(523,643 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(523,643 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(523,643 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000m not found)
file /tmp/St32493.00000m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,246       19.99       19.99
       1980 |      1,246       19.99       39.98
       1990 |      1,247       20.01       59.99
       2000 |      1,247       20.01       79.99
       2007 |      1,247       20.01      100.00
------------+-----------------------------------
      Total |      6,233      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,986 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,247 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,247 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,986 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,247 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,205 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,986 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,247 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,792
        from master                     2,533  (_merge==1)
        from using                        259  (_merge==2)

    matched                             3,700  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,533       39.02       39.02
         using only (2) |        259        3.99       43.01
            matched (3) |      3,700       56.99      100.00
------------------------+-----------------------------------
                  Total |      6,492      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,246          0          0 |     1,246 
      1980 |        14         87      1,232 |     1,333 
      1990 |        13         86      1,234 |     1,333 
      2000 |        13         86      1,234 |     1,333 
      2007 |     1,247          0          0 |     1,247 
-----------+---------------------------------+----------
     Total |     2,533        259      3,700 |     6,492 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,751 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9613e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,233
                                                  Wald chi2(1)    =       0.62
                                                  Prob > chi2     =     0.4299
                                                  R-squared       =     0.0050
                                                  Root MSE        =     1.9989

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0532695   .0674828     0.79   0.430    -.0789943    .1855332
       _cons |  -1.465334   .0912019   -16.07   0.000    -1.644087   -1.286582
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9546e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,233
                                                  Wald chi2(1)    =       0.91
                                                  Prob > chi2     =     0.3395
                                                  R-squared       =          .
                                                  Root MSE        =     2.5998

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0488394    .051129    -0.96   0.339    -.1490505    .0513717
       _cons |    -2.9675   .1386952   -21.40   0.000    -3.239338   -2.695663
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9916e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,466
                                                  Wald chi2(2)    =     319.85
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1132
                                                  Root MSE        =     2.3204

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.022972   .0394339    -0.58   0.560    -.1002611    .0543171
       y2000 |  -1.642003   .1054341   -15.57   0.000     -1.84865   -1.435356
       _cons |  -1.384832   .0780953   -17.73   0.000    -1.537896   -1.231769
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9055
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,478,825      100.00      100.00
------------+-----------------------------------
      Total |  1,478,825      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    492,677       33.32       33.32
          3 |    986,148       66.68      100.00
------------+-----------------------------------
      Total |  1,478,825      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(492,677 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(492,677 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(492,677 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000o not found)
file /tmp/St32493.00000o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,230       19.99       19.99
       1980 |      1,230       19.99       39.98
       1990 |      1,231       20.01       59.99
       2000 |      1,231       20.01       79.99
       2007 |      1,231       20.01      100.00
------------+-----------------------------------
      Total |      6,153      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,922 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,231 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,231 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,922 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,231 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,189 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,922 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,231 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,544
        from master                     2,486  (_merge==1)
        from using                         58  (_merge==2)

    matched                             3,667  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,486       40.03       40.03
         using only (2) |         58        0.93       40.96
            matched (3) |      3,667       59.04      100.00
------------------------+-----------------------------------
                  Total |      6,211      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,230          0          0 |     1,230 
      1980 |         9         20      1,221 |     1,250 
      1990 |         8         19      1,223 |     1,250 
      2000 |         8         19      1,223 |     1,250 
      2007 |     1,231          0          0 |     1,231 
-----------+---------------------------------+----------
     Total |     2,486         58      3,667 |     6,211 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,518 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9664e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,222
                                                  Wald chi2(1)    =       0.03
                                                  Prob > chi2     =     0.8566
                                                  R-squared       =          .
                                                  Root MSE        =       1.99

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0120225   .0665167     0.18   0.857    -.1183478    .1423928
       _cons |  -1.428573   .1009412   -14.15   0.000    -1.626414   -1.230732
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9696e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,222
                                                  Wald chi2(1)    =       2.33
                                                  Prob > chi2     =     0.1268
                                                  R-squared       =          .
                                                  Root MSE        =      2.595

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0701742   .0459658    -1.53   0.127    -.1602655     .019917
       _cons |  -2.922807   .1238519   -23.60   0.000    -3.165552   -2.680062
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9936e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,444
                                                  Wald chi2(2)    =     317.36
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1129
                                                  Root MSE        =     2.3113

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0503946   .0362218    -1.39   0.164     -.121388    .0205988
       y2000 |  -1.615116   .0990678   -16.30   0.000    -1.809285   -1.420947
       _cons |  -1.350352   .0802047   -16.84   0.000     -1.50755   -1.193154
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9060
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,556,240      100.00      100.00
------------+-----------------------------------
      Total |  1,556,240      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    518,482       33.32       33.32
          3 |  1,037,758       66.68      100.00
------------+-----------------------------------
      Total |  1,556,240      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(518,482 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(518,482 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(518,482 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000q not found)
file /tmp/St32493.00000q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,216       19.99       19.99
       1980 |      1,216       19.99       39.98
       1990 |      1,217       20.01       59.99
       2000 |      1,217       20.01       79.99
       2007 |      1,217       20.01      100.00
------------+-----------------------------------
      Total |      6,083      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,866 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,217 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,217 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,866 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,217 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,176 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,866 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,217 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,789
        from master                     2,476  (_merge==1)
        from using                        313  (_merge==2)

    matched                             3,607  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,476       38.71       38.71
         using only (2) |        313        4.89       43.61
            matched (3) |      3,607       56.39      100.00
------------------------+-----------------------------------
                  Total |      6,396      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,216          0          0 |     1,216 
      1980 |        15        105      1,201 |     1,321 
      1990 |        14        104      1,203 |     1,321 
      2000 |        14        104      1,203 |     1,321 
      2007 |     1,217          0          0 |     1,217 
-----------+---------------------------------+----------
     Total |     2,476        313      3,607 |     6,396 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,745 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.3698e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,202
                                                  Wald chi2(1)    =       0.88
                                                  Prob > chi2     =     0.3479
                                                  R-squared       =          .
                                                  Root MSE        =     2.0024

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0738105   .0786284     0.94   0.348    -.0802984    .2279194
       _cons |  -1.412453    .106992   -13.20   0.000    -1.622154   -1.202753
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.3516e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,202
                                                  Wald chi2(1)    =       2.50
                                                  Prob > chi2     =     0.1140
                                                  R-squared       =     0.0011
                                                  Root MSE        =     2.6169

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0886449   .0560876    -1.58   0.114    -.1985746    .0212847
       _cons |  -2.858156   .1312769   -21.77   0.000    -3.115454   -2.600858
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.8721e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,404
                                                  Wald chi2(2)    =     322.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1188
                                                  Root MSE        =     2.3266

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0509317   .0437825    -1.16   0.245    -.1367438    .0348804
       y2000 |   -1.66081   .1007065   -16.49   0.000    -1.858191   -1.463429
       _cons |  -1.269567   .0837496   -15.16   0.000    -1.433714   -1.105421
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9065
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,550,285      100.00      100.00
------------+-----------------------------------
      Total |  1,550,285      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    516,497       33.32       33.32
          3 |  1,033,788       66.68      100.00
------------+-----------------------------------
      Total |  1,550,285      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(516,497 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(516,497 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(516,497 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000s not found)
file /tmp/St32493.00000s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,190       19.99       19.99
       1980 |      1,190       19.99       39.98
       1990 |      1,191       20.01       59.99
       2000 |      1,191       20.01       79.99
       2007 |      1,191       20.01      100.00
------------+-----------------------------------
      Total |      5,953      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,762 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,191 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,191 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,762 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,191 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,155 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,762 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,191 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,806
        from master                     2,427  (_merge==1)
        from using                        379  (_merge==2)

    matched                             3,526  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,427       38.33       38.33
         using only (2) |        379        5.99       44.31
            matched (3) |      3,526       55.69      100.00
------------------------+-----------------------------------
                  Total |      6,332      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,190          0          0 |     1,190 
      1980 |        16        127      1,174 |     1,317 
      1990 |        15        126      1,176 |     1,317 
      2000 |        15        126      1,176 |     1,317 
      2007 |     1,191          0          0 |     1,191 
-----------+---------------------------------+----------
     Total |     2,427        379      3,526 |     6,332 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,759 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9221e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,175
                                                  Wald chi2(1)    =       7.45
                                                  Prob > chi2     =     0.0063
                                                  R-squared       =          .
                                                  Root MSE        =     1.9847

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .1135438   .0416043     2.73   0.006      .032001    .1950867
       _cons |  -1.560862   .0795466   -19.62   0.000     -1.71677   -1.404954
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9201e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,175
                                                  Wald chi2(1)    =       1.40
                                                  Prob > chi2     =     0.2366
                                                  R-squared       =     0.0029
                                                  Root MSE        =     2.5609

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0678522    .057325    -1.18   0.237    -.1802072    .0445028
       _cons |  -2.919026   .1416037   -20.61   0.000    -3.196564   -2.641488
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9842e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,350
                                                  Wald chi2(2)    =     304.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1149
                                                  Root MSE        =     2.2895

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0027752   .0371016    -0.07   0.940    -.0754929    .0699425
       y2000 |  -1.647229   .0988702   -16.66   0.000    -1.841011   -1.453447
       _cons |  -1.408355   .0826247   -17.05   0.000    -1.570297   -1.246414
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9070
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,541,948      100.00      100.00
------------+-----------------------------------
      Total |  1,541,948      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    513,718       33.32       33.32
          3 |  1,028,230       66.68      100.00
------------+-----------------------------------
      Total |  1,541,948      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(513,718 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(513,718 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(513,718 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000u not found)
file /tmp/St32493.00000u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,178       19.99       19.99
       1980 |      1,178       19.99       39.98
       1990 |      1,179       20.01       59.99
       2000 |      1,179       20.01       79.99
       2007 |      1,179       20.01      100.00
------------+-----------------------------------
      Total |      5,893      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,714 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,179 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,179 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,714 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,179 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,146 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,714 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,179 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,803
        from master                     2,406  (_merge==1)
        from using                        397  (_merge==2)

    matched                             3,487  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,406       38.25       38.25
         using only (2) |        397        6.31       44.56
            matched (3) |      3,487       55.44      100.00
------------------------+-----------------------------------
                  Total |      6,290      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,178          0          0 |     1,178 
      1980 |        17        133      1,161 |     1,311 
      1990 |        16        132      1,163 |     1,311 
      2000 |        16        132      1,163 |     1,311 
      2007 |     1,179          0          0 |     1,179 
-----------+---------------------------------+----------
     Total |     2,406        397      3,487 |     6,290 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,753 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.8964e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,162
                                                  Wald chi2(1)    =       0.93
                                                  Prob > chi2     =     0.3358
                                                  R-squared       =     0.0062
                                                  Root MSE        =     1.9662

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0667155   .0693181     0.96   0.336    -.0691456    .2025765
       _cons |  -1.473543    .094273   -15.63   0.000    -1.658314   -1.288771
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8941e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,162
                                                  Wald chi2(1)    =       0.59
                                                  Prob > chi2     =     0.4427
                                                  R-squared       =     0.0023
                                                  Root MSE        =     2.5637

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0382792   .0498701    -0.77   0.443    -.1360228    .0594644
       _cons |  -2.980862   .1328924   -22.43   0.000    -3.241326   -2.720398
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9791e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,324
                                                  Wald chi2(2)    =     306.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1166
                                                  Root MSE        =     2.2888

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0140611   .0389852    -0.36   0.718    -.0904708    .0623485
       y2000 |   -1.64742    .104535   -15.76   0.000    -1.852305   -1.442535
       _cons |  -1.386649   .0791618   -17.52   0.000    -1.541804   -1.231495
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9075
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,530,038      100.00      100.00
------------+-----------------------------------
      Total |  1,530,038      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    509,748       33.32       33.32
          3 |  1,020,290       66.68      100.00
------------+-----------------------------------
      Total |  1,530,038      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(509,748 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(509,748 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(509,748 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00000w not found)
file /tmp/St32493.00000w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,159       19.99       19.99
       1980 |      1,159       19.99       39.98
       1990 |      1,160       20.01       59.99
       2000 |      1,160       20.01       79.99
       2007 |      1,160       20.01      100.00
------------+-----------------------------------
      Total |      5,798      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,638 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,160 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,160 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,638 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,160 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,129 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,638 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,160 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,792
        from master                     2,368  (_merge==1)
        from using                        424  (_merge==2)

    matched                             3,430  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,368       38.06       38.06
         using only (2) |        424        6.81       44.87
            matched (3) |      3,430       55.13      100.00
------------------------+-----------------------------------
                  Total |      6,222      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,159          0          0 |     1,159 
      1980 |        17        142      1,142 |     1,301 
      1990 |        16        141      1,144 |     1,301 
      2000 |        16        141      1,144 |     1,301 
      2007 |     1,160          0          0 |     1,160 
-----------+---------------------------------+----------
     Total |     2,368        424      3,430 |     6,222 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,742 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9252e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,143
                                                  Wald chi2(1)    =       1.08
                                                  Prob > chi2     =     0.2987
                                                  R-squared       =     0.0039
                                                  Root MSE        =     1.9556

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0531809   .0511715     1.04   0.299    -.0471135    .1534753
       _cons |  -1.473927   .0851727   -17.31   0.000    -1.640862   -1.306991
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9270e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,143
                                                  Wald chi2(1)    =       3.60
                                                  Prob > chi2     =     0.0579
                                                  R-squared       =          .
                                                  Root MSE        =     2.5612

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0849351    .044786     1.90   0.058    -.0028439     .172714
       _cons |   -3.25152   .1179942   -27.56   0.000    -3.482784   -3.020256
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9852e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,286
                                                  Wald chi2(2)    =     312.67
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1198
                                                  Root MSE        =     2.2781

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0754499   .0331279     2.28   0.023     .0105205    .1403793
       y2000 |  -1.731227   .0988942   -17.51   0.000    -1.925056   -1.537398
       _cons |  -1.501134   .0786067   -19.10   0.000      -1.6552   -1.347068
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9080
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,519,319      100.00      100.00
------------+-----------------------------------
      Total |  1,519,319      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    506,175       33.32       33.32
          3 |  1,013,144       66.68      100.00
------------+-----------------------------------
      Total |  1,519,319      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(506,175 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(506,175 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(506,175 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000010 not found)
file /tmp/St32493.000010 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,141       19.99       19.99
       1980 |      1,141       19.99       39.98
       1990 |      1,142       20.01       59.99
       2000 |      1,142       20.01       79.99
       2007 |      1,142       20.01      100.00
------------+-----------------------------------
      Total |      5,708      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,566 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,142 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,142 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,566 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,142 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,111 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,566 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,142 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,783
        from master                     2,332  (_merge==1)
        from using                        451  (_merge==2)

    matched                             3,376  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,332       37.86       37.86
         using only (2) |        451        7.32       45.19
            matched (3) |      3,376       54.81      100.00
------------------------+-----------------------------------
                  Total |      6,159      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,141          0          0 |     1,141 
      1980 |        17        151      1,124 |     1,292 
      1990 |        16        150      1,126 |     1,292 
      2000 |        16        150      1,126 |     1,292 
      2007 |     1,142          0          0 |     1,142 
-----------+---------------------------------+----------
     Total |     2,332        451      3,376 |     6,159 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,733 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9192e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,125
                                                  Wald chi2(1)    =       4.35
                                                  Prob > chi2     =     0.0371
                                                  R-squared       =          .
                                                  Root MSE        =      1.948

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0977049   .0468598     2.09   0.037     .0058615    .1895484
       _cons |  -1.527411   .0847852   -18.02   0.000    -1.693586   -1.361235
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9139e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,125
                                                  Wald chi2(1)    =       5.51
                                                  Prob > chi2     =     0.0189
                                                  R-squared       =     0.0060
                                                  Root MSE        =     2.5265

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .1367343   .0582588     2.35   0.019     .0225491    .2509195
       _cons |  -3.343121   .1393111   -24.00   0.000    -3.616165   -3.070076
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9833e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,250
                                                  Wald chi2(2)    =     316.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1150
                                                  Root MSE        =     2.2596

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .1242589   .0394803     3.15   0.002      .046879    .2016388
       y2000 |  -1.755613   .0991263   -17.71   0.000    -1.949897   -1.561329
       _cons |  -1.562413   .0851199   -18.36   0.000    -1.729245   -1.395581
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9085
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,514,555      100.00      100.00
------------+-----------------------------------
      Total |  1,514,555      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    504,587       33.32       33.32
          3 |  1,009,968       66.68      100.00
------------+-----------------------------------
      Total |  1,514,555      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(504,587 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(504,587 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(504,587 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000012 not found)
file /tmp/St32493.000012 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,115       19.99       19.99
       1980 |      1,115       19.99       39.98
       1990 |      1,116       20.01       59.99
       2000 |      1,116       20.01       79.99
       2007 |      1,116       20.01      100.00
------------+-----------------------------------
      Total |      5,578      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,462 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,116 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,116 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,462 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,116 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,086 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,462 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,116 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,797
        from master                     2,280  (_merge==1)
        from using                        517  (_merge==2)

    matched                             3,298  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,280       37.41       37.41
         using only (2) |        517        8.48       45.89
            matched (3) |      3,298       54.11      100.00
------------------------+-----------------------------------
                  Total |      6,095      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,115          0          0 |     1,115 
      1980 |        17        173      1,098 |     1,288 
      1990 |        16        172      1,100 |     1,288 
      2000 |        16        172      1,100 |     1,288 
      2007 |     1,116          0          0 |     1,116 
-----------+---------------------------------+----------
     Total |     2,280        517      3,298 |     6,095 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,747 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9077e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,099
                                                  Wald chi2(1)    =       3.51
                                                  Prob > chi2     =     0.0611
                                                  R-squared       =     0.0007
                                                  Root MSE        =     1.9365

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.096192   .0513721    -1.87   0.061    -.1968796    .0044955
       _cons |  -1.277036   .0922364   -13.85   0.000    -1.457816   -1.096256
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9114e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,099
                                                  Wald chi2(1)    =       0.39
                                                  Prob > chi2     =     0.5338
                                                  R-squared       =          .
                                                  Root MSE        =     2.5506

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0254613   .0409251    -0.62   0.534    -.1056731    .0547504
       _cons |  -3.010477   .1178024   -25.56   0.000    -3.241365   -2.779589
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9819e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,198
                                                  Wald chi2(2)    =     295.33
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1162
                                                  Root MSE        =     2.2654

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0435553   .0311134    -1.40   0.162    -.1045365    .0174258
       y2000 |  -1.620861   .0997209   -16.25   0.000     -1.81631   -1.425411
       _cons |  -1.350175   .0808689   -16.70   0.000    -1.508675   -1.191675
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9090
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,505,027      100.00      100.00
------------+-----------------------------------
      Total |  1,505,027      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    501,411       33.32       33.32
          3 |  1,003,616       66.68      100.00
------------+-----------------------------------
      Total |  1,505,027      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(501,411 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(501,411 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(501,411 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000014 not found)
file /tmp/St32493.000014 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,091       20.00       20.00
       1980 |      1,091       20.00       40.00
       1990 |      1,091       20.00       60.00
       2000 |      1,091       20.00       80.00
       2007 |      1,091       20.00      100.00
------------+-----------------------------------
      Total |      5,455      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,364 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,091 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,091 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,364 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,091 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,063 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,364 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,091 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,792
        from master                     2,228  (_merge==1)
        from using                        564  (_merge==2)

    matched                             3,227  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,228       37.02       37.02
         using only (2) |        564        9.37       46.39
            matched (3) |      3,227       53.61      100.00
------------------------+-----------------------------------
                  Total |      6,019      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,091          0          0 |     1,091 
      1980 |        16        188      1,075 |     1,279 
      1990 |        15        188      1,076 |     1,279 
      2000 |        15        188      1,076 |     1,279 
      2007 |     1,091          0          0 |     1,091 
-----------+---------------------------------+----------
     Total |     2,228        564      3,227 |     6,019 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,746 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.8869e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,075
                                                  Wald chi2(1)    =       0.94
                                                  Prob > chi2     =     0.3335
                                                  R-squared       =     0.0012
                                                  Root MSE        =     1.9438

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0584631   .0604484     0.97   0.333    -.0600135    .1769398
       _cons |  -1.475685   .0876778   -16.83   0.000     -1.64753    -1.30384
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8789e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,075
                                                  Wald chi2(1)    =       1.68
                                                  Prob > chi2     =     0.1956
                                                  R-squared       =          .
                                                  Root MSE        =     2.5418

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0651727   .0503527     1.29   0.196    -.0335167    .1638622
       _cons |  -3.200029    .123051   -26.01   0.000    -3.441205   -2.958854
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9766e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,150
                                                  Wald chi2(2)    =     293.24
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1181
                                                  Root MSE        =     2.2625

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0634025   .0378618     1.67   0.094    -.0108052    .1376102
       y2000 |  -1.715706   .1025143   -16.74   0.000    -1.916631   -1.514782
       _cons |  -1.480963   .0799799   -18.52   0.000    -1.637721   -1.324206
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9095
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,500,263      100.00      100.00
------------+-----------------------------------
      Total |  1,500,263      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    499,823       33.32       33.32
          3 |  1,000,440       66.68      100.00
------------+-----------------------------------
      Total |  1,500,263      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(499,823 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(499,823 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(499,823 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000016 not found)
file /tmp/St32493.000016 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,062       20.00       20.00
       1980 |      1,062       20.00       40.00
       1990 |      1,062       20.00       60.00
       2000 |      1,062       20.00       80.00
       2007 |      1,062       20.00      100.00
------------+-----------------------------------
      Total |      5,310      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,248 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,062 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,062 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,248 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,062 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,037 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,248 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,062 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,809
        from master                     2,170  (_merge==1)
        from using                        639  (_merge==2)

    matched                             3,140  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,170       36.48       36.48
         using only (2) |        639       10.74       47.22
            matched (3) |      3,140       52.78      100.00
------------------------+-----------------------------------
                  Total |      5,949      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,062          0          0 |     1,062 
      1980 |        16        213      1,046 |     1,275 
      1990 |        15        213      1,047 |     1,275 
      2000 |        15        213      1,047 |     1,275 
      2007 |     1,062          0          0 |     1,062 
-----------+---------------------------------+----------
     Total |     2,170        639      3,140 |     5,949 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,763 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9312e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,046
                                                  Wald chi2(1)    =       3.98
                                                  Prob > chi2     =     0.0460
                                                  R-squared       =          .
                                                  Root MSE        =      1.935

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0891587   .0446874     2.00   0.046      .001573    .1767444
       _cons |  -1.505646   .0790519   -19.05   0.000    -1.660585   -1.350707
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9315e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,046
                                                  Wald chi2(1)    =       2.76
                                                  Prob > chi2     =     0.0967
                                                  R-squared       =     0.0027
                                                  Root MSE        =     2.5208

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0883215   .0531746    -1.66   0.097    -.1925418    .0158987
       _cons |  -2.912239   .1274764   -22.85   0.000    -3.162088    -2.66239
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9863e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,092
                                                  Wald chi2(2)    =     293.07
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1234
                                                  Root MSE        =     2.2432

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0299839    .036041    -0.83   0.405     -.100623    .0406551
       y2000 |   -1.65501   .1016576   -16.28   0.000    -1.854255   -1.455765
       _cons |  -1.367895   .0809146   -16.91   0.000    -1.526485   -1.209305
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9100
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,493,117      100.00      100.00
------------+-----------------------------------
      Total |  1,493,117      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    497,441       33.32       33.32
          3 |    995,676       66.68      100.00
------------+-----------------------------------
      Total |  1,493,117      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(497,441 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(497,441 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(497,441 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000018 not found)
file /tmp/St32493.000018 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,043       20.00       20.00
       1980 |      1,043       20.00       40.00
       1990 |      1,043       20.00       60.00
       2000 |      1,043       20.00       80.00
       2007 |      1,043       20.00      100.00
------------+-----------------------------------
      Total |      5,215      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,172 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,043 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,043 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,172 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,043 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,019 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,172 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,043 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,816
        from master                     2,135  (_merge==1)
        from using                        681  (_merge==2)

    matched                             3,080  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,135       36.21       36.21
         using only (2) |        681       11.55       47.76
            matched (3) |      3,080       52.24      100.00
------------------------+-----------------------------------
                  Total |      5,896      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,043          0          0 |     1,043 
      1980 |        17        227      1,026 |     1,270 
      1990 |        16        227      1,027 |     1,270 
      2000 |        16        227      1,027 |     1,270 
      2007 |     1,043          0          0 |     1,043 
-----------+---------------------------------+----------
     Total |     2,135        681      3,080 |     5,896 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,767 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9031e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,026
                                                  Wald chi2(1)    =       0.47
                                                  Prob > chi2     =     0.4947
                                                  R-squared       =     0.0002
                                                  Root MSE        =     1.9054

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0399357   .0584866     0.68   0.495    -.0746959    .1545674
       _cons |  -1.458321   .0854804   -17.06   0.000    -1.625859   -1.290782
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9018e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,026
                                                  Wald chi2(1)    =       1.81
                                                  Prob > chi2     =     0.1779
                                                  R-squared       =     0.0027
                                                  Root MSE        =     2.5094

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0744901   .0552927     1.35   0.178    -.0338815    .1828618
       _cons |  -3.209302    .124341   -25.81   0.000    -3.453005   -2.965598
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9805e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,052
                                                  Wald chi2(2)    =     288.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1232
                                                  Root MSE        =     2.2285

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0648734   .0402268     1.61   0.107    -.0139697    .1437166
       y2000 |  -1.708013   .1023026   -16.70   0.000    -1.908523   -1.507504
       _cons |  -1.484495   .0813791   -18.24   0.000    -1.643995   -1.324995
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9105
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,227,921      100.00      100.00
------------+-----------------------------------
      Total |  1,227,921      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    409,307       33.33       33.33
          3 |    818,614       66.67      100.00
------------+-----------------------------------
      Total |  1,227,921      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(409,307 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(409,307 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(409,307 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001a not found)
file /tmp/St32493.00001a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,014       20.00       20.00
       1980 |      1,014       20.00       40.00
       1990 |      1,014       20.00       60.00
       2000 |      1,014       20.00       80.00
       2007 |      1,014       20.00      100.00
------------+-----------------------------------
      Total |      5,070      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,056 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,014 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,014 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,056 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,014 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(994 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,056 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,014 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,133
        from master                     2,055  (_merge==1)
        from using                         78  (_merge==2)

    matched                             3,015  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,055       39.92       39.92
         using only (2) |         78        1.52       41.43
            matched (3) |      3,015       58.57      100.00
------------------------+-----------------------------------
                  Total |      5,148      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |     1,014          0          0 |     1,014 
      1980 |         9         26      1,005 |     1,040 
      1990 |         9         26      1,005 |     1,040 
      2000 |         9         26      1,005 |     1,040 
      2007 |     1,014          0          0 |     1,014 
-----------+---------------------------------+----------
     Total |     2,055         78      3,015 |     5,148 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,106 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9269e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,004
                                                  Wald chi2(1)    =       1.59
                                                  Prob > chi2     =     0.2069
                                                  R-squared       =          .
                                                  Root MSE        =     1.9167

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |      .0594   .0470676     1.26   0.207    -.0328509    .1516508
       _cons |  -1.493972   .0885869   -16.86   0.000      -1.6676   -1.320345
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9287e-01)

Instrumental variables (2SLS) regression          Number of obs   =      1,004
                                                  Wald chi2(1)    =       0.01
                                                  Prob > chi2     =     0.9174
                                                  R-squared       =          .
                                                  Root MSE        =     2.5045

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0074332   .0716505    -0.10   0.917    -.1478656    .1329992
       _cons |  -3.059703   .1665852   -18.37   0.000    -3.386204   -2.733202
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9856e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,008
                                                  Wald chi2(2)    =     280.26
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1237
                                                  Root MSE        =     2.2257

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0172864    .044928     0.38   0.700    -.0707708    .1053436
       y2000 |  -1.674229   .1038209   -16.13   0.000    -1.877714   -1.470743
       _cons |  -1.436066   .0935469   -15.35   0.000    -1.619414   -1.252717
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9110
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,478,825      100.00      100.00
------------+-----------------------------------
      Total |  1,478,825      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    492,677       33.32       33.32
          3 |    986,148       66.68      100.00
------------+-----------------------------------
      Total |  1,478,825      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(492,677 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(492,677 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(492,677 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001c not found)
file /tmp/St32493.00001c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        999       20.00       20.00
       1980 |        999       20.00       40.00
       1990 |        999       20.00       60.00
       2000 |        999       20.00       80.00
       2007 |        999       20.00      100.00
------------+-----------------------------------
      Total |      4,995      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,996 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(999 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(999 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,996 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(999 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(979 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,996 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(999 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,818
        from master                     2,044  (_merge==1)
        from using                        774  (_merge==2)

    matched                             2,951  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,044       35.43       35.43
         using only (2) |        774       13.42       48.85
            matched (3) |      2,951       51.15      100.00
------------------------+-----------------------------------
                  Total |      5,769      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       999          0          0 |       999 
      1980 |        16        258        983 |     1,257 
      1990 |        15        258        984 |     1,257 
      2000 |        15        258        984 |     1,257 
      2007 |       999          0          0 |       999 
-----------+---------------------------------+----------
     Total |     2,044        774      2,951 |     5,769 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,772 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.8491e-01)

Instrumental variables (2SLS) regression          Number of obs   =        983
                                                  Wald chi2(1)    =       2.67
                                                  Prob > chi2     =     0.1021
                                                  R-squared       =          .
                                                  Root MSE        =     1.9234

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .1267406   .0775278     1.63   0.102    -.0252112    .2786924
       _cons |  -1.572044   .1171361   -13.42   0.000    -1.801627   -1.342462
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8387e-01)

Instrumental variables (2SLS) regression          Number of obs   =        983
                                                  Wald chi2(1)    =       1.04
                                                  Prob > chi2     =     0.3081
                                                  R-squared       =          .
                                                  Root MSE        =     2.4807

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0489804   .0480535     1.02   0.308    -.0452027    .1431635
       _cons |  -3.179028    .128126   -24.81   0.000    -3.430151   -2.927906
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9688e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,966
                                                  Wald chi2(2)    =     281.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1212
                                                  Root MSE        =     2.2158

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0680144   .0391022     1.74   0.082    -.0086245    .1446532
       y2000 |  -1.722489   .1048446   -16.43   0.000     -1.92798   -1.516997
       _cons |  -1.496456   .0867465   -17.25   0.000    -1.666476   -1.326436
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9115
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,470,488      100.00      100.00
------------+-----------------------------------
      Total |  1,470,488      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    489,898       33.32       33.32
          3 |    980,590       66.68      100.00
------------+-----------------------------------
      Total |  1,470,488      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(489,898 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(489,898 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(489,898 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001e not found)
file /tmp/St32493.00001e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        977       20.00       20.00
       1980 |        977       20.00       40.00
       1990 |        977       20.00       60.00
       2000 |        977       20.00       80.00
       2007 |        977       20.00      100.00
------------+-----------------------------------
      Total |      4,885      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,908 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(977 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(977 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,908 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(977 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(959 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,908 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(977 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,813
        from master                     1,997  (_merge==1)
        from using                        816  (_merge==2)

    matched                             2,888  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,997       35.03       35.03
         using only (2) |        816       14.31       49.34
            matched (3) |      2,888       50.66      100.00
------------------------+-----------------------------------
                  Total |      5,701      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       977          0          0 |       977 
      1980 |        15        272        962 |     1,249 
      1990 |        14        272        963 |     1,249 
      2000 |        14        272        963 |     1,249 
      2007 |       977          0          0 |       977 
-----------+---------------------------------+----------
     Total |     1,997        816      2,888 |     5,701 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,770 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9106e-01)

Instrumental variables (2SLS) regression          Number of obs   =        962
                                                  Wald chi2(1)    =      15.62
                                                  Prob > chi2     =     0.0001
                                                  R-squared       =          .
                                                  Root MSE        =     1.9133

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    .149122   .0377363     3.95   0.000     .0751602    .2230838
       _cons |  -1.589398   .0759156   -20.94   0.000     -1.73819   -1.440606
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9175e-01)

Instrumental variables (2SLS) regression          Number of obs   =        962
                                                  Wald chi2(1)    =       0.72
                                                  Prob > chi2     =     0.3951
                                                  R-squared       =          .
                                                  Root MSE        =     2.4909

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.056752   .0667291    -0.85   0.395    -.1875387    .0740347
       _cons |  -2.965947   .1514931   -19.58   0.000    -3.262868   -2.669026
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9828e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,924
                                                  Wald chi2(2)    =     271.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1234
                                                  Root MSE        =     2.2126

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0164376   .0412273     0.40   0.690    -.0643664    .0972416
       y2000 |  -1.673012   .1055505   -15.85   0.000    -1.879887   -1.466136
       _cons |  -1.433826   .0861837   -16.64   0.000    -1.602743   -1.264909
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9120
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,465,724      100.00      100.00
------------+-----------------------------------
      Total |  1,465,724      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    488,310       33.32       33.32
          3 |    977,414       66.68      100.00
------------+-----------------------------------
      Total |  1,465,724      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(488,310 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(488,310 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(488,310 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001g not found)
file /tmp/St32493.00001g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        960       20.00       20.00
       1980 |        960       20.00       40.00
       1990 |        960       20.00       60.00
       2000 |        960       20.00       80.00
       2007 |        960       20.00      100.00
------------+-----------------------------------
      Total |      4,800      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,840 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(960 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(960 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,840 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(960 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(945 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,840 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(960 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,812
        from master                     1,960  (_merge==1)
        from using                        852  (_merge==2)

    matched                             2,840  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,960       34.68       34.68
         using only (2) |        852       15.07       49.75
            matched (3) |      2,840       50.25      100.00
------------------------+-----------------------------------
                  Total |      5,652      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       960          0          0 |       960 
      1980 |        14        284        946 |     1,244 
      1990 |        13        284        947 |     1,244 
      2000 |        13        284        947 |     1,244 
      2007 |       960          0          0 |       960 
-----------+---------------------------------+----------
     Total |     1,960        852      2,840 |     5,652 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,772 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9275e-01)

Instrumental variables (2SLS) regression          Number of obs   =        946
                                                  Wald chi2(1)    =       0.83
                                                  Prob > chi2     =     0.3620
                                                  R-squared       =          .
                                                  Root MSE        =     1.8941

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0569407    .062467    -0.91   0.362    -.1793737    .0654923
       _cons |  -1.354357   .0919572   -14.73   0.000     -1.53459   -1.174124
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9338e-01)

Instrumental variables (2SLS) regression          Number of obs   =        946
                                                  Wald chi2(1)    =       1.39
                                                  Prob > chi2     =     0.2381
                                                  R-squared       =          .
                                                  Root MSE        =      2.492

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0638397   .0541112     1.18   0.238    -.0422163    .1698957
       _cons |  -3.197184   .1314164   -24.33   0.000    -3.454756   -2.939613
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9861e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,892
                                                  Wald chi2(2)    =     267.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1225
                                                  Root MSE        =     2.2082

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0328551   .0402438     0.82   0.414    -.0460214    .1117315
       y2000 |  -1.685412   .1067483   -15.79   0.000    -1.894634   -1.476189
       _cons |  -1.452526   .0842131   -17.25   0.000     -1.61758   -1.287471
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9125
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,133,832      100.00      100.00
------------+-----------------------------------
      Total |  1,133,832      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    377,944       33.33       33.33
          3 |    755,888       66.67      100.00
------------+-----------------------------------
      Total |  1,133,832      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(377,944 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(377,944 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(377,944 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001i not found)
file /tmp/St32493.00001i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        941       20.00       20.00
       1980 |        941       20.00       40.00
       1990 |        941       20.00       60.00
       2000 |        941       20.00       80.00
       2007 |        941       20.00      100.00
------------+-----------------------------------
      Total |      4,705      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,764 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(941 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(941 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,764 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(941 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(928 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,764 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(941 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,957
        from master                     1,903  (_merge==1)
        from using                         54  (_merge==2)

    matched                             2,802  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,903       39.99       39.99
         using only (2) |         54        1.13       41.12
            matched (3) |      2,802       58.88      100.00
------------------------+-----------------------------------
                  Total |      4,759      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       941          0          0 |       941 
      1980 |         7         18        934 |       959 
      1990 |         7         18        934 |       959 
      2000 |         7         18        934 |       959 
      2007 |       941          0          0 |       941 
-----------+---------------------------------+----------
     Total |     1,903         54      2,802 |     4,759 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,936 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9484e-01)

Instrumental variables (2SLS) regression          Number of obs   =        933
                                                  Wald chi2(1)    =       0.46
                                                  Prob > chi2     =     0.4977
                                                  R-squared       =          .
                                                  Root MSE        =     1.8929

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0276715   .0408021     0.68   0.498    -.0522992    .1076422
       _cons |   -1.44191    .079054   -18.24   0.000    -1.596853   -1.286967
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9515e-01)

Instrumental variables (2SLS) regression          Number of obs   =        933
                                                  Wald chi2(1)    =       0.34
                                                  Prob > chi2     =     0.5589
                                                  R-squared       =     0.0008
                                                  Root MSE        =     2.4593

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0158749   .0271595     0.58   0.559    -.0373568    .0691066
       _cons |  -3.111126   .0992432   -31.35   0.000    -3.305639   -2.916613
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9900e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,866
                                                  Wald chi2(2)    =     270.45
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1266
                                                  Root MSE        =     2.1943

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0179793   .0216224     0.83   0.406    -.0243999    .0603585
       y2000 |  -1.685371   .1035786   -16.27   0.000    -1.888381   -1.482361
       _cons |  -1.430251   .0764066   -18.72   0.000    -1.580005   -1.280496
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9130
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,111,203      100.00      100.00
------------+-----------------------------------
      Total |  1,111,203      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    370,401       33.33       33.33
          3 |    740,802       66.67      100.00
------------+-----------------------------------
      Total |  1,111,203      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(370,401 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(370,401 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(370,401 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001k not found)
file /tmp/St32493.00001k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        914       20.00       20.00
       1980 |        914       20.00       40.00
       1990 |        914       20.00       60.00
       2000 |        914       20.00       80.00
       2007 |        914       20.00      100.00
------------+-----------------------------------
      Total |      4,570      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,656 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(914 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(914 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,656 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(914 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(901 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,656 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(914 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,939
        from master                     1,855  (_merge==1)
        from using                         84  (_merge==2)

    matched                             2,715  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,855       39.86       39.86
         using only (2) |         84        1.80       41.66
            matched (3) |      2,715       58.34      100.00
------------------------+-----------------------------------
                  Total |      4,654      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       914          0          0 |       914 
      1980 |         9         28        905 |       942 
      1990 |         9         28        905 |       942 
      2000 |         9         28        905 |       942 
      2007 |       914          0          0 |       914 
-----------+---------------------------------+----------
     Total |     1,855         84      2,715 |     4,654 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,912 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.8548e-01)

Instrumental variables (2SLS) regression          Number of obs   =        904
                                                  Wald chi2(1)    =       2.63
                                                  Prob > chi2     =     0.1050
                                                  R-squared       =     0.0035
                                                  Root MSE        =     1.8902

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0762345   .0470282     1.62   0.105    -.0159391    .1684081
       _cons |  -1.512882   .0874343   -17.30   0.000     -1.68425   -1.341514
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8552e-01)

Instrumental variables (2SLS) regression          Number of obs   =        904
                                                  Wald chi2(1)    =       2.11
                                                  Prob > chi2     =     0.1459
                                                  R-squared       =          .
                                                  Root MSE        =     2.4515

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0796525   .0547719     1.45   0.146    -.0276985    .1870035
       _cons |  -3.245674   .1379175   -23.53   0.000    -3.515987    -2.97536
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9710e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,808
                                                  Wald chi2(2)    =     267.36
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1279
                                                  Root MSE        =     2.1889

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0785351   .0374233     2.10   0.036     .0051867    .1518834
       y2000 |  -1.727549   .1066039   -16.21   0.000    -1.936489    -1.51861
       _cons |  -1.515855   .0873981   -17.34   0.000    -1.687152   -1.344558
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9135
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,439,522      100.00      100.00
------------+-----------------------------------
      Total |  1,439,522      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    479,576       33.31       33.31
          3 |    959,946       66.69      100.00
------------+-----------------------------------
      Total |  1,439,522      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(479,576 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(479,576 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(479,576 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001m not found)
file /tmp/St32493.00001m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        900       20.00       20.00
       1980 |        900       20.00       40.00
       1990 |        900       20.00       60.00
       2000 |        900       20.00       80.00
       2007 |        900       20.00      100.00
------------+-----------------------------------
      Total |      4,500      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,600 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(900 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(900 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,600 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(900 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(888 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,600 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(900 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,818
        from master                     1,846  (_merge==1)
        from using                        972  (_merge==2)

    matched                             2,654  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,846       33.74       33.74
         using only (2) |        972       17.76       51.50
            matched (3) |      2,654       48.50      100.00
------------------------+-----------------------------------
                  Total |      5,472      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       900          0          0 |       900 
      1980 |        16        324        884 |     1,224 
      1990 |        15        324        885 |     1,224 
      2000 |        15        324        885 |     1,224 
      2007 |       900          0          0 |       900 
-----------+---------------------------------+----------
     Total |     1,846        972      2,654 |     5,472 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,772 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9226e-01)

Instrumental variables (2SLS) regression          Number of obs   =        884
                                                  Wald chi2(1)    =       4.72
                                                  Prob > chi2     =     0.0297
                                                  R-squared       =          .
                                                  Root MSE        =     1.8838

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .1200923   .0552509     2.17   0.030     .0118024    .2283821
       _cons |  -1.551628   .0859848   -18.05   0.000    -1.720155   -1.383101
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9228e-01)

Instrumental variables (2SLS) regression          Number of obs   =        884
                                                  Wald chi2(1)    =       1.55
                                                  Prob > chi2     =     0.2130
                                                  R-squared       =          .
                                                  Root MSE        =     2.4388

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0701867     .05636    -1.25   0.213    -.1806503    .0402769
       _cons |  -2.943005   .1343556   -21.90   0.000    -3.206337   -2.679673
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9845e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,768
                                                  Wald chi2(2)    =     254.39
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1255
                                                  Root MSE        =     2.1759

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.015589   .0402606    -0.39   0.699    -.0944982    .0633202
       y2000 |  -1.637209   .1088308   -15.04   0.000    -1.850514   -1.423905
       _cons |  -1.408878   .0845577   -16.66   0.000    -1.574608   -1.243148
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9140
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,062,372      100.00      100.00
------------+-----------------------------------
      Total |  1,062,372      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    354,124       33.33       33.33
          3 |    708,248       66.67      100.00
------------+-----------------------------------
      Total |  1,062,372      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(354,124 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(354,124 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(354,124 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001o not found)
file /tmp/St32493.00001o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        871       20.00       20.00
       1980 |        871       20.00       40.00
       1990 |        871       20.00       60.00
       2000 |        871       20.00       80.00
       2007 |        871       20.00      100.00
------------+-----------------------------------
      Total |      4,355      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,484 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(871 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(871 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,484 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(871 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(861 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,484 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(871 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,865
        from master                     1,772  (_merge==1)
        from using                         93  (_merge==2)

    matched                             2,583  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,772       39.84       39.84
         using only (2) |         93        2.09       41.93
            matched (3) |      2,583       58.07      100.00
------------------------+-----------------------------------
                  Total |      4,448      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       871          0          0 |       871 
      1980 |        10         31        861 |       902 
      1990 |        10         31        861 |       902 
      2000 |        10         31        861 |       902 
      2007 |       871          0          0 |       871 
-----------+---------------------------------+----------
     Total |     1,772         93      2,583 |     4,448 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,835 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9303e-01)

Instrumental variables (2SLS) regression          Number of obs   =        860
                                                  Wald chi2(1)    =       0.96
                                                  Prob > chi2     =     0.3264
                                                  R-squared       =     0.0045
                                                  Root MSE        =     1.8583

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0719006    .073262     0.98   0.326    -.0716903    .2154915
       _cons |  -1.485132   .1066485   -13.93   0.000    -1.694159   -1.276105
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9309e-01)

Instrumental variables (2SLS) regression          Number of obs   =        860
                                                  Wald chi2(1)    =       2.63
                                                  Prob > chi2     =     0.1051
                                                  R-squared       =     0.0022
                                                  Root MSE        =     2.3556

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0957546   .0590856    -1.62   0.105    -.2115602    .0200511
       _cons |  -2.855492    .145344   -19.65   0.000    -3.140361   -2.570623
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9861e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,720
                                                  Wald chi2(2)    =     260.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1303
                                                  Root MSE        =     2.1259

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0490368   .0449992    -1.09   0.276    -.1372335    .0391599
       y2000 |  -1.607739   .1098881   -14.63   0.000    -1.823116   -1.392363
       _cons |  -1.343529   .0896172   -14.99   0.000    -1.519176   -1.167883
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9145
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,418,084      100.00      100.00
------------+-----------------------------------
      Total |  1,418,084      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    472,430       33.31       33.31
          3 |    945,654       66.69      100.00
------------+-----------------------------------
      Total |  1,418,084      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(472,430 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(472,430 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(472,430 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001q not found)
file /tmp/St32493.00001q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        855       20.00       20.00
       1980 |        855       20.00       40.00
       1990 |        855       20.00       60.00
       2000 |        855       20.00       80.00
       2007 |        855       20.00      100.00
------------+-----------------------------------
      Total |      4,275      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,420 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(855 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(855 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,420 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(855 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(848 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,420 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(855 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,803
        from master                     1,753  (_merge==1)
        from using                      1,050  (_merge==2)

    matched                             2,522  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,753       32.92       32.92
         using only (2) |      1,050       19.72       52.64
            matched (3) |      2,522       47.36      100.00
------------------------+-----------------------------------
                  Total |      5,325      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       855          0          0 |       855 
      1980 |        15        350        840 |     1,205 
      1990 |        14        350        841 |     1,205 
      2000 |        14        350        841 |     1,205 
      2007 |       855          0          0 |       855 
-----------+---------------------------------+----------
     Total |     1,753      1,050      2,522 |     5,325 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,760 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.8392e-01)

Instrumental variables (2SLS) regression          Number of obs   =        840
                                                  Wald chi2(1)    =       2.29
                                                  Prob > chi2     =     0.1300
                                                  R-squared       =          .
                                                  Root MSE        =     1.8804

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0817483   .0539936     1.51   0.130    -.0240772    .1875739
       _cons |  -1.502704   .0883871   -17.00   0.000     -1.67594   -1.329469
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8408e-01)

Instrumental variables (2SLS) regression          Number of obs   =        840
                                                  Wald chi2(1)    =       2.17
                                                  Prob > chi2     =     0.1407
                                                  R-squared       =          .
                                                  Root MSE        =     2.3914

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0667913   .0453363     1.47   0.141    -.0220662    .1556488
       _cons |  -3.173642    .119742   -26.50   0.000    -3.408332   -2.938952
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9680e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,680
                                                  Wald chi2(2)    =     246.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1238
                                                  Root MSE        =     2.1508

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0705009   .0342739     2.06   0.040     .0033252    .1376765
       y2000 |  -1.690542     .10849   -15.58   0.000    -1.903178   -1.477905
       _cons |    -1.4902   .0834219   -17.86   0.000    -1.653704   -1.326696
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9150
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,007,586      100.00      100.00
------------+-----------------------------------
      Total |  1,007,586      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    335,862       33.33       33.33
          3 |    671,724       66.67      100.00
------------+-----------------------------------
      Total |  1,007,586      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(335,862 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(335,862 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(335,862 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001s not found)
file /tmp/St32493.00001s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        829       20.00       20.00
       1980 |        829       20.00       40.00
       1990 |        829       20.00       60.00
       2000 |        829       20.00       80.00
       2007 |        829       20.00      100.00
------------+-----------------------------------
      Total |      4,145      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,316 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(829 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(829 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,316 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(829 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(825 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,316 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(829 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,769
        from master                     1,688  (_merge==1)
        from using                         81  (_merge==2)

    matched                             2,457  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,688       39.94       39.94
         using only (2) |         81        1.92       41.86
            matched (3) |      2,457       58.14      100.00
------------------------+-----------------------------------
                  Total |      4,226      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       829          0          0 |       829 
      1980 |        10         27        819 |       856 
      1990 |        10         27        819 |       856 
      2000 |        10         27        819 |       856 
      2007 |       829          0          0 |       829 
-----------+---------------------------------+----------
     Total |     1,688         81      2,457 |     4,226 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,739 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9238e-01)

Instrumental variables (2SLS) regression          Number of obs   =        818
                                                  Wald chi2(1)    =       3.50
                                                  Prob > chi2     =     0.0613
                                                  R-squared       =          .
                                                  Root MSE        =     1.8675

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .1607224    .085898     1.87   0.061    -.0076345    .3290794
       _cons |  -1.604029   .1180219   -13.59   0.000    -1.835348    -1.37271
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9256e-01)

Instrumental variables (2SLS) regression          Number of obs   =        818
                                                  Wald chi2(1)    =       3.10
                                                  Prob > chi2     =     0.0785
                                                  R-squared       =          .
                                                  Root MSE        =     2.3911

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .1187216   .0674779     1.76   0.079    -.0135327    .2509759
       _cons |  -3.322689   .1582256   -21.00   0.000    -3.632805   -3.012572
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9849e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,636
                                                  Wald chi2(2)    =     253.20
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1299
                                                  Root MSE        =     2.1448

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .1300401   .0515931     2.52   0.012     .0289194    .2311608
       y2000 |   -1.77631    .114691   -15.49   0.000      -2.0011    -1.55152
       _cons |  -1.568912   .0954534   -16.44   0.000    -1.755997   -1.381826
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9155
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    967,092      100.00      100.00
------------+-----------------------------------
      Total |    967,092      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    322,364       33.33       33.33
          3 |    644,728       66.67      100.00
------------+-----------------------------------
      Total |    967,092      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(322,364 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(322,364 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(322,364 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001u not found)
file /tmp/St32493.00001u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        805       20.00       20.00
       1980 |        805       20.00       40.00
       1990 |        805       20.00       60.00
       2000 |        805       20.00       80.00
       2007 |        805       20.00      100.00
------------+-----------------------------------
      Total |      4,025      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,220 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(805 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(805 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,220 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(805 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(801 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,220 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(805 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,667
        from master                     1,628  (_merge==1)
        from using                         39  (_merge==2)

    matched                             2,397  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,628       40.06       40.06
         using only (2) |         39        0.96       41.02
            matched (3) |      2,397       58.98      100.00
------------------------+-----------------------------------
                  Total |      4,064      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       805          0          0 |       805 
      1980 |         6         13        799 |       818 
      1990 |         6         13        799 |       818 
      2000 |         6         13        799 |       818 
      2007 |       805          0          0 |       805 
-----------+---------------------------------+----------
     Total |     1,628         39      2,397 |     4,064 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,649 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9740e-01)

Instrumental variables (2SLS) regression          Number of obs   =        798
                                                  Wald chi2(1)    =       5.13
                                                  Prob > chi2     =     0.0235
                                                  R-squared       =          .
                                                  Root MSE        =     1.8131

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .2113124   .0933151     2.26   0.024     .0284182    .3942067
       _cons |   -1.63454   .1160142   -14.09   0.000    -1.861924   -1.407157
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9761e-01)

Instrumental variables (2SLS) regression          Number of obs   =        798
                                                  Wald chi2(1)    =       1.06
                                                  Prob > chi2     =     0.3035
                                                  R-squared       =          .
                                                  Root MSE        =     2.3827

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0725827   .0705399    -1.03   0.303    -.2108383    .0656729
       _cons |  -2.935136   .1592132   -18.44   0.000    -3.247188   -2.623084
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9950e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,596
                                                  Wald chi2(2)    =     244.95
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1331
                                                  Root MSE        =     2.1166

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0044744   .0543907     0.08   0.934    -.1021294    .1110782
       y2000 |  -1.662318   .1162413   -14.30   0.000    -1.890147    -1.43449
       _cons |  -1.420328   .0937427   -15.15   0.000     -1.60406   -1.236596
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9160
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    948,036      100.00      100.00
------------+-----------------------------------
      Total |    948,036      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    316,012       33.33       33.33
          3 |    632,024       66.67      100.00
------------+-----------------------------------
      Total |    948,036      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(316,012 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(316,012 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(316,012 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00001w not found)
file /tmp/St32493.00001w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        779       20.00       20.00
       1980 |        779       20.00       40.00
       1990 |        779       20.00       60.00
       2000 |        779       20.00       80.00
       2007 |        779       20.00      100.00
------------+-----------------------------------
      Total |      3,895      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,116 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(779 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(779 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,116 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(779 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(777 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,116 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(779 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,633
        from master                     1,570  (_merge==1)
        from using                         63  (_merge==2)

    matched                             2,325  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,570       39.67       39.67
         using only (2) |         63        1.59       41.26
            matched (3) |      2,325       58.74      100.00
------------------------+-----------------------------------
                  Total |      3,958      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       779          0          0 |       779 
      1980 |         4         21        775 |       800 
      1990 |         4         21        775 |       800 
      2000 |         4         21        775 |       800 
      2007 |       779          0          0 |       779 
-----------+---------------------------------+----------
     Total |     1,570         63      2,325 |     3,958 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,621 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9703e-01)

Instrumental variables (2SLS) regression          Number of obs   =        774
                                                  Wald chi2(1)    =       2.25
                                                  Prob > chi2     =     0.1336
                                                  R-squared       =          .
                                                  Root MSE        =     1.8546

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0979857    .065318    -1.50   0.134    -.2260068    .0300353
       _cons |  -1.276938   .1141767   -11.18   0.000     -1.50072   -1.053156
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9705e-01)

Instrumental variables (2SLS) regression          Number of obs   =        774
                                                  Wald chi2(1)    =       3.20
                                                  Prob > chi2     =     0.0737
                                                  R-squared       =     0.0005
                                                  Root MSE        =      2.376

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    .126387   .0706728     1.79   0.074    -.0121292    .2649032
       _cons |  -3.350814   .1739518   -19.26   0.000    -3.691753   -3.009875
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9941e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,548
                                                  Wald chi2(2)    =     237.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1331
                                                  Root MSE        =     2.1275

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0485005   .0488198     0.99   0.320    -.0471845    .1441855
       y2000 |  -1.698981   .1137939   -14.93   0.000    -1.922013   -1.475949
       _cons |  -1.484821   .1031884   -14.39   0.000    -1.687066   -1.282575
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9165
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    909,924      100.00      100.00
------------+-----------------------------------
      Total |    909,924      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    303,308       33.33       33.33
          3 |    606,616       66.67      100.00
------------+-----------------------------------
      Total |    909,924      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(303,308 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(303,308 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(303,308 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000020 not found)
file /tmp/St32493.000020 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        738       20.00       20.00
       1980 |        738       20.00       40.00
       1990 |        738       20.00       60.00
       2000 |        738       20.00       80.00
       2007 |        738       20.00      100.00
------------+-----------------------------------
      Total |      3,690      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,952 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(738 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(738 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,952 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(738 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(737 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,952 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(738 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,572
        from master                     1,485  (_merge==1)
        from using                         87  (_merge==2)

    matched                             2,205  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,485       39.32       39.32
         using only (2) |         87        2.30       41.62
            matched (3) |      2,205       58.38      100.00
------------------------+-----------------------------------
                  Total |      3,777      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       738          0          0 |       738 
      1980 |         3         29        735 |       767 
      1990 |         3         29        735 |       767 
      2000 |         3         29        735 |       767 
      2007 |       738          0          0 |       738 
-----------+---------------------------------+----------
     Total |     1,485         87      2,205 |     3,777 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,563 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9840e-01)

Instrumental variables (2SLS) regression          Number of obs   =        734
                                                  Wald chi2(1)    =       7.63
                                                  Prob > chi2     =     0.0057
                                                  R-squared       =          .
                                                  Root MSE        =     1.8387

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1827421   .0661584    -2.76   0.006    -.3124102    -.053074
       _cons |   -1.18569   .1069931   -11.08   0.000    -1.395393   -.9759877
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9843e-01)

Instrumental variables (2SLS) regression          Number of obs   =        734
                                                  Wald chi2(1)    =       4.84
                                                  Prob > chi2     =     0.0278
                                                  R-squared       =          .
                                                  Root MSE        =     2.3658

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1439271   .0653993    -2.20   0.028    -.2721074   -.0157468
       _cons |  -2.721342   .1818035   -14.97   0.000     -3.07767   -2.365014
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9968e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,468
                                                  Wald chi2(2)    =     236.12
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1242
                                                  Root MSE        =     2.1195

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1576925   .0464886    -3.39   0.001    -.2488085   -.0665764
       y2000 |  -1.470771   .1236561   -11.89   0.000    -1.713133    -1.22841
       _cons |  -1.217008   .0974594   -12.49   0.000    -1.408025   -1.025991
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9170
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,381,163      100.00      100.00
------------+-----------------------------------
      Total |  1,381,163      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    460,123       33.31       33.31
          3 |    921,040       66.69      100.00
------------+-----------------------------------
      Total |  1,381,163      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(460,123 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(460,123 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(460,123 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000022 not found)
file /tmp/St32493.000022 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        725       20.00       20.00
       1980 |        725       20.00       40.00
       1990 |        725       20.00       60.00
       2000 |        725       20.00       80.00
       2007 |        725       20.00      100.00
------------+-----------------------------------
      Total |      3,625      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,900 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(725 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(725 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,900 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(725 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(725 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,900 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(725 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,852
        from master                     1,499  (_merge==1)
        from using                      1,353  (_merge==2)

    matched                             2,126  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,499       30.11       30.11
         using only (2) |      1,353       27.18       57.29
            matched (3) |      2,126       42.71      100.00
------------------------+-----------------------------------
                  Total |      4,978      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       725          0          0 |       725 
      1980 |        17        451        708 |     1,176 
      1990 |        16        451        709 |     1,176 
      2000 |        16        451        709 |     1,176 
      2007 |       725          0          0 |       725 
-----------+---------------------------------+----------
     Total |     1,499      1,353      2,126 |     4,978 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,803 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.8344e-01)

Instrumental variables (2SLS) regression          Number of obs   =        708
                                                  Wald chi2(1)    =       1.47
                                                  Prob > chi2     =     0.2246
                                                  R-squared       =     0.0022
                                                  Root MSE        =     1.7816

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0742478   .0611451    -1.21   0.225      -.19409    .0455943
       _cons |  -1.311257   .1002629   -13.08   0.000    -1.507769   -1.114745
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8377e-01)

Instrumental variables (2SLS) regression          Number of obs   =        708
                                                  Wald chi2(1)    =       1.15
                                                  Prob > chi2     =     0.2835
                                                  R-squared       =     0.0048
                                                  Root MSE        =     2.3469

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0660928     .06163    -1.07   0.284    -.1868855    .0546998
       _cons |  -2.939828   .1479807   -19.87   0.000    -3.229865   -2.649791
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9672e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,416
                                                  Wald chi2(2)    =     228.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1407
                                                  Root MSE        =     2.0834

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0684784   .0439937    -1.56   0.120    -.1547044    .0177476
       y2000 |   -1.61693   .1150213   -14.06   0.000    -1.842367   -1.391492
       _cons |  -1.318299   .0949465   -13.88   0.000     -1.50439   -1.132207
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9175
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    853,947      100.00      100.00
------------+-----------------------------------
      Total |    853,947      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    284,649       33.33       33.33
          3 |    569,298       66.67      100.00
------------+-----------------------------------
      Total |    853,947      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(284,649 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(284,649 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(284,649 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000024 not found)
file /tmp/St32493.000024 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        707       20.00       20.00
       1980 |        707       20.00       40.00
       1990 |        707       20.00       60.00
       2000 |        707       20.00       80.00
       2007 |        707       20.00      100.00
------------+-----------------------------------
      Total |      3,535      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,828 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(707 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(707 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,828 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(707 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(707 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,828 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(707 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,462
        from master                     1,423  (_merge==1)
        from using                         39  (_merge==2)

    matched                             2,112  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,423       39.82       39.82
         using only (2) |         39        1.09       40.91
            matched (3) |      2,112       59.09      100.00
------------------------+-----------------------------------
                  Total |      3,574      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       707          0          0 |       707 
      1980 |         3         13        704 |       720 
      1990 |         3         13        704 |       720 
      2000 |         3         13        704 |       720 
      2007 |       707          0          0 |       707 
-----------+---------------------------------+----------
     Total |     1,423         39      2,112 |     3,574 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,453 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9848e-01)

Instrumental variables (2SLS) regression          Number of obs   =        703
                                                  Wald chi2(1)    =       0.00
                                                  Prob > chi2     =     0.9770
                                                  R-squared       =          .
                                                  Root MSE        =     1.7805

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0032596    .113283    -0.03   0.977    -.2252903    .2187711
       _cons |  -1.418156   .1291127   -10.98   0.000    -1.671213     -1.1651
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9846e-01)

Instrumental variables (2SLS) regression          Number of obs   =        703
                                                  Wald chi2(1)    =       0.47
                                                  Prob > chi2     =     0.4915
                                                  R-squared       =     0.0000
                                                  Root MSE        =     2.3349

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0526258   .0765069    -0.69   0.492    -.2025766     .097325
       _cons |  -2.993413   .1606137   -18.64   0.000     -3.30821   -2.678616
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9969e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,406
                                                  Wald chi2(2)    =     226.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1376
                                                  Root MSE        =     2.0772

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0393082    .061168    -0.64   0.520    -.1591954    .0805789
       y2000 |  -1.633729   .1206852   -13.54   0.000    -1.870268   -1.397191
       _cons |  -1.383065   .0984043   -14.05   0.000    -1.575934   -1.190196
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9180
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    821,790      100.00      100.00
------------+-----------------------------------
      Total |    821,790      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    273,930       33.33       33.33
          3 |    547,860       66.67      100.00
------------+-----------------------------------
      Total |    821,790      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(273,930 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(273,930 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(273,930 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000026 not found)
file /tmp/St32493.000026 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        679       20.00       20.00
       1980 |        679       20.00       40.00
       1990 |        679       20.00       60.00
       2000 |        679       20.00       80.00
       2007 |        679       20.00      100.00
------------+-----------------------------------
      Total |      3,395      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,716 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(679 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(679 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,716 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(679 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(679 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,716 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(679 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,409
        from master                     1,367  (_merge==1)
        from using                         42  (_merge==2)

    matched                             2,028  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,367       39.77       39.77
         using only (2) |         42        1.22       41.00
            matched (3) |      2,028       59.00      100.00
------------------------+-----------------------------------
                  Total |      3,437      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       679          0          0 |       679 
      1980 |         3         14        676 |       693 
      1990 |         3         14        676 |       693 
      2000 |         3         14        676 |       693 
      2007 |       679          0          0 |       679 
-----------+---------------------------------+----------
     Total |     1,367         42      2,028 |     3,437 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,400 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9913e-01)

Instrumental variables (2SLS) regression          Number of obs   =        675
                                                  Wald chi2(1)    =       0.31
                                                  Prob > chi2     =     0.5769
                                                  R-squared       =     0.0049
                                                  Root MSE        =     1.8039

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0472281   .0846527    -0.56   0.577    -.2131444    .1186882
       _cons |  -1.367691   .1190058   -11.49   0.000    -1.600938   -1.134444
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9921e-01)

Instrumental variables (2SLS) regression          Number of obs   =        675
                                                  Wald chi2(1)    =      25.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0248
                                                  Root MSE        =      2.285

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.3747358   .0739743    -5.07   0.000    -.5197227   -.2297489
       _cons |  -2.368806   .1670181   -14.18   0.000    -2.696156   -2.041457
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9983e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,350
                                                  Wald chi2(2)    =     247.95
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1553
                                                  Root MSE        =     2.0564

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2821471    .054997    -5.13   0.000    -.3899393    -.174355
       y2000 |  -1.447047   .1198306   -12.08   0.000     -1.68191   -1.212183
       _cons |  -1.099473   .1010364   -10.88   0.000      -1.2975   -.9014452
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9185
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    796,779      100.00      100.00
------------+-----------------------------------
      Total |    796,779      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    265,593       33.33       33.33
          3 |    531,186       66.67      100.00
------------+-----------------------------------
      Total |    796,779      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(265,593 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(265,593 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(265,593 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000028 not found)
file /tmp/St32493.000028 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        652       20.00       20.00
       1980 |        652       20.00       40.00
       1990 |        652       20.00       60.00
       2000 |        652       20.00       80.00
       2007 |        652       20.00      100.00
------------+-----------------------------------
      Total |      3,260      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,608 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(652 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(652 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,608 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(652 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(652 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,608 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(652 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,367
        from master                     1,310  (_merge==1)
        from using                         57  (_merge==2)

    matched                             1,950  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,310       39.49       39.49
         using only (2) |         57        1.72       41.21
            matched (3) |      1,950       58.79      100.00
------------------------+-----------------------------------
                  Total |      3,317      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       652          0          0 |       652 
      1980 |         2         19        650 |       671 
      1990 |         2         19        650 |       671 
      2000 |         2         19        650 |       671 
      2007 |       652          0          0 |       652 
-----------+---------------------------------+----------
     Total |     1,310         57      1,950 |     3,317 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,361 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9646e-01)

Instrumental variables (2SLS) regression          Number of obs   =        649
                                                  Wald chi2(1)    =       3.21
                                                  Prob > chi2     =     0.0731
                                                  R-squared       =          .
                                                  Root MSE        =     1.8279

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .2275818    .126988     1.79   0.073    -.0213101    .4764737
       _cons |  -1.688812   .1625866   -10.39   0.000    -2.007475   -1.370148
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9591e-01)

Instrumental variables (2SLS) regression          Number of obs   =        649
                                                  Wald chi2(1)    =      14.95
                                                  Prob > chi2     =     0.0001
                                                  R-squared       =          .
                                                  Root MSE        =     2.4166

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.3891778   .1006568    -3.87   0.000    -.5864614   -.1918942
       _cons |  -2.294504    .227138   -10.10   0.000    -2.739687   -1.849322
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9924e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,298
                                                  Wald chi2(2)    =     217.12
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1279
                                                  Root MSE        =     2.0777

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2190285   .0742525    -2.95   0.003    -.3645608   -.0734962
       y2000 |  -1.467673   .1333539   -11.01   0.000    -1.729042   -1.206304
       _cons |  -1.175697   .1180143    -9.96   0.000    -1.407001   -.9443938
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9190
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,338,287      100.00      100.00
------------+-----------------------------------
      Total |  1,338,287      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    445,831       33.31       33.31
          3 |    892,456       66.69      100.00
------------+-----------------------------------
      Total |  1,338,287      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(445,831 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(445,831 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(445,831 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002a not found)
file /tmp/St32493.00002a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        630       20.00       20.00
       1980 |        630       20.00       40.00
       1990 |        630       20.00       60.00
       2000 |        630       20.00       80.00
       2007 |        630       20.00      100.00
------------+-----------------------------------
      Total |      3,150      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,520 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(630 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(630 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,520 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(630 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(630 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,520 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(630 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,839
        from master                     1,309  (_merge==1)
        from using                      1,530  (_merge==2)

    matched                             1,841  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,309       27.97       27.97
         using only (2) |      1,530       32.69       60.66
            matched (3) |      1,841       39.34      100.00
------------------------+-----------------------------------
                  Total |      4,680      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       630          0          0 |       630 
      1980 |        17        510        613 |     1,140 
      1990 |        16        510        614 |     1,140 
      2000 |        16        510        614 |     1,140 
      2007 |       630          0          0 |       630 
-----------+---------------------------------+----------
     Total |     1,309      1,530      1,841 |     4,680 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,790 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.7601e-01)

Instrumental variables (2SLS) regression          Number of obs   =        613
                                                  Wald chi2(1)    =       3.92
                                                  Prob > chi2     =     0.0477
                                                  R-squared       =          .
                                                  Root MSE        =     1.7739

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .2006156     .10131     1.98   0.048     .0020516    .3991796
       _cons |  -1.641948   .1324529   -12.40   0.000    -1.901551   -1.382345
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.7679e-01)

Instrumental variables (2SLS) regression          Number of obs   =        613
                                                  Wald chi2(1)    =       3.22
                                                  Prob > chi2     =     0.0727
                                                  R-squared       =     0.0087
                                                  Root MSE        =     2.2803

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .1019432   .0568007     1.79   0.073    -.0093841    .2132705
       _cons |  -3.264904   .1418143   -23.02   0.000    -3.542855   -2.986953
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9528e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,226
                                                  Wald chi2(2)    =     208.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1442
                                                  Root MSE        =     2.0369

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .1238057   .0471582     2.63   0.009     .0313773    .2162342
       y2000 |  -1.748923   .1222941   -14.30   0.000    -1.988615   -1.509231
       _cons |  -1.557487   .0972621   -16.01   0.000    -1.748117   -1.366857
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9195
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    741,993      100.00      100.00
------------+-----------------------------------
      Total |    741,993      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    247,331       33.33       33.33
          3 |    494,662       66.67      100.00
------------+-----------------------------------
      Total |    741,993      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(247,331 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(247,331 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(247,331 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002c not found)
file /tmp/St32493.00002c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        612       20.00       20.00
       1980 |        612       20.00       40.00
       1990 |        612       20.00       60.00
       2000 |        612       20.00       80.00
       2007 |        612       20.00      100.00
------------+-----------------------------------
      Total |      3,060      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,448 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(612 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(612 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,448 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(612 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(612 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,448 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(612 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,263
        from master                     1,227  (_merge==1)
        from using                         36  (_merge==2)

    matched                             1,833  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,227       39.63       39.63
         using only (2) |         36        1.16       40.79
            matched (3) |      1,833       59.21      100.00
------------------------+-----------------------------------
                  Total |      3,096      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       612          0          0 |       612 
      1980 |         1         12        611 |       624 
      1990 |         1         12        611 |       624 
      2000 |         1         12        611 |       624 
      2007 |       612          0          0 |       612 
-----------+---------------------------------+----------
     Total |     1,227         36      1,833 |     3,096 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,260 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9964e-01)

Instrumental variables (2SLS) regression          Number of obs   =        610
                                                  Wald chi2(1)    =      10.64
                                                  Prob > chi2     =     0.0011
                                                  R-squared       =          .
                                                  Root MSE        =     1.8038

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.3827684   .1173594    -3.26   0.001    -.6127885   -.1527482
       _cons |  -1.046421   .1414556    -7.40   0.000    -1.323668   -.7691726
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9968e-01)

Instrumental variables (2SLS) regression          Number of obs   =        610
                                                  Wald chi2(1)    =      31.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.5745

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.5574628   .0986575    -5.65   0.000     -.750828   -.3640975
       _cons |  -1.784892   .2542583    -7.02   0.000    -2.283229   -1.286555
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9993e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,220
                                                  Wald chi2(2)    =     220.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1996

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.5055688   .0729238    -6.93   0.000    -.6484967   -.3626409
       y2000 |   -.987215   .1584496    -6.23   0.000     -1.29777   -.6766595
       _cons |  -.9196612   .1166097    -7.89   0.000    -1.148212   -.6911103
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9200
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    719,364      100.00      100.00
------------+-----------------------------------
      Total |    719,364      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    239,788       33.33       33.33
          3 |    479,576       66.67      100.00
------------+-----------------------------------
      Total |    719,364      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(239,788 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(239,788 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(239,788 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002e not found)
file /tmp/St32493.00002e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        595       20.00       20.00
       1980 |        595       20.00       40.00
       1990 |        595       20.00       60.00
       2000 |        595       20.00       80.00
       2007 |        595       20.00      100.00
------------+-----------------------------------
      Total |      2,975      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,380 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(595 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(595 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,380 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(595 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(595 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,380 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(595 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,223
        from master                     1,193  (_merge==1)
        from using                         30  (_merge==2)

    matched                             1,782  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,193       39.70       39.70
         using only (2) |         30        1.00       40.70
            matched (3) |      1,782       59.30      100.00
------------------------+-----------------------------------
                  Total |      3,005      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       595          0          0 |       595 
      1980 |         1         10        594 |       605 
      1990 |         1         10        594 |       605 
      2000 |         1         10        594 |       605 
      2007 |       595          0          0 |       595 
-----------+---------------------------------+----------
     Total |     1,193         30      1,782 |     3,005 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,220 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9928e-01)

Instrumental variables (2SLS) regression          Number of obs   =        593
                                                  Wald chi2(1)    =       1.19
                                                  Prob > chi2     =     0.2751
                                                  R-squared       =          .
                                                  Root MSE        =     1.7562

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    .124153    .113768     1.09   0.275    -.0988281    .3471342
       _cons |  -1.584373   .1463975   -10.82   0.000    -1.871307   -1.297439
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9929e-01)

Instrumental variables (2SLS) regression          Number of obs   =        593
                                                  Wald chi2(1)    =      15.02
                                                  Prob > chi2     =     0.0001
                                                  R-squared       =          .
                                                  Root MSE        =     2.3355

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.3080995   .0794996    -3.88   0.000    -.4639158   -.1522832
       _cons |  -2.405373   .2024129   -11.88   0.000    -2.802096   -2.008651
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9986e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,186
                                                  Wald chi2(2)    =     207.42
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1379
                                                  Root MSE        =     2.0225

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1930034   .0613898    -3.14   0.002    -.3133251   -.0726816
       y2000 |  -1.434225   .1361726   -10.53   0.000    -1.701118   -1.167331
       _cons |   -1.22921   .1078153   -11.40   0.000    -1.440524   -1.017896
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9205
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    699,117      100.00      100.00
------------+-----------------------------------
      Total |    699,117      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    233,039       33.33       33.33
          3 |    466,078       66.67      100.00
------------+-----------------------------------
      Total |    699,117      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(233,039 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(233,039 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(233,039 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002g not found)
file /tmp/St32493.00002g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        575       20.00       20.00
       1980 |        575       20.00       40.00
       1990 |        575       20.00       60.00
       2000 |        575       20.00       80.00
       2007 |        575       20.00      100.00
------------+-----------------------------------
      Total |      2,875      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,300 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(575 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(575 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,300 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(575 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(575 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,300 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(575 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,192
        from master                     1,153  (_merge==1)
        from using                         39  (_merge==2)

    matched                             1,722  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,153       39.57       39.57
         using only (2) |         39        1.34       40.91
            matched (3) |      1,722       59.09      100.00
------------------------+-----------------------------------
                  Total |      2,914      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       575          0          0 |       575 
      1980 |         1         13        574 |       588 
      1990 |         1         13        574 |       588 
      2000 |         1         13        574 |       588 
      2007 |       575          0          0 |       575 
-----------+---------------------------------+----------
     Total |     1,153         39      1,722 |     2,914 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,189 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9863e-01)

Instrumental variables (2SLS) regression          Number of obs   =        573
                                                  Wald chi2(1)    =       0.03
                                                  Prob > chi2     =     0.8683
                                                  R-squared       =     0.0012
                                                  Root MSE        =     1.7183

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0151665   .0914383    -0.17   0.868    -.1943823    .1640492
       _cons |  -1.434412   .1255175   -11.43   0.000    -1.680422   -1.188402
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9872e-01)

Instrumental variables (2SLS) regression          Number of obs   =        573
                                                  Wald chi2(1)    =       8.51
                                                  Prob > chi2     =     0.0035
                                                  R-squared       =          .
                                                  Root MSE        =     2.2328

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1888921   .0647588    -2.92   0.004    -.3158169   -.0619673
       _cons |  -2.729703   .1573328   -17.35   0.000     -3.03807   -2.421337
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9973e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,146
                                                  Wald chi2(2)    =     205.22
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1468
                                                  Root MSE        =     1.9883

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1471557   .0506509    -2.91   0.004    -.2464297   -.0478817
       y2000 |  -1.525576    .124769   -12.23   0.000    -1.770119   -1.281034
       _cons |  -1.285784   .1007597   -12.76   0.000    -1.483269   -1.088298
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9210
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    672,915      100.00      100.00
------------+-----------------------------------
      Total |    672,915      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    224,305       33.33       33.33
          3 |    448,610       66.67      100.00
------------+-----------------------------------
      Total |    672,915      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(224,305 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(224,305 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(224,305 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002i not found)
file /tmp/St32493.00002i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        554       20.00       20.00
       1980 |        554       20.00       40.00
       1990 |        554       20.00       60.00
       2000 |        554       20.00       80.00
       2007 |        554       20.00      100.00
------------+-----------------------------------
      Total |      2,770      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,216 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(554 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(554 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,216 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(554 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(554 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,216 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(554 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,147
        from master                     1,111  (_merge==1)
        from using                         36  (_merge==2)

    matched                             1,659  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,111       39.59       39.59
         using only (2) |         36        1.28       40.88
            matched (3) |      1,659       59.12      100.00
------------------------+-----------------------------------
                  Total |      2,806      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       554          0          0 |       554 
      1980 |         1         12        553 |       566 
      1990 |         1         12        553 |       566 
      2000 |         1         12        553 |       566 
      2007 |       554          0          0 |       554 
-----------+---------------------------------+----------
     Total |     1,111         36      1,659 |     2,806 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,144 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9429e-01)

Instrumental variables (2SLS) regression          Number of obs   =        552
                                                  Wald chi2(1)    =       0.53
                                                  Prob > chi2     =     0.4668
                                                  R-squared       =          .
                                                  Root MSE        =     1.7089

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0879199   .1208185     0.73   0.467    -.1488801    .3247199
       _cons |  -1.546701   .1503909   -10.28   0.000    -1.841462   -1.251941
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9417e-01)

Instrumental variables (2SLS) regression          Number of obs   =        552
                                                  Wald chi2(1)    =      29.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      2.219

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.3919389   .0726762    -5.39   0.000    -.5343816   -.2494961
       _cons |  -2.288174   .1799076   -12.72   0.000    -2.640787   -1.935562
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9885e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,104
                                                  Wald chi2(2)    =     220.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1607
                                                  Root MSE        =     1.9567

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2739833   .0590982    -4.64   0.000    -.3898137    -.158153
       y2000 |  -1.384288   .1322422   -10.47   0.000    -1.643478   -1.125098
       _cons |  -1.152409   .1052694   -10.95   0.000    -1.358733   -.9460847
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9215
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    652,668      100.00      100.00
------------+-----------------------------------
      Total |    652,668      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    217,556       33.33       33.33
          3 |    435,112       66.67      100.00
------------+-----------------------------------
      Total |    652,668      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(217,556 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(217,556 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(217,556 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002k not found)
file /tmp/St32493.00002k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        543       20.00       20.00
       1980 |        543       20.00       40.00
       1990 |        543       20.00       60.00
       2000 |        543       20.00       80.00
       2007 |        543       20.00      100.00
------------+-----------------------------------
      Total |      2,715      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,172 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(543 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(543 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,172 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(543 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(543 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,172 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(543 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,107
        from master                     1,089  (_merge==1)
        from using                         18  (_merge==2)

    matched                             1,626  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,089       39.85       39.85
         using only (2) |         18        0.66       40.50
            matched (3) |      1,626       59.50      100.00
------------------------+-----------------------------------
                  Total |      2,733      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       543          0          0 |       543 
      1980 |         1          6        542 |       549 
      1990 |         1          6        542 |       549 
      2000 |         1          6        542 |       549 
      2007 |       543          0          0 |       543 
-----------+---------------------------------+----------
     Total |     1,089         18      1,626 |     2,733 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,104 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9032e-01)

Instrumental variables (2SLS) regression          Number of obs   =        541
                                                  Wald chi2(1)    =      10.82
                                                  Prob > chi2     =     0.0010
                                                  R-squared       =     0.0051
                                                  Root MSE        =     1.6788

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2723881   .0828035    -3.29   0.001    -.4346799   -.1100963
       _cons |  -1.174581    .111288   -10.55   0.000    -1.392702    -.956461
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8961e-01)

Instrumental variables (2SLS) regression          Number of obs   =        541
                                                  Wald chi2(1)    =      20.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0418
                                                  Root MSE        =     2.1461

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2833952   .0633222    -4.48   0.000    -.4075045   -.1592859
       _cons |  -2.572265   .1530682   -16.80   0.000    -2.872273   -2.272257
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9799e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,082
                                                  Wald chi2(2)    =     235.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1772
                                                  Root MSE        =     1.9269

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.280471   .0487958    -5.75   0.000    -.3761089   -.1848331
       y2000 |  -1.411592   .1252188   -11.27   0.000    -1.657017   -1.166168
       _cons |  -1.166313   .0967084   -12.06   0.000    -1.355858   -.9767678
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9220
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    638,376      100.00      100.00
------------+-----------------------------------
      Total |    638,376      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    212,792       33.33       33.33
          3 |    425,584       66.67      100.00
------------+-----------------------------------
      Total |    638,376      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(212,792 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(212,792 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(212,792 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002m not found)
file /tmp/St32493.00002m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        525       20.00       20.00
       1980 |        525       20.00       40.00
       1990 |        525       20.00       60.00
       2000 |        525       20.00       80.00
       2007 |        525       20.00      100.00
------------+-----------------------------------
      Total |      2,625      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,100 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(525 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(525 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,100 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(525 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(525 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,100 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(525 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,089
        from master                     1,053  (_merge==1)
        from using                         36  (_merge==2)

    matched                             1,572  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,053       39.57       39.57
         using only (2) |         36        1.35       40.92
            matched (3) |      1,572       59.08      100.00
------------------------+-----------------------------------
                  Total |      2,661      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       525          0          0 |       525 
      1980 |         1         12        524 |       537 
      1990 |         1         12        524 |       537 
      2000 |         1         12        524 |       537 
      2007 |       525          0          0 |       525 
-----------+---------------------------------+----------
     Total |     1,053         36      1,572 |     2,661 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,086 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9951e-01)

Instrumental variables (2SLS) regression          Number of obs   =        523
                                                  Wald chi2(1)    =       0.07
                                                  Prob > chi2     =     0.7858
                                                  R-squared       =          .
                                                  Root MSE        =     1.6442

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0256437   .0943707    -0.27   0.786    -.2106068    .1593195
       _cons |  -1.436655   .1214488   -11.83   0.000     -1.67469   -1.198619
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9956e-01)

Instrumental variables (2SLS) regression          Number of obs   =        523
                                                  Wald chi2(1)    =       1.24
                                                  Prob > chi2     =     0.2657
                                                  R-squared       =     0.0143
                                                  Root MSE        =     2.1218

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0804593    .072294    -1.11   0.266     -.222153    .0612343
       _cons |  -2.955375   .1675108   -17.64   0.000     -3.28369    -2.62706
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9991e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,046
                                                  Wald chi2(2)    =     197.96
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1632
                                                  Root MSE        =     1.8998

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0647857   .0557565    -1.16   0.245    -.1740664     .044495
       y2000 |  -1.589557   .1275788   -12.46   0.000    -1.839607   -1.339507
       _cons |  -1.396056   .1012226   -13.79   0.000    -1.594449   -1.197663
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9225
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    614,556      100.00      100.00
------------+-----------------------------------
      Total |    614,556      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    204,852       33.33       33.33
          3 |    409,704       66.67      100.00
------------+-----------------------------------
      Total |    614,556      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(204,852 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(204,852 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(204,852 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002o not found)
file /tmp/St32493.00002o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        510       20.00       20.00
       1980 |        510       20.00       40.00
       1990 |        510       20.00       60.00
       2000 |        510       20.00       80.00
       2007 |        510       20.00      100.00
------------+-----------------------------------
      Total |      2,550      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,040 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(510 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(510 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,040 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(510 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(510 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,040 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(510 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,044
        from master                     1,023  (_merge==1)
        from using                         21  (_merge==2)

    matched                             1,527  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,023       39.79       39.79
         using only (2) |         21        0.82       40.61
            matched (3) |      1,527       59.39      100.00
------------------------+-----------------------------------
                  Total |      2,571      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       510          0          0 |       510 
      1980 |         1          7        509 |       517 
      1990 |         1          7        509 |       517 
      2000 |         1          7        509 |       517 
      2007 |       510          0          0 |       510 
-----------+---------------------------------+----------
     Total |     1,023         21      1,527 |     2,571 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,041 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9912e-01)

Instrumental variables (2SLS) regression          Number of obs   =        508
                                                  Wald chi2(1)    =       2.09
                                                  Prob > chi2     =     0.1480
                                                  R-squared       =          .
                                                  Root MSE        =     1.6877

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .2242336   .1550065     1.45   0.148    -.0795736    .5280409
       _cons |  -1.736719   .2019101    -8.60   0.000    -2.132455   -1.340982
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9893e-01)

Instrumental variables (2SLS) regression          Number of obs   =        508
                                                  Wald chi2(1)    =      16.79
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0393
                                                  Root MSE        =     2.0759

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.3516189   .0858013    -4.10   0.000    -.5197864   -.1834515
       _cons |  -2.379584   .2007274   -11.85   0.000    -2.773003   -1.986166
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9980e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,016
                                                  Wald chi2(2)    =     207.87
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1861
                                                  Root MSE        =     1.8609

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.21796   .0711489    -3.06   0.002    -.3574092   -.0785107
       y2000 |  -1.455615   .1321202   -11.02   0.000    -1.714566   -1.196664
       _cons |  -1.201796   .1192647   -10.08   0.000    -1.435551   -.9680416
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9230
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    590,736      100.00      100.00
------------+-----------------------------------
      Total |    590,736      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    196,912       33.33       33.33
          3 |    393,824       66.67      100.00
------------+-----------------------------------
      Total |    590,736      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(196,912 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(196,912 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(196,912 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002q not found)
file /tmp/St32493.00002q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        488       20.00       20.00
       1980 |        488       20.00       40.00
       1990 |        488       20.00       60.00
       2000 |        488       20.00       80.00
       2007 |        488       20.00      100.00
------------+-----------------------------------
      Total |      2,440      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,952 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(488 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(488 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,952 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(488 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(488 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,952 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(488 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,006
        from master                       979  (_merge==1)
        from using                         27  (_merge==2)

    matched                             1,461  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        979       39.68       39.68
         using only (2) |         27        1.09       40.78
            matched (3) |      1,461       59.22      100.00
------------------------+-----------------------------------
                  Total |      2,467      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       488          0          0 |       488 
      1980 |         1          9        487 |       497 
      1990 |         1          9        487 |       497 
      2000 |         1          9        487 |       497 
      2007 |       488          0          0 |       488 
-----------+---------------------------------+----------
     Total |       979         27      1,461 |     2,467 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,003 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9429e-01)

Instrumental variables (2SLS) regression          Number of obs   =        486
                                                  Wald chi2(1)    =       0.90
                                                  Prob > chi2     =     0.3440
                                                  R-squared       =     0.0005
                                                  Root MSE        =     1.6151

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0817954   .0864432    -0.95   0.344     -.251221    .0876302
       _cons |  -1.388592    .113245   -12.26   0.000    -1.610548   -1.166636
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9417e-01)

Instrumental variables (2SLS) regression          Number of obs   =        486
                                                  Wald chi2(1)    =      11.89
                                                  Prob > chi2     =     0.0006
                                                  R-squared       =     0.0089
                                                  Root MSE        =     2.0898

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2356467   .0683425    -3.45   0.001    -.3695956   -.1016978
       _cons |  -2.701395   .1562761   -17.29   0.000    -3.007691     -2.3951
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9885e+00)

Instrumental variables (2SLS) regression          Number of obs   =        972
                                                  Wald chi2(2)    =     205.38
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1671
                                                  Root MSE        =     1.8696

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1947235   .0521772    -3.73   0.000    -.2969889    -.092458
       y2000 |   -1.50001   .1273185   -11.78   0.000    -1.749549    -1.25047
       _cons |  -1.275781   .0995409   -12.82   0.000    -1.470878   -1.080685
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9235
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    571,680      100.00      100.00
------------+-----------------------------------
      Total |    571,680      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    190,560       33.33       33.33
          3 |    381,120       66.67      100.00
------------+-----------------------------------
      Total |    571,680      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(190,560 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(190,560 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(190,560 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002s not found)
file /tmp/St32493.00002s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        474       20.00       20.00
       1980 |        474       20.00       40.00
       1990 |        474       20.00       60.00
       2000 |        474       20.00       80.00
       2007 |        474       20.00      100.00
------------+-----------------------------------
      Total |      2,370      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,896 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(474 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(474 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,896 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(474 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(474 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,896 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(474 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           972
        from master                       951  (_merge==1)
        from using                         21  (_merge==2)

    matched                             1,419  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        951       39.77       39.77
         using only (2) |         21        0.88       40.65
            matched (3) |      1,419       59.35      100.00
------------------------+-----------------------------------
                  Total |      2,391      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       474          0          0 |       474 
      1980 |         1          7        473 |       481 
      1990 |         1          7        473 |       481 
      2000 |         1          7        473 |       481 
      2007 |       474          0          0 |       474 
-----------+---------------------------------+----------
     Total |       951         21      1,419 |     2,391 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(969 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9912e-01)

Instrumental variables (2SLS) regression          Number of obs   =        472
                                                  Wald chi2(1)    =       3.33
                                                  Prob > chi2     =     0.0680
                                                  R-squared       =          .
                                                  Root MSE        =     1.6584

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .2650362   .1451985     1.83   0.068    -.0195475      .54962
       _cons |  -1.787649   .1860036    -9.61   0.000    -2.152209   -1.423088
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9893e-01)

Instrumental variables (2SLS) regression          Number of obs   =        472
                                                  Wald chi2(1)    =      11.72
                                                  Prob > chi2     =     0.0006
                                                  R-squared       =          .
                                                  Root MSE        =     2.1335

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2884063    .084242    -3.42   0.001    -.4535176   -.1232949
       _cons |  -2.465609    .213982   -11.52   0.000    -2.885006   -2.046212
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9980e+00)

Instrumental variables (2SLS) regression          Number of obs   =        944
                                                  Wald chi2(2)    =     188.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1671
                                                  Root MSE        =     1.8555

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1520731   .0681962    -2.23   0.026    -.2857352    -.018411
       y2000 |  -1.472897   .1417763   -10.39   0.000    -1.750773    -1.19502
       _cons |  -1.300389    .116792   -11.13   0.000    -1.529298   -1.071481
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9240
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    557,388      100.00      100.00
------------+-----------------------------------
      Total |    557,388      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    185,796       33.33       33.33
          3 |    371,592       66.67      100.00
------------+-----------------------------------
      Total |    557,388      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(185,796 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(185,796 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(185,796 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002u not found)
file /tmp/St32493.00002u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        459       20.00       20.00
       1980 |        459       20.00       40.00
       1990 |        459       20.00       60.00
       2000 |        459       20.00       80.00
       2007 |        459       20.00      100.00
------------+-----------------------------------
      Total |      2,295      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,836 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(459 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(459 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,836 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(459 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(459 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,836 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(459 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           951
        from master                       921  (_merge==1)
        from using                         30  (_merge==2)

    matched                             1,374  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        921       39.61       39.61
         using only (2) |         30        1.29       40.90
            matched (3) |      1,374       59.10      100.00
------------------------+-----------------------------------
                  Total |      2,325      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       459          0          0 |       459 
      1980 |         1         10        458 |       469 
      1990 |         1         10        458 |       469 
      2000 |         1         10        458 |       469 
      2007 |       459          0          0 |       459 
-----------+---------------------------------+----------
     Total |       921         30      1,374 |     2,325 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(948 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9951e-01)

Instrumental variables (2SLS) regression          Number of obs   =        457
                                                  Wald chi2(1)    =       2.58
                                                  Prob > chi2     =     0.1081
                                                  R-squared       =          .
                                                  Root MSE        =     1.5951

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .2485074   .1546682     1.61   0.108    -.0546367    .5516515
       _cons |  -1.746485   .1833195    -9.53   0.000    -2.105784   -1.387185
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9956e-01)

Instrumental variables (2SLS) regression          Number of obs   =        457
                                                  Wald chi2(1)    =       1.71
                                                  Prob > chi2     =     0.1914
                                                  R-squared       =          .
                                                  Root MSE        =     2.5461

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .5866101   .4489673     1.31   0.191    -.2933495     1.46657
       _cons |  -4.268766   .8850691    -4.82   0.000    -6.003469   -2.534062
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9991e+00)

Instrumental variables (2SLS) regression          Number of obs   =        914
                                                  Wald chi2(2)    =     155.94
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0193

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .4191019   .2041701     2.05   0.040     .0189359    .8192679
       y2000 |  -2.010379   .2223813    -9.04   0.000    -2.446239    -1.57452
       _cons |  -1.931174   .2403755    -8.03   0.000    -2.402301   -1.460046
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9245
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    535,950      100.00      100.00
------------+-----------------------------------
      Total |    535,950      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    178,650       33.33       33.33
          3 |    357,300       66.67      100.00
------------+-----------------------------------
      Total |    535,950      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(178,650 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(178,650 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(178,650 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00002w not found)
file /tmp/St32493.00002w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        445       20.00       20.00
       1980 |        445       20.00       40.00
       1990 |        445       20.00       60.00
       2000 |        445       20.00       80.00
       2007 |        445       20.00      100.00
------------+-----------------------------------
      Total |      2,225      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,780 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(445 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(445 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,780 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(445 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(445 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,780 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(445 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           911
        from master                       893  (_merge==1)
        from using                         18  (_merge==2)

    matched                             1,332  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        893       39.81       39.81
         using only (2) |         18        0.80       40.62
            matched (3) |      1,332       59.38      100.00
------------------------+-----------------------------------
                  Total |      2,243      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       445          0          0 |       445 
      1980 |         1          6        444 |       451 
      1990 |         1          6        444 |       451 
      2000 |         1          6        444 |       451 
      2007 |       445          0          0 |       445 
-----------+---------------------------------+----------
     Total |       893         18      1,332 |     2,243 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(908 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9985e-01)

Instrumental variables (2SLS) regression          Number of obs   =        443
                                                  Wald chi2(1)    =       2.62
                                                  Prob > chi2     =     0.1053
                                                  R-squared       =          .
                                                  Root MSE        =     1.5628

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1505507   .0929542    -1.62   0.105    -.3327376    .0316361
       _cons |  -1.326386   .1220654   -10.87   0.000     -1.56563   -1.087142
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9987e-01)

Instrumental variables (2SLS) regression          Number of obs   =        443
                                                  Wald chi2(1)    =       4.16
                                                  Prob > chi2     =     0.0413
                                                  R-squared       =     0.0163
                                                  Root MSE        =     2.0359

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1791442   .0878124    -2.04   0.041    -.3512533   -.0070351
       _cons |  -2.787564   .1903038   -14.65   0.000    -3.160553   -2.414576
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9997e+00)

Instrumental variables (2SLS) regression          Number of obs   =        886
                                                  Wald chi2(2)    =     187.43
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1747
                                                  Root MSE        =     1.8153

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.168009   .0636682    -2.64   0.008    -.2927963   -.0432216
       y2000 |  -1.500157   .1327804   -11.30   0.000    -1.760402   -1.239912
       _cons |   -1.30819   .1088244   -12.02   0.000    -1.521482   -1.094898
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9250
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    520,467      100.00      100.00
------------+-----------------------------------
      Total |    520,467      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    173,489       33.33       33.33
          3 |    346,978       66.67      100.00
------------+-----------------------------------
      Total |    520,467      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(173,489 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(173,489 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(173,489 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000030 not found)
file /tmp/St32493.000030 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        424       20.00       20.00
       1980 |        424       20.00       40.00
       1990 |        424       20.00       60.00
       2000 |        424       20.00       80.00
       2007 |        424       20.00      100.00
------------+-----------------------------------
      Total |      2,120      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,696 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(424 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(424 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,696 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(424 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(424 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,696 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(424 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           893
        from master                       851  (_merge==1)
        from using                         42  (_merge==2)

    matched                             1,269  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        851       39.36       39.36
         using only (2) |         42        1.94       41.30
            matched (3) |      1,269       58.70      100.00
------------------------+-----------------------------------
                  Total |      2,162      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       424          0          0 |       424 
      1980 |         1         14        423 |       438 
      1990 |         1         14        423 |       438 
      2000 |         1         14        423 |       438 
      2007 |       424          0          0 |       424 
-----------+---------------------------------+----------
     Total |       851         42      1,269 |     2,162 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(890 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9910e-01)

Instrumental variables (2SLS) regression          Number of obs   =        422
                                                  Wald chi2(1)    =       4.66
                                                  Prob > chi2     =     0.0309
                                                  R-squared       =     0.0299
                                                  Root MSE        =     1.5157

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .1297025   .0601026     2.16   0.031     .0119036    .2475014
       _cons |   -1.70694   .1246066   -13.70   0.000    -1.951165   -1.462716
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9919e-01)

Instrumental variables (2SLS) regression          Number of obs   =        422
                                                  Wald chi2(1)    =       0.34
                                                  Prob > chi2     =     0.5622
                                                  R-squared       =     0.0018
                                                  Root MSE        =     2.0157

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0381581   .0658331     0.58   0.562    -.0908725    .1671886
       _cons |  -3.217604   .1856252   -17.33   0.000    -3.581423   -2.853786
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9983e+00)

Instrumental variables (2SLS) regression          Number of obs   =        844
                                                  Wald chi2(2)    =     179.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1791
                                                  Root MSE        =     1.7866

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    .069919   .0453449     1.54   0.123    -.0189553    .1587934
       y2000 |  -1.686564   .1272866   -13.25   0.000    -1.936041   -1.437086
       _cons |   -1.60706   .1153406   -13.93   0.000    -1.833123   -1.380997
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9255
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,189,809      100.00      100.00
------------+-----------------------------------
      Total |  1,189,809      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    396,603       33.33       33.33
          3 |    793,206       66.67      100.00
------------+-----------------------------------
      Total |  1,189,809      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(396,603 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(396,603 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(396,603 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000032 not found)
file /tmp/St32493.000032 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        411       20.00       20.00
       1980 |        411       20.00       40.00
       1990 |        411       20.00       60.00
       2000 |        411       20.00       80.00
       2007 |        411       20.00      100.00
------------+-----------------------------------
      Total |      2,055      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,644 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(411 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(411 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,644 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(411 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(411 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,644 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(411 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,658
        from master                       858  (_merge==1)
        from using                      1,800  (_merge==2)

    matched                             1,197  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        858       22.26       22.26
         using only (2) |      1,800       46.69       68.95
            matched (3) |      1,197       31.05      100.00
------------------------+-----------------------------------
                  Total |      3,855      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       411          0          0 |       411 
      1980 |        12        600        399 |     1,011 
      1990 |        12        600        399 |     1,011 
      2000 |        12        600        399 |     1,011 
      2007 |       411          0          0 |       411 
-----------+---------------------------------+----------
     Total |       858      1,800      1,197 |     3,855 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,622 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9134e-01)

Instrumental variables (2SLS) regression          Number of obs   =        398
                                                  Wald chi2(1)    =       5.25
                                                  Prob > chi2     =     0.0220
                                                  R-squared       =          .
                                                  Root MSE        =     1.5002

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    .139349   .0608264     2.29   0.022     .0201314    .2585666
       _cons |  -1.642185   .0970737   -16.92   0.000    -1.832446   -1.451924
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9188e-01)

Instrumental variables (2SLS) regression          Number of obs   =        398
                                                  Wald chi2(1)    =       3.10
                                                  Prob > chi2     =     0.0782
                                                  R-squared       =     0.0163
                                                  Root MSE        =     1.9881

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0866723    .049211    -1.76   0.078     -.183124    .0097795
       _cons |  -2.968667   .1331053   -22.30   0.000    -3.229548   -2.707785
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9832e+00)

Instrumental variables (2SLS) regression          Number of obs   =        796
                                                  Wald chi2(2)    =     171.04
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1790
                                                  Root MSE        =     1.7552

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0370756   .0373324    -0.99   0.321    -.1102458    .0360946
       y2000 |  -1.593467   .1278185   -12.47   0.000    -1.843987   -1.342947
       _cons |   -1.46413   .0957201   -15.30   0.000    -1.651738   -1.276522
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9260
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,176,708      100.00      100.00
------------+-----------------------------------
      Total |  1,176,708      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    392,236       33.33       33.33
          3 |    784,472       66.67      100.00
------------+-----------------------------------
      Total |  1,176,708      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(392,236 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(392,236 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(392,236 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000034 not found)
file /tmp/St32493.000034 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        394       20.00       20.00
       1980 |        394       20.00       40.00
       1990 |        394       20.00       60.00
       2000 |        394       20.00       80.00
       2007 |        394       20.00      100.00
------------+-----------------------------------
      Total |      1,970      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,576 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(394 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(394 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,576 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(394 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(394 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,576 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(394 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,636
        from master                       821  (_merge==1)
        from using                      1,815  (_merge==2)

    matched                             1,149  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        821       21.69       21.69
         using only (2) |      1,815       47.95       69.64
            matched (3) |      1,149       30.36      100.00
------------------------+-----------------------------------
                  Total |      3,785      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       394          0          0 |       394 
      1980 |        11        605        383 |       999 
      1990 |        11        605        383 |       999 
      2000 |        11        605        383 |       999 
      2007 |       394          0          0 |       394 
-----------+---------------------------------+----------
     Total |       821      1,815      1,149 |     3,785 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,603 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.7699e-01)

Instrumental variables (2SLS) regression          Number of obs   =        382
                                                  Wald chi2(1)    =       4.92
                                                  Prob > chi2     =     0.0265
                                                  R-squared       =          .
                                                  Root MSE        =     1.7071

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .4542987   .2047416     2.22   0.026     .0530125    .8555849
       _cons |  -1.984578   .2393961    -8.29   0.000    -2.453786    -1.51537
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.7623e-01)

Instrumental variables (2SLS) regression          Number of obs   =        382
                                                  Wald chi2(1)    =       0.52
                                                  Prob > chi2     =     0.4688
                                                  R-squared       =          .
                                                  Root MSE        =     1.9924

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0344011   .0474824    -0.72   0.469    -.1274649    .0586627
       _cons |  -3.053831   .1444222   -21.15   0.000    -3.336894   -2.770769
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9532e+00)

Instrumental variables (2SLS) regression          Number of obs   =        764
                                                  Wald chi2(2)    =     167.87
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1768
                                                  Root MSE        =     1.7503

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    .036243    .046842     0.77   0.439    -.0555657    .1280518
       y2000 |   -1.67658    .136132   -12.32   0.000    -1.943394   -1.409767
       _cons |  -1.529458   .1030382   -14.84   0.000     -1.73141   -1.327507
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9265
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,167,180      100.00      100.00
------------+-----------------------------------
      Total |  1,167,180      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    389,060       33.33       33.33
          3 |    778,120       66.67      100.00
------------+-----------------------------------
      Total |  1,167,180      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(389,060 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(389,060 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(389,060 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000036 not found)
file /tmp/St32493.000036 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        383       20.00       20.00
       1980 |        383       20.00       40.00
       1990 |        383       20.00       60.00
       2000 |        383       20.00       80.00
       2007 |        383       20.00      100.00
------------+-----------------------------------
      Total |      1,915      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,532 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(383 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,532 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(383 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,532 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,623
        from master                       799  (_merge==1)
        from using                      1,824  (_merge==2)

    matched                             1,116  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        799       21.37       21.37
         using only (2) |      1,824       48.78       70.15
            matched (3) |      1,116       29.85      100.00
------------------------+-----------------------------------
                  Total |      3,739      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       383          0          0 |       383 
      1980 |        11        608        372 |       991 
      1990 |        11        608        372 |       991 
      2000 |        11        608        372 |       991 
      2007 |       383          0          0 |       383 
-----------+---------------------------------+----------
     Total |       799      1,824      1,116 |     3,739 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,590 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.8675e-01)

Instrumental variables (2SLS) regression          Number of obs   =        371
                                                  Wald chi2(1)    =       7.76
                                                  Prob > chi2     =     0.0053
                                                  R-squared       =          .
                                                  Root MSE        =     1.5016

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .2417204   .0867652     2.79   0.005     .0716638     .411777
       _cons |  -1.743255     .11577   -15.06   0.000     -1.97016    -1.51635
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8686e-01)

Instrumental variables (2SLS) regression          Number of obs   =        371
                                                  Wald chi2(1)    =       0.48
                                                  Prob > chi2     =     0.4876
                                                  R-squared       =          .
                                                  Root MSE        =     1.9838

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.052163   .0751547    -0.69   0.488    -.1994635    .0951375
       _cons |  -3.012671    .194125   -15.52   0.000    -3.393149   -2.632193
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9736e+00)

Instrumental variables (2SLS) regression          Number of obs   =        742
                                                  Wald chi2(2)    =     162.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1805
                                                  Root MSE        =     1.7342

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0265604   .0550811     0.48   0.630    -.0813965    .1345173
       y2000 |  -1.654019   .1435394   -11.52   0.000    -1.935351   -1.372687
       _cons |  -1.531014   .1051613   -14.56   0.000    -1.737127   -1.324902
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9270
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    450,198      100.00      100.00
------------+-----------------------------------
      Total |    450,198      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    150,066       33.33       33.33
          3 |    300,132       66.67      100.00
------------+-----------------------------------
      Total |    450,198      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(150,066 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(150,066 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(150,066 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000038 not found)
file /tmp/St32493.000038 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        370       20.00       20.00
       1980 |        370       20.00       40.00
       1990 |        370       20.00       60.00
       2000 |        370       20.00       80.00
       2007 |        370       20.00      100.00
------------+-----------------------------------
      Total |      1,850      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,480 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(370 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(370 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,480 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(370 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(370 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,480 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(370 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           770
        from master                       743  (_merge==1)
        from using                         27  (_merge==2)

    matched                             1,107  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        743       39.58       39.58
         using only (2) |         27        1.44       41.02
            matched (3) |      1,107       58.98      100.00
------------------------+-----------------------------------
                  Total |      1,877      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       370          0          0 |       370 
      1980 |         1          9        369 |       379 
      1990 |         1          9        369 |       379 
      2000 |         1          9        369 |       379 
      2007 |       370          0          0 |       370 
-----------+---------------------------------+----------
     Total |       743         27      1,107 |     1,877 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(767 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9429e-01)

Instrumental variables (2SLS) regression          Number of obs   =        368
                                                  Wald chi2(1)    =       5.05
                                                  Prob > chi2     =     0.0246
                                                  R-squared       =          .
                                                  Root MSE        =     1.4529

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2310059    .102751    -2.25   0.025    -.4323941   -.0296178
       _cons |   -1.28988   .1206197   -10.69   0.000    -1.526291    -1.05347
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9417e-01)

Instrumental variables (2SLS) regression          Number of obs   =        368
                                                  Wald chi2(1)    =      13.88
                                                  Prob > chi2     =     0.0002
                                                  R-squared       =          .
                                                  Root MSE        =     1.9511

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2131709   .0572155    -3.73   0.000    -.3253112   -.1010306
       _cons |  -2.696122   .1602305   -16.83   0.000    -3.010168   -2.382076
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9885e+00)

Instrumental variables (2SLS) regression          Number of obs   =        736
                                                  Wald chi2(2)    =     191.33
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1800
                                                  Root MSE        =     1.7207

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2170807   .0475815    -4.56   0.000    -.3103388   -.1238227
       y2000 |  -1.385058   .1401117    -9.89   0.000    -1.659672   -1.110444
       _cons |  -1.302603    .099677   -13.07   0.000    -1.497966    -1.10724
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9275
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    433,524      100.00      100.00
------------+-----------------------------------
      Total |    433,524      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    144,508       33.33       33.33
          3 |    289,016       66.67      100.00
------------+-----------------------------------
      Total |    433,524      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(144,508 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(144,508 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(144,508 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003a not found)
file /tmp/St32493.00003a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        357       20.00       20.00
       1980 |        357       20.00       40.00
       1990 |        357       20.00       60.00
       2000 |        357       20.00       80.00
       2007 |        357       20.00      100.00
------------+-----------------------------------
      Total |      1,785      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,428 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(357 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(357 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,428 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(357 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(357 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,428 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(357 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           741
        from master                       717  (_merge==1)
        from using                         24  (_merge==2)

    matched                             1,068  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        717       39.64       39.64
         using only (2) |         24        1.33       40.96
            matched (3) |      1,068       59.04      100.00
------------------------+-----------------------------------
                  Total |      1,809      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       357          0          0 |       357 
      1980 |         1          8        356 |       365 
      1990 |         1          8        356 |       365 
      2000 |         1          8        356 |       365 
      2007 |       357          0          0 |       357 
-----------+---------------------------------+----------
     Total |       717         24      1,068 |     1,809 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(738 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9863e-01)

Instrumental variables (2SLS) regression          Number of obs   =        355
                                                  Wald chi2(1)    =       5.59
                                                  Prob > chi2     =     0.0181
                                                  R-squared       =          .
                                                  Root MSE        =       1.44

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2542415   .1075227    -2.36   0.018    -.4649821   -.0435009
       _cons |  -1.288143   .1185714   -10.86   0.000    -1.520539   -1.055748
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9872e-01)

Instrumental variables (2SLS) regression          Number of obs   =        355
                                                  Wald chi2(1)    =      12.40
                                                  Prob > chi2     =     0.0004
                                                  R-squared       =          .
                                                  Root MSE        =     1.9257

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2984591   .0847579    -3.52   0.000    -.4645815   -.1323366
       _cons |   -2.67426   .1688865   -15.83   0.000    -3.005272   -2.343249
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9973e+00)

Instrumental variables (2SLS) regression          Number of obs   =        710
                                                  Wald chi2(2)    =     185.77
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1824
                                                  Root MSE        =      1.701

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2865131   .0645219    -4.44   0.000    -.4129737   -.1600525
       y2000 |  -1.432275   .1363825   -10.50   0.000     -1.69958    -1.16497
       _cons |  -1.260935   .1054036   -11.96   0.000    -1.467522   -1.054348
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9280
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    419,232      100.00      100.00
------------+-----------------------------------
      Total |    419,232      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    139,744       33.33       33.33
          3 |    279,488       66.67      100.00
------------+-----------------------------------
      Total |    419,232      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(139,744 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(139,744 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(139,744 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003c not found)
file /tmp/St32493.00003c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        346       20.00       20.00
       1980 |        346       20.00       40.00
       1990 |        346       20.00       60.00
       2000 |        346       20.00       80.00
       2007 |        346       20.00      100.00
------------+-----------------------------------
      Total |      1,730      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,384 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(346 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(346 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,384 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(346 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(346 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,384 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(346 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           716
        from master                       695  (_merge==1)
        from using                         21  (_merge==2)

    matched                             1,035  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        695       39.69       39.69
         using only (2) |         21        1.20       40.89
            matched (3) |      1,035       59.11      100.00
------------------------+-----------------------------------
                  Total |      1,751      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       346          0          0 |       346 
      1980 |         1          7        345 |       353 
      1990 |         1          7        345 |       353 
      2000 |         1          7        345 |       353 
      2007 |       346          0          0 |       346 
-----------+---------------------------------+----------
     Total |       695         21      1,035 |     1,751 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(713 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9928e-01)

Instrumental variables (2SLS) regression          Number of obs   =        344
                                                  Wald chi2(1)    =       1.18
                                                  Prob > chi2     =     0.2777
                                                  R-squared       =     0.0186
                                                  Root MSE        =     1.3893

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1192626   .1098626    -1.09   0.278    -.3345893     .096064
       _cons |  -1.406746   .1200833   -11.71   0.000    -1.642105   -1.171388
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9929e-01)

Instrumental variables (2SLS) regression          Number of obs   =        344
                                                  Wald chi2(1)    =      18.00
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0284
                                                  Root MSE        =     1.8193

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.3061241   .0721603    -4.24   0.000    -.4475557   -.1646925
       _cons |  -2.671549   .1509344   -17.70   0.000    -2.967375   -2.375723
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9986e+00)

Instrumental variables (2SLS) regression          Number of obs   =        688
                                                  Wald chi2(2)    =     200.01
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2247
                                                  Root MSE        =     1.6156

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2617556   .0575171    -4.55   0.000     -.374487   -.1490242
       y2000 |  -1.457071   .1302509   -11.19   0.000    -1.712358   -1.201784
       _cons |  -1.285012   .1000135   -12.85   0.000    -1.481035   -1.088989
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9285
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,133,832      100.00      100.00
------------+-----------------------------------
      Total |  1,133,832      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    377,944       33.33       33.33
          3 |    755,888       66.67      100.00
------------+-----------------------------------
      Total |  1,133,832      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(377,944 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(377,944 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(377,944 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003e not found)
file /tmp/St32493.00003e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        334       20.00       20.00
       1980 |        334       20.00       40.00
       1990 |        334       20.00       60.00
       2000 |        334       20.00       80.00
       2007 |        334       20.00      100.00
------------+-----------------------------------
      Total |      1,670      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,336 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(334 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(334 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,336 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(334 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(334 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,336 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(334 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,570
        from master                       692  (_merge==1)
        from using                      1,878  (_merge==2)

    matched                               978  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        692       19.50       19.50
         using only (2) |      1,878       52.93       72.44
            matched (3) |        978       27.56      100.00
------------------------+-----------------------------------
                  Total |      3,548      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       334          0          0 |       334 
      1980 |         8        626        326 |       960 
      1990 |         8        626        326 |       960 
      2000 |         8        626        326 |       960 
      2007 |       334          0          0 |       334 
-----------+---------------------------------+----------
     Total |       692      1,878        978 |     3,548 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,546 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.8829e-01)

Instrumental variables (2SLS) regression          Number of obs   =        325
                                                  Wald chi2(1)    =       0.34
                                                  Prob > chi2     =     0.5622
                                                  R-squared       =          .
                                                  Root MSE        =     1.3605

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0363446   .0627055     0.58   0.562    -.0865559    .1592452
       _cons |  -1.519584   .0912657   -16.65   0.000    -1.698461   -1.340707
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8920e-01)

Instrumental variables (2SLS) regression          Number of obs   =        325
                                                  Wald chi2(1)    =       5.33
                                                  Prob > chi2     =     0.0210
                                                  R-squared       =     0.0148
                                                  Root MSE        =     1.8113

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1274887   .0552196    -2.31   0.021    -.2357171   -.0192603
       _cons |  -2.969656   .1296821   -22.90   0.000    -3.223828   -2.715483
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9775e+00)

Instrumental variables (2SLS) regression          Number of obs   =        650
                                                  Wald chi2(2)    =     180.38
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2174
                                                  Root MSE        =     1.6028

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0833426    .040867    -2.04   0.041    -.1634403   -.0032448
       y2000 |  -1.613584   .1286499   -12.54   0.000    -1.865734   -1.361435
       _cons |  -1.421621    .095011   -14.96   0.000    -1.607839   -1.235402
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9290
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,120,731      100.00      100.00
------------+-----------------------------------
      Total |  1,120,731      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    373,577       33.33       33.33
          3 |    747,154       66.67      100.00
------------+-----------------------------------
      Total |  1,120,731      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(373,577 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(373,577 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(373,577 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003g not found)
file /tmp/St32493.00003g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        316       20.00       20.00
       1980 |        316       20.00       40.00
       1990 |        316       20.00       60.00
       2000 |        316       20.00       80.00
       2007 |        316       20.00      100.00
------------+-----------------------------------
      Total |      1,580      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,264 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(316 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(316 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,264 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(316 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(316 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,264 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(316 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,555
        from master                       656  (_merge==1)
        from using                      1,899  (_merge==2)

    matched                               924  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        656       18.86       18.86
         using only (2) |      1,899       54.58       73.44
            matched (3) |        924       26.56      100.00
------------------------+-----------------------------------
                  Total |      3,479      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       316          0          0 |       316 
      1980 |         8        633        308 |       949 
      1990 |         8        633        308 |       949 
      2000 |         8        633        308 |       949 
      2007 |       316          0          0 |       316 
-----------+---------------------------------+----------
     Total |       656      1,899        924 |     3,479 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,531 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.8829e-01)

Instrumental variables (2SLS) regression          Number of obs   =        307
                                                  Wald chi2(1)    =       0.15
                                                  Prob > chi2     =     0.6953
                                                  R-squared       =     0.0030
                                                  Root MSE        =     1.2733

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0230861    .058933     0.39   0.695    -.0924204    .1385926
       _cons |  -1.528577   .1016385   -15.04   0.000    -1.727784   -1.329369
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.8917e-01)

Instrumental variables (2SLS) regression          Number of obs   =        307
                                                  Wald chi2(1)    =       1.48
                                                  Prob > chi2     =     0.2243
                                                  R-squared       =     0.0080
                                                  Root MSE        =     1.7302

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0846846   .0696882    -1.22   0.224     -.221271    .0519018
       _cons |  -2.948747   .2204538   -13.38   0.000    -3.380828   -2.516665
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9775e+00)

Instrumental variables (2SLS) regression          Number of obs   =        614
                                                  Wald chi2(2)    =     189.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2348
                                                  Root MSE        =     1.5237

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.047839   .0470333    -1.02   0.309    -.1400225    .0443445
       y2000 |  -1.609897   .1447385   -11.12   0.000    -1.893579   -1.326214
       _cons |  -1.443062   .1038348   -13.90   0.000    -1.646574   -1.239549
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9295
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,111,203      100.00      100.00
------------+-----------------------------------
      Total |  1,111,203      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    370,401       33.33       33.33
          3 |    740,802       66.67      100.00
------------+-----------------------------------
      Total |  1,111,203      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(370,401 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(370,401 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(370,401 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003i not found)
file /tmp/St32493.00003i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        310       20.00       20.00
       1980 |        310       20.00       40.00
       1990 |        310       20.00       60.00
       2000 |        310       20.00       80.00
       2007 |        310       20.00      100.00
------------+-----------------------------------
      Total |      1,550      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,240 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(310 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(310 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,240 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(310 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(310 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,240 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(310 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,531
        from master                       641  (_merge==1)
        from using                      1,890  (_merge==2)

    matched                               909  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        641       18.63       18.63
         using only (2) |      1,890       54.94       73.58
            matched (3) |        909       26.42      100.00
------------------------+-----------------------------------
                  Total |      3,440      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       310          0          0 |       310 
      1980 |         7        630        303 |       940 
      1990 |         7        630        303 |       940 
      2000 |         7        630        303 |       940 
      2007 |       310          0          0 |       310 
-----------+---------------------------------+----------
     Total |       641      1,890        909 |     3,440 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,510 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9216e-01)

Instrumental variables (2SLS) regression          Number of obs   =        302
                                                  Wald chi2(1)    =       1.38
                                                  Prob > chi2     =     0.2408
                                                  R-squared       =          .
                                                  Root MSE        =     1.3128

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0717437   .0611581    -1.17   0.241    -.1916114    .0481241
       _cons |   -1.46401    .089893   -16.29   0.000    -1.640198   -1.287823
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9254e-01)

Instrumental variables (2SLS) regression          Number of obs   =        302
                                                  Wald chi2(1)    =       6.90
                                                  Prob > chi2     =     0.0086
                                                  R-squared       =     0.0148
                                                  Root MSE        =     1.7134

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.1538755   .0585804    -2.63   0.009    -.2686909   -.0390601
       _cons |  -2.931601    .140494   -20.87   0.000    -3.206965   -2.656238
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9847e+00)

Instrumental variables (2SLS) regression          Number of obs   =        604
                                                  Wald chi2(2)    =     189.70
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2305
                                                  Root MSE        =     1.5308

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.129147   .0424139    -3.04   0.002    -.2122767   -.0460173
       y2000 |  -1.555576   .1304397   -11.93   0.000    -1.811233   -1.299919
       _cons |  -1.418275   .0943548   -15.03   0.000    -1.603207   -1.233343
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9300
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    366,828      100.00      100.00
------------+-----------------------------------
      Total |    366,828      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    122,276       33.33       33.33
          3 |    244,552       66.67      100.00
------------+-----------------------------------
      Total |    366,828      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(122,276 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(122,276 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(122,276 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003k not found)
file /tmp/St32493.00003k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        302       20.00       20.00
       1980 |        302       20.00       40.00
       1990 |        302       20.00       60.00
       2000 |        302       20.00       80.00
       2007 |        302       20.00      100.00
------------+-----------------------------------
      Total |      1,510      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,208 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(302 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,208 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(302 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,208 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           628
        from master                       607  (_merge==1)
        from using                         21  (_merge==2)

    matched                               903  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        607       39.65       39.65
         using only (2) |         21        1.37       41.02
            matched (3) |        903       58.98      100.00
------------------------+-----------------------------------
                  Total |      1,531      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       302          0          0 |       302 
      1980 |         1          7        301 |       309 
      1990 |         1          7        301 |       309 
      2000 |         1          7        301 |       309 
      2007 |       302          0          0 |       302 
-----------+---------------------------------+----------
     Total |       607         21        903 |     1,531 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(625 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9779e-01)

Instrumental variables (2SLS) regression          Number of obs   =        300
                                                  Wald chi2(1)    =       0.31
                                                  Prob > chi2     =     0.5749
                                                  R-squared       =          .
                                                  Root MSE        =     1.3314

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0729349   .1300527     0.56   0.575    -.1819637    .3278335
       _cons |  -1.584331   .1259395   -12.58   0.000    -1.831168   -1.337494
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9743e-01)

Instrumental variables (2SLS) regression          Number of obs   =        300
                                                  Wald chi2(1)    =      11.33
                                                  Prob > chi2     =     0.0008
                                                  R-squared       =     0.0806
                                                  Root MSE        =     1.6486

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.3162872   .0939527    -3.37   0.001    -.5004311   -.1321433
       _cons |  -2.635801   .1933158   -13.63   0.000    -3.014693   -2.256909
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9952e+00)

Instrumental variables (2SLS) regression          Number of obs   =        600
                                                  Wald chi2(2)    =     198.65
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2746
                                                  Root MSE        =     1.4862

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.2117804   .0731991    -2.89   0.004     -.355248   -.0683128
       y2000 |   -1.45703    .142622   -10.22   0.000    -1.736564   -1.177496
       _cons |   -1.36593   .1025372   -13.32   0.000    -1.566899   -1.164961
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9305
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    358,491      100.00      100.00
------------+-----------------------------------
      Total |    358,491      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    119,497       33.33       33.33
          3 |    238,994       66.67      100.00
------------+-----------------------------------
      Total |    358,491      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(119,497 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(119,497 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(119,497 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003m not found)
file /tmp/St32493.00003m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        299       20.00       20.00
       1980 |        299       20.00       40.00
       1990 |        299       20.00       60.00
       2000 |        299       20.00       80.00
       2007 |        299       20.00      100.00
------------+-----------------------------------
      Total |      1,495      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,196 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(299 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(299 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,196 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(299 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(299 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,196 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(299 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           610
        from master                       601  (_merge==1)
        from using                          9  (_merge==2)

    matched                               894  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        601       39.96       39.96
         using only (2) |          9        0.60       40.56
            matched (3) |        894       59.44      100.00
------------------------+-----------------------------------
                  Total |      1,504      100.00

. tab year _merge 

           |              _merge
      year | master on  using onl  matched ( |     Total
-----------+---------------------------------+----------
      1970 |       299          0          0 |       299 
      1980 |         1          3        298 |       302 
      1990 |         1          3        298 |       302 
      2000 |         1          3        298 |       302 
      2007 |       299          0          0 |       299 
-----------+---------------------------------+----------
     Total |       601          9        894 |     1,504 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(607 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   9.9985e-01)

Instrumental variables (2SLS) regression          Number of obs   =        297
                                                  Wald chi2(1)    =       4.04
                                                  Prob > chi2     =     0.0445
                                                  R-squared       =          .
                                                  Root MSE        =     1.3414

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .2401317   .1195152     2.01   0.045     .0058862    .4743772
       _cons |  -1.708166   .1178068   -14.50   0.000    -1.939063   -1.477269
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   9.9987e-01)

Instrumental variables (2SLS) regression          Number of obs   =        297
                                                  Wald chi2(1)    =       0.07
                                                  Prob > chi2     =     0.7920
                                                  R-squared       =     0.0006
                                                  Root MSE        =     1.6974

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.0222089   .0842155    -0.26   0.792    -.1872683    .1428506
       _cons |  -3.165909   .1559544   -20.30   0.000    -3.471574   -2.860244
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.9997e+00)

Instrumental variables (2SLS) regression          Number of obs   =        594
                                                  Wald chi2(2)    =     180.15
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2294
                                                  Root MSE        =     1.5158

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   .0456985   .0657943     0.69   0.487     -.083256     .174653
       y2000 |  -1.699109   .1325466   -12.82   0.000    -1.958896   -1.439323
       _cons |  -1.564301   .1005301   -15.56   0.000    -1.761336   -1.367265
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9310
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    350,154      100.00      100.00
------------+-----------------------------------
      Total |    350,154      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    116,718       33.33       33.33
          3 |    233,436       66.67      100.00
------------+-----------------------------------
      Total |    350,154      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(116,718 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(116,718 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(116,718 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003o not found)
file /tmp/St32493.00003o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        294       20.00       20.00
       1980 |        294       20.00       40.00
       1990 |        294       20.00       60.00
       2000 |        294       20.00       80.00
       2007 |        294       20.00      100.00
------------+-----------------------------------
      Total |      1,470      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,176 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(294 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(294 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,176 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(294 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(294 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,176 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(294 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           588
        from master                       588  (_merge==1)
        from using                          0  (_merge==2)

    matched                               882  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        588       40.00       40.00
            matched (3) |        882       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,470      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       294          0 |       294 
      1980 |         0        294 |       294 
      1990 |         0        294 |       294 
      2000 |         0        294 |       294 
      2007 |       294          0 |       294 
-----------+----------------------+----------
     Total |       588        882 |     1,470 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(588 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        293
                                                  Wald chi2(1)    =      30.77
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.2974

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9058305   .1633006    -5.55   0.000    -1.225894   -.5857673
       _cons |  -.5594973   .1909669    -2.93   0.003    -.9337855    -.185209
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        293
                                                  Wald chi2(1)    =      64.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1234
                                                  Root MSE        =      1.544

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9480485   .1179218    -8.04   0.000    -1.179171    -.716926
       _cons |  -1.429786   .2383936    -6.00   0.000    -1.897029   -.9625433
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        586
                                                  Wald chi2(2)    =     302.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2968
                                                  Root MSE        =     1.4264

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9370562   .0931518   -10.06   0.000     -1.11963   -.7544819
       y2000 |  -.9243759   .1393303    -6.63   0.000    -1.197458   -.6512936
       _cons |  -.5259805   .1301589    -4.04   0.000    -.7810873   -.2708737
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9315
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,071,900      100.00      100.00
------------+-----------------------------------
      Total |  1,071,900      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    357,300       33.33       33.33
          3 |    714,600       66.67      100.00
------------+-----------------------------------
      Total |  1,071,900      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(357,300 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(357,300 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(357,300 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003q not found)
file /tmp/St32493.00003q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        900       20.00       20.00
       1980 |        900       20.00       40.00
       1990 |        900       20.00       60.00
       2000 |        900       20.00       80.00
       2007 |        900       20.00      100.00
------------+-----------------------------------
      Total |      4,500      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,600 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(900 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(900 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,600 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(900 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(888 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,600 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(900 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,800
        from master                     1,800  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,700  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,800       40.00       40.00
            matched (3) |      2,700       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,500      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       900          0 |       900 
      1980 |         0        900 |       900 
      1990 |         0        900 |       900 
      2000 |         0        900 |       900 
      2007 |       900          0 |       900 
-----------+----------------------+----------
     Total |     1,800      2,700 |     4,500 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,800 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        899
                                                  Wald chi2(1)    =      85.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9757

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8530791   .0922408    -9.25   0.000    -1.033868   -.6722905
       _cons |  -.5036572   .1181354    -4.26   0.000    -.7351983    -.272116
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        899
                                                  Wald chi2(1)    =     188.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0867
                                                  Root MSE        =     2.3287

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.986143   .0718119   -13.73   0.000    -1.126892   -.8453943
       _cons |  -1.247248    .153999    -8.10   0.000     -1.54908   -.9454153
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,798
                                                  Wald chi2(2)    =     551.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1328
                                                  Root MSE        =     2.1698

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9513171   .0560663   -16.97   0.000    -1.061205   -.8414292
       y2000 |  -.9125059    .111491    -8.18   0.000    -1.131024   -.6939876
       _cons |  -.3992321   .0937497    -4.26   0.000    -.5829782   -.2154859
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9320
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,062,372      100.00      100.00
------------+-----------------------------------
      Total |  1,062,372      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    354,124       33.33       33.33
          3 |    708,248       66.67      100.00
------------+-----------------------------------
      Total |  1,062,372      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(354,124 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(354,124 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(354,124 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003s not found)
file /tmp/St32493.00003s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        892       20.00       20.00
       1980 |        892       20.00       40.00
       1990 |        892       20.00       60.00
       2000 |        892       20.00       80.00
       2007 |        892       20.00      100.00
------------+-----------------------------------
      Total |      4,460      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,568 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(892 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(892 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,568 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(892 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(880 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,568 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(892 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,784
        from master                     1,784  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,676  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,784       40.00       40.00
            matched (3) |      2,676       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,460      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       892          0 |       892 
      1980 |         0        892 |       892 
      1990 |         0        892 |       892 
      2000 |         0        892 |       892 
      2007 |       892          0 |       892 
-----------+----------------------+----------
     Total |     1,784      2,676 |     4,460 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,784 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        891
                                                  Wald chi2(1)    =      85.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9739

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8519668   .0924004    -9.22   0.000    -1.033068   -.6708654
       _cons |  -.5049044    .118406    -4.26   0.000     -.736976   -.2728329
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        891
                                                  Wald chi2(1)    =     187.79
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0860
                                                  Root MSE        =     2.3278

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9902277     .07226   -13.70   0.000    -1.131855   -.8486007
       _cons |  -1.239352   .1548786    -8.00   0.000    -1.542908   -.9357953
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,782
                                                  Wald chi2(2)    =     548.34
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1325
                                                  Root MSE        =     2.1688

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9538971     .05635   -16.93   0.000    -1.064341    -.843453
       y2000 |  -.9100759   .1119574    -8.13   0.000    -1.129508   -.6906435
       _cons |  -.3965537    .094166    -4.21   0.000    -.5811156   -.2119918
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9325
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,044,507      100.00      100.00
------------+-----------------------------------
      Total |  1,044,507      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    348,169       33.33       33.33
          3 |    696,338       66.67      100.00
------------+-----------------------------------
      Total |  1,044,507      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(348,169 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(348,169 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(348,169 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003u not found)
file /tmp/St32493.00003u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        877       20.00       20.00
       1980 |        877       20.00       40.00
       1990 |        877       20.00       60.00
       2000 |        877       20.00       80.00
       2007 |        877       20.00      100.00
------------+-----------------------------------
      Total |      4,385      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,508 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(877 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(877 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,508 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(877 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(866 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,508 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(877 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,754
        from master                     1,754  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,631  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,754       40.00       40.00
            matched (3) |      2,631       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,385      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       877          0 |       877 
      1980 |         0        877 |       877 
      1990 |         0        877 |       877 
      2000 |         0        877 |       877 
      2007 |       877          0 |       877 
-----------+----------------------+----------
     Total |     1,754      2,631 |     4,385 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,754 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        876
                                                  Wald chi2(1)    =      83.79
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9701

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8516223   .0930355    -9.15   0.000    -1.033969    -.669276
       _cons |  -.5052986   .1192326    -4.24   0.000    -.7389903   -.2716069
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        876
                                                  Wald chi2(1)    =     186.34
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0874
                                                  Root MSE        =     2.3156

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9892907   .0724718   -13.65   0.000    -1.131333   -.8472486
       _cons |  -1.241131   .1553539    -7.99   0.000     -1.54562   -.9366434
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,752
                                                  Wald chi2(2)    =     542.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1334
                                                  Root MSE        =     2.1606

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9531049   .0566032   -16.84   0.000    -1.064045   -.8421646
       y2000 |   -.910753   .1124746    -8.10   0.000    -1.131199   -.6903069
       _cons |  -.3973939   .0946099    -4.20   0.000    -.5828259    -.211962
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9330
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,037,361      100.00      100.00
------------+-----------------------------------
      Total |  1,037,361      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    345,787       33.33       33.33
          3 |    691,574       66.67      100.00
------------+-----------------------------------
      Total |  1,037,361      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(345,787 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(345,787 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(345,787 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00003w not found)
file /tmp/St32493.00003w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        871       20.00       20.00
       1980 |        871       20.00       40.00
       1990 |        871       20.00       60.00
       2000 |        871       20.00       80.00
       2007 |        871       20.00      100.00
------------+-----------------------------------
      Total |      4,355      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,484 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(871 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(871 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,484 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(871 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(861 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,484 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(871 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,742
        from master                     1,742  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,613  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,742       40.00       40.00
            matched (3) |      2,613       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,355      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       871          0 |       871 
      1980 |         0        871 |       871 
      1990 |         0        871 |       871 
      2000 |         0        871 |       871 
      2007 |       871          0 |       871 
-----------+----------------------+----------
     Total |     1,742      2,613 |     4,355 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,742 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        870
                                                  Wald chi2(1)    =      83.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9689

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8506682   .0933193    -9.12   0.000    -1.033571   -.6677657
       _cons |  -.5064566   .1196225    -4.23   0.000    -.7409124   -.2720008
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        870
                                                  Wald chi2(1)    =     185.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0868
                                                  Root MSE        =     2.3145

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.988936   .0726884   -13.61   0.000    -1.131403   -.8464693
       _cons |  -1.241888   .1557969    -7.97   0.000    -1.547244   -.9365317
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,740
                                                  Wald chi2(2)    =     539.09
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1330
                                                  Root MSE        =     2.1595

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9525964   .0567737   -16.78   0.000    -1.063871   -.8413221
       y2000 |  -.9111428   .1127907    -8.08   0.000    -1.132208   -.6900771
       _cons |   -.398033   .0949078    -4.19   0.000    -.5840489   -.2120172
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9335
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,026,642      100.00      100.00
------------+-----------------------------------
      Total |  1,026,642      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    342,214       33.33       33.33
          3 |    684,428       66.67      100.00
------------+-----------------------------------
      Total |  1,026,642      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(342,214 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(342,214 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(342,214 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000040 not found)
file /tmp/St32493.000040 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        862       20.00       20.00
       1980 |        862       20.00       40.00
       1990 |        862       20.00       60.00
       2000 |        862       20.00       80.00
       2007 |        862       20.00      100.00
------------+-----------------------------------
      Total |      4,310      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,448 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(862 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(862 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,448 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(862 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(853 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,448 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(862 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,724
        from master                     1,724  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,586  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,724       40.00       40.00
            matched (3) |      2,586       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,310      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       862          0 |       862 
      1980 |         0        862 |       862 
      1990 |         0        862 |       862 
      2000 |         0        862 |       862 
      2007 |       862          0 |       862 
-----------+----------------------+----------
     Total |     1,724      2,586 |     4,310 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,724 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        861
                                                  Wald chi2(1)    =      82.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9665

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8560651   .0940129    -9.11   0.000    -1.040327   -.6718031
       _cons |  -.5031158   .1203584    -4.18   0.000    -.7390139   -.2672178
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        861
                                                  Wald chi2(1)    =     185.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0862
                                                  Root MSE        =      2.302

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9911109   .0728072   -13.61   0.000     -1.13381   -.8484115
       _cons |  -1.239085   .1559448    -7.95   0.000    -1.544731   -.9334384
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,722
                                                  Wald chi2(2)    =     537.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1333
                                                  Root MSE        =     2.1513

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9557106   .0569854   -16.77   0.000      -1.0674   -.8440212
       y2000 |  -.9074613   .1129846    -8.03   0.000    -1.128907   -.6860155
       _cons |  -.3971528   .0951182    -4.18   0.000    -.5835811   -.2107246
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9340
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,018,305      100.00      100.00
------------+-----------------------------------
      Total |  1,018,305      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    339,435       33.33       33.33
          3 |    678,870       66.67      100.00
------------+-----------------------------------
      Total |  1,018,305      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(339,435 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(339,435 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(339,435 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000042 not found)
file /tmp/St32493.000042 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        855       20.00       20.00
       1980 |        855       20.00       40.00
       1990 |        855       20.00       60.00
       2000 |        855       20.00       80.00
       2007 |        855       20.00      100.00
------------+-----------------------------------
      Total |      4,275      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,420 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(855 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(855 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,420 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(855 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(848 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,420 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(855 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,710
        from master                     1,710  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,565  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,710       40.00       40.00
            matched (3) |      2,565       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,275      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       855          0 |       855 
      1980 |         0        855 |       855 
      1990 |         0        855 |       855 
      2000 |         0        855 |       855 
      2007 |       855          0 |       855 
-----------+----------------------+----------
     Total |     1,710      2,565 |     4,275 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,710 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        854
                                                  Wald chi2(1)    =      82.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9659

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.856179   .0943734    -9.07   0.000    -1.041147   -.6712106
       _cons |  -.5033492   .1208168    -4.17   0.000    -.7401458   -.2665526
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        854
                                                  Wald chi2(1)    =     185.00
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0860
                                                  Root MSE        =     2.3008

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9935729    .073048   -13.60   0.000    -1.136744   -.8504014
       _cons |  -1.234881   .1564649    -7.89   0.000    -1.541547   -.9282156
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,708
                                                  Wald chi2(2)    =     534.83
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1332
                                                  Root MSE        =     2.1506

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9575461   .0571877   -16.74   0.000    -1.069632   -.8454602
       y2000 |  -.9060099   .1134028    -7.99   0.000    -1.128275   -.6837445
       _cons |  -.3955575   .0954661    -4.14   0.000    -.5826677   -.2084473
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9345
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,007,586      100.00      100.00
------------+-----------------------------------
      Total |  1,007,586      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    335,862       33.33       33.33
          3 |    671,724       66.67      100.00
------------+-----------------------------------
      Total |  1,007,586      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(335,862 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(335,862 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(335,862 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000044 not found)
file /tmp/St32493.000044 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        846       20.00       20.00
       1980 |        846       20.00       40.00
       1990 |        846       20.00       60.00
       2000 |        846       20.00       80.00
       2007 |        846       20.00      100.00
------------+-----------------------------------
      Total |      4,230      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,384 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(846 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(846 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,384 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(846 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(841 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,384 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(846 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,692
        from master                     1,692  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,538  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,692       40.00       40.00
            matched (3) |      2,538       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,230      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       846          0 |       846 
      1980 |         0        846 |       846 
      1990 |         0        846 |       846 
      2000 |         0        846 |       846 
      2007 |       846          0 |       846 
-----------+----------------------+----------
     Total |     1,692      2,538 |     4,230 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,692 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        845
                                                  Wald chi2(1)    =      84.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9526

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8760164   .0955167    -9.17   0.000    -1.063226   -.6888071
       _cons |  -.4820568   .1217721    -3.96   0.000    -.7207256   -.2433879
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        845
                                                  Wald chi2(1)    =     188.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0893
                                                  Root MSE        =     2.2942

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.029427   .0749317   -13.74   0.000    -1.176291    -.882564
       _cons |  -1.168041   .1596412    -7.32   0.000    -1.480932     -.85515
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,690
                                                  Wald chi2(2)    =     540.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1388
                                                  Root MSE        =     2.1411

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9887075   .0584081   -16.93   0.000    -1.103185   -.8742297
       y2000 |  -.8812271   .1138916    -7.74   0.000    -1.104451   -.6580037
       _cons |  -.3622239   .0963464    -3.76   0.000    -.5510594   -.1733885
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9350
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    996,867      100.00      100.00
------------+-----------------------------------
      Total |    996,867      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    332,289       33.33       33.33
          3 |    664,578       66.67      100.00
------------+-----------------------------------
      Total |    996,867      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(332,289 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(332,289 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(332,289 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000046 not found)
file /tmp/St32493.000046 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        837       20.00       20.00
       1980 |        837       20.00       40.00
       1990 |        837       20.00       60.00
       2000 |        837       20.00       80.00
       2007 |        837       20.00      100.00
------------+-----------------------------------
      Total |      4,185      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,348 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(837 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(837 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,348 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(837 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(833 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,348 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(837 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,674
        from master                     1,674  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,511  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,674       40.00       40.00
            matched (3) |      2,511       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,185      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       837          0 |       837 
      1980 |         0        837 |       837 
      1990 |         0        837 |       837 
      2000 |         0        837 |       837 
      2007 |       837          0 |       837 
-----------+----------------------+----------
     Total |     1,674      2,511 |     4,185 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,674 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        836
                                                  Wald chi2(1)    =      83.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9528

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8781965   .0960491    -9.14   0.000    -1.066449   -.6899437
       _cons |  -.4798005   .1224685    -3.92   0.000    -.7198344   -.2397667
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        836
                                                  Wald chi2(1)    =     186.82
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0886
                                                  Root MSE        =     2.2919

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.029256   .0753025   -13.67   0.000    -1.176846    -.881666
       _cons |  -1.169013   .1604005    -7.29   0.000    -1.483392   -.8546337
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,672
                                                  Wald chi2(2)    =     535.73
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1384
                                                  Root MSE        =     2.1398

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9891628   .0587152   -16.85   0.000    -1.104242    -.874083
       y2000 |  -.8814849   .1144347    -7.70   0.000    -1.105773   -.6571971
       _cons |  -.3617734   .0968347    -3.74   0.000     -.551566   -.1719809
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9355
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    987,339      100.00      100.00
------------+-----------------------------------
      Total |    987,339      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    329,113       33.33       33.33
          3 |    658,226       66.67      100.00
------------+-----------------------------------
      Total |    987,339      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(329,113 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(329,113 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(329,113 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000048 not found)
file /tmp/St32493.000048 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        829       20.00       20.00
       1980 |        829       20.00       40.00
       1990 |        829       20.00       60.00
       2000 |        829       20.00       80.00
       2007 |        829       20.00      100.00
------------+-----------------------------------
      Total |      4,145      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,316 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(829 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(829 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,316 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(829 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(825 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,316 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(829 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,658
        from master                     1,658  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,487  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,658       40.00       40.00
            matched (3) |      2,487       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,145      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       829          0 |       829 
      1980 |         0        829 |       829 
      1990 |         0        829 |       829 
      2000 |         0        829 |       829 
      2007 |       829          0 |       829 
-----------+----------------------+----------
     Total |     1,658      2,487 |     4,145 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,658 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        828
                                                  Wald chi2(1)    =      82.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.946

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8743029   .0961971    -9.09   0.000    -1.062846     -.68576
       _cons |  -.4824553   .1226562    -3.93   0.000     -.722857   -.2420537
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        828
                                                  Wald chi2(1)    =     184.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0908
                                                  Root MSE        =     2.2818

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.024099    .075309   -13.60   0.000    -1.171702   -.8764963
       _cons |  -1.176859    .160431    -7.34   0.000    -1.491298   -.8624201
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,656
                                                  Wald chi2(2)    =     532.15
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1402
                                                  Root MSE        =     2.1312

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9843422   .0587507   -16.75   0.000    -1.099491    -.869193
       y2000 |  -.8850821   .1145208    -7.73   0.000    -1.109539   -.6606255
       _cons |  -.3654021   .0969081    -3.77   0.000    -.5553385   -.1754656
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9360
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    967,092      100.00      100.00
------------+-----------------------------------
      Total |    967,092      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    322,364       33.33       33.33
          3 |    644,728       66.67      100.00
------------+-----------------------------------
      Total |    967,092      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(322,364 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(322,364 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(322,364 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004a not found)
file /tmp/St32493.00004a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        812       20.00       20.00
       1980 |        812       20.00       40.00
       1990 |        812       20.00       60.00
       2000 |        812       20.00       80.00
       2007 |        812       20.00      100.00
------------+-----------------------------------
      Total |      4,060      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,248 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(812 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(812 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,248 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(812 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(808 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,248 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(812 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,624
        from master                     1,624  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,436  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,624       40.00       40.00
            matched (3) |      2,436       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,060      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       812          0 |       812 
      1980 |         0        812 |       812 
      1990 |         0        812 |       812 
      2000 |         0        812 |       812 
      2007 |       812          0 |       812 
-----------+----------------------+----------
     Total |     1,624      2,436 |     4,060 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,624 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        811
                                                  Wald chi2(1)    =      80.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9294

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8638541   .0963582    -8.97   0.000    -1.052713   -.6749955
       _cons |  -.4934621   .1228762    -4.02   0.000    -.7342951   -.2526291
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        811
                                                  Wald chi2(1)    =     184.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0931
                                                  Root MSE        =      2.272

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.046469    .077002   -13.59   0.000     -1.19739   -.8955478
       _cons |  -1.136866   .1633225    -6.96   0.000    -1.456972   -.8167601
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,622
                                                  Wald chi2(2)    =     527.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1426
                                                  Root MSE        =     2.1202

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9973556   .0597549   -16.69   0.000    -1.114473   -.8802381
       y2000 |   -.876325   .1153131    -7.60   0.000    -1.102335   -.6503154
       _cons |   -.351437   .0978992    -3.59   0.000     -.543316   -.1595581
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9365
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    958,755      100.00      100.00
------------+-----------------------------------
      Total |    958,755      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    319,585       33.33       33.33
          3 |    639,170       66.67      100.00
------------+-----------------------------------
      Total |    958,755      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(319,585 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(319,585 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(319,585 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004c not found)
file /tmp/St32493.00004c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        805       20.00       20.00
       1980 |        805       20.00       40.00
       1990 |        805       20.00       60.00
       2000 |        805       20.00       80.00
       2007 |        805       20.00      100.00
------------+-----------------------------------
      Total |      4,025      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,220 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(805 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(805 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,220 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(805 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(801 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,220 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(805 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,610
        from master                     1,610  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,415  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,610       40.00       40.00
            matched (3) |      2,415       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,025      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       805          0 |       805 
      1980 |         0        805 |       805 
      1990 |         0        805 |       805 
      2000 |         0        805 |       805 
      2007 |       805          0 |       805 
-----------+----------------------+----------
     Total |     1,610      2,415 |     4,025 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,610 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        804
                                                  Wald chi2(1)    =      79.87
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9296

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.86498   .0967879    -8.94   0.000    -1.054681   -.6752792
       _cons |    -.49223   .1234215    -3.99   0.000    -.7341318   -.2503282
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        804
                                                  Wald chi2(1)    =     183.12
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0938
                                                  Root MSE        =     2.2693

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.045229   .0772398   -13.53   0.000    -1.196616   -.8938415
       _cons |  -1.139071   .1638335    -6.95   0.000    -1.460179   -.8179635
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,608
                                                  Wald chi2(2)    =     523.36
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1430
                                                  Root MSE        =     2.1188

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9967684   .0599714   -16.62   0.000     -1.11431   -.8792266
       y2000 |  -.8767305   .1157349    -7.58   0.000    -1.103567   -.6498942
       _cons |  -.3520314   .0982536    -3.58   0.000    -.5446049   -.1594579
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9370
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    948,036      100.00      100.00
------------+-----------------------------------
      Total |    948,036      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    316,012       33.33       33.33
          3 |    632,024       66.67      100.00
------------+-----------------------------------
      Total |    948,036      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(316,012 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(316,012 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(316,012 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004e not found)
file /tmp/St32493.00004e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        796       20.00       20.00
       1980 |        796       20.00       40.00
       1990 |        796       20.00       60.00
       2000 |        796       20.00       80.00
       2007 |        796       20.00      100.00
------------+-----------------------------------
      Total |      3,980      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,184 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(796 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(796 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,184 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(796 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(792 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,184 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(796 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,592
        from master                     1,592  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,388  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,592       40.00       40.00
            matched (3) |      2,388       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,980      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       796          0 |       796 
      1980 |         0        796 |       796 
      1990 |         0        796 |       796 
      2000 |         0        796 |       796 
      2007 |       796          0 |       796 
-----------+----------------------+----------
     Total |     1,592      2,388 |     3,980 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,592 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        795
                                                  Wald chi2(1)    =      79.00
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9294

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8658439   .0974167    -8.89   0.000    -1.056777   -.6749107
       _cons |   -.491648   .1241914    -3.96   0.000    -.7350588   -.2482373
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        795
                                                  Wald chi2(1)    =     181.05
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0941
                                                  Root MSE        =     2.2681

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.045673   .0777126   -13.46   0.000    -1.197987   -.8933588
       _cons |  -1.138318    .164815    -6.91   0.000     -1.46135   -.8152867
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,590
                                                  Wald chi2(2)    =     517.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1432
                                                  Root MSE        =      2.118

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9973311   .0603482   -16.53   0.000    -1.115611   -.8790508
       y2000 |  -.8760407    .116369    -7.53   0.000     -1.10412   -.6479617
       _cons |  -.3517615   .0988156    -3.56   0.000    -.5454365   -.1580865
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9375
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    927,789      100.00      100.00
------------+-----------------------------------
      Total |    927,789      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    309,263       33.33       33.33
          3 |    618,526       66.67      100.00
------------+-----------------------------------
      Total |    927,789      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(309,263 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(309,263 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(309,263 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004g not found)
file /tmp/St32493.00004g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        779       20.00       20.00
       1980 |        779       20.00       40.00
       1990 |        779       20.00       60.00
       2000 |        779       20.00       80.00
       2007 |        779       20.00      100.00
------------+-----------------------------------
      Total |      3,895      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,116 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(779 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(779 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,116 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(779 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(777 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,116 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(779 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,558
        from master                     1,558  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,337  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,558       40.00       40.00
            matched (3) |      2,337       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,895      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       779          0 |       779 
      1980 |         0        779 |       779 
      1990 |         0        779 |       779 
      2000 |         0        779 |       779 
      2007 |       779          0 |       779 
-----------+----------------------+----------
     Total |     1,558      2,337 |     3,895 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,558 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        778
                                                  Wald chi2(1)    =      76.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9253

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8652477   .0987695    -8.76   0.000    -1.058832    -.671663
       _cons |  -.4931352   .1258327    -3.92   0.000    -.7397629   -.2465076
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        778
                                                  Wald chi2(1)    =     175.13
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0919
                                                  Root MSE        =     2.2641

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.042333   .0787647   -13.23   0.000    -1.196709   -.8879574
       _cons |  -1.146036   .1669641    -6.86   0.000     -1.47328   -.8187923
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,556
                                                  Wald chi2(2)    =     505.22
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1433
                                                  Root MSE        =     2.1134

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9947395   .0611501   -16.27   0.000    -1.114592   -.8748874
       y2000 |  -.8790015   .1174674    -7.48   0.000    -1.109233   -.6487697
       _cons |  -.3551982   .0999184    -3.55   0.000    -.5510346   -.1593618
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9380
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    909,924      100.00      100.00
------------+-----------------------------------
      Total |    909,924      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    303,308       33.33       33.33
          3 |    606,616       66.67      100.00
------------+-----------------------------------
      Total |    909,924      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(303,308 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(303,308 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(303,308 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004i not found)
file /tmp/St32493.00004i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        764       20.00       20.00
       1980 |        764       20.00       40.00
       1990 |        764       20.00       60.00
       2000 |        764       20.00       80.00
       2007 |        764       20.00      100.00
------------+-----------------------------------
      Total |      3,820      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,056 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(764 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,056 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(762 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,056 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,528
        from master                     1,528  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,292  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,528       40.00       40.00
            matched (3) |      2,292       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,820      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       764          0 |       764 
      1980 |         0        764 |       764 
      1990 |         0        764 |       764 
      2000 |         0        764 |       764 
      2007 |       764          0 |       764 
-----------+----------------------+----------
     Total |     1,528      2,292 |     3,820 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,528 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        763
                                                  Wald chi2(1)    =      75.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9132

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8629571   .0991752    -8.70   0.000    -1.057337   -.6685773
       _cons |  -.4947223   .1264157    -3.91   0.000    -.7424926    -.246952
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        763
                                                  Wald chi2(1)    =     171.72
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0909
                                                  Root MSE        =     2.2593

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.042135    .079527   -13.10   0.000    -1.198005    -.886265
       _cons |  -1.144621   .1685969    -6.79   0.000    -1.475065   -.8141772
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,526
                                                  Wald chi2(2)    =     497.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1440
                                                  Root MSE        =     2.1053

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9939925   .0616167   -16.13   0.000    -1.114759   -.8732259
       y2000 |  -.8788713   .1182028    -7.44   0.000    -1.110544   -.6471981
       _cons |  -.3549963   .1006266    -3.53   0.000    -.5522208   -.1577718
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9385
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    893,250      100.00      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    297,750       33.33       33.33
          3 |    595,500       66.67      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(297,750 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(297,750 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(297,750 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004k not found)
file /tmp/St32493.00004k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        750       20.00       20.00
       1980 |        750       20.00       40.00
       1990 |        750       20.00       60.00
       2000 |        750       20.00       80.00
       2007 |        750       20.00      100.00
------------+-----------------------------------
      Total |      3,750      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,000 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(750 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(749 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,500
        from master                     1,500  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,250  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,500       40.00       40.00
            matched (3) |      2,250       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,750      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       750          0 |       750 
      1980 |         0        750 |       750 
      1990 |         0        750 |       750 
      2000 |         0        750 |       750 
      2007 |       750          0 |       750 
-----------+----------------------+----------
     Total |     1,500      2,250 |     3,750 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,500 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =      74.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9119

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8770238   .1014639    -8.64   0.000    -1.075889   -.6781581
       _cons |  -.4801703   .1287063    -3.73   0.000      -.73243   -.2279106
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =     174.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0906
                                                  Root MSE        =     2.2506

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.050352   .0795033   -13.21   0.000    -1.206175   -.8945284
       _cons |  -1.130059   .1688027    -6.69   0.000    -1.460906   -.7992115
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,498
                                                  Wald chi2(2)    =     497.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1447
                                                  Root MSE        =     2.0992

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.004355   .0619825   -16.20   0.000    -1.125838   -.8828711
       y2000 |  -.8708337   .1189859    -7.32   0.000    -1.104042   -.6376257
       _cons |  -.3445146   .1012129    -3.40   0.001    -.5428884   -.1461409
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9390
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    878,958      100.00      100.00
------------+-----------------------------------
      Total |    878,958      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    292,986       33.33       33.33
          3 |    585,972       66.67      100.00
------------+-----------------------------------
      Total |    878,958      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(292,986 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(292,986 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(292,986 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004m not found)
file /tmp/St32493.00004m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        738       20.00       20.00
       1980 |        738       20.00       40.00
       1990 |        738       20.00       60.00
       2000 |        738       20.00       80.00
       2007 |        738       20.00      100.00
------------+-----------------------------------
      Total |      3,690      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,952 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(738 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(738 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,952 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(738 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(737 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,952 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(738 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,476
        from master                     1,476  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,214  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,476       40.00       40.00
            matched (3) |      2,214       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,690      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       738          0 |       738 
      1980 |         0        738 |       738 
      1990 |         0        738 |       738 
      2000 |         0        738 |       738 
      2007 |       738          0 |       738 
-----------+----------------------+----------
     Total |     1,476      2,214 |     3,690 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,476 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        737
                                                  Wald chi2(1)    =      73.07
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9106

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8745236   .1023041    -8.55   0.000    -1.075036   -.6740113
       _cons |  -.4847374   .1297798    -3.74   0.000    -.7391011   -.2303737
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        737
                                                  Wald chi2(1)    =     176.72
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0887
                                                  Root MSE        =       2.25

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.057458   .0795453   -13.29   0.000    -1.213364   -.9015518
       _cons |   -1.11639   .1692012    -6.60   0.000    -1.448018   -.7847616
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,474
                                                  Wald chi2(2)    =     494.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1431
                                                  Root MSE        =     2.0989

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.008799   .0621281   -16.24   0.000    -1.130568   -.8870304
       y2000 |  -.8650031   .1198114    -7.22   0.000    -1.099829    -.630177
       _cons |  -.3416211   .1017943    -3.36   0.001    -.5411342    -.142108
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9395
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    870,621      100.00      100.00
------------+-----------------------------------
      Total |    870,621      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    290,207       33.33       33.33
          3 |    580,414       66.67      100.00
------------+-----------------------------------
      Total |    870,621      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(290,207 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(290,207 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(290,207 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004o not found)
file /tmp/St32493.00004o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        731       20.00       20.00
       1980 |        731       20.00       40.00
       1990 |        731       20.00       60.00
       2000 |        731       20.00       80.00
       2007 |        731       20.00      100.00
------------+-----------------------------------
      Total |      3,655      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,924 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(731 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(731 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,924 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(731 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(730 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,924 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(731 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,462
        from master                     1,462  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,193  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,462       40.00       40.00
            matched (3) |      2,193       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,655      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       731          0 |       731 
      1980 |         0        731 |       731 
      1990 |         0        731 |       731 
      2000 |         0        731 |       731 
      2007 |       731          0 |       731 
-----------+----------------------+----------
     Total |     1,462      2,193 |     3,655 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,462 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        730
                                                  Wald chi2(1)    =      72.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9081

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8713763   .1026197    -8.49   0.000    -1.072507   -.6702454
       _cons |  -.4880545   .1302123    -3.75   0.000     -.743266    -.232843
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        730
                                                  Wald chi2(1)    =     174.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0890
                                                  Root MSE        =     2.2489

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.055896   .0798493   -13.22   0.000    -1.212397   -.8993938
       _cons |  -1.119173    .169883    -6.59   0.000    -1.452137    -.786208
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,460
                                                  Wald chi2(2)    =     489.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1437
                                                  Root MSE        =     2.0971

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.006814   .0623478   -16.15   0.000    -1.129014   -.8846148
       y2000 |   -.866532   .1202787    -7.20   0.000    -1.102274   -.6307902
       _cons |  -.3436713   .1021876    -3.36   0.001    -.5439553   -.1433872
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9400
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    863,475      100.00      100.00
------------+-----------------------------------
      Total |    863,475      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    287,825       33.33       33.33
          3 |    575,650       66.67      100.00
------------+-----------------------------------
      Total |    863,475      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(287,825 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(287,825 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(287,825 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004q not found)
file /tmp/St32493.00004q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        725       20.00       20.00
       1980 |        725       20.00       40.00
       1990 |        725       20.00       60.00
       2000 |        725       20.00       80.00
       2007 |        725       20.00      100.00
------------+-----------------------------------
      Total |      3,625      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,900 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(725 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(725 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,900 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(725 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(725 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,900 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(725 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,450
        from master                     1,450  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,175  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,450       40.00       40.00
            matched (3) |      2,175       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,625      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       725          0 |       725 
      1980 |         0        725 |       725 
      1990 |         0        725 |       725 
      2000 |         0        725 |       725 
      2007 |       725          0 |       725 
-----------+----------------------+----------
     Total |     1,450      2,175 |     3,625 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,450 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        724
                                                  Wald chi2(1)    =      71.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9048

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8703812   .1029245    -8.46   0.000     -1.07211   -.6686528
       _cons |  -.4889272    .130726    -3.74   0.000    -.7451456   -.2327089
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        724
                                                  Wald chi2(1)    =     173.42
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0889
                                                  Root MSE        =      2.241

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.054402   .0800682   -13.17   0.000    -1.211332   -.8974708
       _cons |  -1.123896   .1704094    -6.60   0.000    -1.457892   -.7898996
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,448
                                                  Wald chi2(2)    =     487.44
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1443
                                                  Root MSE        =     2.0914

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.005394   .0625397   -16.08   0.000     -1.12797   -.8828189
       y2000 |  -.8701281   .1204882    -7.22   0.000    -1.106281   -.6339756
       _cons |  -.3447638   .1024724    -3.36   0.001    -.5456059   -.1439216
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9405
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    853,947      100.00      100.00
------------+-----------------------------------
      Total |    853,947      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    284,649       33.33       33.33
          3 |    569,298       66.67      100.00
------------+-----------------------------------
      Total |    853,947      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(284,649 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(284,649 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(284,649 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004s not found)
file /tmp/St32493.00004s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        717       20.00       20.00
       1980 |        717       20.00       40.00
       1990 |        717       20.00       60.00
       2000 |        717       20.00       80.00
       2007 |        717       20.00      100.00
------------+-----------------------------------
      Total |      3,585      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,868 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(717 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(717 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,868 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(717 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(717 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,868 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(717 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,434
        from master                     1,434  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,151  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,434       40.00       40.00
            matched (3) |      2,151       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,585      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       717          0 |       717 
      1980 |         0        717 |       717 
      1990 |         0        717 |       717 
      2000 |         0        717 |       717 
      2007 |       717          0 |       717 
-----------+----------------------+----------
     Total |     1,434      2,151 |     3,585 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,434 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        716
                                                  Wald chi2(1)    =      70.30
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9011

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8672984   .1034441    -8.38   0.000    -1.070045   -.6645516
       _cons |  -.4940331   .1313164    -3.76   0.000    -.7514085   -.2366577
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        716
                                                  Wald chi2(1)    =     172.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0891
                                                  Root MSE        =      2.234

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.05519   .0803712   -13.13   0.000    -1.212715   -.8976657
       _cons |  -1.122084   .1710279    -6.56   0.000    -1.457292   -.7868754
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,432
                                                  Wald chi2(2)    =     483.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1448
                                                  Root MSE        =     2.0861

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.005193   .0628191   -16.00   0.000    -1.128316   -.8820697
       y2000 |  -.8681224   .1208987    -7.18   0.000    -1.105079   -.6311654
       _cons |  -.3468175   .1028387    -3.37   0.001    -.5483776   -.1452574
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9410
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    842,037      100.00      100.00
------------+-----------------------------------
      Total |    842,037      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    280,679       33.33       33.33
          3 |    561,358       66.67      100.00
------------+-----------------------------------
      Total |    842,037      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(280,679 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(280,679 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(280,679 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004u not found)
file /tmp/St32493.00004u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        707       20.00       20.00
       1980 |        707       20.00       40.00
       1990 |        707       20.00       60.00
       2000 |        707       20.00       80.00
       2007 |        707       20.00      100.00
------------+-----------------------------------
      Total |      3,535      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,828 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(707 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(707 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,828 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(707 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(707 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,828 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(707 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,414
        from master                     1,414  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,121  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,414       40.00       40.00
            matched (3) |      2,121       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,535      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       707          0 |       707 
      1980 |         0        707 |       707 
      1990 |         0        707 |       707 
      2000 |         0        707 |       707 
      2007 |       707          0 |       707 
-----------+----------------------+----------
     Total |     1,414      2,121 |     3,535 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,414 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        706
                                                  Wald chi2(1)    =      70.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8832

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.921535    .110061    -8.37   0.000    -1.137251   -.7058193
       _cons |   -.434558   .1372816    -3.17   0.002     -.703625    -.165491
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        706
                                                  Wald chi2(1)    =     182.27
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0945
                                                  Root MSE        =     2.2215

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.084833   .0803537   -13.50   0.000    -1.242323   -.9273427
       _cons |   -1.07306   .1708393    -6.28   0.000    -1.407899   -.7382213
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,412
                                                  Wald chi2(2)    =     497.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1569
                                                  Root MSE        =     2.0672

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.042453   .0636279   -16.38   0.000    -1.167161   -.9177445
       y2000 |  -.8462484   .1208535    -7.00   0.000    -1.083117   -.6093798
       _cons |  -.3053882   .1033086    -2.96   0.003    -.5078693   -.1029071
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9415
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    821,790      100.00      100.00
------------+-----------------------------------
      Total |    821,790      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    273,930       33.33       33.33
          3 |    547,860       66.67      100.00
------------+-----------------------------------
      Total |    821,790      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(273,930 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(273,930 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(273,930 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00004w not found)
file /tmp/St32493.00004w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        690       20.00       20.00
       1980 |        690       20.00       40.00
       1990 |        690       20.00       60.00
       2000 |        690       20.00       80.00
       2007 |        690       20.00      100.00
------------+-----------------------------------
      Total |      3,450      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,760 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(690 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(690 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,760 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(690 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(690 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,760 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(690 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,380
        from master                     1,380  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,070  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,380       40.00       40.00
            matched (3) |      2,070       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,450      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       690          0 |       690 
      1980 |         0        690 |       690 
      1990 |         0        690 |       690 
      2000 |         0        690 |       690 
      2007 |       690          0 |       690 
-----------+----------------------+----------
     Total |     1,380      2,070 |     3,450 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,380 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        689
                                                  Wald chi2(1)    =      68.46
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8793

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9213688   .1113545    -8.27   0.000     -1.13962    -.703118
       _cons |   -.435349   .1388279    -3.14   0.002    -.7074466   -.1632514
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        689
                                                  Wald chi2(1)    =     177.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0951
                                                  Root MSE        =     2.2144

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.087987   .0816182   -13.33   0.000    -1.247956   -.9280186
       _cons |  -1.069064   .1732071    -6.17   0.000    -1.408544   -.7295845
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,378
                                                  Wald chi2(2)    =     486.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1580
                                                  Root MSE        =     2.0616

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.04459   .0645776   -16.18   0.000    -1.171159   -.9180199
       y2000 |  -.8457677   .1221037    -6.93   0.000    -1.085087   -.6064488
       _cons |  -.3037309   .1045317    -2.91   0.004    -.5086093   -.0988524
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9420
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    808,689      100.00      100.00
------------+-----------------------------------
      Total |    808,689      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    269,563       33.33       33.33
          3 |    539,126       66.67      100.00
------------+-----------------------------------
      Total |    808,689      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(269,563 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(269,563 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(269,563 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000050 not found)
file /tmp/St32493.000050 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        679       20.00       20.00
       1980 |        679       20.00       40.00
       1990 |        679       20.00       60.00
       2000 |        679       20.00       80.00
       2007 |        679       20.00      100.00
------------+-----------------------------------
      Total |      3,395      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,716 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(679 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(679 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,716 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(679 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(679 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,716 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(679 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,358
        from master                     1,358  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,037  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,358       40.00       40.00
            matched (3) |      2,037       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,395      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       679          0 |       679 
      1980 |         0        679 |       679 
      1990 |         0        679 |       679 
      2000 |         0        679 |       679 
      2007 |       679          0 |       679 
-----------+----------------------+----------
     Total |     1,358      2,037 |     3,395 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,358 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        678
                                                  Wald chi2(1)    =      66.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8758

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9178469   .1123542    -8.17   0.000    -1.138057   -.6976367
       _cons |  -.4401488   .1400289    -3.14   0.002    -.7146005   -.1656971
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        678
                                                  Wald chi2(1)    =     173.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0923
                                                  Root MSE        =     2.2046

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.087853   .0826528   -13.16   0.000     -1.24985    -.925857
       _cons |  -1.070632   .1750465    -6.12   0.000    -1.413717   -.7275468
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,356
                                                  Wald chi2(2)    =     477.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1564
                                                  Root MSE        =     2.0549

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.043348   .0653659   -15.96   0.000    -1.171462   -.9152327
       y2000 |  -.8471082   .1228351    -6.90   0.000    -1.087861   -.6063558
       _cons |  -.3060211   .1053965    -2.90   0.004    -.5125945   -.0994477
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9425
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    796,779      100.00      100.00
------------+-----------------------------------
      Total |    796,779      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    265,593       33.33       33.33
          3 |    531,186       66.67      100.00
------------+-----------------------------------
      Total |    796,779      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(265,593 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(265,593 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(265,593 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000052 not found)
file /tmp/St32493.000052 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        669       20.00       20.00
       1980 |        669       20.00       40.00
       1990 |        669       20.00       60.00
       2000 |        669       20.00       80.00
       2007 |        669       20.00      100.00
------------+-----------------------------------
      Total |      3,345      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,676 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(669 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(669 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,676 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(669 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(669 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,676 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(669 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,338
        from master                     1,338  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,007  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,338       40.00       40.00
            matched (3) |      2,007       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,345      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       669          0 |       669 
      1980 |         0        669 |       669 
      1990 |         0        669 |       669 
      2000 |         0        669 |       669 
      2007 |       669          0 |       669 
-----------+----------------------+----------
     Total |     1,338      2,007 |     3,345 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,338 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        668
                                                  Wald chi2(1)    =      65.83
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8644

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.913026    .112533    -8.11   0.000    -1.133587   -.6924653
       _cons |  -.4485816    .140271    -3.20   0.001    -.7235077   -.1736555
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        668
                                                  Wald chi2(1)    =     170.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0910
                                                  Root MSE        =     2.1991

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.086038   .0831673   -13.06   0.000    -1.249043   -.9230334
       _cons |  -1.074799   .1761314    -6.10   0.000     -1.42001   -.7295879
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,336
                                                  Wald chi2(2)    =     471.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1568
                                                  Root MSE        =     2.0468

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.040706   .0656594   -15.85   0.000    -1.169396   -.9120161
       y2000 |  -.8467709   .1232938    -6.87   0.000    -1.088422   -.6051195
       _cons |  -.3120876   .1058223    -2.95   0.003    -.5194955   -.1046797
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9430
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    787,251      100.00      100.00
------------+-----------------------------------
      Total |    787,251      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    262,417       33.33       33.33
          3 |    524,834       66.67      100.00
------------+-----------------------------------
      Total |    787,251      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(262,417 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(262,417 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(262,417 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000054 not found)
file /tmp/St32493.000054 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        661       20.00       20.00
       1980 |        661       20.00       40.00
       1990 |        661       20.00       60.00
       2000 |        661       20.00       80.00
       2007 |        661       20.00      100.00
------------+-----------------------------------
      Total |      3,305      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,644 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(661 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(661 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,644 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(661 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(661 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,644 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(661 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,322
        from master                     1,322  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,983  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,322       40.00       40.00
            matched (3) |      1,983       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,305      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       661          0 |       661 
      1980 |         0        661 |       661 
      1990 |         0        661 |       661 
      2000 |         0        661 |       661 
      2007 |       661          0 |       661 
-----------+----------------------+----------
     Total |     1,322      1,983 |     3,305 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,322 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        660
                                                  Wald chi2(1)    =      68.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8694

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9583954   .1156345    -8.29   0.000    -1.185035   -.7317559
       _cons |  -.4016347   .1433562    -2.80   0.005    -.6826077   -.1206618
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        660
                                                  Wald chi2(1)    =     169.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0886
                                                  Root MSE        =     2.1997

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.105898   .0848466   -13.03   0.000    -1.272194   -.9396017
       _cons |  -1.039808   .1789911    -5.81   0.000    -1.390624   -.6889916
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,320
                                                  Wald chi2(2)    =     470.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1539
                                                  Root MSE        =     2.0483

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.067601   .0671094   -15.91   0.000    -1.199133    -.936069
       y2000 |  -.8257685   .1244378    -6.64   0.000    -1.069662   -.5818748
       _cons |  -.2849866   .1072161    -2.66   0.008    -.4951264   -.0748468
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9435
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    776,532      100.00      100.00
------------+-----------------------------------
      Total |    776,532      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    258,844       33.33       33.33
          3 |    517,688       66.67      100.00
------------+-----------------------------------
      Total |    776,532      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(258,844 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(258,844 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(258,844 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000056 not found)
file /tmp/St32493.000056 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        652       20.00       20.00
       1980 |        652       20.00       40.00
       1990 |        652       20.00       60.00
       2000 |        652       20.00       80.00
       2007 |        652       20.00      100.00
------------+-----------------------------------
      Total |      3,260      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,608 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(652 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(652 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,608 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(652 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(652 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,608 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(652 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,304
        from master                     1,304  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,956  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,304       40.00       40.00
            matched (3) |      1,956       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,260      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       652          0 |       652 
      1980 |         0        652 |       652 
      1990 |         0        652 |       652 
      2000 |         0        652 |       652 
      2007 |       652          0 |       652 
-----------+----------------------+----------
     Total |     1,304      1,956 |     3,260 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,304 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        651
                                                  Wald chi2(1)    =      67.42
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8604

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9508983   .1158115    -8.21   0.000    -1.177885   -.7239119
       _cons |  -.4141654   .1435735    -2.88   0.004    -.6955642   -.1327666
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        651
                                                  Wald chi2(1)    =     167.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0886
                                                  Root MSE        =     2.1961

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.105577   .0853016   -12.96   0.000    -1.272765   -.9383893
       _cons |  -1.039366   .1799142    -5.78   0.000    -1.391991   -.6867407
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,302
                                                  Wald chi2(2)    =     464.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1541
                                                  Root MSE        =     2.0425

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.065418   .0673785   -15.81   0.000    -1.197478   -.9333588
       y2000 |  -.8218814   .1249343    -6.58   0.000    -1.066748   -.5770147
       _cons |  -.2918643   .1076391    -2.71   0.007    -.5028332   -.0808955
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9440
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    758,667      100.00      100.00
------------+-----------------------------------
      Total |    758,667      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    252,889       33.33       33.33
          3 |    505,778       66.67      100.00
------------+-----------------------------------
      Total |    758,667      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(252,889 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(252,889 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(252,889 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000058 not found)
file /tmp/St32493.000058 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        637       20.00       20.00
       1980 |        637       20.00       40.00
       1990 |        637       20.00       60.00
       2000 |        637       20.00       80.00
       2007 |        637       20.00      100.00
------------+-----------------------------------
      Total |      3,185      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,548 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(637 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(637 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,548 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(637 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(637 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,548 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(637 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,274
        from master                     1,274  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,911  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,274       40.00       40.00
            matched (3) |      1,911       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,185      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       637          0 |       637 
      1980 |         0        637 |       637 
      1990 |         0        637 |       637 
      2000 |         0        637 |       637 
      2007 |       637          0 |       637 
-----------+----------------------+----------
     Total |     1,274      1,911 |     3,185 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,274 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        636
                                                  Wald chi2(1)    =      66.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8585

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9540012   .1167667    -8.17   0.000     -1.18286   -.7251427
       _cons |  -.4106149   .1449375    -2.83   0.005    -.6946873   -.1265426
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        636
                                                  Wald chi2(1)    =     163.43
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0888
                                                  Root MSE        =     2.1881

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.100956   .0861198   -12.78   0.000    -1.269747    -.932164
       _cons |   -1.04922    .181633    -5.78   0.000    -1.405214    -.693226
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,272
                                                  Wald chi2(2)    =     454.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1545
                                                  Root MSE        =      2.037

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.062786    .068025   -15.62   0.000    -1.196112   -.9294591
       y2000 |   -.825603   .1260686    -6.55   0.000    -1.072693   -.5785131
       _cons |  -.2943416   .1086776    -2.71   0.007    -.5073459   -.0813374
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9445
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    750,330      100.00      100.00
------------+-----------------------------------
      Total |    750,330      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    250,110       33.33       33.33
          3 |    500,220       66.67      100.00
------------+-----------------------------------
      Total |    750,330      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(250,110 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(250,110 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(250,110 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005a not found)
file /tmp/St32493.00005a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        630       20.00       20.00
       1980 |        630       20.00       40.00
       1990 |        630       20.00       60.00
       2000 |        630       20.00       80.00
       2007 |        630       20.00      100.00
------------+-----------------------------------
      Total |      3,150      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,520 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(630 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(630 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,520 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(630 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(630 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,520 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(630 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,260
        from master                     1,260  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,890  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,260       40.00       40.00
            matched (3) |      1,890       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,150      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       630          0 |       630 
      1980 |         0        630 |       630 
      1990 |         0        630 |       630 
      2000 |         0        630 |       630 
      2007 |       630          0 |       630 
-----------+----------------------+----------
     Total |     1,260      1,890 |     3,150 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,260 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        629
                                                  Wald chi2(1)    =      66.80
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8456

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.952657   .1165601    -8.17   0.000    -1.181111   -.7242034
       _cons |  -.4172511   .1447137    -2.88   0.004    -.7008848   -.1336174
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        629
                                                  Wald chi2(1)    =     162.50
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0915
                                                  Root MSE        =     2.1779

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.099779   .0862739   -12.75   0.000    -1.268872   -.9306851
       _cons |  -1.056371   .1818462    -5.81   0.000    -1.412783   -.6999594
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,258
                                                  Wald chi2(2)    =     453.80
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1571
                                                  Root MSE        =     2.0257

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.061512   .0680606   -15.60   0.000    -1.194908   -.9281153
       y2000 |  -.8263564   .1260407    -6.56   0.000    -1.073392   -.5793211
       _cons |  -.3008826   .1087077    -2.77   0.006    -.5139457   -.0878194
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9450
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    741,993      100.00      100.00
------------+-----------------------------------
      Total |    741,993      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    247,331       33.33       33.33
          3 |    494,662       66.67      100.00
------------+-----------------------------------
      Total |    741,993      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(247,331 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(247,331 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(247,331 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005c not found)
file /tmp/St32493.00005c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        623       20.00       20.00
       1980 |        623       20.00       40.00
       1990 |        623       20.00       60.00
       2000 |        623       20.00       80.00
       2007 |        623       20.00      100.00
------------+-----------------------------------
      Total |      3,115      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,492 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(623 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(623 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,492 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(623 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(623 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,492 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(623 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,246
        from master                     1,246  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,869  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,246       40.00       40.00
            matched (3) |      1,869       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,115      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       623          0 |       623 
      1980 |         0        623 |       623 
      1990 |         0        623 |       623 
      2000 |         0        623 |       623 
      2007 |       623          0 |       623 
-----------+----------------------+----------
     Total |     1,246      1,869 |     3,115 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,246 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        622
                                                  Wald chi2(1)    =      67.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8342

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9615848   .1169379    -8.22   0.000    -1.190779   -.7323907
       _cons |  -.4116347   .1449274    -2.84   0.005    -.6956872   -.1275822
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        622
                                                  Wald chi2(1)    =     159.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0905
                                                  Root MSE        =     2.1753

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.100078   .0869978   -12.64   0.000     -1.27059   -.9295652
       _cons |  -1.057958   .1831596    -5.78   0.000    -1.416944   -.6989714
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,244
                                                  Wald chi2(2)    =     450.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1590
                                                  Root MSE        =     2.0183

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.063977   .0684588   -15.54   0.000    -1.198153   -.9297999
       y2000 |  -.8225022   .1263915    -6.51   0.000    -1.070225   -.5747794
       _cons |  -.3022891   .1090602    -2.77   0.006    -.5160433    -.088535
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9455
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    728,892      100.00      100.00
------------+-----------------------------------
      Total |    728,892      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    242,964       33.33       33.33
          3 |    485,928       66.67      100.00
------------+-----------------------------------
      Total |    728,892      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(242,964 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(242,964 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(242,964 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005e not found)
file /tmp/St32493.00005e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        612       20.00       20.00
       1980 |        612       20.00       40.00
       1990 |        612       20.00       60.00
       2000 |        612       20.00       80.00
       2007 |        612       20.00      100.00
------------+-----------------------------------
      Total |      3,060      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,448 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(612 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(612 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,448 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(612 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(612 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,448 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(612 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,224
        from master                     1,224  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,836  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,224       40.00       40.00
            matched (3) |      1,836       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,060      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       612          0 |       612 
      1980 |         0        612 |       612 
      1990 |         0        612 |       612 
      2000 |         0        612 |       612 
      2007 |       612          0 |       612 
-----------+----------------------+----------
     Total |     1,224      1,836 |     3,060 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,224 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        611
                                                  Wald chi2(1)    =      66.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8242

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.95127   .1170706    -8.13   0.000    -1.180724   -.7218159
       _cons |   -.424865   .1451874    -2.93   0.003     -.709427   -.1403029
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        611
                                                  Wald chi2(1)    =     158.67
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0922
                                                  Root MSE        =     2.1628

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.099858   .0873141   -12.60   0.000     -1.27099   -.9287253
       _cons |  -1.059177   .1837389    -5.76   0.000    -1.419298   -.6990549
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,222
                                                  Wald chi2(2)    =     446.06
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1613
                                                  Root MSE        =     2.0072

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.061021   .0686714   -15.45   0.000    -1.195615   -.9264278
       y2000 |    -.82339   .1267846    -6.49   0.000    -1.071883   -.5748968
       _cons |  -.3076503   .1094197    -2.81   0.005     -.522109   -.0931917
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9460
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    719,364      100.00      100.00
------------+-----------------------------------
      Total |    719,364      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    239,788       33.33       33.33
          3 |    479,576       66.67      100.00
------------+-----------------------------------
      Total |    719,364      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(239,788 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(239,788 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(239,788 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005g not found)
file /tmp/St32493.00005g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        604       20.00       20.00
       1980 |        604       20.00       40.00
       1990 |        604       20.00       60.00
       2000 |        604       20.00       80.00
       2007 |        604       20.00      100.00
------------+-----------------------------------
      Total |      3,020      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,416 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(604 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(604 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,416 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(604 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(604 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,416 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(604 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,208
        from master                     1,208  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,812  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,208       40.00       40.00
            matched (3) |      1,812       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,020      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       604          0 |       604 
      1980 |         0        604 |       604 
      1990 |         0        604 |       604 
      2000 |         0        604 |       604 
      2007 |       604          0 |       604 
-----------+----------------------+----------
     Total |     1,208      1,812 |     3,020 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,208 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        603
                                                  Wald chi2(1)    =      66.24
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8041

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9282191   .1140481    -8.14   0.000    -1.151749    -.704689
       _cons |  -.4541257   .1422394    -3.19   0.001    -.7329097   -.1753417
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        603
                                                  Wald chi2(1)    =     156.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0919
                                                  Root MSE        =     2.1589

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.099435    .087826   -12.52   0.000    -1.271571   -.9272997
       _cons |  -1.062588   .1847894    -5.75   0.000    -1.424768   -.7004072
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,206
                                                  Wald chi2(2)    =     443.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1636
                                                  Root MSE        =     1.9966

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.054493   .0684545   -15.40   0.000    -1.188662   -.9203249
       y2000 |  -.8264873    .126857    -6.52   0.000    -1.075122   -.5778521
       _cons |  -.3192726   .1093403    -2.92   0.004    -.5335757   -.1049695
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9465
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    708,645      100.00      100.00
------------+-----------------------------------
      Total |    708,645      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    236,215       33.33       33.33
          3 |    472,430       66.67      100.00
------------+-----------------------------------
      Total |    708,645      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(236,215 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(236,215 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(236,215 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005i not found)
file /tmp/St32493.00005i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        595       20.00       20.00
       1980 |        595       20.00       40.00
       1990 |        595       20.00       60.00
       2000 |        595       20.00       80.00
       2007 |        595       20.00      100.00
------------+-----------------------------------
      Total |      2,975      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,380 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(595 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(595 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,380 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(595 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(595 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,380 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(595 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,190
        from master                     1,190  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,785  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,190       40.00       40.00
            matched (3) |      1,785       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,975      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       595          0 |       595 
      1980 |         0        595 |       595 
      1990 |         0        595 |       595 
      2000 |         0        595 |       595 
      2007 |       595          0 |       595 
-----------+----------------------+----------
     Total |     1,190      1,785 |     2,975 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,190 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        594
                                                  Wald chi2(1)    =      64.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8017

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9299385   .1153622    -8.06   0.000    -1.156044   -.7038328
       _cons |  -.4538707     .14367    -3.16   0.002    -.7354588   -.1722826
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        594
                                                  Wald chi2(1)    =     154.90
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0922
                                                  Root MSE        =     2.1544

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.101211   .0884787   -12.45   0.000    -1.274626    -.927796
       _cons |   -1.06145   .1860395    -5.71   0.000    -1.426081   -.6968196
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,188
                                                  Wald chi2(2)    =     438.09
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1636
                                                  Root MSE        =     1.9931

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.056376   .0690477   -15.30   0.000    -1.191707   -.9210446
       y2000 |  -.8255493   .1276439    -6.47   0.000    -1.075727    -.575372
       _cons |  -.3188527   .1101107    -2.90   0.004    -.5346657   -.1030398
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9470
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    699,117      100.00      100.00
------------+-----------------------------------
      Total |    699,117      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    233,039       33.33       33.33
          3 |    466,078       66.67      100.00
------------+-----------------------------------
      Total |    699,117      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(233,039 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(233,039 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(233,039 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005k not found)
file /tmp/St32493.00005k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        587       20.00       20.00
       1980 |        587       20.00       40.00
       1990 |        587       20.00       60.00
       2000 |        587       20.00       80.00
       2007 |        587       20.00      100.00
------------+-----------------------------------
      Total |      2,935      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,348 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(587 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(587 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,348 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(587 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(587 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,348 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(587 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,174
        from master                     1,174  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,761  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,174       40.00       40.00
            matched (3) |      1,761       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,935      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       587          0 |       587 
      1980 |         0        587 |       587 
      1990 |         0        587 |       587 
      2000 |         0        587 |       587 
      2007 |       587          0 |       587 
-----------+----------------------+----------
     Total |     1,174      1,761 |     2,935 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,174 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        586
                                                  Wald chi2(1)    =      64.77
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7932

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.937848   .1165358    -8.05   0.000    -1.166254   -.7094421
       _cons |   -.447845   .1446421    -3.10   0.002    -.7313383   -.1643518
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        586
                                                  Wald chi2(1)    =     154.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0892
                                                  Root MSE        =     2.1536

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.11028   .0893675   -12.42   0.000    -1.285437   -.9351224
       _cons |  -1.045077   .1876832    -5.57   0.000    -1.412929   -.6772244
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,172
                                                  Wald chi2(2)    =     435.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1640
                                                  Root MSE        =     1.9883

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.065254   .0696782   -15.29   0.000    -1.201821   -.9286877
       y2000 |  -.8163152   .1283368    -6.36   0.000    -1.067851   -.5647797
       _cons |  -.3120221   .1107431    -2.82   0.005    -.5290746   -.0949695
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9475
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    684,825      100.00      100.00
------------+-----------------------------------
      Total |    684,825      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    228,275       33.33       33.33
          3 |    456,550       66.67      100.00
------------+-----------------------------------
      Total |    684,825      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(228,275 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(228,275 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(228,275 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005m not found)
file /tmp/St32493.00005m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        575       20.00       20.00
       1980 |        575       20.00       40.00
       1990 |        575       20.00       60.00
       2000 |        575       20.00       80.00
       2007 |        575       20.00      100.00
------------+-----------------------------------
      Total |      2,875      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,300 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(575 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(575 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,300 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(575 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(575 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,300 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(575 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,150
        from master                     1,150  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,725  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,150       40.00       40.00
            matched (3) |      1,725       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,875      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       575          0 |       575 
      1980 |         0        575 |       575 
      1990 |         0        575 |       575 
      2000 |         0        575 |       575 
      2007 |       575          0 |       575 
-----------+----------------------+----------
     Total |     1,150      1,725 |     2,875 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,150 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        574
                                                  Wald chi2(1)    =      60.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7753

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9110727   .1170857    -7.78   0.000    -1.140556    -.681589
       _cons |  -.4788144   .1452982    -3.30   0.001    -.7635936   -.1940353
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        574
                                                  Wald chi2(1)    =     146.05
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0905
                                                  Root MSE        =      2.123

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.082562   .0895791   -12.08   0.000    -1.258133   -.9069899
       _cons |  -1.092149   .1880015    -5.81   0.000    -1.460625   -.7236726
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,148
                                                  Wald chi2(2)    =     421.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1673
                                                  Root MSE        =     1.9635

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.037709   .0699293   -14.84   0.000    -1.174768   -.9006503
       y2000 |  -.8315326   .1281996    -6.49   0.000    -1.082799   -.5802661
       _cons |   -.343637   .1108533    -3.10   0.002    -.5609055   -.1263684
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9480
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    672,915      100.00      100.00
------------+-----------------------------------
      Total |    672,915      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    224,305       33.33       33.33
          3 |    448,610       66.67      100.00
------------+-----------------------------------
      Total |    672,915      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(224,305 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(224,305 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(224,305 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005o not found)
file /tmp/St32493.00005o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        565       20.00       20.00
       1980 |        565       20.00       40.00
       1990 |        565       20.00       60.00
       2000 |        565       20.00       80.00
       2007 |        565       20.00      100.00
------------+-----------------------------------
      Total |      2,825      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,260 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(565 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(565 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,260 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(565 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(565 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,260 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(565 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,130
        from master                     1,130  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,695  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,130       40.00       40.00
            matched (3) |      1,695       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,825      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       565          0 |       565 
      1980 |         0        565 |       565 
      1990 |         0        565 |       565 
      2000 |         0        565 |       565 
      2007 |       565          0 |       565 
-----------+----------------------+----------
     Total |     1,130      1,695 |     2,825 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,130 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        564
                                                  Wald chi2(1)    =      59.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7536

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9097196   .1179501    -7.71   0.000    -1.140898   -.6785417
       _cons |  -.4812601   .1459168    -3.30   0.001    -.7672518   -.1952685
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        564
                                                  Wald chi2(1)    =     144.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0866
                                                  Root MSE        =     2.1203

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.091291   .0909162   -12.00   0.000    -1.269483   -.9130984
       _cons |   -1.07832   .1904424    -5.66   0.000     -1.45158   -.7050593
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,128
                                                  Wald chi2(2)    =     418.20
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1672
                                                  Root MSE        =     1.9523

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.043898   .0707247   -14.76   0.000    -1.182516   -.9052799
       y2000 |  -.8279195    .128782    -6.43   0.000    -1.080328   -.5755114
       _cons |  -.3380896   .1115932    -3.03   0.002    -.5568081    -.119371
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9485
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    659,814      100.00      100.00
------------+-----------------------------------
      Total |    659,814      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    219,938       33.33       33.33
          3 |    439,876       66.67      100.00
------------+-----------------------------------
      Total |    659,814      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(219,938 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(219,938 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(219,938 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005q not found)
file /tmp/St32493.00005q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        554       20.00       20.00
       1980 |        554       20.00       40.00
       1990 |        554       20.00       60.00
       2000 |        554       20.00       80.00
       2007 |        554       20.00      100.00
------------+-----------------------------------
      Total |      2,770      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,216 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(554 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(554 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,216 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(554 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(554 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,216 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(554 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,108
        from master                     1,108  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,662  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,108       40.00       40.00
            matched (3) |      1,662       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,770      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       554          0 |       554 
      1980 |         0        554 |       554 
      1990 |         0        554 |       554 
      2000 |         0        554 |       554 
      2007 |       554          0 |       554 
-----------+----------------------+----------
     Total |     1,108      1,662 |     2,770 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,108 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        553
                                                  Wald chi2(1)    =      58.22
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7465

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9019065   .1182052    -7.63   0.000    -1.133585   -.6702286
       _cons |  -.4891453   .1464199    -3.34   0.001    -.7761231   -.2021676
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        553
                                                  Wald chi2(1)    =     142.04
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0839
                                                  Root MSE        =     2.1119

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.091757   .0916058   -11.92   0.000    -1.271301   -.9122126
       _cons |  -1.080685   .1917444    -5.64   0.000    -1.456497   -.7048727
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,106
                                                  Wald chi2(2)    =     412.94
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1679
                                                  Root MSE        =     1.9446

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.042118   .0711694   -14.64   0.000    -1.181608   -.9026288
       y2000 |  -.8330179   .1295101    -6.43   0.000    -1.086853   -.5791828
       _cons |  -.3394671   .1122961    -3.02   0.003    -.5595635   -.1193708
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9490
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    652,668      100.00      100.00
------------+-----------------------------------
      Total |    652,668      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    217,556       33.33       33.33
          3 |    435,112       66.67      100.00
------------+-----------------------------------
      Total |    652,668      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(217,556 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(217,556 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(217,556 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005s not found)
file /tmp/St32493.00005s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        548       20.00       20.00
       1980 |        548       20.00       40.00
       1990 |        548       20.00       60.00
       2000 |        548       20.00       80.00
       2007 |        548       20.00      100.00
------------+-----------------------------------
      Total |      2,740      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,192 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(548 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(548 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,192 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(548 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(548 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,192 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(548 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,096
        from master                     1,096  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,644  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,096       40.00       40.00
            matched (3) |      1,644       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,740      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       548          0 |       548 
      1980 |         0        548 |       548 
      1990 |         0        548 |       548 
      2000 |         0        548 |       548 
      2007 |       548          0 |       548 
-----------+----------------------+----------
     Total |     1,096      1,644 |     2,740 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,096 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        547
                                                  Wald chi2(1)    =      58.44
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7341

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9014598   .1179213    -7.64   0.000    -1.132581   -.6703383
       _cons |  -.4968578   .1460878    -3.40   0.001    -.7831847   -.2105309
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        547
                                                  Wald chi2(1)    =     139.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0859
                                                  Root MSE        =     2.0943

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.081297   .0914157   -11.83   0.000    -1.260469   -.9021257
       _cons |  -1.105685   .1912544    -5.78   0.000    -1.480536    -.730833
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,094
                                                  Wald chi2(2)    =     411.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1708
                                                  Root MSE        =     1.9291

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.034187   .0710129   -14.56   0.000    -1.173369   -.8950039
       y2000 |  -.8375957    .129166    -6.48   0.000    -1.090756   -.5844351
       _cons |  -.3551802   .1120224    -3.17   0.002    -.5747401   -.1356203
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9495
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    646,713      100.00      100.00
------------+-----------------------------------
      Total |    646,713      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    215,571       33.33       33.33
          3 |    431,142       66.67      100.00
------------+-----------------------------------
      Total |    646,713      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(215,571 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(215,571 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(215,571 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005u not found)
file /tmp/St32493.00005u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        543       20.00       20.00
       1980 |        543       20.00       40.00
       1990 |        543       20.00       60.00
       2000 |        543       20.00       80.00
       2007 |        543       20.00      100.00
------------+-----------------------------------
      Total |      2,715      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,172 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(543 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(543 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,172 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(543 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(543 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,172 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(543 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,086
        from master                     1,086  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,629  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,086       40.00       40.00
            matched (3) |      1,629       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,715      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       543          0 |       543 
      1980 |         0        543 |       543 
      1990 |         0        543 |       543 
      2000 |         0        543 |       543 
      2007 |       543          0 |       543 
-----------+----------------------+----------
     Total |     1,086      1,629 |     2,715 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,086 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        542
                                                  Wald chi2(1)    =      57.28
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.735

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9247581   .1221861    -7.57   0.000    -1.164238   -.6852778
       _cons |  -.4737638   .1500704    -3.16   0.002    -.7678964   -.1796312
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        542
                                                  Wald chi2(1)    =     136.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0777
                                                  Root MSE        =     2.0986

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.106103    .094663   -11.68   0.000    -1.291639   -.9205665
       _cons |  -1.062344   .1966745    -5.40   0.000    -1.447819    -.676869
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,084
                                                  Wald chi2(2)    =     403.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1651
                                                  Root MSE        =     1.9316

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.058532   .0735147   -14.40   0.000    -1.202618   -.9144463
       y2000 |   -.819032   .1306138    -6.27   0.000     -1.07503   -.5630337
       _cons |  -.3311528   .1141308    -2.90   0.004    -.5548452   -.1074605
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9500
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    638,376      100.00      100.00
------------+-----------------------------------
      Total |    638,376      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    212,792       33.33       33.33
          3 |    425,584       66.67      100.00
------------+-----------------------------------
      Total |    638,376      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(212,792 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(212,792 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(212,792 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00005w not found)
file /tmp/St32493.00005w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        536       20.00       20.00
       1980 |        536       20.00       40.00
       1990 |        536       20.00       60.00
       2000 |        536       20.00       80.00
       2007 |        536       20.00      100.00
------------+-----------------------------------
      Total |      2,680      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,144 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(536 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(536 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,144 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(536 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(536 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,144 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(536 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,072
        from master                     1,072  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,608  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,072       40.00       40.00
            matched (3) |      1,608       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,680      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       536          0 |       536 
      1980 |         0        536 |       536 
      1990 |         0        536 |       536 
      2000 |         0        536 |       536 
      2007 |       536          0 |       536 
-----------+----------------------+----------
     Total |     1,072      1,608 |     2,680 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,072 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        535
                                                  Wald chi2(1)    =      54.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7259

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9034177   .1222393    -7.39   0.000    -1.143002    -.663833
       _cons |  -.4967873   .1502028    -3.31   0.001    -.7911794   -.2023953
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        535
                                                  Wald chi2(1)    =     130.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0891
                                                  Root MSE        =     2.0506

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.064104   .0931414   -11.42   0.000    -1.246658     -.88155
       _cons |  -1.141343   .1935168    -5.90   0.000    -1.520629    -.762057
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,070
                                                  Wald chi2(2)    =     397.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1747
                                                  Root MSE        =      1.901

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.022019   .0728378   -14.03   0.000    -1.164779     -.87926
       y2000 |   -.848757   .1293847    -6.56   0.000    -1.102346   -.5951677
       _cons |  -.3703083   .1130846    -3.27   0.001      -.59195   -.1486667
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9505
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    625,275      100.00      100.00
------------+-----------------------------------
      Total |    625,275      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    208,425       33.33       33.33
          3 |    416,850       66.67      100.00
------------+-----------------------------------
      Total |    625,275      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(208,425 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(208,425 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(208,425 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000060 not found)
file /tmp/St32493.000060 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        525       20.00       20.00
       1980 |        525       20.00       40.00
       1990 |        525       20.00       60.00
       2000 |        525       20.00       80.00
       2007 |        525       20.00      100.00
------------+-----------------------------------
      Total |      2,625      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,100 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(525 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(525 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,100 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(525 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(525 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,100 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(525 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,050
        from master                     1,050  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,575  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,050       40.00       40.00
            matched (3) |      1,575       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,625      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       525          0 |       525 
      1980 |         0        525 |       525 
      1990 |         0        525 |       525 
      2000 |         0        525 |       525 
      2007 |       525          0 |       525 
-----------+----------------------+----------
     Total |     1,050      1,575 |     2,625 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,050 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        524
                                                  Wald chi2(1)    =      53.13
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6935

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8845106   .1213433    -7.29   0.000    -1.122339   -.6466822
       _cons |   -.519995   .1490189    -3.49   0.000    -.8120667   -.2279234
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        524
                                                  Wald chi2(1)    =     128.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0957
                                                  Root MSE        =     2.0327

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.055184   .0932272   -11.32   0.000    -1.237906   -.8724617
       _cons |  -1.161498   .1936472    -6.00   0.000     -1.54104   -.7819568
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,048
                                                  Wald chi2(2)    =     395.14
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1834
                                                  Root MSE        =     1.8767

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.01061   .0726474   -13.91   0.000    -1.152996   -.8682233
       y2000 |  -.8582106   .1290448    -6.65   0.000    -1.111134   -.6052874
       _cons |   -.385567     .11278    -3.42   0.001    -.6066118   -.1645221
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9510
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    614,556      100.00      100.00
------------+-----------------------------------
      Total |    614,556      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    204,852       33.33       33.33
          3 |    409,704       66.67      100.00
------------+-----------------------------------
      Total |    614,556      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(204,852 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(204,852 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(204,852 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000062 not found)
file /tmp/St32493.000062 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        516       20.00       20.00
       1980 |        516       20.00       40.00
       1990 |        516       20.00       60.00
       2000 |        516       20.00       80.00
       2007 |        516       20.00      100.00
------------+-----------------------------------
      Total |      2,580      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,064 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(516 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(516 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,064 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(516 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(516 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,064 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(516 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,032
        from master                     1,032  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,548  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,032       40.00       40.00
            matched (3) |      1,548       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,580      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       516          0 |       516 
      1980 |         0        516 |       516 
      1990 |         0        516 |       516 
      2000 |         0        516 |       516 
      2007 |       516          0 |       516 
-----------+----------------------+----------
     Total |     1,032      1,548 |     2,580 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,032 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        515
                                                  Wald chi2(1)    =      52.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6888

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8831838   .1222071    -7.23   0.000    -1.122705   -.6436623
       _cons |  -.5206597   .1501443    -3.47   0.001    -.8149372   -.2263822
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        515
                                                  Wald chi2(1)    =     126.30
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0948
                                                  Root MSE        =     2.0253

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.053844   .0937726   -11.24   0.000    -1.237635   -.8700531
       _cons |  -1.162253   .1948424    -5.97   0.000    -1.544137   -.7803691
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,030
                                                  Wald chi2(2)    =     390.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1841
                                                  Root MSE        =     1.8703

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.009257   .0730923   -13.81   0.000    -1.152515   -.8659987
       y2000 |  -.8584762   .1297483    -6.62   0.000    -1.112778   -.6041742
       _cons |  -.3861309     .11347    -3.40   0.001     -.608528   -.1637338
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9515
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    607,410      100.00      100.00
------------+-----------------------------------
      Total |    607,410      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    202,470       33.33       33.33
          3 |    404,940       66.67      100.00
------------+-----------------------------------
      Total |    607,410      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(202,470 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(202,470 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(202,470 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000064 not found)
file /tmp/St32493.000064 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        510       20.00       20.00
       1980 |        510       20.00       40.00
       1990 |        510       20.00       60.00
       2000 |        510       20.00       80.00
       2007 |        510       20.00      100.00
------------+-----------------------------------
      Total |      2,550      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,040 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(510 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(510 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,040 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(510 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(510 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,040 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(510 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,020
        from master                     1,020  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,530  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,020       40.00       40.00
            matched (3) |      1,530       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,550      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       510          0 |       510 
      1980 |         0        510 |       510 
      1990 |         0        510 |       510 
      2000 |         0        510 |       510 
      2007 |       510          0 |       510 
-----------+----------------------+----------
     Total |     1,020      1,530 |     2,550 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,020 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        509
                                                  Wald chi2(1)    =      52.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.679

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8995538   .1235804    -7.28   0.000    -1.141767   -.6573406
       _cons |  -.5047039    .151367    -3.33   0.001    -.8013777     -.20803
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        509
                                                  Wald chi2(1)    =     123.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0918
                                                  Root MSE        =     2.0175

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.050804   .0943701   -11.13   0.000    -1.235766   -.8658417
       _cons |  -1.168514   .1959329    -5.96   0.000    -1.552535   -.7844923
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,018
                                                  Wald chi2(2)    =     388.07
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1862
                                                  Root MSE        =     1.8604

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.011409   .0735782   -13.75   0.000     -1.15562   -.8671988
       y2000 |  -.8558883        .13    -6.58   0.000    -1.110684   -.6010929
       _cons |  -.3854012   .1138351    -3.39   0.001    -.6085138   -.1622885
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9520
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    590,736      100.00      100.00
------------+-----------------------------------
      Total |    590,736      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    196,912       33.33       33.33
          3 |    393,824       66.67      100.00
------------+-----------------------------------
      Total |    590,736      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(196,912 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(196,912 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(196,912 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000066 not found)
file /tmp/St32493.000066 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        496       20.00       20.00
       1980 |        496       20.00       40.00
       1990 |        496       20.00       60.00
       2000 |        496       20.00       80.00
       2007 |        496       20.00      100.00
------------+-----------------------------------
      Total |      2,480      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,984 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(496 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(496 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,984 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(496 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(496 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,984 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(496 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           992
        from master                       992  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,488  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        992       40.00       40.00
            matched (3) |      1,488       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,480      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       496          0 |       496 
      1980 |         0        496 |       496 
      1990 |         0        496 |       496 
      2000 |         0        496 |       496 
      2007 |       496          0 |       496 
-----------+----------------------+----------
     Total |       992      1,488 |     2,480 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(992 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        495
                                                  Wald chi2(1)    =      51.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6639

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.898403   .1257669    -7.14   0.000    -1.144902   -.6519044
       _cons |  -.5074985   .1536129    -3.30   0.001    -.8085743   -.2064228
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        495
                                                  Wald chi2(1)    =     121.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0988
                                                  Root MSE        =     2.0026

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.049756   .0951913   -11.03   0.000    -1.236328   -.8631847
       _cons |  -1.169182   .1978467    -5.91   0.000    -1.556955   -.7814098
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        990
                                                  Wald chi2(2)    =     381.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1930
                                                  Root MSE        =     1.8452

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -1.0106   .0743616   -13.59   0.000    -1.156346   -.8648544
       y2000 |  -.8538585   .1309794    -6.52   0.000    -1.110573   -.5971437
       _cons |  -.3877962    .114772    -3.38   0.001    -.6127452   -.1628473
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9525
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    581,208      100.00      100.00
------------+-----------------------------------
      Total |    581,208      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    193,736       33.33       33.33
          3 |    387,472       66.67      100.00
------------+-----------------------------------
      Total |    581,208      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(193,736 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(193,736 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(193,736 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000068 not found)
file /tmp/St32493.000068 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        488       20.00       20.00
       1980 |        488       20.00       40.00
       1990 |        488       20.00       60.00
       2000 |        488       20.00       80.00
       2007 |        488       20.00      100.00
------------+-----------------------------------
      Total |      2,440      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,952 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(488 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(488 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,952 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(488 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(488 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,952 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(488 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           976
        from master                       976  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,464  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        976       40.00       40.00
            matched (3) |      1,464       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,440      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       488          0 |       488 
      1980 |         0        488 |       488 
      1990 |         0        488 |       488 
      2000 |         0        488 |       488 
      2007 |       488          0 |       488 
-----------+----------------------+----------
     Total |       976      1,464 |     2,440 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(976 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        487
                                                  Wald chi2(1)    =      50.90
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.653

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9021442   .1264506    -7.13   0.000    -1.149983   -.6543056
       _cons |  -.5082607   .1543668    -3.29   0.001     -.810814   -.2057073
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        487
                                                  Wald chi2(1)    =     117.76
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0989
                                                  Root MSE        =     1.9947

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.041667   .0959891   -10.85   0.000    -1.229802   -.8535314
       _cons |  -1.186053   .1994532    -5.95   0.000    -1.576974   -.7951317
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        974
                                                  Wald chi2(2)    =     375.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1941
                                                  Root MSE        =     1.8357

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.00544   .0748782   -13.43   0.000    -1.152198    -.858681
       y2000 |   -.855153   .1315019    -6.50   0.000    -1.112892   -.5974142
       _cons |  -.3980015   .1153593    -3.45   0.001    -.6241017   -.1719014
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9530
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    571,680      100.00      100.00
------------+-----------------------------------
      Total |    571,680      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    190,560       33.33       33.33
          3 |    381,120       66.67      100.00
------------+-----------------------------------
      Total |    571,680      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(190,560 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(190,560 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(190,560 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006a not found)
file /tmp/St32493.00006a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        480       20.00       20.00
       1980 |        480       20.00       40.00
       1990 |        480       20.00       60.00
       2000 |        480       20.00       80.00
       2007 |        480       20.00      100.00
------------+-----------------------------------
      Total |      2,400      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,920 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(480 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(480 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,920 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(480 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(480 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,920 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(480 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           960
        from master                       960  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,440  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        960       40.00       40.00
            matched (3) |      1,440       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,400      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       480          0 |       480 
      1980 |         0        480 |       480 
      1990 |         0        480 |       480 
      2000 |         0        480 |       480 
      2007 |       480          0 |       480 
-----------+----------------------+----------
     Total |       960      1,440 |     2,400 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(960 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        479
                                                  Wald chi2(1)    =      49.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6401

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8906027   .1264821    -7.04   0.000    -1.138503   -.6427023
       _cons |  -.5237981   .1544144    -3.39   0.001    -.8264448   -.2211513
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        479
                                                  Wald chi2(1)    =     116.18
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0970
                                                  Root MSE        =     1.9912

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.052313   .0976308   -10.78   0.000    -1.243666   -.8609603
       _cons |  -1.167158   .2024252    -5.77   0.000    -1.563904   -.7704115
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        958
                                                  Wald chi2(2)    =     370.87
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1955
                                                  Root MSE        =      1.828

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.009646   .0757411   -13.33   0.000    -1.158095   -.8611958
       y2000 |  -.8494558    .132231    -6.42   0.000    -1.108624   -.5902877
       _cons |  -.3967284    .116244    -3.41   0.001    -.6245623   -.1688944
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9535
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    564,534      100.00      100.00
------------+-----------------------------------
      Total |    564,534      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    188,178       33.33       33.33
          3 |    376,356       66.67      100.00
------------+-----------------------------------
      Total |    564,534      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(188,178 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(188,178 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(188,178 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006c not found)
file /tmp/St32493.00006c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        474       20.00       20.00
       1980 |        474       20.00       40.00
       1990 |        474       20.00       60.00
       2000 |        474       20.00       80.00
       2007 |        474       20.00      100.00
------------+-----------------------------------
      Total |      2,370      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,896 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(474 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(474 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,896 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(474 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(474 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,896 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(474 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           948
        from master                       948  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,422  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        948       40.00       40.00
            matched (3) |      1,422       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,370      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       474          0 |       474 
      1980 |         0        474 |       474 
      1990 |         0        474 |       474 
      2000 |         0        474 |       474 
      2007 |       474          0 |       474 
-----------+----------------------+----------
     Total |       948      1,422 |     2,370 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(948 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        473
                                                  Wald chi2(1)    =      49.33
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6365

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8921653   .1270219    -7.02   0.000    -1.141124   -.6432068
       _cons |  -.5240837   .1551056    -3.38   0.001     -.828085   -.2200824
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        473
                                                  Wald chi2(1)    =     114.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0967
                                                  Root MSE        =     1.9869

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.051511   .0981638   -10.71   0.000    -1.243909   -.8591138
       _cons |  -1.168879   .2034187    -5.75   0.000    -1.567572   -.7701854
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        946
                                                  Wald chi2(2)    =     366.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1948
                                                  Root MSE        =     1.8241

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.009448   .0761339   -13.26   0.000    -1.158668   -.8602287
       y2000 |   -.847906   .1327729    -6.39   0.000    -1.108136   -.5876759
       _cons |  -.3988523   .1168025    -3.41   0.001    -.6277811   -.1699235
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9540
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    557,388      100.00      100.00
------------+-----------------------------------
      Total |    557,388      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    185,796       33.33       33.33
          3 |    371,592       66.67      100.00
------------+-----------------------------------
      Total |    557,388      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(185,796 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(185,796 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(185,796 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006e not found)
file /tmp/St32493.00006e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        468       20.00       20.00
       1980 |        468       20.00       40.00
       1990 |        468       20.00       60.00
       2000 |        468       20.00       80.00
       2007 |        468       20.00      100.00
------------+-----------------------------------
      Total |      2,340      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,872 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(468 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(468 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,872 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(468 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(468 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,872 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(468 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           936
        from master                       936  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,404  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        936       40.00       40.00
            matched (3) |      1,404       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,340      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       468          0 |       468 
      1980 |         0        468 |       468 
      1990 |         0        468 |       468 
      2000 |         0        468 |       468 
      2007 |       468          0 |       468 
-----------+----------------------+----------
     Total |       936      1,404 |     2,340 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(936 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        467
                                                  Wald chi2(1)    =      50.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6109

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8972181   .1268524    -7.07   0.000    -1.145844   -.6485919
       _cons |  -.5190323   .1547927    -3.35   0.001    -.8224204   -.2156441
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        467
                                                  Wald chi2(1)    =     116.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0872
                                                  Root MSE        =     1.9817

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.071163   .0991615   -10.80   0.000    -1.265516   -.8768096
       _cons |  -1.134674   .2056231    -5.52   0.000    -1.537688   -.7316603
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        934
                                                  Wald chi2(2)    =     372.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1976
                                                  Root MSE        =     1.8088

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.025155   .0764905   -13.40   0.000    -1.175073   -.8752361
       y2000 |  -.8378519    .132783    -6.31   0.000    -1.098102   -.5776021
       _cons |  -.3822122   .1170357    -3.27   0.001    -.6115979   -.1528265
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9545
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    546,669      100.00      100.00
------------+-----------------------------------
      Total |    546,669      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    182,223       33.33       33.33
          3 |    364,446       66.67      100.00
------------+-----------------------------------
      Total |    546,669      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(182,223 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(182,223 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(182,223 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006g not found)
file /tmp/St32493.00006g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        459       20.00       20.00
       1980 |        459       20.00       40.00
       1990 |        459       20.00       60.00
       2000 |        459       20.00       80.00
       2007 |        459       20.00      100.00
------------+-----------------------------------
      Total |      2,295      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,836 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(459 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(459 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,836 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(459 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(459 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,836 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(459 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           918
        from master                       918  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,377  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        918       40.00       40.00
            matched (3) |      1,377       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,295      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       459          0 |       459 
      1980 |         0        459 |       459 
      1990 |         0        459 |       459 
      2000 |         0        459 |       459 
      2007 |       459          0 |       459 
-----------+----------------------+----------
     Total |       918      1,377 |     2,295 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(918 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        458
                                                  Wald chi2(1)    =      48.95
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6075

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.90902   .1299302    -7.00   0.000    -1.163678   -.6543615
       _cons |  -.5062587   .1577936    -3.21   0.001    -.8155285   -.1969888
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        458
                                                  Wald chi2(1)    =     114.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0862
                                                  Root MSE        =     1.9734

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.070403   .1000176   -10.70   0.000    -1.266434   -.8743718
       _cons |  -1.135628   .2072097    -5.48   0.000    -1.541752   -.7295043
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        916
                                                  Wald chi2(2)    =     366.83
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1989
                                                  Root MSE        =     1.8022

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.028173   .0774642   -13.27   0.000    -1.180001   -.8763463
       y2000 |  -.8349755   .1337971    -6.24   0.000    -1.097213    -.572738
       _cons |  -.3789997   .1180516    -3.21   0.001    -.6103765   -.1476228
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9550
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    535,950      100.00      100.00
------------+-----------------------------------
      Total |    535,950      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    178,650       33.33       33.33
          3 |    357,300       66.67      100.00
------------+-----------------------------------
      Total |    535,950      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(178,650 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(178,650 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(178,650 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006i not found)
file /tmp/St32493.00006i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        450       20.00       20.00
       1980 |        450       20.00       40.00
       1990 |        450       20.00       60.00
       2000 |        450       20.00       80.00
       2007 |        450       20.00      100.00
------------+-----------------------------------
      Total |      2,250      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,800 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(450 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(450 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,800 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(450 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(450 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,800 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(450 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           900
        from master                       900  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,350  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        900       40.00       40.00
            matched (3) |      1,350       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,250      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       450          0 |       450 
      1980 |         0        450 |       450 
      1990 |         0        450 |       450 
      2000 |         0        450 |       450 
      2007 |       450          0 |       450 
-----------+----------------------+----------
     Total |       900      1,350 |     2,250 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(900 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        449
                                                  Wald chi2(1)    =      48.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.602

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9043231    .130496    -6.93   0.000    -1.160091   -.6485556
       _cons |  -.5155619   .1585168    -3.25   0.001    -.8262491   -.2048746
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        449
                                                  Wald chi2(1)    =     112.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0863
                                                  Root MSE        =     1.9705

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.071266   .1008884   -10.62   0.000    -1.269003   -.8735282
       _cons |  -1.133968   .2089534    -5.43   0.000    -1.543509    -.724427
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        898
                                                  Wald chi2(2)    =     360.06
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1982
                                                  Root MSE        =     1.7982

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.027546    .078037   -13.17   0.000    -1.180496   -.8745964
       y2000 |  -.8310551   .1348187    -6.16   0.000    -1.095295   -.5668153
       _cons |  -.3840007   .1189273    -3.23   0.001     -.617094   -.1509074
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9555
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    529,995      100.00      100.00
------------+-----------------------------------
      Total |    529,995      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    176,665       33.33       33.33
          3 |    353,330       66.67      100.00
------------+-----------------------------------
      Total |    529,995      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(176,665 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(176,665 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(176,665 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006k not found)
file /tmp/St32493.00006k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        445       20.00       20.00
       1980 |        445       20.00       40.00
       1990 |        445       20.00       60.00
       2000 |        445       20.00       80.00
       2007 |        445       20.00      100.00
------------+-----------------------------------
      Total |      2,225      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,780 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(445 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(445 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,780 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(445 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(445 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,780 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(445 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           890
        from master                       890  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,335  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        890       40.00       40.00
            matched (3) |      1,335       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,225      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       445          0 |       445 
      1980 |         0        445 |       445 
      1990 |         0        445 |       445 
      2000 |         0        445 |       445 
      2007 |       445          0 |       445 
-----------+----------------------+----------
     Total |       890      1,335 |     2,225 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(890 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        444
                                                  Wald chi2(1)    =      46.30
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.595

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8885114   .1305774    -6.80   0.000    -1.144438   -.6325844
       _cons |  -.5322458   .1586972    -3.35   0.001    -.8432866    -.221205
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        444
                                                  Wald chi2(1)    =     109.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0893
                                                  Root MSE        =     1.9596

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.057488   .1010386   -10.47   0.000     -1.25552    -.859456
       _cons |  -1.160967   .2092296    -5.55   0.000    -1.571049   -.7508841
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        888
                                                  Wald chi2(2)    =     354.88
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2016
                                                  Root MSE        =     1.7892

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.013112   .0781484   -12.96   0.000     -1.16628   -.8599437
       y2000 |  -.8441358   .1349077    -6.26   0.000     -1.10855   -.5797215
       _cons |  -.3991489    .119072    -3.35   0.001    -.6325258   -.1657719
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9560
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    520,467      100.00      100.00
------------+-----------------------------------
      Total |    520,467      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    173,489       33.33       33.33
          3 |    346,978       66.67      100.00
------------+-----------------------------------
      Total |    520,467      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(173,489 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(173,489 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(173,489 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006m not found)
file /tmp/St32493.00006m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        437       20.00       20.00
       1980 |        437       20.00       40.00
       1990 |        437       20.00       60.00
       2000 |        437       20.00       80.00
       2007 |        437       20.00      100.00
------------+-----------------------------------
      Total |      2,185      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,748 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(437 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(437 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,748 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(437 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(437 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,748 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(437 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           874
        from master                       874  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,311  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        874       40.00       40.00
            matched (3) |      1,311       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,185      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       437          0 |       437 
      1980 |         0        437 |       437 
      1990 |         0        437 |       437 
      2000 |         0        437 |       437 
      2007 |       437          0 |       437 
-----------+----------------------+----------
     Total |       874      1,311 |     2,185 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(874 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        436
                                                  Wald chi2(1)    =      45.00
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5853

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8777254   .1308367    -6.71   0.000    -1.134161     -.62129
       _cons |  -.5462952   .1590291    -3.44   0.001    -.8579866   -.2346039
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        436
                                                  Wald chi2(1)    =     108.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0954
                                                  Root MSE        =     1.9341

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.052327   .1008986   -10.43   0.000    -1.250084   -.8545691
       _cons |   -1.17269   .2087865    -5.62   0.000    -1.581904   -.7634758
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        872
                                                  Wald chi2(2)    =     352.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2069
                                                  Root MSE        =     1.7711

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.006426   .0781973   -12.87   0.000     -1.15969   -.8531622
       y2000 |  -.8489707   .1348008    -6.30   0.000    -1.113176    -.584766
       _cons |   -.408841   .1190355    -3.43   0.001    -.6421463   -.1755358
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9565
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    504,984      100.00      100.00
------------+-----------------------------------
      Total |    504,984      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    168,328       33.33       33.33
          3 |    336,656       66.67      100.00
------------+-----------------------------------
      Total |    504,984      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(168,328 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(168,328 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(168,328 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006o not found)
file /tmp/St32493.00006o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        424       20.00       20.00
       1980 |        424       20.00       40.00
       1990 |        424       20.00       60.00
       2000 |        424       20.00       80.00
       2007 |        424       20.00      100.00
------------+-----------------------------------
      Total |      2,120      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,696 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(424 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(424 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,696 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(424 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(424 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,696 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(424 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           848
        from master                       848  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,272  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        848       40.00       40.00
            matched (3) |      1,272       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,120      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       424          0 |       424 
      1980 |         0        424 |       424 
      1990 |         0        424 |       424 
      2000 |         0        424 |       424 
      2007 |       424          0 |       424 
-----------+----------------------+----------
     Total |       848      1,272 |     2,120 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(848 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        423
                                                  Wald chi2(1)    =      39.95
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5593

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8220798   .1300583    -6.32   0.000    -1.076989   -.5671703
       _cons |  -.6092922   .1585286    -3.84   0.000    -.9200025   -.2985819
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        423
                                                  Wald chi2(1)    =     117.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0936
                                                  Root MSE        =     1.9204

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.061171   .0978504   -10.84   0.000    -1.252954   -.8693873
       _cons |   -1.15675   .2041125    -5.67   0.000    -1.556803   -.7566967
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        846
                                                  Wald chi2(2)    =     355.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2098
                                                  Root MSE        =     1.7525

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9984016   .0762185   -13.10   0.000    -1.147787   -.8490161
       y2000 |  -.8526372   .1345204    -6.34   0.000    -1.116292   -.5889819
       _cons |  -.4205433   .1179727    -3.56   0.000    -.6517657    -.189321
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9570
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    499,029      100.00      100.00
------------+-----------------------------------
      Total |    499,029      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    166,343       33.33       33.33
          3 |    332,686       66.67      100.00
------------+-----------------------------------
      Total |    499,029      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(166,343 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(166,343 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(166,343 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006q not found)
file /tmp/St32493.00006q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        419       20.00       20.00
       1980 |        419       20.00       40.00
       1990 |        419       20.00       60.00
       2000 |        419       20.00       80.00
       2007 |        419       20.00      100.00
------------+-----------------------------------
      Total |      2,095      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,676 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(419 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(419 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,676 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(419 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(419 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,676 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(419 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           838
        from master                       838  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,257  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        838       40.00       40.00
            matched (3) |      1,257       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,095      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       419          0 |       419 
      1980 |         0        419 |       419 
      1990 |         0        419 |       419 
      2000 |         0        419 |       419 
      2007 |       419          0 |       419 
-----------+----------------------+----------
     Total |       838      1,257 |     2,095 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(838 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        418
                                                  Wald chi2(1)    =      41.85
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5147

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8241406   .1273978    -6.47   0.000    -1.073836   -.5744455
       _cons |   -.608917   .1551135    -3.93   0.000    -.9129339   -.3049001
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        418
                                                  Wald chi2(1)    =     115.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0915
                                                  Root MSE        =     1.9175

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.060677   .0986742   -10.75   0.000    -1.254075   -.8672793
       _cons |  -1.157778   .2056182    -5.63   0.000    -1.560783   -.7547742
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        836
                                                  Wald chi2(2)    =     358.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2128
                                                  Root MSE        =     1.7309

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9984101   .0759975   -13.14   0.000    -1.147363   -.8494577
       y2000 |  -.8507459    .133762    -6.36   0.000    -1.112914   -.5885772
       _cons |  -.4225021   .1173735    -3.60   0.000    -.6525499   -.1924543
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9575
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    493,074      100.00      100.00
------------+-----------------------------------
      Total |    493,074      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    164,358       33.33       33.33
          3 |    328,716       66.67      100.00
------------+-----------------------------------
      Total |    493,074      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(164,358 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(164,358 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(164,358 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006s not found)
file /tmp/St32493.00006s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        414       20.00       20.00
       1980 |        414       20.00       40.00
       1990 |        414       20.00       60.00
       2000 |        414       20.00       80.00
       2007 |        414       20.00      100.00
------------+-----------------------------------
      Total |      2,070      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,656 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(414 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(414 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,656 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(414 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(414 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,656 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(414 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           828
        from master                       828  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,242  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        828       40.00       40.00
            matched (3) |      1,242       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,070      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       414          0 |       414 
      1980 |         0        414 |       414 
      1990 |         0        414 |       414 
      2000 |         0        414 |       414 
      2007 |       414          0 |       414 
-----------+----------------------+----------
     Total |       828      1,242 |     2,070 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(828 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        413
                                                  Wald chi2(1)    =      41.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5111

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8239181     .12782    -6.45   0.000    -1.074441   -.5733954
       _cons |  -.6085523   .1556555    -3.91   0.000    -.9136315   -.3034731
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        413
                                                  Wald chi2(1)    =     114.57
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0916
                                                  Root MSE        =     1.9145

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.058787   .0989167   -10.70   0.000     -1.25266   -.8649133
       _cons |  -1.161285   .2062258    -5.63   0.000     -1.56548   -.7570897
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        826
                                                  Wald chi2(2)    =     356.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2133
                                                  Root MSE        =     1.7277

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9968232   .0761905   -13.08   0.000    -1.146154   -.8474926
       y2000 |  -.8526308    .134276    -6.35   0.000    -1.115807   -.5894546
       _cons |  -.4235707   .1177786    -3.60   0.000    -.6544125    -.192729
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9580
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    489,501      100.00      100.00
------------+-----------------------------------
      Total |    489,501      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    163,167       33.33       33.33
          3 |    326,334       66.67      100.00
------------+-----------------------------------
      Total |    489,501      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(163,167 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(163,167 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(163,167 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006u not found)
file /tmp/St32493.00006u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        411       20.00       20.00
       1980 |        411       20.00       40.00
       1990 |        411       20.00       60.00
       2000 |        411       20.00       80.00
       2007 |        411       20.00      100.00
------------+-----------------------------------
      Total |      2,055      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,644 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(411 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(411 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,644 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(411 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(411 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,644 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(411 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           822
        from master                       822  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,233  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        822       40.00       40.00
            matched (3) |      1,233       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,055      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       411          0 |       411 
      1980 |         0        411 |       411 
      1990 |         0        411 |       411 
      2000 |         0        411 |       411 
      2007 |       411          0 |       411 
-----------+----------------------+----------
     Total |       822      1,233 |     2,055 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(822 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        410
                                                  Wald chi2(1)    =      44.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5119

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8346997   .1247413    -6.69   0.000    -1.079188   -.5902113
       _cons |  -.5981865   .1529455    -3.91   0.000    -.8979542   -.2984188
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        410
                                                  Wald chi2(1)    =     113.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0920
                                                  Root MSE        =     1.9065

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.056218    .099093   -10.66   0.000    -1.250437   -.8619998
       _cons |  -1.168143   .2065328    -5.66   0.000     -1.57294   -.7633462
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        820
                                                  Wald chi2(2)    =     357.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2134
                                                  Root MSE        =     1.7237

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9979222   .0758861   -13.15   0.000    -1.146656   -.8491882
       y2000 |  -.8527567   .1343207    -6.35   0.000     -1.11602    -.589493
       _cons |  -.4235291   .1176459    -3.60   0.000    -.6541107   -.1929474
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9585
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    483,546      100.00      100.00
------------+-----------------------------------
      Total |    483,546      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    161,182       33.33       33.33
          3 |    322,364       66.67      100.00
------------+-----------------------------------
      Total |    483,546      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(161,182 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(161,182 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(161,182 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00006w not found)
file /tmp/St32493.00006w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        406       20.00       20.00
       1980 |        406       20.00       40.00
       1990 |        406       20.00       60.00
       2000 |        406       20.00       80.00
       2007 |        406       20.00      100.00
------------+-----------------------------------
      Total |      2,030      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,624 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(406 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(406 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,624 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(406 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(406 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,624 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(406 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           812
        from master                       812  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,218  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        812       40.00       40.00
            matched (3) |      1,218       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,030      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       406          0 |       406 
      1980 |         0        406 |       406 
      1990 |         0        406 |       406 
      2000 |         0        406 |       406 
      2007 |       406          0 |       406 
-----------+----------------------+----------
     Total |       812      1,218 |     2,030 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(812 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        405
                                                  Wald chi2(1)    =      42.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5045

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8195794   .1251155    -6.55   0.000    -1.064801   -.5743575
       _cons |  -.6152895   .1532665    -4.01   0.000    -.9156864   -.3148926
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        405
                                                  Wald chi2(1)    =     111.81
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0887
                                                  Root MSE        =     1.9019

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.058908   .1001433   -10.57   0.000    -1.255185   -.8626308
       _cons |  -1.165667   .2083926    -5.59   0.000    -1.574109   -.7572253
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        810
                                                  Wald chi2(2)    =     353.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2137
                                                  Root MSE        =     1.7178

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.995897   .0765192   -13.01   0.000    -1.145872   -.8459221
       y2000 |  -.8557957   .1348429    -6.35   0.000    -1.120083   -.5915085
       _cons |   -.426736   .1182457    -3.61   0.000    -.6584934   -.1949786
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9590
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    481,164      100.00      100.00
------------+-----------------------------------
      Total |    481,164      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    160,388       33.33       33.33
          3 |    320,776       66.67      100.00
------------+-----------------------------------
      Total |    481,164      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(160,388 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(160,388 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(160,388 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000070 not found)
file /tmp/St32493.000070 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        404       20.00       20.00
       1980 |        404       20.00       40.00
       1990 |        404       20.00       60.00
       2000 |        404       20.00       80.00
       2007 |        404       20.00      100.00
------------+-----------------------------------
      Total |      2,020      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,616 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(404 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(404 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,616 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(404 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(404 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,616 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(404 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           808
        from master                       808  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,212  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        808       40.00       40.00
            matched (3) |      1,212       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,020      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       404          0 |       404 
      1980 |         0        404 |       404 
      1990 |         0        404 |       404 
      2000 |         0        404 |       404 
      2007 |       404          0 |       404 
-----------+----------------------+----------
     Total |       808      1,212 |     2,020 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(808 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        403
                                                  Wald chi2(1)    =      43.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5048

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8453382    .127979    -6.61   0.000    -1.096173    -.594504
       _cons |  -.5897698   .1559921    -3.78   0.000    -.8955088   -.2840308
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        403
                                                  Wald chi2(1)    =     111.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0873
                                                  Root MSE        =      1.902

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.060438   .1005792   -10.54   0.000     -1.25757   -.8633068
       _cons |  -1.163453   .2092317    -5.56   0.000    -1.573539   -.7533659
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        806
                                                  Wald chi2(2)    =     352.34
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2129
                                                  Root MSE        =     1.7177

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.004817   .0772151   -13.01   0.000    -1.156155   -.8534777
       y2000 |  -.8473201   .1353669    -6.26   0.000    -1.112634   -.5820059
       _cons |  -.4192978   .1188854    -3.53   0.000    -.6523088   -.1862867
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9595
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    469,254      100.00      100.00
------------+-----------------------------------
      Total |    469,254      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    156,418       33.33       33.33
          3 |    312,836       66.67      100.00
------------+-----------------------------------
      Total |    469,254      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(156,418 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(156,418 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(156,418 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000072 not found)
file /tmp/St32493.000072 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        394       20.00       20.00
       1980 |        394       20.00       40.00
       1990 |        394       20.00       60.00
       2000 |        394       20.00       80.00
       2007 |        394       20.00      100.00
------------+-----------------------------------
      Total |      1,970      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,576 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(394 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(394 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,576 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(394 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(394 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,576 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(394 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           788
        from master                       788  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,182  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        788       40.00       40.00
            matched (3) |      1,182       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,970      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       394          0 |       394 
      1980 |         0        394 |       394 
      1990 |         0        394 |       394 
      2000 |         0        394 |       394 
      2007 |       394          0 |       394 
-----------+----------------------+----------
     Total |       788      1,182 |     1,970 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(788 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        393
                                                  Wald chi2(1)    =      41.05
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4958

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8390078   .1309564    -6.41   0.000    -1.095678    -.582338
       _cons |  -.5967092   .1588426    -3.76   0.000     -.908035   -.2853835
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        393
                                                  Wald chi2(1)    =     106.80
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0898
                                                  Root MSE        =     1.8866

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.046224   .1012389   -10.33   0.000    -1.244648    -.847799
       _cons |   -1.18841    .210402    -5.65   0.000     -1.60079   -.7760296
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        786
                                                  Wald chi2(2)    =     342.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2149
                                                  Root MSE        =     1.7054

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9934826   .0780907   -12.72   0.000    -1.146538   -.8404277
       y2000 |  -.8543379   .1362697    -6.27   0.000    -1.121422   -.5872541
       _cons |  -.4318289   .1197814    -3.61   0.000    -.6665961   -.1970616
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9600
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    464,490      100.00      100.00
------------+-----------------------------------
      Total |    464,490      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    154,830       33.33       33.33
          3 |    309,660       66.67      100.00
------------+-----------------------------------
      Total |    464,490      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(154,830 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(154,830 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(154,830 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000074 not found)
file /tmp/St32493.000074 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        390       20.00       20.00
       1980 |        390       20.00       40.00
       1990 |        390       20.00       60.00
       2000 |        390       20.00       80.00
       2007 |        390       20.00      100.00
------------+-----------------------------------
      Total |      1,950      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,560 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(390 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(390 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,560 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(390 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(390 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,560 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(390 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           780
        from master                       780  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,170  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        780       40.00       40.00
            matched (3) |      1,170       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,950      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       390          0 |       390 
      1980 |         0        390 |       390 
      1990 |         0        390 |       390 
      2000 |         0        390 |       390 
      2007 |       390          0 |       390 
-----------+----------------------+----------
     Total |       780      1,170 |     1,950 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(780 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        389
                                                  Wald chi2(1)    =      40.06
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4942

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8519804   .1346057    -6.33   0.000    -1.115803    -.588158
       _cons |  -.5840566   .1621036    -3.60   0.000    -.9017739   -.2663394
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        389
                                                  Wald chi2(1)    =     104.96
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0885
                                                  Root MSE        =      1.885

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.044457   .1019483   -10.24   0.000    -1.244272   -.8446418
       _cons |  -1.192065   .2116817    -5.63   0.000    -1.606954   -.7771767
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        778
                                                  Wald chi2(2)    =     338.41
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2153
                                                  Root MSE        =     1.7032

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9963778   .0790241   -12.61   0.000    -1.151262   -.8414933
       y2000 |  -.8508196   .1370883    -6.21   0.000    -1.119508   -.5821315
       _cons |  -.4303205   .1205671    -3.57   0.000    -.6666276   -.1940133
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9605
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    456,153      100.00      100.00
------------+-----------------------------------
      Total |    456,153      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    152,051       33.33       33.33
          3 |    304,102       66.67      100.00
------------+-----------------------------------
      Total |    456,153      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(152,051 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(152,051 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(152,051 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000076 not found)
file /tmp/St32493.000076 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        383       20.00       20.00
       1980 |        383       20.00       40.00
       1990 |        383       20.00       60.00
       2000 |        383       20.00       80.00
       2007 |        383       20.00      100.00
------------+-----------------------------------
      Total |      1,915      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,532 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(383 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,532 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(383 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,532 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           766
        from master                       766  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,149  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        766       40.00       40.00
            matched (3) |      1,149       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,915      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       383          0 |       383 
      1980 |         0        383 |       383 
      1990 |         0        383 |       383 
      2000 |         0        383 |       383 
      2007 |       383          0 |       383 
-----------+----------------------+----------
     Total |       766      1,149 |     1,915 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(766 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        382
                                                  Wald chi2(1)    =      38.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4917

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8480765   .1358519    -6.24   0.000    -1.114341   -.5818117
       _cons |  -.5892323   .1635976    -3.60   0.000    -.9098776   -.2685869
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        382
                                                  Wald chi2(1)    =     103.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0875
                                                  Root MSE        =     1.8851

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.049248   .1032123   -10.17   0.000    -1.251541   -.8469558
       _cons |  -1.182068   .2141943    -5.52   0.000    -1.601881   -.7622552
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        764
                                                  Wald chi2(2)    =     332.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2146
                                                  Root MSE        =     1.7022

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.998944   .0799251   -12.50   0.000    -1.155594   -.8422937
       y2000 |   -.846747   .1383295    -6.12   0.000    -1.117868   -.5756262
       _cons |  -.4285341   .1217898    -3.52   0.000    -.6672377   -.1898305
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9610
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    450,198      100.00      100.00
------------+-----------------------------------
      Total |    450,198      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    150,066       33.33       33.33
          3 |    300,132       66.67      100.00
------------+-----------------------------------
      Total |    450,198      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(150,066 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(150,066 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(150,066 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000078 not found)
file /tmp/St32493.000078 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        378       20.00       20.00
       1980 |        378       20.00       40.00
       1990 |        378       20.00       60.00
       2000 |        378       20.00       80.00
       2007 |        378       20.00      100.00
------------+-----------------------------------
      Total |      1,890      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,512 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(378 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(378 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,512 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(378 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(378 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,512 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(378 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           756
        from master                       756  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,134  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        756       40.00       40.00
            matched (3) |      1,134       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,890      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       378          0 |       378 
      1980 |         0        378 |       378 
      1990 |         0        378 |       378 
      2000 |         0        378 |       378 
      2007 |       378          0 |       378 
-----------+----------------------+----------
     Total |       756      1,134 |     1,890 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(756 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        377
                                                  Wald chi2(1)    =      38.18
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4833

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8505158    .137655    -6.18   0.000    -1.120315   -.5807169
       _cons |  -.5900796   .1657174    -3.56   0.000    -.9148797   -.2652795
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        377
                                                  Wald chi2(1)    =     100.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0813
                                                  Root MSE        =     1.8801

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.046666   .1046525   -10.00   0.000    -1.251781   -.8415509
       _cons |  -1.196509   .2171003    -5.51   0.000    -1.622018   -.7710001
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(2)    =     328.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2138
                                                  Root MSE        =     1.6956

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9977396     .08099   -12.32   0.000    -1.156477   -.8390021
       y2000 |  -.8545542   .1390326    -6.15   0.000    -1.127053   -.5820553
       _cons |  -.4327977   .1229336    -3.52   0.000    -.6737432   -.1918522
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9615
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    440,670      100.00      100.00
------------+-----------------------------------
      Total |    440,670      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    146,890       33.33       33.33
          3 |    293,780       66.67      100.00
------------+-----------------------------------
      Total |    440,670      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(146,890 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(146,890 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(146,890 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007a not found)
file /tmp/St32493.00007a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        370       20.00       20.00
       1980 |        370       20.00       40.00
       1990 |        370       20.00       60.00
       2000 |        370       20.00       80.00
       2007 |        370       20.00      100.00
------------+-----------------------------------
      Total |      1,850      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,480 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(370 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(370 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,480 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(370 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(370 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,480 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(370 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           740
        from master                       740  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,110  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        740       40.00       40.00
            matched (3) |      1,110       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,850      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       370          0 |       370 
      1980 |         0        370 |       370 
      1990 |         0        370 |       370 
      2000 |         0        370 |       370 
      2007 |       370          0 |       370 
-----------+----------------------+----------
     Total |       740      1,110 |     1,850 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(740 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        369
                                                  Wald chi2(1)    =      36.50
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4626

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8254812   .1366254    -6.04   0.000    -1.093262   -.5577002
       _cons |  -.6201698    .164573    -3.77   0.000    -.9427269   -.2976127
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        369
                                                  Wald chi2(1)    =     104.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1528
                                                  Root MSE        =      1.785

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.075859   .1051173   -10.23   0.000    -1.281885   -.8698324
       _cons |  -1.149427   .2158084    -5.33   0.000    -1.572403     -.72645
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        738
                                                  Wald chi2(2)    =     337.88
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2536
                                                  Root MSE        =      1.639

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.011322   .0817927   -12.36   0.000    -1.171633   -.8510112
       y2000 |  -.8472966   .1366897    -6.20   0.000    -1.115204   -.5793896
       _cons |  -.4217138   .1221044    -3.45   0.001     -.661034   -.1823936
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9620
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    433,524      100.00      100.00
------------+-----------------------------------
      Total |    433,524      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    144,508       33.33       33.33
          3 |    289,016       66.67      100.00
------------+-----------------------------------
      Total |    433,524      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(144,508 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(144,508 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(144,508 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007c not found)
file /tmp/St32493.00007c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        364       20.00       20.00
       1980 |        364       20.00       40.00
       1990 |        364       20.00       60.00
       2000 |        364       20.00       80.00
       2007 |        364       20.00      100.00
------------+-----------------------------------
      Total |      1,820      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,456 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(364 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(364 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,456 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(364 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(364 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,456 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(364 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           728
        from master                       728  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,092  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        728       40.00       40.00
            matched (3) |      1,092       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,820      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       364          0 |       364 
      1980 |         0        364 |       364 
      1990 |         0        364 |       364 
      2000 |         0        364 |       364 
      2007 |       364          0 |       364 
-----------+----------------------+----------
     Total |       728      1,092 |     1,820 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(728 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        363
                                                  Wald chi2(1)    =      36.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4488

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8325769   .1374989    -6.06   0.000     -1.10207   -.5630839
       _cons |  -.6136518   .1651146    -3.72   0.000    -.9372705   -.2900331
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        363
                                                  Wald chi2(1)    =     104.26
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1508
                                                  Root MSE        =     1.7848

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.082397   .1060065   -10.21   0.000    -1.290166   -.8746286
       _cons |  -1.138011   .2175095    -5.23   0.000    -1.564322   -.7117001
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        726
                                                  Wald chi2(2)    =     336.50
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2544
                                                  Root MSE        =     1.6325

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.01838   .0823209   -12.37   0.000    -1.179726   -.8570336
       y2000 |   -.840957   .1373639    -6.12   0.000    -1.110185   -.5717288
       _cons |  -.4156027   .1226423    -3.39   0.001    -.6559772   -.1752281
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9625
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    425,187      100.00      100.00
------------+-----------------------------------
      Total |    425,187      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    141,729       33.33       33.33
          3 |    283,458       66.67      100.00
------------+-----------------------------------
      Total |    425,187      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(141,729 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(141,729 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(141,729 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007e not found)
file /tmp/St32493.00007e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        357       20.00       20.00
       1980 |        357       20.00       40.00
       1990 |        357       20.00       60.00
       2000 |        357       20.00       80.00
       2007 |        357       20.00      100.00
------------+-----------------------------------
      Total |      1,785      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,428 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(357 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(357 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,428 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(357 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(357 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,428 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(357 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           714
        from master                       714  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,071  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        714       40.00       40.00
            matched (3) |      1,071       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,785      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       357          0 |       357 
      1980 |         0        357 |       357 
      1990 |         0        357 |       357 
      2000 |         0        357 |       357 
      2007 |       357          0 |       357 
-----------+----------------------+----------
     Total |       714      1,071 |     1,785 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(714 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        356
                                                  Wald chi2(1)    =      36.44
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4441

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8341113   .1381861    -6.04   0.000    -1.104951   -.5632715
       _cons |  -.6128332   .1660436    -3.69   0.000    -.9382728   -.2873937
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        356
                                                  Wald chi2(1)    =     100.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1468
                                                  Root MSE        =     1.7735

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.071687   .1067992   -10.03   0.000    -1.281009    -.862364
       _cons |  -1.157901   .2191388    -5.28   0.000    -1.587405   -.7283965
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        712
                                                  Wald chi2(2)    =     330.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2546
                                                  Root MSE        =     1.6236

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.01057   .0828944   -12.19   0.000     -1.17304   -.8481001
       y2000 |  -.8465121    .138088    -6.13   0.000     -1.11716   -.5758647
       _cons |  -.4246707    .123362    -3.44   0.001    -.6664558   -.1828856
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9630
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    419,232      100.00      100.00
------------+-----------------------------------
      Total |    419,232      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    139,744       33.33       33.33
          3 |    279,488       66.67      100.00
------------+-----------------------------------
      Total |    419,232      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(139,744 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(139,744 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(139,744 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007g not found)
file /tmp/St32493.00007g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        352       20.00       20.00
       1980 |        352       20.00       40.00
       1990 |        352       20.00       60.00
       2000 |        352       20.00       80.00
       2007 |        352       20.00      100.00
------------+-----------------------------------
      Total |      1,760      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,408 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(352 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(352 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,408 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(352 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(352 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,408 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(352 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           704
        from master                       704  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,056  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        704       40.00       40.00
            matched (3) |      1,056       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,760      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       352          0 |       352 
      1980 |         0        352 |       352 
      1990 |         0        352 |       352 
      2000 |         0        352 |       352 
      2007 |       352          0 |       352 
-----------+----------------------+----------
     Total |       704      1,056 |     1,760 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(704 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        351
                                                  Wald chi2(1)    =      37.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4432

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8691884   .1412001    -6.16   0.000    -1.145935   -.5924412
       _cons |  -.5796813    .168943    -3.43   0.001    -.9108035   -.2485592
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        351
                                                  Wald chi2(1)    =     102.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1498
                                                  Root MSE        =     1.7599

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.083693   .1068518   -10.14   0.000    -1.293119   -.8742671
       _cons |  -1.138751    .219108    -5.20   0.000    -1.568195   -.7093072
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        702
                                                  Wald chi2(2)    =     333.25
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2562
                                                  Root MSE        =     1.6154

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.029589    .083477   -12.33   0.000    -1.193201   -.8659772
       y2000 |  -.8301062   .1385402    -5.99   0.000     -1.10164   -.5585724
       _cons |  -.4088758   .1238411    -3.30   0.001    -.6515998   -.1661518
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9635
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    412,086      100.00      100.00
------------+-----------------------------------
      Total |    412,086      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    137,362       33.33       33.33
          3 |    274,724       66.67      100.00
------------+-----------------------------------
      Total |    412,086      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(137,362 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(137,362 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(137,362 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007i not found)
file /tmp/St32493.00007i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        346       20.00       20.00
       1980 |        346       20.00       40.00
       1990 |        346       20.00       60.00
       2000 |        346       20.00       80.00
       2007 |        346       20.00      100.00
------------+-----------------------------------
      Total |      1,730      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,384 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(346 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(346 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,384 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(346 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(346 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,384 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(346 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           692
        from master                       692  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,038  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        692       40.00       40.00
            matched (3) |      1,038       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,730      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       346          0 |       346 
      1980 |         0        346 |       346 
      1990 |         0        346 |       346 
      2000 |         0        346 |       346 
      2007 |       346          0 |       346 
-----------+----------------------+----------
     Total |       692      1,038 |     1,730 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(692 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        345
                                                  Wald chi2(1)    =      35.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4246

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8712656   .1457993    -5.98   0.000    -1.157027   -.5855042
       _cons |  -.5777156   .1738695    -3.32   0.001    -.9184935   -.2369378
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        345
                                                  Wald chi2(1)    =      84.67
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1464
                                                  Root MSE        =     1.7072

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9889519    .107473    -9.20   0.000    -1.199595   -.7783087
       _cons |  -1.321136   .2200409    -6.00   0.000    -1.752408   -.8898641
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        690
                                                  Wald chi2(2)    =     317.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2641
                                                  Root MSE        =     1.5754

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9579918   .0845019   -11.34   0.000    -1.123612   -.7923712
       y2000 |  -.8938309   .1372729    -6.51   0.000    -1.162881   -.6247809
       _cons |  -.4848989   .1239852    -3.91   0.000    -.7279054   -.2418924
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9640
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    404,940      100.00      100.00
------------+-----------------------------------
      Total |    404,940      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    134,980       33.33       33.33
          3 |    269,960       66.67      100.00
------------+-----------------------------------
      Total |    404,940      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(134,980 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(134,980 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(134,980 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007k not found)
file /tmp/St32493.00007k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        340       20.00       20.00
       1980 |        340       20.00       40.00
       1990 |        340       20.00       60.00
       2000 |        340       20.00       80.00
       2007 |        340       20.00      100.00
------------+-----------------------------------
      Total |      1,700      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,360 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(340 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(340 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,360 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(340 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(340 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,360 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(340 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           680
        from master                       680  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,020  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        680       40.00       40.00
            matched (3) |      1,020       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,700      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       340          0 |       340 
      1980 |         0        340 |       340 
      1990 |         0        340 |       340 
      2000 |         0        340 |       340 
      2007 |       340          0 |       340 
-----------+----------------------+----------
     Total |       680      1,020 |     1,700 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(680 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        339
                                                  Wald chi2(1)    =      35.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.422

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.877402   .1481452    -5.92   0.000    -1.167761   -.5870428
       _cons |  -.5707003   .1762985    -3.24   0.001     -.916239   -.2251615
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        339
                                                  Wald chi2(1)    =      80.26
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1437
                                                  Root MSE        =     1.6954

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9700717   .1082838    -8.96   0.000    -1.182304   -.7578393
       _cons |  -1.351706   .2215168    -6.10   0.000    -1.785871   -.9175412
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        678
                                                  Wald chi2(2)    =     310.05
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2639
                                                  Root MSE        =     1.5671

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9457571   .0853574   -11.08   0.000    -1.113054   -.7784597
       y2000 |  -.8993698   .1380046    -6.52   0.000    -1.169854   -.6288857
       _cons |  -.4975759   .1248295    -3.99   0.000    -.7422373   -.2529146
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9645
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    401,367      100.00      100.00
------------+-----------------------------------
      Total |    401,367      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    133,789       33.33       33.33
          3 |    267,578       66.67      100.00
------------+-----------------------------------
      Total |    401,367      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(133,789 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(133,789 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(133,789 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007m not found)
file /tmp/St32493.00007m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        337       20.00       20.00
       1980 |        337       20.00       40.00
       1990 |        337       20.00       60.00
       2000 |        337       20.00       80.00
       2007 |        337       20.00      100.00
------------+-----------------------------------
      Total |      1,685      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,348 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(337 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(337 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,348 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(337 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(337 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,348 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(337 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           674
        from master                       674  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,011  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        674       40.00       40.00
            matched (3) |      1,011       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,685      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       337          0 |       337 
      1980 |         0        337 |       337 
      1990 |         0        337 |       337 
      2000 |         0        337 |       337 
      2007 |       337          0 |       337 
-----------+----------------------+----------
     Total |       674      1,011 |     1,685 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(674 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        336
                                                  Wald chi2(1)    =      34.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4155

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8695144   .1480173    -5.87   0.000    -1.159623   -.5794059
       _cons |  -.5795828   .1762029    -3.29   0.001    -.9249342   -.2342314
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        336
                                                  Wald chi2(1)    =      80.57
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1450
                                                  Root MSE        =     1.6916

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9795994   .1091322    -8.98   0.000    -1.193495   -.7657042
       _cons |  -1.333989     .22313    -5.98   0.000    -1.771316   -.8966619
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        672
                                                  Wald chi2(2)    =     309.50
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2662
                                                  Root MSE        =     1.5624

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9505246   .0858137   -11.08   0.000    -1.118716   -.7823328
       y2000 |  -.8952112   .1383618    -6.47   0.000    -1.166395   -.6240271
       _cons |  -.4929008    .125286    -3.93   0.000    -.7384569   -.2473448
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9650
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    397,794      100.00      100.00
------------+-----------------------------------
      Total |    397,794      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    132,598       33.33       33.33
          3 |    265,196       66.67      100.00
------------+-----------------------------------
      Total |    397,794      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(132,598 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(132,598 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(132,598 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007o not found)
file /tmp/St32493.00007o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        334       20.00       20.00
       1980 |        334       20.00       40.00
       1990 |        334       20.00       60.00
       2000 |        334       20.00       80.00
       2007 |        334       20.00      100.00
------------+-----------------------------------
      Total |      1,670      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,336 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(334 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(334 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,336 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(334 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(334 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,336 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(334 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           668
        from master                       668  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,002  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        668       40.00       40.00
            matched (3) |      1,002       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,670      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       334          0 |       334 
      1980 |         0        334 |       334 
      1990 |         0        334 |       334 
      2000 |         0        334 |       334 
      2007 |       334          0 |       334 
-----------+----------------------+----------
     Total |       668      1,002 |     1,670 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(668 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        333
                                                  Wald chi2(1)    =      34.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4118

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8723599   .1485684    -5.87   0.000    -1.163548   -.5811712
       _cons |  -.5772982   .1768663    -3.26   0.001    -.9239498   -.2306467
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        333
                                                  Wald chi2(1)    =      78.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1421
                                                  Root MSE        =     1.6887

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9746499   .1099526    -8.86   0.000    -1.190153   -.7591469
       _cons |  -1.343677   .2247089    -5.98   0.000    -1.784098   -.9032553
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        666
                                                  Wald chi2(2)    =     306.44
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2665
                                                  Root MSE        =     1.5589

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9475427   .0863422   -10.97   0.000     -1.11677   -.7783152
       y2000 |  -.8973467   .1388122    -6.46   0.000    -1.169414   -.6252798
       _cons |  -.4968129   .1258611    -3.95   0.000    -.7434962   -.2501296
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9655
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    389,457      100.00      100.00
------------+-----------------------------------
      Total |    389,457      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    129,819       33.33       33.33
          3 |    259,638       66.67      100.00
------------+-----------------------------------
      Total |    389,457      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(129,819 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(129,819 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(129,819 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007q not found)
file /tmp/St32493.00007q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        327       20.00       20.00
       1980 |        327       20.00       40.00
       1990 |        327       20.00       60.00
       2000 |        327       20.00       80.00
       2007 |        327       20.00      100.00
------------+-----------------------------------
      Total |      1,635      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,308 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(327 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,308 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(327 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,308 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           654
        from master                       654  (_merge==1)
        from using                          0  (_merge==2)

    matched                               981  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        654       40.00       40.00
            matched (3) |        981       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,635      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       327          0 |       327 
      1980 |         0        327 |       327 
      1990 |         0        327 |       327 
      2000 |         0        327 |       327 
      2007 |       327          0 |       327 
-----------+----------------------+----------
     Total |       654        981 |     1,635 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(654 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        326
                                                  Wald chi2(1)    =      33.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4003

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8592929   .1488559    -5.77   0.000    -1.151045   -.5675407
       _cons |  -.5921358   .1772456    -3.34   0.001    -.9395308   -.2447408
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        326
                                                  Wald chi2(1)    =      76.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1418
                                                  Root MSE        =     1.6855

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9724465   .1110004    -8.76   0.000    -1.190003   -.7548896
       _cons |  -1.348409   .2268451    -5.94   0.000    -1.793017   -.9038006
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        652
                                                  Wald chi2(2)    =     301.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2685
                                                  Root MSE        =      1.552

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9424426   .0869216   -10.84   0.000    -1.112806   -.7720793
       y2000 |  -.9011845   .1397001    -6.45   0.000    -1.174992   -.6273774
       _cons |  -.5031093   .1266889    -3.97   0.000     -.751415   -.2548036
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9660
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    382,311      100.00      100.00
------------+-----------------------------------
      Total |    382,311      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    127,437       33.33       33.33
          3 |    254,874       66.67      100.00
------------+-----------------------------------
      Total |    382,311      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(127,437 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(127,437 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(127,437 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007s not found)
file /tmp/St32493.00007s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        321       20.00       20.00
       1980 |        321       20.00       40.00
       1990 |        321       20.00       60.00
       2000 |        321       20.00       80.00
       2007 |        321       20.00      100.00
------------+-----------------------------------
      Total |      1,605      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,284 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(321 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(321 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,284 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(321 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(321 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,284 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(321 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           642
        from master                       642  (_merge==1)
        from using                          0  (_merge==2)

    matched                               963  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        642       40.00       40.00
            matched (3) |        963       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,605      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       321          0 |       321 
      1980 |         0        321 |       321 
      1990 |         0        321 |       321 
      2000 |         0        321 |       321 
      2007 |       321          0 |       321 
-----------+----------------------+----------
     Total |       642        963 |     1,605 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(642 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        320
                                                  Wald chi2(1)    =      37.07
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.3562

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8941047   .1468467    -6.09   0.000    -1.181919   -.6062905
       _cons |  -.5686225   .1745236    -3.26   0.001    -.9106826   -.2265625
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        320
                                                  Wald chi2(1)    =      76.36
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1398
                                                  Root MSE        =     1.6199

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9528026   .1090369    -8.74   0.000    -1.166511   -.7390943
       _cons |  -1.412335   .2228228    -6.34   0.000    -1.849059   -.9756101
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        640
                                                  Wald chi2(2)    =     318.72
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2837
                                                  Root MSE        =     1.4951

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9372543   .0855093   -10.96   0.000    -1.104849   -.7696591
       y2000 |  -.9189346   .1364264    -6.74   0.000    -1.186325   -.6515438
       _cons |  -.5224317   .1239534    -4.21   0.000    -.7653759   -.2794874
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9665
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    376,356      100.00      100.00
------------+-----------------------------------
      Total |    376,356      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    125,452       33.33       33.33
          3 |    250,904       66.67      100.00
------------+-----------------------------------
      Total |    376,356      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(125,452 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(125,452 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(125,452 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007u not found)
file /tmp/St32493.00007u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        316       20.00       20.00
       1980 |        316       20.00       40.00
       1990 |        316       20.00       60.00
       2000 |        316       20.00       80.00
       2007 |        316       20.00      100.00
------------+-----------------------------------
      Total |      1,580      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,264 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(316 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(316 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,264 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(316 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(316 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,264 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(316 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           632
        from master                       632  (_merge==1)
        from using                          0  (_merge==2)

    matched                               948  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        632       40.00       40.00
            matched (3) |        948       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,580      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       316          0 |       316 
      1980 |         0        316 |       316 
      1990 |         0        316 |       316 
      2000 |         0        316 |       316 
      2007 |       316          0 |       316 
-----------+----------------------+----------
     Total |       632        948 |     1,580 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(632 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        315
                                                  Wald chi2(1)    =      36.88
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.3404

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8926588   .1469972    -6.07   0.000    -1.180768   -.6045495
       _cons |    -.56941   .1745399    -3.26   0.001    -.9115018   -.2273182
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        315
                                                  Wald chi2(1)    =      75.19
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1440
                                                  Root MSE        =     1.6133

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9601001   .1107244    -8.67   0.000    -1.177116   -.7430841
       _cons |  -1.400177   .2258056    -6.20   0.000    -1.842747   -.9576059
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        630
                                                  Wald chi2(2)    =     317.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2901
                                                  Root MSE        =     1.4845

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9421625   .0864162   -10.90   0.000    -1.111535   -.7727898
       y2000 |  -.9172438   .1368504    -6.70   0.000    -1.185466   -.6490219
       _cons |  -.5164188   .1247121    -4.14   0.000    -.7608501   -.2719875
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9670
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    372,783      100.00      100.00
------------+-----------------------------------
      Total |    372,783      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    124,261       33.33       33.33
          3 |    248,522       66.67      100.00
------------+-----------------------------------
      Total |    372,783      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(124,261 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(124,261 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(124,261 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00007w not found)
file /tmp/St32493.00007w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        313       20.00       20.00
       1980 |        313       20.00       40.00
       1990 |        313       20.00       60.00
       2000 |        313       20.00       80.00
       2007 |        313       20.00      100.00
------------+-----------------------------------
      Total |      1,565      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,252 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(313 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(313 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,252 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(313 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(313 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,252 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(313 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           626
        from master                       626  (_merge==1)
        from using                          0  (_merge==2)

    matched                               939  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        626       40.00       40.00
            matched (3) |        939       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,565      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       313          0 |       313 
      1980 |         0        313 |       313 
      1990 |         0        313 |       313 
      2000 |         0        313 |       313 
      2007 |       313          0 |       313 
-----------+----------------------+----------
     Total |       626        939 |     1,565 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(626 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        312
                                                  Wald chi2(1)    =      36.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =       1.33

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8823923   .1469113    -6.01   0.000    -1.170333   -.5944514
       _cons |    -.58186   .1741559    -3.34   0.001    -.9231993   -.2405207
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        312
                                                  Wald chi2(1)    =      74.43
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1451
                                                  Root MSE        =     1.6109

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9567196   .1108983    -8.63   0.000    -1.174076   -.7393628
       _cons |  -1.406407   .2262313    -6.22   0.000    -1.849812   -.9630013
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        624
                                                  Wald chi2(2)    =     316.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2943
                                                  Root MSE        =     1.4783

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.93705     .08642   -10.84   0.000     -1.10643   -.7676699
       y2000 |  -.9196927   .1369844    -6.71   0.000    -1.188177   -.6512083
       _cons |  -.5234348    .124652    -4.20   0.000    -.7677483   -.2791213
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9675
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    369,210      100.00      100.00
------------+-----------------------------------
      Total |    369,210      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    123,070       33.33       33.33
          3 |    246,140       66.67      100.00
------------+-----------------------------------
      Total |    369,210      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(123,070 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(123,070 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(123,070 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000080 not found)
file /tmp/St32493.000080 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        310       20.00       20.00
       1980 |        310       20.00       40.00
       1990 |        310       20.00       60.00
       2000 |        310       20.00       80.00
       2007 |        310       20.00      100.00
------------+-----------------------------------
      Total |      1,550      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,240 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(310 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(310 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,240 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(310 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(310 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,240 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(310 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           620
        from master                       620  (_merge==1)
        from using                          0  (_merge==2)

    matched                               930  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        620       40.00       40.00
            matched (3) |        930       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,550      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       310          0 |       310 
      1980 |         0        310 |       310 
      1990 |         0        310 |       310 
      2000 |         0        310 |       310 
      2007 |       310          0 |       310 
-----------+----------------------+----------
     Total |       620        930 |     1,550 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(620 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        309
                                                  Wald chi2(1)    =      35.27
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.3264

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.875676   .1474473    -5.94   0.000    -1.164667   -.5866846
       _cons |  -.5890781   .1747402    -3.37   0.001    -.9315626   -.2465936
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        309
                                                  Wald chi2(1)    =      70.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1398
                                                  Root MSE        =      1.608

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9505539   .1128374    -8.42   0.000    -1.171711   -.7293968
       _cons |  -1.418784   .2296365    -6.18   0.000    -1.868863   -.9687047
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        618
                                                  Wald chi2(2)    =     310.38
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2927
                                                  Root MSE        =     1.4752

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9307495   .0876239   -10.62   0.000    -1.102489   -.7590098
       y2000 |  -.9255429   .1377368    -6.72   0.000    -1.195502   -.6555838
       _cons |  -.5302096   .1257577    -4.22   0.000    -.7766901   -.2837291
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9680
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    366,828      100.00      100.00
------------+-----------------------------------
      Total |    366,828      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    122,276       33.33       33.33
          3 |    244,552       66.67      100.00
------------+-----------------------------------
      Total |    366,828      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(122,276 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(122,276 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(122,276 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000082 not found)
file /tmp/St32493.000082 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        308       20.00       20.00
       1980 |        308       20.00       40.00
       1990 |        308       20.00       60.00
       2000 |        308       20.00       80.00
       2007 |        308       20.00      100.00
------------+-----------------------------------
      Total |      1,540      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,232 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(308 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(308 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,232 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(308 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(308 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,232 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(308 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           616
        from master                       616  (_merge==1)
        from using                          0  (_merge==2)

    matched                               924  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        616       40.00       40.00
            matched (3) |        924       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,540      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       308          0 |       308 
      1980 |         0        308 |       308 
      1990 |         0        308 |       308 
      2000 |         0        308 |       308 
      2007 |       308          0 |       308 
-----------+----------------------+----------
     Total |       616        924 |     1,540 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(616 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        307
                                                  Wald chi2(1)    =      35.14
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.326

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8786271   .1482128    -5.93   0.000    -1.169119   -.5881353
       _cons |  -.5859831   .1756693    -3.34   0.001    -.9302887   -.2416776
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        307
                                                  Wald chi2(1)    =      69.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1382
                                                  Root MSE        =     1.6073

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9492412   .1136596    -8.35   0.000     -1.17201   -.7264724
       _cons |  -1.422611   .2313509    -6.15   0.000     -1.87605   -.9691715
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        614
                                                  Wald chi2(2)    =     308.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2925
                                                  Root MSE        =     1.4745

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9305134   .0882082   -10.55   0.000    -1.103398   -.7576286
       y2000 |  -.9271215   .1383168    -6.70   0.000    -1.198217   -.6560256
       _cons |  -.5304845   .1264274    -4.20   0.000    -.7782776   -.2826914
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9685
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    359,682      100.00      100.00
------------+-----------------------------------
      Total |    359,682      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    119,894       33.33       33.33
          3 |    239,788       66.67      100.00
------------+-----------------------------------
      Total |    359,682      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(119,894 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(119,894 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(119,894 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000084 not found)
file /tmp/St32493.000084 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        302       20.00       20.00
       1980 |        302       20.00       40.00
       1990 |        302       20.00       60.00
       2000 |        302       20.00       80.00
       2007 |        302       20.00      100.00
------------+-----------------------------------
      Total |      1,510      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,208 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(302 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,208 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(302 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,208 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           604
        from master                       604  (_merge==1)
        from using                          0  (_merge==2)

    matched                               906  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        604       40.00       40.00
            matched (3) |        906       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,510      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       302          0 |       302 
      1980 |         0        302 |       302 
      1990 |         0        302 |       302 
      2000 |         0        302 |       302 
      2007 |       302          0 |       302 
-----------+----------------------+----------
     Total |       604        906 |     1,510 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(604 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        301
                                                  Wald chi2(1)    =      34.18
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.3181

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.870653   .1489269    -5.85   0.000    -1.162544   -.5787617
       _cons |  -.5936811   .1765388    -3.36   0.001    -.9396907   -.2476714
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        301
                                                  Wald chi2(1)    =      68.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1387
                                                  Root MSE        =     1.5983

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9426313   .1142146    -8.25   0.000    -1.166488   -.7187748
       _cons |  -1.434298   .2324447    -6.17   0.000    -1.889881   -.9787147
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        602
                                                  Wald chi2(2)    =     303.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2946
                                                  Root MSE        =     1.4661

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9235686   .0886382   -10.42   0.000    -1.097296   -.7498409
       y2000 |  -.9328557   .1388929    -6.72   0.000    -1.205081   -.6606306
       _cons |  -.5370608   .1270288    -4.23   0.000    -.7860326    -.288089
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9690
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    358,491      100.00      100.00
------------+-----------------------------------
      Total |    358,491      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    119,497       33.33       33.33
          3 |    238,994       66.67      100.00
------------+-----------------------------------
      Total |    358,491      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(119,497 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(119,497 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(119,497 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000086 not found)
file /tmp/St32493.000086 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        301       20.00       20.00
       1980 |        301       20.00       40.00
       1990 |        301       20.00       60.00
       2000 |        301       20.00       80.00
       2007 |        301       20.00      100.00
------------+-----------------------------------
      Total |      1,505      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,204 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(301 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(301 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,204 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(301 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(301 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,204 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(301 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           602
        from master                       602  (_merge==1)
        from using                          0  (_merge==2)

    matched                               903  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        602       40.00       40.00
            matched (3) |        903       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,505      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       301          0 |       301 
      1980 |         0        301 |       301 
      1990 |         0        301 |       301 
      2000 |         0        301 |       301 
      2007 |       301          0 |       301 
-----------+----------------------+----------
     Total |       602        903 |     1,505 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(602 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        300
                                                  Wald chi2(1)    =      33.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0012
                                                  Root MSE        =     1.3119

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8592575   .1481374    -5.80   0.000    -1.149602   -.5689136
       _cons |  -.6082237   .1756502    -3.46   0.001    -.9524918   -.2639556
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        300
                                                  Wald chi2(1)    =      67.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1398
                                                  Root MSE        =     1.5899

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9380826    .113827    -8.24   0.000    -1.161179   -.7149858
       _cons |  -1.444944   .2316802    -6.24   0.000    -1.899029   -.9908593
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        600
                                                  Wald chi2(2)    =     304.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2974
                                                  Root MSE        =     1.4587

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9171873   .0883043   -10.39   0.000    -1.090261   -.7441141
       y2000 |  -.9377446   .1384326    -6.77   0.000    -1.209068   -.6664216
       _cons |  -.5462489   .1265604    -4.32   0.000    -.7943026   -.2981951
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9695
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    356,109      100.00      100.00
------------+-----------------------------------
      Total |    356,109      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    118,703       33.33       33.33
          3 |    237,406       66.67      100.00
------------+-----------------------------------
      Total |    356,109      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(118,703 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(118,703 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(118,703 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.000088 not found)
file /tmp/St32493.000088 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        299       20.00       20.00
       1980 |        299       20.00       40.00
       1990 |        299       20.00       60.00
       2000 |        299       20.00       80.00
       2007 |        299       20.00      100.00
------------+-----------------------------------
      Total |      1,495      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,196 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(299 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(299 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,196 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(299 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(299 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,196 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(299 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           598
        from master                       598  (_merge==1)
        from using                          0  (_merge==2)

    matched                               897  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        598       40.00       40.00
            matched (3) |        897       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,495      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       299          0 |       299 
      1980 |         0        299 |       299 
      1990 |         0        299 |       299 
      2000 |         0        299 |       299 
      2007 |       299          0 |       299 
-----------+----------------------+----------
     Total |       598        897 |     1,495 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(598 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        298
                                                  Wald chi2(1)    =      33.45
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0027
                                                  Root MSE        =      1.308

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8566987   .1481328    -5.78   0.000    -1.147034   -.5663637
       _cons |  -.6125322    .175575    -3.49   0.000    -.9566529   -.2684116
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        298
                                                  Wald chi2(1)    =      68.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1394
                                                  Root MSE        =      1.576

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9403952   .1132159    -8.31   0.000    -1.162294    -.718496
       _cons |  -1.442165   .2303135    -6.26   0.000    -1.893571   -.9907591
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        596
                                                  Wald chi2(2)    =     306.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2993
                                                  Root MSE        =     1.4494

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.918204   .0880281   -10.43   0.000    -1.090736   -.7456721
       y2000 |    -.93684   .1379823    -6.79   0.000     -1.20728   -.6663997
       _cons |  -.5467702   .1261281    -4.34   0.000    -.7939767   -.2995637
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9700
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    350,154      100.00      100.00
------------+-----------------------------------
      Total |    350,154      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    116,718       33.33       33.33
          3 |    233,436       66.67      100.00
------------+-----------------------------------
      Total |    350,154      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(116,718 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(116,718 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(116,718 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St32493.00008a not found)
file /tmp/St32493.00008a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        294       20.00       20.00
       1980 |        294       20.00       40.00
       1990 |        294       20.00       60.00
       2000 |        294       20.00       80.00
       2007 |        294       20.00      100.00
------------+-----------------------------------
      Total |      1,470      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,176 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(294 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(294 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,176 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(294 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(294 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,176 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(294 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           588
        from master                       588  (_merge==1)
        from using                          0  (_merge==2)

    matched                               882  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        588       40.00       40.00
            matched (3) |        882       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,470      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       294          0 |       294 
      1980 |         0        294 |       294 
      1990 |         0        294 |       294 
      2000 |         0        294 |       294 
      2007 |       294          0 |       294 
-----------+----------------------+----------
     Total |       588        882 |     1,470 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(588 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        293
                                                  Wald chi2(1)    =      30.77
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.2974

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9058305   .1633006    -5.55   0.000    -1.225894   -.5857673
       _cons |  -.5594973   .1909669    -2.93   0.003    -.9337855    -.185209
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        293
                                                  Wald chi2(1)    =      64.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1234
                                                  Root MSE        =      1.544

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9480485   .1179218    -8.04   0.000    -1.179171    -.716926
       _cons |  -1.429786   .2383936    -6.00   0.000    -1.897029   -.9625433
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        586
                                                  Wald chi2(2)    =     302.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2968
                                                  Root MSE        =     1.4264

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9370562   .0931518   -10.06   0.000     -1.11963   -.7544819
       y2000 |  -.9243759   .1393303    -6.63   0.000    -1.197458   -.6512936
       _cons |  -.5259805   .1301589    -4.04   0.000    -.7810873   -.2708737
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit

.  postclose `czoneresults' ;

. log close ;
      name:  <unnamed>
       log:  /ssgprojects/project0002/MobZ.new/programs/07_adh/cutoff_loop.log
  log type:  text
 closed on:  23 Aug 2020, 12:46:38
-------------------------------------------------------------------------------

. 
end of do-file
