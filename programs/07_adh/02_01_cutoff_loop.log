
  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   14.2   Copyright 1985-2015 StataCorp LLC
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
                                      College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

8-user Stata network perpetual license:
       Serial number:  501406244326
         Licensed to:  ECCO Cornell University
                       Ithaca, NY

Notes:
      1.  Stata is running in batch mode.
      2.  Unicode is supported; see help unicode_advice.

. do 02_01_cutoff_loop.do 

. /**********************
> This is the do-file loop
> 
> It has three steps
> 
> 1. Calculate the aggregate data
>         (national level)
> 
> 2. Decide which czone defn to use
> 
> 3. Aggregate cty data to czone
> 
> 4. Run regressions of delM on delIPW, 
>         store regressions.
>         
> ***************************/
. 
. include "../config.do"

. /*  config.do */
. 
. 
. 
. if ( "`c(hostname)'" == "ecco.vrdc.cornell.edu" ) {
. global root "/ssgprojects/project0002/MobZ.new"
. }

. 
. if ( "`c(username)'" == "vilhuber" ) {
. global root "/home/vilhuber/Workspace/git/larsvilhuber/MobZ"
. }

. 
. if ( "`c(hostname)'" == "some.server.at.census" ) {
. global root "/made/up/path/Mobz"
. }

. 
. /* check if the author creates a log file. If not, adjust the following code 
> fragment */
. 
. local c_date = c(current_date)

. local cdate = subinstr("`c_date'", " ", "_", .)

. local c_time = c(current_time)

. local ctime = subinstr("`c_time'", ":", "_", .)

. 
. // log using "${root}/logfile_`cdate'-`ctime'.log", replace text
. 
. /* It will provide some info about how and when the program was run */
. /* See https://www.stata.com/manuals13/pcreturn.pdf#pcreturn */
. local variant = cond(c(MP),"MP",cond(c(SE),"SE",c(flavor)) )  

. // alternatively, you could use 
. // local variant = cond(c(stata_version)>13,c(real_flavor),"NA")  
. 
. di "=== SYSTEM DIAGNOSTICS ==="
=== SYSTEM DIAGNOSTICS ===

. di "Stata version: `c(stata_version)'"
Stata version: 14.2

. di "Updated as of: `c(born_date)'"
Updated as of: 19 Dec 2017

. di "Variant:       `variant'"
Variant:       IC

. di "Processors:    `c(processors)'"
Processors:    1

. di "OS:            `c(os)' `c(osdtl)'"
OS:            Unix 

. di "Machine type:  `c(machine_type)'"
Machine type:  PC (64-bit x86-64)

. di "=========================="
==========================

. 
. 
. 
. 
. /* define relative libraries */
. 
. global paperdir "${root}/paper"

. global interwrk "${root}/data/interwrk"

. global raw "${root}/raw"

. global temp "${root}/temp"

. global outputs "${root}/data"

. global programs "${root}/programs"

. global outgraphs "${root}/figures"

. global logdir "${programs}/logs"

. 
. cap mkdir "$logdir"

. log using "${logdir}/logfile_`cdate'-`ctime'.log", replace text
(note: file /ssgprojects/project0002/MobZ.new/programs/logs/logfile_19_Aug_2020
> -20_52_45.log not found)
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /ssgprojects/project0002/MobZ.new/programs/logs/logfile_19_Aug_202
> 0-20_52_45.log
  log type:  text
 opened on:  19 Aug 2020, 20:52:45

. cap mkdir "$temp"

. cap mkdir "${root}/data"

. cap mkdir "$interwrk"

. cap mkdir "$raw"

. cap mkdir "$outputs"

. 
. /* install any packages locally */
. capture mkdir "${programs}/ado"

. sysdir set PERSONAL "${programs}/ado/personal"

. sysdir set PLUS     "${programs}/ado/plus"

. sysdir set SITE     "${programs}/ado/site"

. sysdir
   STATA:  /usr/local/stata14/
    BASE:  /usr/local/stata14/ado/base/
    SITE:  /ssgprojects/project0002/MobZ.new/programs/ado/site/
    PLUS:  /ssgprojects/project0002/MobZ.new/programs/ado/plus/
PERSONAL:  /ssgprojects/project0002/MobZ.new/programs/ado/personal/
OLDPLACE:  ~/ado/

. 
. /* define data sources */
. 
. /* QCEW */
. /* data/working/mobz/qcew */
.     global qcewdata "${raw}/qcew"  

. /* /data/working/mobz/outputs */
.     global czonedata "$outputs"  

. 
. /* ADH */
.     global adhdata "${raw}/adh_data/Public Release Data/dta"

. /* CZONE */
.     global czonedata "${raw}/adh_data/"

. /* files provided separately by David Dorn */
.     global dorndata "${raw}/ddorn/"

. 
. /* CBP */
.     /* this is where the raw Stata versions of CBP data reside */
.    global cbpdata "/data/clean/cbp"

. 
. 
. cap log close

. log using cutoff_loop.log, replace 
-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /ssgprojects/project0002/MobZ.new/programs/07_adh/cutoff_loop.log
  log type:  text
 opened on:  19 Aug 2020, 20:52:45

. 
. /* local macros */
. local czonedataset = "${outputs}/clusters_cutoff_jtw1990.dta"

. global czone_iteration = "${interwrk}/czones_cutoff.dta"

. global dodir "${programs}/07_adh/"

. global ipw_regs "${interwrk}/cutoff_post.dta"

. 
. include "$dodir/zz_aggregatedata.do"

. 
. /*****************
> Prep Aggregate Data
> *******************/
. 
. /*********************
> Trade data
> ***********************/
. 
. /* source: Autor Dorn Hanson public data files */
. 
. use "$adhdata/sic87dd_trade_data.dta", clear
(SIC trade data for ADH post collapse of problem SIC industries)

. 
. bys year sic87dd: egen M_ucjt = sum(imports*(exporter=="CHN")*(importer=="USA
> "))

. 
. bys year sic87dd: egen M_ocjt = sum(imports*(exporter=="CHN")*(importer=="OTH
> "))

. 
. keep if year == 1991 | year == 2000 | year == 2007
(59,636 observations deleted)

. collapse (first) M*, by(sic87dd year) 

. 
. /* this is fixing an issue with two of the sic codes that only show up in 200
> 6 */
. expand 3 if year == 2007 & (sic87dd == 2992 | sic87dd==3273)
(4 observations created)

. bys sic87dd year: egen seq = seq() 

. replace year = 2000 if seq == 3
(2 real changes made)

. replace year = 1990 if seq == 2
(2 real changes made)

. replace M_ucjt = 0 if seq > 1
(4 real changes made)

. replace M_ocjt = 0 if seq > 1 
(4 real changes made)

. drop seq

. 
. sort sic87dd year 

. 
. gen del_M_ucjt = M_ucjt[_n+1]-M_ucjt if year<2007
(397 missing values generated)

. gen del_M_ocjt = M_ocjt[_n+1]-M_ocjt if year<2007
(397 missing values generated)

. 
. drop if year == 2007
(397 observations deleted)

. replace year = 1990 if year == 1991 
(395 real changes made)

. 
. keep del* M_* sic87dd year

. 
. sort sic87dd year

. 
. save "$interwrk/tmp_tradedata.dta", replace
file /ssgprojects/project0002/MobZ.new/data/interwrk/tmp_tradedata.dta saved

. 
. /*****************************
> National Industry Employment
> *****************************/
. use "$interwrk/industry_data.dta", clear

. 
. collapse (sum) emp, by(sic87dd year)

. 
. rename emp L_ujt 

. 
. sort sic87dd year

. 
. /* used nowhere else? */
. save "$interwrk/tmp_industrydata.dta", replace
file /ssgprojects/project0002/MobZ.new/data/interwrk/tmp_industrydata.dta saved

. 
. 
. 
. 
. 
. 
. 
. 
. set more off

. #delimit ;
delimiter now ;
. tempname czoneresults;

. use "`czonedataset'", clear ;

.  /***********************
> Creating string of values to 
> loop over
> ***********************/
> local values = "" ;

. foreach clus of varlist clus* { ;
  2.         di "`clus'" ;
  3.         local val = real(subinstr("`clus'","clus","",.)) ;
  4.         di "`val'" ;
  5.         local values = "`values' `val'" ;
  6. } ;
clus9000
9000
clus9005
9005
clus9010
9010
clus9015
9015
clus9020
9020
clus9025
9025
clus9030
9030
clus9035
9035
clus9040
9040
clus9045
9045
clus9050
9050
clus9055
9055
clus9060
9060
clus9065
9065
clus9070
9070
clus9075
9075
clus9080
9080
clus9085
9085
clus9090
9090
clus9095
9095
clus9100
9100
clus9105
9105
clus9110
9110
clus9115
9115
clus9120
9120
clus9125
9125
clus9130
9130
clus9135
9135
clus9140
9140
clus9145
9145
clus9150
9150
clus9155
9155
clus9160
9160
clus9165
9165
clus9170
9170
clus9175
9175
clus9180
9180
clus9185
9185
clus9190
9190
clus9195
9195
clus9200
9200
clus9205
9205
clus9210
9210
clus9215
9215
clus9220
9220
clus9225
9225
clus9230
9230
clus9235
9235
clus9240
9240
clus9245
9245
clus9250
9250
clus9255
9255
clus9260
9260
clus9265
9265
clus9270
9270
clus9275
9275
clus9280
9280
clus9285
9285
clus9290
9290
clus9295
9295
clus9300
9300
clus9305
9305
clus9310
9310
clus9315
9315
clus9320
9320
clus9325
9325
clus9330
9330
clus9335
9335
clus9340
9340
clus9345
9345
clus9350
9350
clus9355
9355
clus9360
9360
clus9365
9365
clus9370
9370
clus9375
9375
clus9380
9380
clus9385
9385
clus9390
9390
clus9395
9395
clus9400
9400
clus9405
9405
clus9410
9410
clus9415
9415
clus9420
9420
clus9425
9425
clus9430
9430
clus9435
9435
clus9440
9440
clus9445
9445
clus9450
9450
clus9455
9455
clus9460
9460
clus9465
9465
clus9470
9470
clus9475
9475
clus9480
9480
clus9485
9485
clus9490
9490
clus9495
9495
clus9500
9500
clus9505
9505
clus9510
9510
clus9515
9515
clus9520
9520
clus9525
9525
clus9530
9530
clus9535
9535
clus9540
9540
clus9545
9545
clus9550
9550
clus9555
9555
clus9560
9560
clus9565
9565
clus9570
9570
clus9575
9575
clus9580
9580
clus9585
9585
clus9590
9590
clus9595
9595
clus9600
9600
clus9605
9605
clus9610
9610
clus9615
9615
clus9620
9620
clus9625
9625
clus9630
9630
clus9635
9635
clus9640
9640
clus9645
9645
clus9650
9650
clus9655
9655
clus9660
9660
clus9665
9665
clus9670
9670
clus9675
9675
clus9680
9680
clus9685
9685
clus9690
9690
clus9695
9695
clus9700
9700

. postfile `czoneresults' cutoff beta_1990 se_1990 F_90 beta_2000 se_2000 beta_
> all se_all
>                                iqr_1990 iqr_2000 iqr_all
>                         using $ipw_regs, replace ;

.                         /* 
> missing step: estimate effects using our "replicated" Commuting Zones, which
> aren't exactly the same 
> */      
>         di "`values'" ;
 9000 9005 9010 9015 9020 9025 9030 9035 9040 9045 9050 9055 9060 9065 9070 907
> 5 9080 9085 9090 9095 9100 9105 9110 9115 9120 9125 9130 9135 9140 9145 9150 
> 9155 9160 9165 9170 9175 9180 9185 9190 9195 9200 9205 9210 9215 9220 9225 92
> 30 9235 9240 9245 9250 9255 9260 9265 9270 9275 9280 9285 9290 9295 9300 9305
>  9310 9315 9320 9325 9330 9335 9340 9345 9350 9355 9360 9365 9370 9375 9380 9
> 385 9390 9395 9400 9405 9410 9415 9420 9425 9430 9435 9440 9445 9450 9455 946
> 0 9465 9470 9475 9480 9485 9490 9495 9500 9505 9510 9515 9520 9525 9530 9535 
> 9540 9545 9550 9555 9560 9565 9570 9575 9580 9585 9590 9595 9600 9605 9610 96
> 15 9620 9625 9630 9635 9640 9645 9650 9655 9660 9665 9670 9675 9680 9685 9690
>  9695 9700

. foreach i in `values'  { ;
  2.         di "`i'" ;
  3.         local cutoff = `i'/10000 ;
  4.         * step2 ;
.         use "`czonedataset'", clear;
  5.                 egen czone = group(clus`i') ;
  6.                 keep fips czone;
  7.                 sort fips ;
  8.                 tempfile czone;
  9.                 save "$czone_iteration", replace;
 10.                         *step3 ;
.         include "$dodir/zz_ctymerge.do";
 11.                 qui sum IPW_uit if year == 1990, d;
 12.                 local iqr_1990 = r(p75) - r(p25) ;
 13.         qui sum IPW_uit if year == 2000, d;
 14.                 local iqr_2000 = r(p75) - r(p25) ;
 15.         qui sum IPW_uit if year>=1990 & year<=2000,d ;
 16.                 local iqr_all = r(p75) - r(p25) ;
 17.                 *step4 ;
.         ivregress 2sls del_L_mprime (IPW_uit = IPW_oit ) if year == 1990 [wei
> ght=share_czpop];
 18.                 local beta90 = _b[IPW_uit] ;
 19.                 local se90 = _se[IPW_uit] ;
 20.                 qui estat firststage;
 21.                 matrix A = r(singleresults);
 22.                 local F_90 = A[1,4] ;
 23.                                                         ivregress 2sls del
> _L_mprime (IPW_uit = IPW_oit ) if year == 2000 [weight=share_czpop];
 24.                 local beta00 = _b[IPW_uit] ;
 25.                 local se00 = _se[IPW_uit];
 26.         ivregress 2sls del_L_mprime (IPW_uit = IPW_oit ) y2000 [weight=sha
> re_czpop] ;
 27.                 local betaall = _b[IPW_uit] ;
 28.                 local seall = _se[IPW_uit] ;
 29.         post `czoneresults' (`cutoff') (`beta90') (`se90') (`F_90') (`beta
> 00') (`se00') (`betaall') (`seall')
>                                                                         (`iqr
> _1990') (`iqr_2000') (`iqr_all');
 30. } ;
9000
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,656,284      100.00      100.00
------------+-----------------------------------
      Total |  1,656,284      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    551,830       33.32       33.32
          3 |  1,104,454       66.68      100.00
------------+-----------------------------------
      Total |  1,656,284      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(551,830 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(551,830 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(551,830 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000002 not found)
file /tmp/St20945.000002 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,390       19.99       19.99
       1980 |      1,390       19.99       39.98
       1990 |      1,391       20.01       59.99
       2000 |      1,391       20.01       79.99
       2007 |      1,391       20.01      100.00
------------+-----------------------------------
      Total |      6,953      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,562 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,391 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,391 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,562 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,391 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,336 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,562 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,391 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,781
        from master                     2,781  (_merge==1)
        from using                          0  (_merge==2)

    matched                             4,172  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,781       40.00       40.00
            matched (3) |      4,172       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,953      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,390          0 |     1,390 
      1980 |         0      1,390 |     1,390 
      1990 |         0      1,391 |     1,391 
      2000 |         0      1,391 |     1,391 
      2007 |     1,391          0 |     1,391 
-----------+----------------------+----------
     Total |     2,781      4,172 |     6,953 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,780 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,389
                                                  Wald chi2(1)    =     103.87
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1238

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7761289   .0761549   -10.19   0.000    -.9253898    -.626868
       _cons |  -.5841228   .0990173    -5.90   0.000    -.7781932   -.3900525
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,390
                                                  Wald chi2(1)    =     232.76
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0670
                                                  Root MSE        =     2.5343

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9463564     .06203   -15.26   0.000    -1.067933   -.8247799
       _cons |  -1.319409   .1336546    -9.87   0.000    -1.581367   -1.057451
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,779
                                                  Wald chi2(2)    =     703.47
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1097
                                                  Root MSE        =     2.3517

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9002156   .0477843   -18.84   0.000    -.9938712     -.80656
       y2000 |  -.9528293   .0969123    -9.83   0.000    -1.142774   -.7628846
       _cons |    -.45218   .0810043    -5.58   0.000    -.6109456   -.2934144
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9005
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,646,756      100.00      100.00
------------+-----------------------------------
      Total |  1,646,756      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    548,654       33.32       33.32
          3 |  1,098,102       66.68      100.00
------------+-----------------------------------
      Total |  1,646,756      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(548,654 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(548,654 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(548,654 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000004 not found)
file /tmp/St20945.000004 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,382       19.99       19.99
       1980 |      1,382       19.99       39.98
       1990 |      1,383       20.01       59.99
       2000 |      1,383       20.01       79.99
       2007 |      1,383       20.01      100.00
------------+-----------------------------------
      Total |      6,913      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,530 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,383 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,530 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,329 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,530 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,765
        from master                     2,765  (_merge==1)
        from using                          0  (_merge==2)

    matched                             4,148  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,765       40.00       40.00
            matched (3) |      4,148       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,913      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,382          0 |     1,382 
      1980 |         0      1,382 |     1,382 
      1990 |         0      1,383 |     1,383 
      2000 |         0      1,383 |     1,383 
      2007 |     1,383          0 |     1,383 
-----------+----------------------+----------
     Total |     2,765      4,148 |     6,913 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,764 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,381
                                                  Wald chi2(1)    =     102.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1226

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7742736   .0763021   -10.15   0.000     -.923823   -.6247242
       _cons |  -.5858188   .0992222    -5.90   0.000    -.7802908   -.3913468
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,382
                                                  Wald chi2(1)    =     233.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0767
                                                  Root MSE        =     2.5201

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9462859   .0618786   -15.29   0.000    -1.067566   -.8250061
       _cons |  -1.319959   .1332898    -9.90   0.000    -1.581202   -1.058715
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,763
                                                  Wald chi2(2)    =     703.40
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1149
                                                  Root MSE        =     2.3442

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8996464   .0477765   -18.83   0.000    -.9932866   -.8060061
       y2000 |  -.9539515   .0968774    -9.85   0.000    -1.143828   -.7640753
       _cons |  -.4525072   .0809861    -5.59   0.000    -.6112371   -.2937773
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9010
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,639,610      100.00      100.00
------------+-----------------------------------
      Total |  1,639,610      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    546,272       33.32       33.32
          3 |  1,093,338       66.68      100.00
------------+-----------------------------------
      Total |  1,639,610      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(546,272 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(546,272 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(546,272 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000006 not found)
file /tmp/St20945.000006 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,376       19.99       19.99
       1980 |      1,376       19.99       39.98
       1990 |      1,377       20.01       59.99
       2000 |      1,377       20.01       79.99
       2007 |      1,377       20.01      100.00
------------+-----------------------------------
      Total |      6,883      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,506 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,377 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,377 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,506 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,377 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,324 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,506 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,377 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,753
        from master                     2,753  (_merge==1)
        from using                          0  (_merge==2)

    matched                             4,130  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,753       40.00       40.00
            matched (3) |      4,130       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,883      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,376          0 |     1,376 
      1980 |         0      1,376 |     1,376 
      1990 |         0      1,377 |     1,377 
      2000 |         0      1,377 |     1,377 
      2007 |     1,377          0 |     1,377 
-----------+----------------------+----------
     Total |     2,753      4,130 |     6,883 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,752 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,376
                                                  Wald chi2(1)    =     103.33
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1221

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7754928   .0762891   -10.17   0.000    -.9250166    -.625969
       _cons |  -.5840758   .0992825    -5.88   0.000     -.778666   -.3894856
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,376
                                                  Wald chi2(1)    =     232.88
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0768
                                                  Root MSE        =     2.5202

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9460785   .0619955   -15.26   0.000    -1.067587   -.8245697
       _cons |  -1.320138   .1335611    -9.88   0.000    -1.581913   -1.058363
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,752
                                                  Wald chi2(2)    =     701.43
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1148
                                                  Root MSE        =     2.3439

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8998309   .0478359   -18.81   0.000    -.9935876   -.8060742
       y2000 |  -.9540941   .0970462    -9.83   0.000    -1.144301   -.7638872
       _cons |  -.4518249   .0811268    -5.57   0.000    -.6108306   -.2928193
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9015
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,633,655      100.00      100.00
------------+-----------------------------------
      Total |  1,633,655      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    544,287       33.32       33.32
          3 |  1,089,368       66.68      100.00
------------+-----------------------------------
      Total |  1,633,655      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(544,287 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(544,287 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(544,287 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000008 not found)
file /tmp/St20945.000008 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,371       19.99       19.99
       1980 |      1,371       19.99       39.98
       1990 |      1,372       20.01       59.99
       2000 |      1,372       20.01       79.99
       2007 |      1,372       20.01      100.00
------------+-----------------------------------
      Total |      6,858      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,486 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,372 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,372 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,486 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,372 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,319 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,486 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,372 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,743
        from master                     2,743  (_merge==1)
        from using                          0  (_merge==2)

    matched                             4,115  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,743       40.00       40.00
            matched (3) |      4,115       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,858      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,371          0 |     1,371 
      1980 |         0      1,371 |     1,371 
      1990 |         0      1,372 |     1,372 
      2000 |         0      1,372 |     1,372 
      2007 |     1,372          0 |     1,372 
-----------+----------------------+----------
     Total |     2,743      4,115 |     6,858 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,742 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,371
                                                  Wald chi2(1)    =     103.65
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1188

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7759298   .0762138   -10.18   0.000     -.925306   -.6265536
       _cons |  -.5838506   .0992072    -5.89   0.000    -.7782931    -.389408
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,371
                                                  Wald chi2(1)    =     232.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0768
                                                  Root MSE        =     2.5194

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9462578   .0620816   -15.24   0.000    -1.067936   -.8245801
       _cons |  -1.319928   .1337484    -9.87   0.000     -1.58207   -1.057786
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,742
                                                  Wald chi2(2)    =     700.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1160
                                                  Root MSE        =     2.3416

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9000655   .0478573   -18.81   0.000    -.9938641   -.8062669
       y2000 |  -.9537524   .0971267    -9.82   0.000    -1.144117   -.7633876
       _cons |  -.4518523   .0811734    -5.57   0.000    -.6109493   -.2927552
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9020
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,627,700      100.00      100.00
------------+-----------------------------------
      Total |  1,627,700      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    542,302       33.32       33.32
          3 |  1,085,398       66.68      100.00
------------+-----------------------------------
      Total |  1,627,700      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(542,302 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(542,302 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(542,302 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000a not found)
file /tmp/St20945.00000a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,366       19.99       19.99
       1980 |      1,366       19.99       39.98
       1990 |      1,367       20.01       59.99
       2000 |      1,367       20.01       79.99
       2007 |      1,367       20.01      100.00
------------+-----------------------------------
      Total |      6,833      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,466 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,367 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,367 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,466 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,367 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,314 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,466 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,367 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,733
        from master                     2,733  (_merge==1)
        from using                          0  (_merge==2)

    matched                             4,100  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,733       40.00       40.00
            matched (3) |      4,100       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,833      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,366          0 |     1,366 
      1980 |         0      1,366 |     1,366 
      1990 |         0      1,367 |     1,367 
      2000 |         0      1,367 |     1,367 
      2007 |     1,367          0 |     1,367 
-----------+----------------------+----------
     Total |     2,733      4,100 |     6,833 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,732 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,366
                                                  Wald chi2(1)    =     103.21
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      2.118

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.774405   .0762271   -10.16   0.000    -.9238075   -.6250025
       _cons |  -.5853036   .0992664    -5.90   0.000    -.7798623    -.390745
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,366
                                                  Wald chi2(1)    =     231.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0769
                                                  Root MSE        =     2.5186

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9468069   .0621722   -15.23   0.000    -1.068662   -.8249517
       _cons |  -1.318781   .1339437    -9.85   0.000    -1.581306   -1.056256
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,732
                                                  Wald chi2(2)    =     698.81
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1162
                                                  Root MSE        =      2.341

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9000433   .0479147   -18.78   0.000    -.9939544   -.8061321
       y2000 |  -.9538083   .0972711    -9.81   0.000    -1.144456   -.7631604
       _cons |  -.4517074    .081288    -5.56   0.000    -.6110289   -.2923859
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9025
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,618,172      100.00      100.00
------------+-----------------------------------
      Total |  1,618,172      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    539,126       33.32       33.32
          3 |  1,079,046       66.68      100.00
------------+-----------------------------------
      Total |  1,618,172      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(539,126 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(539,126 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(539,126 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000c not found)
file /tmp/St20945.00000c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,358       19.99       19.99
       1980 |      1,358       19.99       39.98
       1990 |      1,359       20.01       59.99
       2000 |      1,359       20.01       79.99
       2007 |      1,359       20.01      100.00
------------+-----------------------------------
      Total |      6,793      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,434 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,359 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,359 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,434 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,359 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,308 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,434 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,359 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,717
        from master                     2,717  (_merge==1)
        from using                          0  (_merge==2)

    matched                             4,076  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,717       40.00       40.00
            matched (3) |      4,076       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,793      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,358          0 |     1,358 
      1980 |         0      1,358 |     1,358 
      1990 |         0      1,359 |     1,359 
      2000 |         0      1,359 |     1,359 
      2007 |     1,359          0 |     1,359 
-----------+----------------------+----------
     Total |     2,717      4,076 |     6,793 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,716 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,358
                                                  Wald chi2(1)    =     102.57
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1123

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7757302   .0765949   -10.13   0.000    -.9258535   -.6256068
       _cons |  -.5842364   .0995676    -5.87   0.000    -.7793852   -.3890875
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,358
                                                  Wald chi2(1)    =     232.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0766
                                                  Root MSE        =     2.5175

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9484954   .0621477   -15.26   0.000    -1.070303    -.826688
       _cons |  -1.316181   .1339772    -9.82   0.000    -1.578771   -1.053591
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,716
                                                  Wald chi2(2)    =     698.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1176
                                                  Root MSE        =     2.3376

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9018961   .0479431   -18.81   0.000    -.9958629   -.8079293
       y2000 |  -.9524625   .0974054    -9.78   0.000    -1.143374   -.7615514
       _cons |  -.4501353   .0813668    -5.53   0.000    -.6096114   -.2906592
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9030
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,608,644      100.00      100.00
------------+-----------------------------------
      Total |  1,608,644      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    535,950       33.32       33.32
          3 |  1,072,694       66.68      100.00
------------+-----------------------------------
      Total |  1,608,644      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(535,950 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(535,950 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(535,950 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000e not found)
file /tmp/St20945.00000e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,350       19.99       19.99
       1980 |      1,350       19.99       39.98
       1990 |      1,351       20.01       59.99
       2000 |      1,351       20.01       79.99
       2007 |      1,351       20.01      100.00
------------+-----------------------------------
      Total |      6,753      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,402 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,351 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,351 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,402 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,351 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,300 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,402 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,351 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,701
        from master                     2,701  (_merge==1)
        from using                          0  (_merge==2)

    matched                             4,052  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,701       40.00       40.00
            matched (3) |      4,052       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,753      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,350          0 |     1,350 
      1980 |         0      1,350 |     1,350 
      1990 |         0      1,351 |     1,351 
      2000 |         0      1,351 |     1,351 
      2007 |     1,351          0 |     1,351 
-----------+----------------------+----------
     Total |     2,701      4,052 |     6,753 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,700 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,350
                                                  Wald chi2(1)    =     102.12
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1124

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7758549   .0767752   -10.11   0.000    -.9263316   -.6253783
       _cons |   -.583625   .0998653    -5.84   0.000    -.7793575   -.3878925
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,350
                                                  Wald chi2(1)    =     231.76
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0765
                                                  Root MSE        =     2.5176

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9489705   .0623351   -15.22   0.000    -1.071145    -.826796
       _cons |  -1.315149   .1343951    -9.79   0.000    -1.578559    -1.05174
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,700
                                                  Wald chi2(2)    =     695.13
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1172
                                                  Root MSE        =     2.3377

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9022404   .0480806   -18.77   0.000    -.9964767   -.8080041
       y2000 |  -.9526165   .0976908    -9.75   0.000    -1.144087   -.7611461
       _cons |  -.4492055   .0816284    -5.50   0.000    -.6091942   -.2892168
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9035
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,596,734      100.00      100.00
------------+-----------------------------------
      Total |  1,596,734      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    531,980       33.32       33.32
          3 |  1,064,754       66.68      100.00
------------+-----------------------------------
      Total |  1,596,734      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(531,980 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(531,980 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(531,980 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000g not found)
file /tmp/St20945.00000g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,340       19.99       19.99
       1980 |      1,340       19.99       39.98
       1990 |      1,341       20.01       59.99
       2000 |      1,341       20.01       79.99
       2007 |      1,341       20.01      100.00
------------+-----------------------------------
      Total |      6,703      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,362 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,341 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,341 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,362 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,341 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,291 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,362 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,341 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,681
        from master                     2,681  (_merge==1)
        from using                          0  (_merge==2)

    matched                             4,022  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,681       40.00       40.00
            matched (3) |      4,022       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,703      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,340          0 |     1,340 
      1980 |         0      1,340 |     1,340 
      1990 |         0      1,341 |     1,341 
      2000 |         0      1,341 |     1,341 
      2007 |     1,341          0 |     1,341 
-----------+----------------------+----------
     Total |     2,681      4,022 |     6,703 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,680 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,340
                                                  Wald chi2(1)    =     103.33
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1122

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7785479   .0765891   -10.17   0.000    -.9286598   -.6284361
       _cons |  -.5808083   .0998347    -5.82   0.000    -.7764806    -.385136
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,340
                                                  Wald chi2(1)    =     230.29
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0765
                                                  Root MSE        =      2.517

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9500067   .0626023   -15.18   0.000    -1.072705   -.8273084
       _cons |   -1.31311   .1349503    -9.73   0.000    -1.577607   -1.048612
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,680
                                                  Wald chi2(2)    =     691.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1169
                                                  Root MSE        =     2.3372

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9037026   .0482118   -18.74   0.000    -.9981961   -.8092092
       y2000 |  -.9513226   .0980209    -9.71   0.000     -1.14344   -.7592053
       _cons |  -.4476756    .081895    -5.47   0.000    -.6081868   -.2871645
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9040
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,587,206      100.00      100.00
------------+-----------------------------------
      Total |  1,587,206      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    528,804       33.32       33.32
          3 |  1,058,402       66.68      100.00
------------+-----------------------------------
      Total |  1,587,206      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(528,804 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(528,804 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(528,804 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000i not found)
file /tmp/St20945.00000i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,332       19.99       19.99
       1980 |      1,332       19.99       39.98
       1990 |      1,333       20.01       59.99
       2000 |      1,333       20.01       79.99
       2007 |      1,333       20.01      100.00
------------+-----------------------------------
      Total |      6,663      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,330 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,333 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,333 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,330 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,333 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,283 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,330 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,333 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,665
        from master                     2,665  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,998  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,665       40.00       40.00
            matched (3) |      3,998       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,663      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,332          0 |     1,332 
      1980 |         0      1,332 |     1,332 
      1990 |         0      1,333 |     1,333 
      2000 |         0      1,333 |     1,333 
      2007 |     1,333          0 |     1,333 
-----------+----------------------+----------
     Total |     2,665      3,998 |     6,663 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,664 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,332
                                                  Wald chi2(1)    =     102.77
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1121

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7794802   .0768907   -10.14   0.000    -.9301832   -.6287773
       _cons |   -.579829   .1001918    -5.79   0.000    -.7762014   -.3834567
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,332
                                                  Wald chi2(1)    =     229.15
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0769
                                                  Root MSE        =     2.5158

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9500905   .0627627   -15.14   0.000    -1.073103   -.8270777
       _cons |   -1.31292   .1352904    -9.70   0.000    -1.578085   -1.047756
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,664
                                                  Wald chi2(2)    =     688.21
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1171
                                                  Root MSE        =     2.3365

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.904081   .0483578   -18.70   0.000    -.9988605   -.8093015
       y2000 |  -.9509684   .0982882    -9.68   0.000     -1.14361   -.7583271
       _cons |  -.4472903   .0821246    -5.45   0.000    -.6082517    -.286329
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9045
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,580,060      100.00      100.00
------------+-----------------------------------
      Total |  1,580,060      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    526,422       33.32       33.32
          3 |  1,053,638       66.68      100.00
------------+-----------------------------------
      Total |  1,580,060      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(526,422 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(526,422 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(526,422 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000k not found)
file /tmp/St20945.00000k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,326       19.99       19.99
       1980 |      1,326       19.99       39.98
       1990 |      1,327       20.01       59.99
       2000 |      1,327       20.01       79.99
       2007 |      1,327       20.01      100.00
------------+-----------------------------------
      Total |      6,633      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,306 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,327 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,306 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,277 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,306 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,653
        from master                     2,653  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,980  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,653       40.00       40.00
            matched (3) |      3,980       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,633      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,326          0 |     1,326 
      1980 |         0      1,326 |     1,326 
      1990 |         0      1,327 |     1,327 
      2000 |         0      1,327 |     1,327 
      2007 |     1,327          0 |     1,327 
-----------+----------------------+----------
     Total |     2,653      3,980 |     6,633 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,652 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,326
                                                  Wald chi2(1)    =     102.88
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1105

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7810718   .0770077   -10.14   0.000     -.932004   -.6301396
       _cons |  -.5783263   .1003405    -5.76   0.000      -.77499   -.3816626
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,326
                                                  Wald chi2(1)    =     228.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0762
                                                  Root MSE        =     2.5148

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9500696   .0628425   -15.12   0.000    -1.073239   -.8269006
       _cons |  -1.312883   .1354815    -9.69   0.000    -1.578422   -1.047344
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,652
                                                  Wald chi2(2)    =     686.45
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1167
                                                  Root MSE        =     2.3351

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9045083   .0484172   -18.68   0.000    -.9994043   -.8096124
       y2000 |  -.9503573   .0984454    -9.65   0.000    -1.143307   -.7574079
       _cons |  -.4470321   .0822456    -5.44   0.000    -.6082305   -.2858337
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9050
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,571,723      100.00      100.00
------------+-----------------------------------
      Total |  1,571,723      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    523,643       33.32       33.32
          3 |  1,048,080       66.68      100.00
------------+-----------------------------------
      Total |  1,571,723      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(523,643 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(523,643 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(523,643 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000m not found)
file /tmp/St20945.00000m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,319       19.99       19.99
       1980 |      1,319       19.99       39.98
       1990 |      1,320       20.01       59.99
       2000 |      1,320       20.01       79.99
       2007 |      1,320       20.01      100.00
------------+-----------------------------------
      Total |      6,598      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,278 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,320 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,320 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,278 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,320 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,272 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,278 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,320 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,639
        from master                     2,639  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,959  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,639       40.00       40.00
            matched (3) |      3,959       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,598      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,319          0 |     1,319 
      1980 |         0      1,319 |     1,319 
      1990 |         0      1,320 |     1,320 
      2000 |         0      1,320 |     1,320 
      2007 |     1,320          0 |     1,320 
-----------+----------------------+----------
     Total |     2,639      3,959 |     6,598 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,638 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,319
                                                  Wald chi2(1)    =     102.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1104

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.781569   .0772045   -10.12   0.000    -.9328871   -.6302508
       _cons |   -.577492   .1006015    -5.74   0.000    -.7746674   -.3803166
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,319
                                                  Wald chi2(1)    =     227.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0763
                                                  Root MSE        =     2.5139

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.949807   .0629889   -15.08   0.000    -1.073263    -.826351
       _cons |  -1.313269   .1357998    -9.67   0.000    -1.579432   -1.047107
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,638
                                                  Wald chi2(2)    =     683.21
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1169
                                                  Root MSE        =     2.3345

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9044484   .0485344   -18.64   0.000    -.9995741   -.8093227
       y2000 |  -.9506171   .0986832    -9.63   0.000    -1.144033   -.7572016
       _cons |   -.446786    .082445    -5.42   0.000    -.6083752   -.2851968
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9055
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,564,577      100.00      100.00
------------+-----------------------------------
      Total |  1,564,577      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    521,261       33.32       33.32
          3 |  1,043,316       66.68      100.00
------------+-----------------------------------
      Total |  1,564,577      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(521,261 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(521,261 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(521,261 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000o not found)
file /tmp/St20945.00000o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,313       19.99       19.99
       1980 |      1,313       19.99       39.98
       1990 |      1,314       20.01       59.99
       2000 |      1,314       20.01       79.99
       2007 |      1,314       20.01      100.00
------------+-----------------------------------
      Total |      6,568      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,254 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,314 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,314 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,254 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,314 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,267 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,254 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,314 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,627
        from master                     2,627  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,941  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,627       40.00       40.00
            matched (3) |      3,941       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,568      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,313          0 |     1,313 
      1980 |         0      1,313 |     1,313 
      1990 |         0      1,314 |     1,314 
      2000 |         0      1,314 |     1,314 
      2007 |     1,314          0 |     1,314 
-----------+----------------------+----------
     Total |     2,627      3,941 |     6,568 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,626 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,313
                                                  Wald chi2(1)    =     102.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1103

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7816595   .0773832   -10.10   0.000    -.9333279   -.6299912
       _cons |  -.5771818   .1008363    -5.72   0.000    -.7748173   -.3795462
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,313
                                                  Wald chi2(1)    =     226.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0759
                                                  Root MSE        =     2.5131

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9493916   .0631384   -15.04   0.000    -1.073141   -.8256427
       _cons |  -1.314188   .1361094    -9.66   0.000    -1.580958   -1.047419
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,626
                                                  Wald chi2(2)    =     680.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1167
                                                  Root MSE        =      2.334

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9041594   .0486498   -18.59   0.000    -.9995112   -.8088076
       y2000 |  -.9512181   .0988902    -9.62   0.000    -1.145039   -.7573968
       _cons |  -.4468706   .0826272    -5.41   0.000    -.6088168   -.2849243
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9060
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,556,240      100.00      100.00
------------+-----------------------------------
      Total |  1,556,240      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    518,482       33.32       33.32
          3 |  1,037,758       66.68      100.00
------------+-----------------------------------
      Total |  1,556,240      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(518,482 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(518,482 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(518,482 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000q not found)
file /tmp/St20945.00000q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,306       19.99       19.99
       1980 |      1,306       19.99       39.98
       1990 |      1,307       20.01       59.99
       2000 |      1,307       20.01       79.99
       2007 |      1,307       20.01      100.00
------------+-----------------------------------
      Total |      6,533      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,226 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,307 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,307 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,226 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,307 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,260 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,226 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,307 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,613
        from master                     2,613  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,920  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,613       40.00       40.00
            matched (3) |      3,920       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,533      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,306          0 |     1,306 
      1980 |         0      1,306 |     1,306 
      1990 |         0      1,307 |     1,307 
      2000 |         0      1,307 |     1,307 
      2007 |     1,307          0 |     1,307 
-----------+----------------------+----------
     Total |     2,613      3,920 |     6,533 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,612 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,306
                                                  Wald chi2(1)    =      99.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1095

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7838879   .0785455    -9.98   0.000    -.9378343   -.6299416
       _cons |  -.5739061   .1019065    -5.63   0.000    -.7736392   -.3741731
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,306
                                                  Wald chi2(1)    =     223.14
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0776
                                                  Root MSE        =     2.5075

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9421726   .0630723   -14.94   0.000    -1.065792   -.8185533
       _cons |  -1.326468   .1360401    -9.75   0.000    -1.593102   -1.059834
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,612
                                                  Wald chi2(2)    =     674.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1171
                                                  Root MSE        =     2.3302

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9000639   .0488213   -18.44   0.000    -.9957519   -.8043759
       y2000 |  -.9542371   .0990421    -9.63   0.000    -1.148356   -.7601181
       _cons |  -.4503538   .0827849    -5.44   0.000    -.6126093   -.2880983
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9065
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,550,285      100.00      100.00
------------+-----------------------------------
      Total |  1,550,285      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    516,497       33.32       33.32
          3 |  1,033,788       66.68      100.00
------------+-----------------------------------
      Total |  1,550,285      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(516,497 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(516,497 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(516,497 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000s not found)
file /tmp/St20945.00000s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,301       19.99       19.99
       1980 |      1,301       19.99       39.98
       1990 |      1,302       20.01       59.99
       2000 |      1,302       20.01       79.99
       2007 |      1,302       20.01      100.00
------------+-----------------------------------
      Total |      6,508      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,206 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,302 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,206 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,256 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,206 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,603
        from master                     2,603  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,905  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,603       40.00       40.00
            matched (3) |      3,905       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,508      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,301          0 |     1,301 
      1980 |         0      1,301 |     1,301 
      1990 |         0      1,302 |     1,302 
      2000 |         0      1,302 |     1,302 
      2007 |     1,302          0 |     1,302 
-----------+----------------------+----------
     Total |     2,603      3,905 |     6,508 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,602 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,301
                                                  Wald chi2(1)    =      98.87
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1078

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.781861   .0786302    -9.94   0.000    -.9359734   -.6277487
       _cons |  -.5761525   .1020162    -5.65   0.000    -.7761007   -.3762044
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,301
                                                  Wald chi2(1)    =     221.67
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0783
                                                  Root MSE        =     2.5045

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9396585   .0631126   -14.89   0.000    -1.063357     -.81596
       _cons |  -1.331081   .1361261    -9.78   0.000    -1.597884   -1.064279
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,602
                                                  Wald chi2(2)    =     671.01
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1178
                                                  Root MSE        =     2.3278

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8976792   .0488604   -18.37   0.000    -.9934438   -.8019146
       y2000 |  -.9559749   .0991295    -9.64   0.000    -1.150265   -.7616847
       _cons |  -.4529852   .0828556    -5.47   0.000    -.6153791   -.2905913
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9070
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,541,948      100.00      100.00
------------+-----------------------------------
      Total |  1,541,948      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    513,718       33.32       33.32
          3 |  1,028,230       66.68      100.00
------------+-----------------------------------
      Total |  1,541,948      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(513,718 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(513,718 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(513,718 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000u not found)
file /tmp/St20945.00000u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,294       19.99       19.99
       1980 |      1,294       19.99       39.98
       1990 |      1,295       20.01       59.99
       2000 |      1,295       20.01       79.99
       2007 |      1,295       20.01      100.00
------------+-----------------------------------
      Total |      6,473      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,178 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,295 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,295 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,178 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,295 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,251 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,178 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,295 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,589
        from master                     2,589  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,884  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,589       40.00       40.00
            matched (3) |      3,884       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,473      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,294          0 |     1,294 
      1980 |         0      1,294 |     1,294 
      1990 |         0      1,295 |     1,295 
      2000 |         0      1,295 |     1,295 
      2007 |     1,295          0 |     1,295 
-----------+----------------------+----------
     Total |     2,589      3,884 |     6,473 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,588 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,294
                                                  Wald chi2(1)    =      98.36
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1075

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7816944   .0788203    -9.92   0.000    -.9361793   -.6272095
       _cons |  -.5760848   .1022717    -5.63   0.000    -.7765337   -.3756358
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,294
                                                  Wald chi2(1)    =     220.46
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0783
                                                  Root MSE        =     2.5045

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9396922   .0632875   -14.85   0.000    -1.063733    -.815651
       _cons |  -1.330811    .136504    -9.75   0.000    -1.598354   -1.063268
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,588
                                                  Wald chi2(2)    =     667.46
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1178
                                                  Root MSE        =     2.3277

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8976584   .0489907   -18.32   0.000    -.9936784   -.8016383
       y2000 |  -.9560395   .0993913    -9.62   0.000    -1.150843   -.7612362
       _cons |  -.4527545   .0830771    -5.45   0.000    -.6155826   -.2899264
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9075
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,530,038      100.00      100.00
------------+-----------------------------------
      Total |  1,530,038      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    509,748       33.32       33.32
          3 |  1,020,290       66.68      100.00
------------+-----------------------------------
      Total |  1,530,038      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(509,748 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(509,748 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(509,748 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00000w not found)
file /tmp/St20945.00000w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,284       19.99       19.99
       1980 |      1,284       19.99       39.98
       1990 |      1,285       20.01       59.99
       2000 |      1,285       20.01       79.99
       2007 |      1,285       20.01      100.00
------------+-----------------------------------
      Total |      6,423      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,138 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,285 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,285 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,138 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,285 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,241 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,138 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,285 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,569
        from master                     2,569  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,854  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,569       40.00       40.00
            matched (3) |      3,854       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,423      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,284          0 |     1,284 
      1980 |         0      1,284 |     1,284 
      1990 |         0      1,285 |     1,285 
      2000 |         0      1,285 |     1,285 
      2007 |     1,285          0 |     1,285 
-----------+----------------------+----------
     Total |     2,569      3,854 |     6,423 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,568 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,284
                                                  Wald chi2(1)    =      97.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1049

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7809035   .0790523    -9.88   0.000    -.9358432   -.6259639
       _cons |  -.5766789   .1025666    -5.62   0.000    -.7777058    -.375652
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,284
                                                  Wald chi2(1)    =     218.79
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0776
                                                  Root MSE        =     2.5025

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9392433   .0634991   -14.79   0.000    -1.063699   -.8147873
       _cons |  -1.331127   .1369486    -9.72   0.000    -1.599541   -1.062712
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,568
                                                  Wald chi2(2)    =     662.85
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1175
                                                  Root MSE        =     2.3255

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8971157   .0491467   -18.25   0.000    -.9934414     -.80079
       y2000 |  -.9562036   .0996837    -9.59   0.000     -1.15158   -.7608271
       _cons |  -.4530774   .0833306    -5.44   0.000    -.6164023   -.2897524
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9080
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,519,319      100.00      100.00
------------+-----------------------------------
      Total |  1,519,319      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    506,175       33.32       33.32
          3 |  1,013,144       66.68      100.00
------------+-----------------------------------
      Total |  1,519,319      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(506,175 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(506,175 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(506,175 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000010 not found)
file /tmp/St20945.000010 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,275       19.99       19.99
       1980 |      1,275       19.99       39.98
       1990 |      1,276       20.01       59.99
       2000 |      1,276       20.01       79.99
       2007 |      1,276       20.01      100.00
------------+-----------------------------------
      Total |      6,378      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,102 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,276 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,276 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,102 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,276 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,232 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,102 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,276 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,551
        from master                     2,551  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,827  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,551       40.00       40.00
            matched (3) |      3,827       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,378      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,275          0 |     1,275 
      1980 |         0      1,275 |     1,275 
      1990 |         0      1,276 |     1,276 
      2000 |         0      1,276 |     1,276 
      2007 |     1,276          0 |     1,276 
-----------+----------------------+----------
     Total |     2,551      3,827 |     6,378 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,550 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,275
                                                  Wald chi2(1)    =      97.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1005

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7887212   .0800372    -9.85   0.000    -.9455912   -.6318512
       _cons |  -.5686727   .1034602    -5.50   0.000    -.7714509   -.3658945
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,275
                                                  Wald chi2(1)    =     218.44
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0773
                                                  Root MSE        =     2.5017

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9429095   .0637981   -14.78   0.000    -1.067952   -.8178675
       _cons |  -1.323976   .1375636    -9.62   0.000    -1.593596   -1.054356
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,550
                                                  Wald chi2(2)    =     661.06
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1178
                                                  Root MSE        =     2.3223

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9020964   .0494459   -18.24   0.000    -.9990086   -.8051841
       y2000 |  -.9515962   .0999712    -9.52   0.000    -1.147536   -.7556562
       _cons |  -.4481138   .0836323    -5.36   0.000    -.6120301   -.2841975
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9085
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,514,555      100.00      100.00
------------+-----------------------------------
      Total |  1,514,555      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    504,587       33.32       33.32
          3 |  1,009,968       66.68      100.00
------------+-----------------------------------
      Total |  1,514,555      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(504,587 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(504,587 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(504,587 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000012 not found)
file /tmp/St20945.000012 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,271       19.99       19.99
       1980 |      1,271       19.99       39.98
       1990 |      1,272       20.01       59.99
       2000 |      1,272       20.01       79.99
       2007 |      1,272       20.01      100.00
------------+-----------------------------------
      Total |      6,358      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,086 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,272 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,272 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,086 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,272 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,229 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,086 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,272 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,543
        from master                     2,543  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,815  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,543       40.00       40.00
            matched (3) |      3,815       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,358      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,271          0 |     1,271 
      1980 |         0      1,271 |     1,271 
      1990 |         0      1,272 |     1,272 
      2000 |         0      1,272 |     1,272 
      2007 |     1,272          0 |     1,272 
-----------+----------------------+----------
     Total |     2,543      3,815 |     6,358 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,542 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,271
                                                  Wald chi2(1)    =      99.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1025

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7963402   .0798149    -9.98   0.000    -.9527745    -.639906
       _cons |  -.5602212   .1033497    -5.42   0.000    -.7627828   -.3576595
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,271
                                                  Wald chi2(1)    =     216.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0785
                                                  Root MSE        =     2.4982

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9394209   .0637757   -14.73   0.000    -1.064419   -.8144227
       _cons |  -1.330699   .1375329    -9.68   0.000    -1.600258   -1.061139
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,542
                                                  Wald chi2(2)    =     660.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1180
                                                  Root MSE        =     2.3205

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9015084   .0494056   -18.25   0.000    -.9983416   -.8046751
       y2000 |  -.9526609   .1000274    -9.52   0.000    -1.148711   -.7566108
       _cons |   -.448389   .0836466    -5.36   0.000    -.6123334   -.2844447
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9090
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,505,027      100.00      100.00
------------+-----------------------------------
      Total |  1,505,027      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    501,411       33.32       33.32
          3 |  1,003,616       66.68      100.00
------------+-----------------------------------
      Total |  1,505,027      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(501,411 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(501,411 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(501,411 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000014 not found)
file /tmp/St20945.000014 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,263       19.99       19.99
       1980 |      1,263       19.99       39.98
       1990 |      1,264       20.01       59.99
       2000 |      1,264       20.01       79.99
       2007 |      1,264       20.01      100.00
------------+-----------------------------------
      Total |      6,318      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,054 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,264 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,264 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,054 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,264 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,221 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,054 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,264 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,527
        from master                     2,527  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,791  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,527       40.00       40.00
            matched (3) |      3,791       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,318      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,263          0 |     1,263 
      1980 |         0      1,263 |     1,263 
      1990 |         0      1,264 |     1,264 
      2000 |         0      1,264 |     1,264 
      2007 |     1,264          0 |     1,264 
-----------+----------------------+----------
     Total |     2,527      3,791 |     6,318 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,526 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,263
                                                  Wald chi2(1)    =      99.82
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.1006

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7991733   .0799912    -9.99   0.000    -.9559532   -.6423934
       _cons |  -.5568893   .1035793    -5.38   0.000    -.7599009   -.3538777
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,263
                                                  Wald chi2(1)    =     215.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0786
                                                  Root MSE        =     2.4946

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9384183   .0638838   -14.69   0.000    -1.063628   -.8132084
       _cons |  -1.332497   .1377643    -9.67   0.000     -1.60251   -1.062484
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,526
                                                  Wald chi2(2)    =     658.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1183
                                                  Root MSE        =     2.3175

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9015097   .0494935   -18.21   0.000    -.9985152   -.8045042
       y2000 |  -.9529118   .1002112    -9.51   0.000    -1.149322   -.7565015
       _cons |  -.4480708   .0837987    -5.35   0.000    -.6123132   -.2838283
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9095
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,500,263      100.00      100.00
------------+-----------------------------------
      Total |  1,500,263      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    499,823       33.32       33.32
          3 |  1,000,440       66.68      100.00
------------+-----------------------------------
      Total |  1,500,263      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(499,823 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(499,823 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(499,823 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000016 not found)
file /tmp/St20945.000016 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,259       19.99       19.99
       1980 |      1,259       19.99       39.98
       1990 |      1,260       20.01       59.99
       2000 |      1,260       20.01       79.99
       2007 |      1,260       20.01      100.00
------------+-----------------------------------
      Total |      6,298      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,038 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,260 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,260 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,038 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,260 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,217 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,038 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,260 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,519
        from master                     2,519  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,779  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,519       40.00       40.00
            matched (3) |      3,779       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,298      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,259          0 |     1,259 
      1980 |         0      1,259 |     1,259 
      1990 |         0      1,260 |     1,260 
      2000 |         0      1,260 |     1,260 
      2007 |     1,260          0 |     1,260 
-----------+----------------------+----------
     Total |     2,519      3,779 |     6,298 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,518 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,259
                                                  Wald chi2(1)    =      99.39
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0964

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7970114   .0799445    -9.97   0.000    -.9536997   -.6403231
       _cons |  -.5593836   .1035241    -5.40   0.000    -.7622871   -.3564802
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,259
                                                  Wald chi2(1)    =     215.90
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0783
                                                  Root MSE        =     2.4928

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9402717   .0639928   -14.69   0.000    -1.065695   -.8148481
       _cons |  -1.328902   .1379724    -9.63   0.000    -1.599323   -1.058481
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,518
                                                  Wald chi2(2)    =     657.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1181
                                                  Root MSE        =     2.3149

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9022687   .0495455   -18.21   0.000    -.9993762   -.8051612
       y2000 |  -.9519616   .1002691    -9.49   0.000    -1.148485   -.7554378
       _cons |  -.4474597   .0838575    -5.34   0.000    -.6118173    -.283102
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9100
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,493,117      100.00      100.00
------------+-----------------------------------
      Total |  1,493,117      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    497,441       33.32       33.32
          3 |    995,676       66.68      100.00
------------+-----------------------------------
      Total |  1,493,117      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(497,441 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(497,441 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(497,441 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000018 not found)
file /tmp/St20945.000018 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,253       19.99       19.99
       1980 |      1,253       19.99       39.98
       1990 |      1,254       20.01       59.99
       2000 |      1,254       20.01       79.99
       2007 |      1,254       20.01      100.00
------------+-----------------------------------
      Total |      6,268      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(5,014 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,254 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,254 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(5,014 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,254 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,211 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(5,014 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,254 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,507
        from master                     2,507  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,761  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,507       40.00       40.00
            matched (3) |      3,761       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,268      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,253          0 |     1,253 
      1980 |         0      1,253 |     1,253 
      1990 |         0      1,254 |     1,254 
      2000 |         0      1,254 |     1,254 
      2007 |     1,254          0 |     1,254 
-----------+----------------------+----------
     Total |     2,507      3,761 |     6,268 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,506 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,253
                                                  Wald chi2(1)    =      99.20
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0926

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7975787   .0800792    -9.96   0.000    -.9545311   -.6406263
       _cons |  -.5585302    .103671    -5.39   0.000    -.7617217   -.3553388
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,253
                                                  Wald chi2(1)    =     214.84
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0791
                                                  Root MSE        =     2.4896

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9386742   .0640412   -14.66   0.000    -1.064193   -.8131557
       _cons |  -1.331375   .1380915    -9.64   0.000    -1.602029    -1.06072
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,506
                                                  Wald chi2(2)    =     656.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1187
                                                  Root MSE        =     2.3113

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9012991   .0495904   -18.17   0.000    -.9984944   -.8041038
       y2000 |  -.9525058   .1003509    -9.49   0.000     -1.14919   -.7558217
       _cons |  -.4482246   .0839339    -5.34   0.000     -.612732   -.2837171
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9105
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,484,780      100.00      100.00
------------+-----------------------------------
      Total |  1,484,780      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    494,662       33.32       33.32
          3 |    990,118       66.68      100.00
------------+-----------------------------------
      Total |  1,484,780      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(494,662 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(494,662 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(494,662 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001a not found)
file /tmp/St20945.00001a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,246       19.99       19.99
       1980 |      1,246       19.99       39.98
       1990 |      1,247       20.01       59.99
       2000 |      1,247       20.01       79.99
       2007 |      1,247       20.01      100.00
------------+-----------------------------------
      Total |      6,233      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,986 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,247 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,247 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,986 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,247 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,205 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,986 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,247 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,493
        from master                     2,493  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,740  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,493       40.00       40.00
            matched (3) |      3,740       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,233      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,246          0 |     1,246 
      1980 |         0      1,246 |     1,246 
      1990 |         0      1,247 |     1,247 
      2000 |         0      1,247 |     1,247 
      2007 |     1,247          0 |     1,247 
-----------+----------------------+----------
     Total |     2,493      3,740 |     6,233 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,492 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,246
                                                  Wald chi2(1)    =      98.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0927

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7976076   .0803073    -9.93   0.000     -.955007   -.6402081
       _cons |  -.5584644   .1039721    -5.37   0.000    -.7622459   -.3546829
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,246
                                                  Wald chi2(1)    =     213.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0790
                                                  Root MSE        =     2.4892

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9384618    .064219   -14.61   0.000    -1.064329   -.8125949
       _cons |  -1.331985   .1384756    -9.62   0.000    -1.603392   -1.060577
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,492
                                                  Wald chi2(2)    =     652.40
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1186
                                                  Root MSE        =     2.3111

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9011432   .0497296   -18.12   0.000    -.9986114   -.8036751
       y2000 |  -.9528935   .1006252    -9.47   0.000    -1.150115   -.7556718
       _cons |  -.4483456   .0841679    -5.33   0.000    -.6133117   -.2833795
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9110
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,478,825      100.00      100.00
------------+-----------------------------------
      Total |  1,478,825      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    492,677       33.32       33.32
          3 |    986,148       66.68      100.00
------------+-----------------------------------
      Total |  1,478,825      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(492,677 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(492,677 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(492,677 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001c not found)
file /tmp/St20945.00001c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,241       19.99       19.99
       1980 |      1,241       19.99       39.98
       1990 |      1,242       20.01       59.99
       2000 |      1,242       20.01       79.99
       2007 |      1,242       20.01      100.00
------------+-----------------------------------
      Total |      6,208      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,966 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,242 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,242 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,966 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,242 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,200 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,966 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,242 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,483
        from master                     2,483  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,725  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,483       40.00       40.00
            matched (3) |      3,725       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,208      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,241          0 |     1,241 
      1980 |         0      1,241 |     1,241 
      1990 |         0      1,242 |     1,242 
      2000 |         0      1,242 |     1,242 
      2007 |     1,242          0 |     1,242 
-----------+----------------------+----------
     Total |     2,483      3,725 |     6,208 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,482 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,241
                                                  Wald chi2(1)    =      98.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0903

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7976092   .0803586    -9.93   0.000    -.9551092   -.6401092
       _cons |  -.5582681   .1040545    -5.37   0.000    -.7622112    -.354325
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,241
                                                  Wald chi2(1)    =     215.01
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0781
                                                  Root MSE        =     2.4872

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9402398   .0641228   -14.66   0.000    -1.065918   -.8145614
       _cons |  -1.328753   .1383749    -9.60   0.000    -1.599963   -1.057543
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,482
                                                  Wald chi2(2)    =     653.44
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1183
                                                  Root MSE        =      2.309

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9024526   .0496785   -18.17   0.000    -.9998207   -.8050845
       y2000 |    -.95214   .1007049    -9.45   0.000    -1.149518   -.7547621
       _cons |  -.4467442   .0841947    -5.31   0.000    -.6117628   -.2817255
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9115
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,470,488      100.00      100.00
------------+-----------------------------------
      Total |  1,470,488      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    489,898       33.32       33.32
          3 |    980,590       66.68      100.00
------------+-----------------------------------
      Total |  1,470,488      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(489,898 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(489,898 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(489,898 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001e not found)
file /tmp/St20945.00001e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,234       19.99       19.99
       1980 |      1,234       19.99       39.98
       1990 |      1,235       20.01       59.99
       2000 |      1,235       20.01       79.99
       2007 |      1,235       20.01      100.00
------------+-----------------------------------
      Total |      6,173      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,938 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,235 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,235 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,938 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,235 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,193 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,938 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,235 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,469
        from master                     2,469  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,704  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,469       40.00       40.00
            matched (3) |      3,704       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,173      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,234          0 |     1,234 
      1980 |         0      1,234 |     1,234 
      1990 |         0      1,235 |     1,235 
      2000 |         0      1,235 |     1,235 
      2007 |     1,235          0 |     1,235 
-----------+----------------------+----------
     Total |     2,469      3,704 |     6,173 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,468 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,234
                                                  Wald chi2(1)    =      97.70
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0899

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7976027   .0806944    -9.88   0.000    -.9557608   -.6394445
       _cons |  -.5582456    .104431    -5.35   0.000    -.7629267   -.3535646
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,234
                                                  Wald chi2(1)    =     213.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0783
                                                  Root MSE        =     2.4864

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9400571   .0642714   -14.63   0.000    -1.066027   -.8140874
       _cons |  -1.329186   .1387041    -9.58   0.000    -1.601041   -1.057331
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,468
                                                  Wald chi2(2)    =     649.94
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1185
                                                  Root MSE        =     2.3085

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9023715   .0498194   -18.11   0.000    -1.000016   -.8047272
       y2000 |  -.9523161   .1009714    -9.43   0.000    -1.150216   -.7544159
       _cons |  -.4468127   .0844172    -5.29   0.000    -.6122673   -.2813582
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9120
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,465,724      100.00      100.00
------------+-----------------------------------
      Total |  1,465,724      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    488,310       33.32       33.32
          3 |    977,414       66.68      100.00
------------+-----------------------------------
      Total |  1,465,724      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(488,310 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(488,310 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(488,310 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001g not found)
file /tmp/St20945.00001g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,230       19.99       19.99
       1980 |      1,230       19.99       39.98
       1990 |      1,231       20.01       59.99
       2000 |      1,231       20.01       79.99
       2007 |      1,231       20.01      100.00
------------+-----------------------------------
      Total |      6,153      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,922 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,231 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,231 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,922 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,231 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,189 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,922 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,231 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,461
        from master                     2,461  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,692  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,461       40.00       40.00
            matched (3) |      3,692       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,153      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,230          0 |     1,230 
      1980 |         0      1,230 |     1,230 
      1990 |         0      1,231 |     1,231 
      2000 |         0      1,231 |     1,231 
      2007 |     1,231          0 |     1,231 
-----------+----------------------+----------
     Total |     2,461      3,692 |     6,153 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,460 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,230
                                                  Wald chi2(1)    =      97.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0884

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.7954139   .0807281    -9.85   0.000    -.9536381   -.6371897
       _cons |  -.5602493   .1044969    -5.36   0.000    -.7650594   -.3554392
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,230
                                                  Wald chi2(1)    =     213.80
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0777
                                                  Root MSE        =     2.4864

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.94244   .0644544   -14.62   0.000    -1.068768   -.8161116
       _cons |  -1.325427    .139024    -9.53   0.000    -1.597909   -1.052945
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,460
                                                  Wald chi2(2)    =     648.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1183
                                                  Root MSE        =     2.3081

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9034377   .0499259   -18.10   0.000    -1.001291   -.8055849
       y2000 |  -.9524485   .1011156    -9.42   0.000    -1.150632   -.7542656
       _cons |  -.4453433   .0845658    -5.27   0.000    -.6110891   -.2795974
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9125
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,453,814      100.00      100.00
------------+-----------------------------------
      Total |  1,453,814      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    484,340       33.32       33.32
          3 |    969,474       66.68      100.00
------------+-----------------------------------
      Total |  1,453,814      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(484,340 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(484,340 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(484,340 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001i not found)
file /tmp/St20945.00001i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,220       19.99       19.99
       1980 |      1,220       19.99       39.98
       1990 |      1,221       20.01       59.99
       2000 |      1,221       20.01       79.99
       2007 |      1,221       20.01      100.00
------------+-----------------------------------
      Total |      6,103      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,882 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,221 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,221 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,882 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,221 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,179 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,882 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,221 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,441
        from master                     2,441  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,662  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,441       40.00       40.00
            matched (3) |      3,662       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,103      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,220          0 |     1,220 
      1980 |         0      1,220 |     1,220 
      1990 |         0      1,221 |     1,221 
      2000 |         0      1,221 |     1,221 
      2007 |     1,221          0 |     1,221 
-----------+----------------------+----------
     Total |     2,441      3,662 |     6,103 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,440 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,220
                                                  Wald chi2(1)    =      99.46
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0825

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8071144   .0809291    -9.97   0.000    -.9657325   -.6484963
       _cons |  -.5483865   .1046803    -5.24   0.000    -.7535561   -.3432169
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,220
                                                  Wald chi2(1)    =     212.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0773
                                                  Root MSE        =     2.4818

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9445427   .0647827   -14.58   0.000    -1.071514    -.817571
       _cons |  -1.323423   .1396295    -9.48   0.000    -1.597092   -1.049754
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,440
                                                  Wald chi2(2)    =     648.95
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1184
                                                  Root MSE        =     2.3022

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9080692    .050126   -18.12   0.000    -1.006314   -.8098239
       y2000 |  -.9500426   .1013199    -9.38   0.000    -1.148626   -.7514593
       _cons |  -.4410537   .0847613    -5.20   0.000    -.6071827   -.2749247
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9130
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,449,050      100.00      100.00
------------+-----------------------------------
      Total |  1,449,050      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    482,752       33.32       33.32
          3 |    966,298       66.68      100.00
------------+-----------------------------------
      Total |  1,449,050      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(482,752 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(482,752 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(482,752 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001k not found)
file /tmp/St20945.00001k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,216       19.99       19.99
       1980 |      1,216       19.99       39.98
       1990 |      1,217       20.01       59.99
       2000 |      1,217       20.01       79.99
       2007 |      1,217       20.01      100.00
------------+-----------------------------------
      Total |      6,083      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,866 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,217 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,217 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,866 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,217 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,176 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,866 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,217 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,433
        from master                     2,433  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,650  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,433       40.00       40.00
            matched (3) |      3,650       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,083      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,216          0 |     1,216 
      1980 |         0      1,216 |     1,216 
      1990 |         0      1,217 |     1,217 
      2000 |         0      1,217 |     1,217 
      2007 |     1,217          0 |     1,217 
-----------+----------------------+----------
     Total |     2,433      3,650 |     6,083 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,432 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,216
                                                  Wald chi2(1)    =     100.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0804

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8105376   .0809023   -10.02   0.000    -.9691031    -.651972
       _cons |   -.544483   .1046819    -5.20   0.000    -.7496558   -.3393103
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,216
                                                  Wald chi2(1)    =     211.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0770
                                                  Root MSE        =     2.4817

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9448102   .0649344   -14.55   0.000    -1.072079   -.8175411
       _cons |  -1.323062    .139923    -9.46   0.000    -1.597306   -1.048817
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,432
                                                  Wald chi2(2)    =     648.19
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1183
                                                  Root MSE        =      2.301

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9091424   .0501966   -18.11   0.000    -1.007526   -.8107589
       y2000 |  -.9495918   .1014333    -9.36   0.000    -1.148397    -.750786
       _cons |  -.4396439   .0848666    -5.18   0.000    -.6059795   -.2733084
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9135
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,439,522      100.00      100.00
------------+-----------------------------------
      Total |  1,439,522      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    479,576       33.31       33.31
          3 |    959,946       66.69      100.00
------------+-----------------------------------
      Total |  1,439,522      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(479,576 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(479,576 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(479,576 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001m not found)
file /tmp/St20945.00001m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,208       19.99       19.99
       1980 |      1,208       19.99       39.98
       1990 |      1,209       20.01       59.99
       2000 |      1,209       20.01       79.99
       2007 |      1,209       20.01      100.00
------------+-----------------------------------
      Total |      6,043      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,834 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,209 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,209 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,834 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,209 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,168 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,834 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,209 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,417
        from master                     2,417  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,626  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,417       40.00       40.00
            matched (3) |      3,626       60.00      100.00
------------------------+-----------------------------------
                  Total |      6,043      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,208          0 |     1,208 
      1980 |         0      1,208 |     1,208 
      1990 |         0      1,209 |     1,209 
      2000 |         0      1,209 |     1,209 
      2007 |     1,209          0 |     1,209 
-----------+----------------------+----------
     Total |     2,417      3,626 |     6,043 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,416 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,208
                                                  Wald chi2(1)    =      99.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0797

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8113252   .0811595   -10.00   0.000     -.970395   -.6522554
       _cons |  -.5428532   .1050034    -5.17   0.000    -.7486562   -.3370503
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,208
                                                  Wald chi2(1)    =     211.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0779
                                                  Root MSE        =     2.4791

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9450333   .0650544   -14.53   0.000    -1.072538   -.8175291
       _cons |  -1.322337   .1401898    -9.43   0.000    -1.597104    -1.04757
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,416
                                                  Wald chi2(2)    =     645.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1188
                                                  Root MSE        =     2.2992

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9095277   .0503124   -18.08   0.000    -1.008138   -.8109172
       y2000 |  -.9497589   .1016868    -9.34   0.000    -1.149061   -.7504565
       _cons |  -.4384473    .085073    -5.15   0.000    -.6051873   -.2717073
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9140
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,427,612      100.00      100.00
------------+-----------------------------------
      Total |  1,427,612      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    475,606       33.31       33.31
          3 |    952,006       66.69      100.00
------------+-----------------------------------
      Total |  1,427,612      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(475,606 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(475,606 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(475,606 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001o not found)
file /tmp/St20945.00001o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,198       19.99       19.99
       1980 |      1,198       19.99       39.98
       1990 |      1,199       20.01       59.99
       2000 |      1,199       20.01       79.99
       2007 |      1,199       20.01      100.00
------------+-----------------------------------
      Total |      5,993      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,794 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,199 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,199 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,794 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,199 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,161 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,794 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,199 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,397
        from master                     2,397  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,596  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,397       40.00       40.00
            matched (3) |      3,596       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,993      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,198          0 |     1,198 
      1980 |         0      1,198 |     1,198 
      1990 |         0      1,199 |     1,199 
      2000 |         0      1,199 |     1,199 
      2007 |     1,199          0 |     1,199 
-----------+----------------------+----------
     Total |     2,397      3,596 |     5,993 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,396 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,198
                                                  Wald chi2(1)    =      99.80
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0765

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8161755   .0816978    -9.99   0.000    -.9763002   -.6560508
       _cons |  -.5385877   .1055076    -5.10   0.000    -.7453787   -.3317966
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,198
                                                  Wald chi2(1)    =     211.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0766
                                                  Root MSE        =     2.4737

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9461684   .0650556   -14.54   0.000    -1.073675   -.8186618
       _cons |  -1.318563   .1402767    -9.40   0.000    -1.593501   -1.043626
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,396
                                                  Wald chi2(2)    =     643.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1182
                                                  Root MSE        =     2.2945

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.911852   .0504041   -18.09   0.000    -1.010642   -.8130617
       y2000 |  -.9452887   .1019184    -9.27   0.000    -1.145045   -.7455323
       _cons |   -.436946   .0852171    -5.13   0.000    -.6039685   -.2699235
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9145
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,418,084      100.00      100.00
------------+-----------------------------------
      Total |  1,418,084      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    472,430       33.31       33.31
          3 |    945,654       66.69      100.00
------------+-----------------------------------
      Total |  1,418,084      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(472,430 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(472,430 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(472,430 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001q not found)
file /tmp/St20945.00001q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,190       19.99       19.99
       1980 |      1,190       19.99       39.98
       1990 |      1,191       20.01       59.99
       2000 |      1,191       20.01       79.99
       2007 |      1,191       20.01      100.00
------------+-----------------------------------
      Total |      5,953      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,762 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,191 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,191 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,762 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,191 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,155 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,762 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,191 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,381
        from master                     2,381  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,572  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,381       40.00       40.00
            matched (3) |      3,572       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,953      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,190          0 |     1,190 
      1980 |         0      1,190 |     1,190 
      1990 |         0      1,191 |     1,191 
      2000 |         0      1,191 |     1,191 
      2007 |     1,191          0 |     1,191 
-----------+----------------------+----------
     Total |     2,381      3,572 |     5,953 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,380 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,190
                                                  Wald chi2(1)    =     100.09
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0729

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8195228   .0819167   -10.00   0.000    -.9800766   -.6589691
       _cons |  -.5360442    .105739    -5.07   0.000    -.7432889   -.3287995
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,190
                                                  Wald chi2(1)    =     210.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0781
                                                  Root MSE        =     2.4696

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9433673   .0650957   -14.49   0.000    -1.070953    -.815782
       _cons |  -1.323581   .1404111    -9.43   0.000    -1.598782    -1.04838
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,380
                                                  Wald chi2(2)    =     641.27
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1192
                                                  Root MSE        =     2.2903

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9107251   .0504531   -18.05   0.000    -1.009611   -.8118388
       y2000 |  -.9449734   .1020712    -9.26   0.000    -1.145029   -.7449176
       _cons |  -.4391773   .0853202    -5.15   0.000    -.6064017   -.2719528
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9150
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,407,365      100.00      100.00
------------+-----------------------------------
      Total |  1,407,365      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    468,857       33.31       33.31
          3 |    938,508       66.69      100.00
------------+-----------------------------------
      Total |  1,407,365      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(468,857 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(468,857 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(468,857 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001s not found)
file /tmp/St20945.00001s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,181       19.99       19.99
       1980 |      1,181       19.99       39.98
       1990 |      1,182       20.01       59.99
       2000 |      1,182       20.01       79.99
       2007 |      1,182       20.01      100.00
------------+-----------------------------------
      Total |      5,908      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,726 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,182 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,182 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,726 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,182 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,147 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,726 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,182 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,363
        from master                     2,363  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,545  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,363       40.00       40.00
            matched (3) |      3,545       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,908      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,181          0 |     1,181 
      1980 |         0      1,181 |     1,181 
      1990 |         0      1,182 |     1,182 
      2000 |         0      1,182 |     1,182 
      2007 |     1,182          0 |     1,182 
-----------+----------------------+----------
     Total |     2,363      3,545 |     5,908 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,362 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,181
                                                  Wald chi2(1)    =     100.15
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0679

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8131397   .0812517   -10.01   0.000    -.9723901   -.6538893
       _cons |  -.5426443   .1052027    -5.16   0.000    -.7488378   -.3364508
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,181
                                                  Wald chi2(1)    =     210.77
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0762
                                                  Root MSE        =     2.4678

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9445236   .0650594   -14.52   0.000    -1.072038   -.8170095
       _cons |  -1.321702   .1404608    -9.41   0.000       -1.597   -1.046404
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,362
                                                  Wald chi2(2)    =     640.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1185
                                                  Root MSE        =     2.2876

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9099879   .0503444   -18.08   0.000    -1.008661   -.8113147
       y2000 |  -.9459986   .1022621    -9.25   0.000    -1.146429   -.7455685
       _cons |  -.4397843   .0853815    -5.15   0.000    -.6071289   -.2724397
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9155
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,403,792      100.00      100.00
------------+-----------------------------------
      Total |  1,403,792      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    467,666       33.31       33.31
          3 |    936,126       66.69      100.00
------------+-----------------------------------
      Total |  1,403,792      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(467,666 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(467,666 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(467,666 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001u not found)
file /tmp/St20945.00001u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,178       19.99       19.99
       1980 |      1,178       19.99       39.98
       1990 |      1,179       20.01       59.99
       2000 |      1,179       20.01       79.99
       2007 |      1,179       20.01      100.00
------------+-----------------------------------
      Total |      5,893      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,714 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,179 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,179 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,714 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,179 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,146 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,714 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,179 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,357
        from master                     2,357  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,536  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,357       40.00       40.00
            matched (3) |      3,536       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,893      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,178          0 |     1,178 
      1980 |         0      1,178 |     1,178 
      1990 |         0      1,179 |     1,179 
      2000 |         0      1,179 |     1,179 
      2007 |     1,179          0 |     1,179 
-----------+----------------------+----------
     Total |     2,357      3,536 |     5,893 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,356 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,178
                                                  Wald chi2(1)    =      99.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0678

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8131953   .0813575   -10.00   0.000    -.9726531   -.6537374
       _cons |  -.5425509     .10534    -5.15   0.000    -.7490135   -.3360884
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,178
                                                  Wald chi2(1)    =     210.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0763
                                                  Root MSE        =     2.4677

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9444545   .0651378   -14.50   0.000    -1.072122   -.8167867
       _cons |  -1.321881   .1406291    -9.40   0.000    -1.597509   -1.046254
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,356
                                                  Wald chi2(2)    =     639.07
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1186
                                                  Root MSE        =     2.2875

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9099534   .0504064   -18.05   0.000    -1.008748   -.8111587
       y2000 |  -.9461127   .1023874    -9.24   0.000    -1.146788   -.7454371
       _cons |   -.439784   .0854878    -5.14   0.000    -.6073369    -.272231
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9160
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,397,837      100.00      100.00
------------+-----------------------------------
      Total |  1,397,837      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    465,681       33.31       33.31
          3 |    932,156       66.69      100.00
------------+-----------------------------------
      Total |  1,397,837      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(465,681 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(465,681 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(465,681 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00001w not found)
file /tmp/St20945.00001w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,173       19.99       19.99
       1980 |      1,173       19.99       39.98
       1990 |      1,174       20.01       59.99
       2000 |      1,174       20.01       79.99
       2007 |      1,174       20.01      100.00
------------+-----------------------------------
      Total |      5,868      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,694 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,174 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,174 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,694 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,174 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,142 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,694 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,174 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,347
        from master                     2,347  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,521  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,347       40.00       40.00
            matched (3) |      3,521       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,868      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,173          0 |     1,173 
      1980 |         0      1,173 |     1,173 
      1990 |         0      1,174 |     1,174 
      2000 |         0      1,174 |     1,174 
      2007 |     1,174          0 |     1,174 
-----------+----------------------+----------
     Total |     2,347      3,521 |     5,868 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,346 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,173
                                                  Wald chi2(1)    =      99.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0676

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8131891   .0815197    -9.98   0.000    -.9729648   -.6534133
       _cons |  -.5423507   .1055539    -5.14   0.000    -.7492325   -.3354689
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,173
                                                  Wald chi2(1)    =     209.28
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0762
                                                  Root MSE        =     2.4669

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9443446   .0652772   -14.47   0.000    -1.072286   -.8164036
       _cons |  -1.321772   .1409312    -9.38   0.000    -1.597992   -1.045552
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,346
                                                  Wald chi2(2)    =     636.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1186
                                                  Root MSE        =     2.2869

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9098586   .0505133   -18.01   0.000    -1.008863   -.8108544
       y2000 |  -.9460945   .1025875    -9.22   0.000    -1.147162   -.7450267
       _cons |  -.4396729   .0856583    -5.13   0.000      -.60756   -.2717857
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9165
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,388,309      100.00      100.00
------------+-----------------------------------
      Total |  1,388,309      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    462,505       33.31       33.31
          3 |    925,804       66.69      100.00
------------+-----------------------------------
      Total |  1,388,309      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(462,505 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(462,505 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(462,505 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000020 not found)
file /tmp/St20945.000020 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,165       19.99       19.99
       1980 |      1,165       19.99       39.98
       1990 |      1,166       20.01       59.99
       2000 |      1,166       20.01       79.99
       2007 |      1,166       20.01      100.00
------------+-----------------------------------
      Total |      5,828      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,662 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,166 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,166 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,662 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,166 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,134 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,662 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,166 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,331
        from master                     2,331  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,497  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,331       40.00       40.00
            matched (3) |      3,497       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,828      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,165          0 |     1,165 
      1980 |         0      1,165 |     1,165 
      1990 |         0      1,166 |     1,166 
      2000 |         0      1,166 |     1,166 
      2007 |     1,166          0 |     1,166 
-----------+----------------------+----------
     Total |     2,331      3,497 |     5,828 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,330 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,165
                                                  Wald chi2(1)    =      99.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0664

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8155236    .081748    -9.98   0.000    -.9757469   -.6553004
       _cons |  -.5394058   .1058474    -5.10   0.000    -.7468629   -.3319487
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,165
                                                  Wald chi2(1)    =     210.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0867
                                                  Root MSE        =     2.4494

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9461902   .0652457   -14.50   0.000    -1.074069    -.818311
       _cons |  -1.322491   .1405203    -9.41   0.000    -1.597905   -1.047076
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,330
                                                  Wald chi2(2)    =     637.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1240
                                                  Root MSE        =     2.2776

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.911745   .0505964   -18.02   0.000    -1.010912   -.8125779
       y2000 |  -.9490616   .1024757    -9.26   0.000     -1.14991   -.7482129
       _cons |  -.4372105   .0856759    -5.10   0.000    -.6051322   -.2692889
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9170
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,381,163      100.00      100.00
------------+-----------------------------------
      Total |  1,381,163      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    460,123       33.31       33.31
          3 |    921,040       66.69      100.00
------------+-----------------------------------
      Total |  1,381,163      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(460,123 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(460,123 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(460,123 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000022 not found)
file /tmp/St20945.000022 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,159       19.99       19.99
       1980 |      1,159       19.99       39.98
       1990 |      1,160       20.01       59.99
       2000 |      1,160       20.01       79.99
       2007 |      1,160       20.01      100.00
------------+-----------------------------------
      Total |      5,798      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,638 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,160 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,160 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,638 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,160 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,129 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,638 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,160 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,319
        from master                     2,319  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,479  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,319       40.00       40.00
            matched (3) |      3,479       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,798      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,159          0 |     1,159 
      1980 |         0      1,159 |     1,159 
      1990 |         0      1,160 |     1,160 
      2000 |         0      1,160 |     1,160 
      2007 |     1,160          0 |     1,160 
-----------+----------------------+----------
     Total |     2,319      3,479 |     5,798 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,318 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,159
                                                  Wald chi2(1)    =      99.22
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0619

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8146838   .0817876    -9.96   0.000    -.9749846    -.654383
       _cons |  -.5398758    .105936    -5.10   0.000    -.7475066   -.3322451
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,159
                                                  Wald chi2(1)    =     209.59
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0886
                                                  Root MSE        =     2.4418

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9440276   .0652074   -14.48   0.000    -1.071832   -.8162234
       _cons |   -1.32613   .1404445    -9.44   0.000    -1.601396   -1.050864
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,318
                                                  Wald chi2(2)    =     636.21
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1243
                                                  Root MSE        =     2.2715

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.909934    .050591   -17.99   0.000    -1.009091   -.8107775
       y2000 |  -.9506095   .1024559    -9.28   0.000    -1.151419   -.7497995
       _cons |  -.4386537   .0856871    -5.12   0.000    -.6065974     -.27071
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9175
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,372,826      100.00      100.00
------------+-----------------------------------
      Total |  1,372,826      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    457,344       33.31       33.31
          3 |    915,482       66.69      100.00
------------+-----------------------------------
      Total |  1,372,826      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(457,344 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(457,344 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(457,344 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000024 not found)
file /tmp/St20945.000024 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,152       19.99       19.99
       1980 |      1,152       19.99       39.98
       1990 |      1,153       20.01       59.99
       2000 |      1,153       20.01       79.99
       2007 |      1,153       20.01      100.00
------------+-----------------------------------
      Total |      5,763      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,610 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,153 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,153 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,610 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,153 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,122 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,610 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,153 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,305
        from master                     2,305  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,458  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,305       40.00       40.00
            matched (3) |      3,458       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,763      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,152          0 |     1,152 
      1980 |         0      1,152 |     1,152 
      1990 |         0      1,153 |     1,153 
      2000 |         0      1,153 |     1,153 
      2007 |     1,153          0 |     1,153 
-----------+----------------------+----------
     Total |     2,305      3,458 |     5,763 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,304 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,152
                                                  Wald chi2(1)    =      98.33
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0581

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8120282   .0818902    -9.92   0.000    -.9725301   -.6515263
       _cons |  -.5422188   .1060683    -5.11   0.000    -.7501088   -.3343288
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,152
                                                  Wald chi2(1)    =     208.84
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0889
                                                  Root MSE        =     2.4397

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9446424   .0653676   -14.45   0.000     -1.07276   -.8165242
       _cons |  -1.325248   .1407819    -9.41   0.000    -1.601175    -1.04932
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,304
                                                  Wald chi2(2)    =     633.76
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1247
                                                  Root MSE        =     2.2689

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9096885   .0506989   -17.94   0.000    -1.009057   -.8103205
       y2000 |  -.9515432   .1026535    -9.27   0.000     -1.15274   -.7503462
       _cons |  -.4384322   .0858582    -5.11   0.000    -.6067111   -.2701533
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9180
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,359,725      100.00      100.00
------------+-----------------------------------
      Total |  1,359,725      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    452,977       33.31       33.31
          3 |    906,748       66.69      100.00
------------+-----------------------------------
      Total |  1,359,725      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(452,977 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(452,977 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(452,977 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000026 not found)
file /tmp/St20945.000026 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,141       19.99       19.99
       1980 |      1,141       19.99       39.98
       1990 |      1,142       20.01       59.99
       2000 |      1,142       20.01       79.99
       2007 |      1,142       20.01      100.00
------------+-----------------------------------
      Total |      5,708      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,566 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,142 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,142 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,566 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,142 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,111 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,566 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,142 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,283
        from master                     2,283  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,425  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,283       40.00       40.00
            matched (3) |      3,425       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,708      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,141          0 |     1,141 
      1980 |         0      1,141 |     1,141 
      1990 |         0      1,142 |     1,142 
      2000 |         0      1,142 |     1,142 
      2007 |     1,142          0 |     1,142 
-----------+----------------------+----------
     Total |     2,283      3,425 |     5,708 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,282 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,141
                                                  Wald chi2(1)    =      97.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      2.053

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.81785   .0827718    -9.88   0.000    -.9800797   -.6556204
       _cons |  -.5361733   .1068606    -5.02   0.000    -.7456162   -.3267303
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,141
                                                  Wald chi2(1)    =     206.80
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0884
                                                  Root MSE        =     2.4356

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.946675   .0658305   -14.38   0.000      -1.0757   -.8176496
       _cons |  -1.322209   .1415943    -9.34   0.000    -1.599729   -1.044689
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,282
                                                  Wald chi2(2)    =     629.76
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1254
                                                  Root MSE        =     2.2637

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9127922   .0510846   -17.87   0.000    -1.012916   -.8126682
       y2000 |  -.9495749   .1029948    -9.22   0.000    -1.151441   -.7477089
       _cons |  -.4353556   .0862195    -5.05   0.000    -.6043428   -.2663684
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9185
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,349,006      100.00      100.00
------------+-----------------------------------
      Total |  1,349,006      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    449,404       33.31       33.31
          3 |    899,602       66.69      100.00
------------+-----------------------------------
      Total |  1,349,006      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(449,404 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(449,404 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(449,404 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000028 not found)
file /tmp/St20945.000028 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,132       19.99       19.99
       1980 |      1,132       19.99       39.98
       1990 |      1,133       20.01       59.99
       2000 |      1,133       20.01       79.99
       2007 |      1,133       20.01      100.00
------------+-----------------------------------
      Total |      5,663      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,530 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,133 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,133 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,530 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,133 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,103 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,530 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,133 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,265
        from master                     2,265  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,398  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,265       40.00       40.00
            matched (3) |      3,398       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,663      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,132          0 |     1,132 
      1980 |         0      1,132 |     1,132 
      1990 |         0      1,133 |     1,133 
      2000 |         0      1,133 |     1,133 
      2007 |     1,133          0 |     1,133 
-----------+----------------------+----------
     Total |     2,265      3,398 |     5,663 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,264 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,132
                                                  Wald chi2(1)    =      97.00
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0509

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8209569   .0833549    -9.85   0.000    -.9843294   -.6575843
       _cons |  -.5330053   .1074615    -4.96   0.000     -.743626   -.3223847
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,132
                                                  Wald chi2(1)    =     205.41
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0881
                                                  Root MSE        =     2.4338

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9492697    .066233   -14.33   0.000    -1.079084   -.8194554
       _cons |  -1.318419   .1423301    -9.26   0.000    -1.597381   -1.039457
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,264
                                                  Wald chi2(2)    =     625.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1253
                                                  Root MSE        =     2.2618

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9155442   .0514055   -17.81   0.000    -1.016297   -.8147912
       y2000 |  -.9482541   .1033605    -9.17   0.000    -1.150837   -.7456712
       _cons |  -.4325801   .0865912    -5.00   0.000    -.6022957   -.2628645
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9190
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,338,287      100.00      100.00
------------+-----------------------------------
      Total |  1,338,287      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    445,831       33.31       33.31
          3 |    892,456       66.69      100.00
------------+-----------------------------------
      Total |  1,338,287      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(445,831 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(445,831 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(445,831 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002a not found)
file /tmp/St20945.00002a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,123       19.99       19.99
       1980 |      1,123       19.99       39.98
       1990 |      1,124       20.01       59.99
       2000 |      1,124       20.01       79.99
       2007 |      1,124       20.01      100.00
------------+-----------------------------------
      Total |      5,618      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,494 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,124 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,124 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,494 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,124 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,094 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,494 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,124 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,247
        from master                     2,247  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,371  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,247       40.00       40.00
            matched (3) |      3,371       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,618      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,123          0 |     1,123 
      1980 |         0      1,123 |     1,123 
      1990 |         0      1,124 |     1,124 
      2000 |         0      1,124 |     1,124 
      2007 |     1,124          0 |     1,124 
-----------+----------------------+----------
     Total |     2,247      3,371 |     5,618 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,246 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,123
                                                  Wald chi2(1)    =      96.79
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0489

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8225264   .0836045    -9.84   0.000    -.9863882   -.6586646
       _cons |  -.5316036   .1078028    -4.93   0.000    -.7428931   -.3203141
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,123
                                                  Wald chi2(1)    =     204.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0876
                                                  Root MSE        =     2.4337

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9518554   .0665457   -14.30   0.000    -1.082283   -.8214283
       _cons |  -1.312692   .1429641    -9.18   0.000    -1.592897   -1.032488
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,246
                                                  Wald chi2(2)    =     622.15
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1246
                                                  Root MSE        =     2.2609

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.91783    .051619   -17.78   0.000    -1.019001   -.8166587
       y2000 |  -.9452646   .1037325    -9.11   0.000    -1.148577   -.7419527
       _cons |  -.4303928   .0869302    -4.95   0.000    -.6007728   -.2600128
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9195
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,328,759      100.00      100.00
------------+-----------------------------------
      Total |  1,328,759      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    442,655       33.31       33.31
          3 |    886,104       66.69      100.00
------------+-----------------------------------
      Total |  1,328,759      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(442,655 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(442,655 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(442,655 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002c not found)
file /tmp/St20945.00002c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,115       19.99       19.99
       1980 |      1,115       19.99       39.98
       1990 |      1,116       20.01       59.99
       2000 |      1,116       20.01       79.99
       2007 |      1,116       20.01      100.00
------------+-----------------------------------
      Total |      5,578      100.00

. 
. xtset czone year
       panel variable:  czone (unbalanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,462 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,116 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,116 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,462 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,116 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,086 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,462 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,116 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,231
        from master                     2,231  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,347  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,231       40.00       40.00
            matched (3) |      3,347       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,578      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,115          0 |     1,115 
      1980 |         0      1,115 |     1,115 
      1990 |         0      1,116 |     1,116 
      2000 |         0      1,116 |     1,116 
      2007 |     1,116          0 |     1,116 
-----------+----------------------+----------
     Total |     2,231      3,347 |     5,578 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,230 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,115
                                                  Wald chi2(1)    =      96.27
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      2.042

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8244429   .0840253    -9.81   0.000    -.9891293   -.6597564
       _cons |   -.529158   .1081773    -4.89   0.000    -.7411817   -.3171344
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,115
                                                  Wald chi2(1)    =     207.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0840
                                                  Root MSE        =     2.4344

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9613848    .066664   -14.42   0.000    -1.092044   -.8307256
       _cons |  -1.295211   .1432863    -9.04   0.000    -1.576047   -1.014375
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,230
                                                  Wald chi2(2)    =     624.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1226
                                                  Root MSE        =     2.2587

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9254658   .0517323   -17.89   0.000    -1.026859   -.8240723
       y2000 |  -.9398017   .1039916    -9.04   0.000    -1.143621   -.7359818
       _cons |  -.4218724   .0871424    -4.84   0.000    -.5926684   -.2510765
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9200
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,314,864      100.00      100.00
------------+-----------------------------------
      Total |  1,314,864      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    438,288       33.33       33.33
          3 |    876,576       66.67      100.00
------------+-----------------------------------
      Total |  1,314,864      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(438,288 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(438,288 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(438,288 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002e not found)
file /tmp/St20945.00002e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,104       20.00       20.00
       1980 |      1,104       20.00       40.00
       1990 |      1,104       20.00       60.00
       2000 |      1,104       20.00       80.00
       2007 |      1,104       20.00      100.00
------------+-----------------------------------
      Total |      5,520      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,416 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,104 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,104 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,416 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,104 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,075 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,416 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,104 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,208
        from master                     2,208  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,312  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,208       40.00       40.00
            matched (3) |      3,312       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,520      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,104          0 |     1,104 
      1980 |         0      1,104 |     1,104 
      1990 |         0      1,104 |     1,104 
      2000 |         0      1,104 |     1,104 
      2007 |     1,104          0 |     1,104 
-----------+----------------------+----------
     Total |     2,208      3,312 |     5,520 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,208 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,103
                                                  Wald chi2(1)    =      95.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0429

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8276278   .0845087    -9.79   0.000    -.9932619   -.6619938
       _cons |  -.5259628    .108809    -4.83   0.000    -.7392245   -.3127011
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,103
                                                  Wald chi2(1)    =     206.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0836
                                                  Root MSE        =     2.4336

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9632326   .0670199   -14.37   0.000    -1.094589   -.8318759
       _cons |   -1.29172   .1440553    -8.97   0.000    -1.574063   -1.009376
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,206
                                                  Wald chi2(2)    =     619.27
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1220
                                                  Root MSE        =     2.2586

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9276796   .0520205   -17.83   0.000    -1.029638   -.8257212
       y2000 |  -.9378126   .1045578    -8.97   0.000    -1.142742   -.7328831
       _cons |  -.4197006   .0876209    -4.79   0.000    -.5914344   -.2479668
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9205
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,299,381      100.00      100.00
------------+-----------------------------------
      Total |  1,299,381      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    433,127       33.33       33.33
          3 |    866,254       66.67      100.00
------------+-----------------------------------
      Total |  1,299,381      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(433,127 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(433,127 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(433,127 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002g not found)
file /tmp/St20945.00002g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,091       20.00       20.00
       1980 |      1,091       20.00       40.00
       1990 |      1,091       20.00       60.00
       2000 |      1,091       20.00       80.00
       2007 |      1,091       20.00      100.00
------------+-----------------------------------
      Total |      5,455      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,364 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,091 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,091 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,364 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,091 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,063 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,364 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,091 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,182
        from master                     2,182  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,273  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,182       40.00       40.00
            matched (3) |      3,273       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,455      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,091          0 |     1,091 
      1980 |         0      1,091 |     1,091 
      1990 |         0      1,091 |     1,091 
      2000 |         0      1,091 |     1,091 
      2007 |     1,091          0 |     1,091 
-----------+----------------------+----------
     Total |     2,182      3,273 |     5,455 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,182 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,090
                                                  Wald chi2(1)    =      95.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0393

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8315822   .0851046    -9.77   0.000    -.9983842   -.6647802
       _cons |   -.522124      .1095    -4.77   0.000      -.73674    -.307508
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,090
                                                  Wald chi2(1)    =     208.07
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0790
                                                  Root MSE        =     2.4311

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9716106   .0673578   -14.42   0.000    -1.103629   -.8395918
       _cons |  -1.276588   .1447126    -8.82   0.000    -1.560219   -.9929564
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,180
                                                  Wald chi2(2)    =     617.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1200
                                                  Root MSE        =     2.2557

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9349002   .0523016   -17.88   0.000    -1.037409    -.832391
       y2000 |  -.9321239   .1050265    -8.88   0.000    -1.137972   -.7262757
       _cons |  -.4123597   .0880647    -4.68   0.000    -.5849633    -.239756
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9210
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,288,662      100.00      100.00
------------+-----------------------------------
      Total |  1,288,662      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    429,554       33.33       33.33
          3 |    859,108       66.67      100.00
------------+-----------------------------------
      Total |  1,288,662      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(429,554 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(429,554 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(429,554 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002i not found)
file /tmp/St20945.00002i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,082       20.00       20.00
       1980 |      1,082       20.00       40.00
       1990 |      1,082       20.00       60.00
       2000 |      1,082       20.00       80.00
       2007 |      1,082       20.00      100.00
------------+-----------------------------------
      Total |      5,410      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,328 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,082 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,082 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,328 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,082 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,056 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,328 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,082 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,164
        from master                     2,164  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,246  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,164       40.00       40.00
            matched (3) |      3,246       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,410      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,082          0 |     1,082 
      1980 |         0      1,082 |     1,082 
      1990 |         0      1,082 |     1,082 
      2000 |         0      1,082 |     1,082 
      2007 |     1,082          0 |     1,082 
-----------+----------------------+----------
     Total |     2,164      3,246 |     5,410 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,164 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,081
                                                  Wald chi2(1)    =      95.19
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0374

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.832825   .0853628    -9.76   0.000    -1.000133   -.6655171
       _cons |   -.520994   .1098338    -4.74   0.000    -.7362644   -.3057236
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,081
                                                  Wald chi2(1)    =     206.83
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0783
                                                  Root MSE        =     2.4293

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9718869   .0675781   -14.38   0.000    -1.104338   -.8394362
       _cons |  -1.276018   .1451851    -8.79   0.000    -1.560576   -.9914606
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,162
                                                  Wald chi2(2)    =     613.85
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1201
                                                  Root MSE        =     2.2537

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9354389   .0524655   -17.83   0.000    -1.038269   -.8326084
       y2000 |  -.9314414   .1053668    -8.84   0.000    -1.137957   -.7249262
       _cons |  -.4119832   .0883463    -4.66   0.000    -.5851388   -.2388276
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9215
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,276,752      100.00      100.00
------------+-----------------------------------
      Total |  1,276,752      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    425,584       33.33       33.33
          3 |    851,168       66.67      100.00
------------+-----------------------------------
      Total |  1,276,752      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(425,584 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(425,584 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(425,584 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002k not found)
file /tmp/St20945.00002k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,072       20.00       20.00
       1980 |      1,072       20.00       40.00
       1990 |      1,072       20.00       60.00
       2000 |      1,072       20.00       80.00
       2007 |      1,072       20.00      100.00
------------+-----------------------------------
      Total |      5,360      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,288 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,072 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,072 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,288 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,072 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,047 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,288 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,072 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,144
        from master                     2,144  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,216  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,144       40.00       40.00
            matched (3) |      3,216       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,360      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,072          0 |     1,072 
      1980 |         0      1,072 |     1,072 
      1990 |         0      1,072 |     1,072 
      2000 |         0      1,072 |     1,072 
      2007 |     1,072          0 |     1,072 
-----------+----------------------+----------
     Total |     2,144      3,216 |     5,360 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,144 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,071
                                                  Wald chi2(1)    =      94.09
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      2.037

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8332571   .0859019    -9.70   0.000    -1.001622   -.6648925
       _cons |  -.5204381   .1104655    -4.71   0.000    -.7369465   -.3039298
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,071
                                                  Wald chi2(1)    =     205.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0772
                                                  Root MSE        =     2.4281

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9732027   .0678583   -14.34   0.000    -1.106203   -.8402028
       _cons |    -1.2738   .1457878    -8.74   0.000    -1.559539   -.9880614
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,142
                                                  Wald chi2(2)    =     609.14
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1193
                                                  Root MSE        =     2.2529

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9365883   .0527189   -17.77   0.000    -1.039915   -.8332612
       y2000 |  -.9308522   .1058305    -8.80   0.000    -1.138276   -.7234283
       _cons |  -.4106625   .0887471    -4.63   0.000    -.5846037   -.2367213
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9220
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,264,842      100.00      100.00
------------+-----------------------------------
      Total |  1,264,842      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    421,614       33.33       33.33
          3 |    843,228       66.67      100.00
------------+-----------------------------------
      Total |  1,264,842      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(421,614 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(421,614 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(421,614 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002m not found)
file /tmp/St20945.00002m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,062       20.00       20.00
       1980 |      1,062       20.00       40.00
       1990 |      1,062       20.00       60.00
       2000 |      1,062       20.00       80.00
       2007 |      1,062       20.00      100.00
------------+-----------------------------------
      Total |      5,310      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,248 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,062 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,062 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,248 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,062 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,037 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,248 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,062 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,124
        from master                     2,124  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,186  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,124       40.00       40.00
            matched (3) |      3,186       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,310      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,062          0 |     1,062 
      1980 |         0      1,062 |     1,062 
      1990 |         0      1,062 |     1,062 
      2000 |         0      1,062 |     1,062 
      2007 |     1,062          0 |     1,062 
-----------+----------------------+----------
     Total |     2,124      3,186 |     5,310 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,124 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,061
                                                  Wald chi2(1)    =      95.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0245

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8365631   .0853966    -9.80   0.000    -1.003937   -.6691889
       _cons |  -.5168796    .109965    -4.70   0.000    -.7324071   -.3013521
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,061
                                                  Wald chi2(1)    =     202.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0768
                                                  Root MSE        =     2.4232

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9702713   .0681124   -14.25   0.000    -1.103769   -.8367734
       _cons |  -1.280292   .1463106    -8.75   0.000    -1.567055   -.9935284
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,122
                                                  Wald chi2(2)    =     607.95
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1205
                                                  Root MSE        =     2.2441

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9353061   .0527515   -17.73   0.000    -1.038697    -.831915
       y2000 |  -.9329811   .1059156    -8.81   0.000    -1.140572   -.7253903
       _cons |  -.4119851   .0888072    -4.64   0.000     -.586044   -.2379261
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9225
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,252,932      100.00      100.00
------------+-----------------------------------
      Total |  1,252,932      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    417,644       33.33       33.33
          3 |    835,288       66.67      100.00
------------+-----------------------------------
      Total |  1,252,932      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(417,644 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(417,644 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(417,644 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002o not found)
file /tmp/St20945.00002o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,052       20.00       20.00
       1980 |      1,052       20.00       40.00
       1990 |      1,052       20.00       60.00
       2000 |      1,052       20.00       80.00
       2007 |      1,052       20.00      100.00
------------+-----------------------------------
      Total |      5,260      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,208 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,052 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,052 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,208 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,052 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,028 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,208 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,052 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,104
        from master                     2,104  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,156  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,104       40.00       40.00
            matched (3) |      3,156       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,260      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,052          0 |     1,052 
      1980 |         0      1,052 |     1,052 
      1990 |         0      1,052 |     1,052 
      2000 |         0      1,052 |     1,052 
      2007 |     1,052          0 |     1,052 
-----------+----------------------+----------
     Total |     2,104      3,156 |     5,260 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,104 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,051
                                                  Wald chi2(1)    =      95.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0192

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8402743   .0858107    -9.79   0.000     -1.00846   -.6720885
       _cons |  -.5126715   .1104152    -4.64   0.000    -.7290813   -.2962618
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,051
                                                  Wald chi2(1)    =     205.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0838
                                                  Root MSE        =     2.4116

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9896549    .069038   -14.33   0.000    -1.124967    -.854343
       _cons |  -1.242615    .147881    -8.40   0.000    -1.532457   -.9527739
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,102
                                                  Wald chi2(2)    =     609.36
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1242
                                                  Root MSE        =     2.2369

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9502267   .0533962   -17.80   0.000    -1.054881   -.8455722
       y2000 |   -.919757   .1062812    -8.65   0.000    -1.128064   -.7114497
       _cons |  -.3958515   .0893264    -4.43   0.000    -.5709281   -.2207748
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9230
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,242,213      100.00      100.00
------------+-----------------------------------
      Total |  1,242,213      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    414,071       33.33       33.33
          3 |    828,142       66.67      100.00
------------+-----------------------------------
      Total |  1,242,213      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(414,071 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(414,071 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(414,071 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002q not found)
file /tmp/St20945.00002q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,043       20.00       20.00
       1980 |      1,043       20.00       40.00
       1990 |      1,043       20.00       60.00
       2000 |      1,043       20.00       80.00
       2007 |      1,043       20.00      100.00
------------+-----------------------------------
      Total |      5,215      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,172 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,043 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,043 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,172 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,043 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,019 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,172 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,043 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,086
        from master                     2,086  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,129  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,086       40.00       40.00
            matched (3) |      3,129       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,215      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,043          0 |     1,043 
      1980 |         0      1,043 |     1,043 
      1990 |         0      1,043 |     1,043 
      2000 |         0      1,043 |     1,043 
      2007 |     1,043          0 |     1,043 
-----------+----------------------+----------
     Total |     2,086      3,129 |     5,215 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,086 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,042
                                                  Wald chi2(1)    =      94.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0185

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8397368   .0861636    -9.75   0.000    -1.008614   -.6708592
       _cons |  -.5127328    .110875    -4.62   0.000    -.7300439   -.2954217
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,042
                                                  Wald chi2(1)    =     203.81
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0838
                                                  Root MSE        =     2.4085

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9885195   .0692418   -14.28   0.000    -1.124231   -.8528079
       _cons |  -1.244165   .1483296    -8.39   0.000    -1.534886   -.9534443
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,084
                                                  Wald chi2(2)    =     604.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1244
                                                  Root MSE        =     2.2348

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9492602   .0535768   -17.72   0.000    -1.054269   -.8442516
       y2000 |  -.9205009    .106641    -8.63   0.000    -1.129513   -.7114883
       _cons |  -.3963503   .0896347    -4.42   0.000    -.5720311   -.2206695
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9235
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,227,921      100.00      100.00
------------+-----------------------------------
      Total |  1,227,921      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    409,307       33.33       33.33
          3 |    818,614       66.67      100.00
------------+-----------------------------------
      Total |  1,227,921      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(409,307 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(409,307 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(409,307 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002s not found)
file /tmp/St20945.00002s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,031       20.00       20.00
       1980 |      1,031       20.00       40.00
       1990 |      1,031       20.00       60.00
       2000 |      1,031       20.00       80.00
       2007 |      1,031       20.00      100.00
------------+-----------------------------------
      Total |      5,155      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,124 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,031 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,031 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,124 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,031 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(1,008 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,124 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,031 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,062
        from master                     2,062  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,093  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,062       40.00       40.00
            matched (3) |      3,093       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,155      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,031          0 |     1,031 
      1980 |         0      1,031 |     1,031 
      1990 |         0      1,031 |     1,031 
      2000 |         0      1,031 |     1,031 
      2007 |     1,031          0 |     1,031 
-----------+----------------------+----------
     Total |     2,062      3,093 |     5,155 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,062 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,030
                                                  Wald chi2(1)    =      95.13
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0169

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8451642   .0866515    -9.75   0.000    -1.014998   -.6753303
       _cons |  -.5075407   .1114907    -4.55   0.000    -.7260585    -.289023
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,030
                                                  Wald chi2(1)    =     202.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0822
                                                  Root MSE        =      2.399

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9895895   .0695323   -14.23   0.000     -1.12587   -.8533086
       _cons |  -1.242011   .1488491    -8.34   0.000     -1.53375   -.9502726
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,060
                                                  Wald chi2(2)    =     600.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1233
                                                  Root MSE        =     2.2286

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.951398   .0538375   -17.67   0.000    -1.056918   -.8458784
       y2000 |  -.9180749   .1069829    -8.58   0.000    -1.127758   -.7083922
       _cons |  -.3946373   .0899758    -4.39   0.000    -.5709865    -.218288
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9240
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,216,011      100.00      100.00
------------+-----------------------------------
      Total |  1,216,011      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    405,337       33.33       33.33
          3 |    810,674       66.67      100.00
------------+-----------------------------------
      Total |  1,216,011      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(405,337 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(405,337 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(405,337 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002u not found)
file /tmp/St20945.00002u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,021       20.00       20.00
       1980 |      1,021       20.00       40.00
       1990 |      1,021       20.00       60.00
       2000 |      1,021       20.00       80.00
       2007 |      1,021       20.00      100.00
------------+-----------------------------------
      Total |      5,105      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,084 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,021 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,021 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,084 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,021 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(999 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,084 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,021 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,042
        from master                     2,042  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,063  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,042       40.00       40.00
            matched (3) |      3,063       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,105      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,021          0 |     1,021 
      1980 |         0      1,021 |     1,021 
      1990 |         0      1,021 |     1,021 
      2000 |         0      1,021 |     1,021 
      2007 |     1,021          0 |     1,021 
-----------+----------------------+----------
     Total |     2,042      3,063 |     5,105 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,042 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,020
                                                  Wald chi2(1)    =      93.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0143

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8564862    .088349    -9.69   0.000    -1.029647   -.6833253
       _cons |  -.4953395     .11312    -4.38   0.000    -.7170507   -.2736284
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,020
                                                  Wald chi2(1)    =     202.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0846
                                                  Root MSE        =     2.3911

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9815116   .0689637   -14.23   0.000    -1.116678   -.8463452
       _cons |  -1.256657   .1479982    -8.49   0.000    -1.546728    -.966586
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,040
                                                  Wald chi2(2)    =     599.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1272
                                                  Root MSE        =     2.2209

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9488128   .0537263   -17.66   0.000    -1.054114   -.8435113
       y2000 |  -.9199817   .1070759    -8.59   0.000    -1.129847   -.7101168
       _cons |  -.3972064   .0899823    -4.41   0.000    -.5735684   -.2208444
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9245
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,207,674      100.00      100.00
------------+-----------------------------------
      Total |  1,207,674      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    402,558       33.33       33.33
          3 |    805,116       66.67      100.00
------------+-----------------------------------
      Total |  1,207,674      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(402,558 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(402,558 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(402,558 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00002w not found)
file /tmp/St20945.00002w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,014       20.00       20.00
       1980 |      1,014       20.00       40.00
       1990 |      1,014       20.00       60.00
       2000 |      1,014       20.00       80.00
       2007 |      1,014       20.00      100.00
------------+-----------------------------------
      Total |      5,070      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,056 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,014 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,014 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,056 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,014 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(994 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,056 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,014 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,028
        from master                     2,028  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,042  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,028       40.00       40.00
            matched (3) |      3,042       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,070      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,014          0 |     1,014 
      1980 |         0      1,014 |     1,014 
      1990 |         0      1,014 |     1,014 
      2000 |         0      1,014 |     1,014 
      2007 |     1,014          0 |     1,014 
-----------+----------------------+----------
     Total |     2,028      3,042 |     5,070 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,028 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,013
                                                  Wald chi2(1)    =      93.59
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0136

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8574648   .0886332    -9.67   0.000    -1.031183   -.6837469
       _cons |  -.4944782   .1134453    -4.36   0.000    -.7168269   -.2721296
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,013
                                                  Wald chi2(1)    =     201.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0845
                                                  Root MSE        =       2.39

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9831918   .0692665   -14.19   0.000    -1.118952   -.8474318
       _cons |  -1.253121   .1485835    -8.43   0.000    -1.544339   -.9619027
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,026
                                                  Wald chi2(2)    =     596.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1268
                                                  Root MSE        =     2.2201

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9502808   .0539494   -17.61   0.000     -1.05602   -.8445419
       y2000 |  -.9181712   .1074282    -8.55   0.000    -1.128727   -.7076157
       _cons |  -.3958679   .0902816    -4.38   0.000    -.5728164   -.2189193
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9250
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,201,719      100.00      100.00
------------+-----------------------------------
      Total |  1,201,719      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    400,573       33.33       33.33
          3 |    801,146       66.67      100.00
------------+-----------------------------------
      Total |  1,201,719      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(400,573 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(400,573 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(400,573 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000030 not found)
file /tmp/St20945.000030 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |      1,009       20.00       20.00
       1980 |      1,009       20.00       40.00
       1990 |      1,009       20.00       60.00
       2000 |      1,009       20.00       80.00
       2007 |      1,009       20.00      100.00
------------+-----------------------------------
      Total |      5,045      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(4,036 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(1,009 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(1,009 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(4,036 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(1,009 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(989 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(4,036 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(1,009 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         2,018
        from master                     2,018  (_merge==1)
        from using                          0  (_merge==2)

    matched                             3,027  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      2,018       40.00       40.00
            matched (3) |      3,027       60.00      100.00
------------------------+-----------------------------------
                  Total |      5,045      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |     1,009          0 |     1,009 
      1980 |         0      1,009 |     1,009 
      1990 |         0      1,009 |     1,009 
      2000 |         0      1,009 |     1,009 
      2007 |     1,009          0 |     1,009 
-----------+----------------------+----------
     Total |     2,018      3,027 |     5,045 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(2,018 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,008
                                                  Wald chi2(1)    =      93.26
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     2.0101

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8565365   .0886949    -9.66   0.000    -1.030375   -.6826976
       _cons |  -.4963846   .1135296    -4.37   0.000    -.7188986   -.2738706
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,008
                                                  Wald chi2(1)    =     200.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0845
                                                  Root MSE        =     2.3899

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9833856    .069442   -14.16   0.000    -1.119489   -.8472818
       _cons |  -1.252249   .1489747    -8.41   0.000    -1.544234   -.9602639
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      2,016
                                                  Wald chi2(2)    =     593.39
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1267
                                                  Root MSE        =     2.2185

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9501812   .0540494   -17.58   0.000    -1.056116   -.8442463
       y2000 |  -.9168323   .1076256    -8.52   0.000    -1.127775   -.7058901
       _cons |  -.3968883   .0904466    -4.39   0.000    -.5741603   -.2196163
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9255
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,189,809      100.00      100.00
------------+-----------------------------------
      Total |  1,189,809      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    396,603       33.33       33.33
          3 |    793,206       66.67      100.00
------------+-----------------------------------
      Total |  1,189,809      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(396,603 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(396,603 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(396,603 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000032 not found)
file /tmp/St20945.000032 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        999       20.00       20.00
       1980 |        999       20.00       40.00
       1990 |        999       20.00       60.00
       2000 |        999       20.00       80.00
       2007 |        999       20.00      100.00
------------+-----------------------------------
      Total |      4,995      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,996 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(999 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(999 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,996 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(999 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(979 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,996 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(999 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,998
        from master                     1,998  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,997  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,998       40.00       40.00
            matched (3) |      2,997       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,995      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       999          0 |       999 
      1980 |         0        999 |       999 
      1990 |         0        999 |       999 
      2000 |         0        999 |       999 
      2007 |       999          0 |       999 
-----------+----------------------+----------
     Total |     1,998      2,997 |     4,995 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,998 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        998
                                                  Wald chi2(1)    =      90.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9934

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8384378   .0880166    -9.53   0.000    -1.010947   -.6659285
       _cons |  -.5158699   .1128891    -4.57   0.000    -.7371286   -.2946113
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        998
                                                  Wald chi2(1)    =     199.18
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0854
                                                  Root MSE        =     2.3831

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9826814    .069629   -14.11   0.000    -1.119152   -.8462109
       _cons |  -1.253079   .1493979    -8.39   0.000    -1.545894   -.9602644
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,996
                                                  Wald chi2(2)    =     589.47
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1294
                                                  Root MSE        =     2.2085

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9450158   .0540513   -17.48   0.000    -1.050954   -.8390773
       y2000 |  -.9203135   .1076604    -8.55   0.000    -1.131324    -.709303
       _cons |  -.4025231   .0905072    -4.45   0.000    -.5799139   -.2251323
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9260
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,176,708      100.00      100.00
------------+-----------------------------------
      Total |  1,176,708      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    392,236       33.33       33.33
          3 |    784,472       66.67      100.00
------------+-----------------------------------
      Total |  1,176,708      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(392,236 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(392,236 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(392,236 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000034 not found)
file /tmp/St20945.000034 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        988       20.00       20.00
       1980 |        988       20.00       40.00
       1990 |        988       20.00       60.00
       2000 |        988       20.00       80.00
       2007 |        988       20.00      100.00
------------+-----------------------------------
      Total |      4,940      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,952 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(988 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(988 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,952 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(988 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(968 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,952 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(988 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,976
        from master                     1,976  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,964  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,976       40.00       40.00
            matched (3) |      2,964       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,940      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       988          0 |       988 
      1980 |         0        988 |       988 
      1990 |         0        988 |       988 
      2000 |         0        988 |       988 
      2007 |       988          0 |       988 
-----------+----------------------+----------
     Total |     1,976      2,964 |     4,940 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,976 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        987
                                                  Wald chi2(1)    =      90.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9935

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8417443   .0885444    -9.51   0.000    -1.015288   -.6682004
       _cons |  -.5120746   .1135425    -4.51   0.000    -.7346137   -.2895354
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        987
                                                  Wald chi2(1)    =     198.00
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0850
                                                  Root MSE        =     2.3787

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9833221   .0698816   -14.07   0.000    -1.120288   -.8463567
       _cons |  -1.251854   .1499548    -8.35   0.000     -1.54576   -.9579474
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,974
                                                  Wald chi2(2)    =     585.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1295
                                                  Root MSE        =     2.2059

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9463651   .0542889   -17.43   0.000    -1.052769   -.8399607
       y2000 |  -.9194822   .1081387    -8.50   0.000     -1.13143   -.7075342
       _cons |  -.4008234   .0908994    -4.41   0.000     -.578983   -.2226639
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9265
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,167,180      100.00      100.00
------------+-----------------------------------
      Total |  1,167,180      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    389,060       33.33       33.33
          3 |    778,120       66.67      100.00
------------+-----------------------------------
      Total |  1,167,180      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(389,060 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(389,060 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(389,060 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000036 not found)
file /tmp/St20945.000036 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        980       20.00       20.00
       1980 |        980       20.00       40.00
       1990 |        980       20.00       60.00
       2000 |        980       20.00       80.00
       2007 |        980       20.00      100.00
------------+-----------------------------------
      Total |      4,900      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,920 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(980 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(980 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,920 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(980 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(962 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,920 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(980 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,960
        from master                     1,960  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,940  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,960       40.00       40.00
            matched (3) |      2,940       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,900      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       980          0 |       980 
      1980 |         0        980 |       980 
      1990 |         0        980 |       980 
      2000 |         0        980 |       980 
      2007 |       980          0 |       980 
-----------+----------------------+----------
     Total |     1,960      2,940 |     4,900 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,960 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        979
                                                  Wald chi2(1)    =      89.79
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9916

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8416976   .0888259    -9.48   0.000    -1.015793   -.6676021
       _cons |  -.5126009   .1139054    -4.50   0.000    -.7358513   -.2893505
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        979
                                                  Wald chi2(1)    =     196.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0851
                                                  Root MSE        =     2.3776

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9836195   .0701604   -14.02   0.000    -1.121131   -.8461076
       _cons |  -1.251515   .1505436    -8.31   0.000    -1.546575    -.956455
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,958
                                                  Wald chi2(2)    =     581.26
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1297
                                                  Root MSE        =     2.2044

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9465619   .0544905   -17.37   0.000    -1.053361   -.8397624
       y2000 |  -.9190714   .1085143    -8.47   0.000    -1.131756   -.7063873
       _cons |   -.401085   .0912231    -4.40   0.000    -.5798789   -.2222911
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9270
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,163,607      100.00      100.00
------------+-----------------------------------
      Total |  1,163,607      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    387,869       33.33       33.33
          3 |    775,738       66.67      100.00
------------+-----------------------------------
      Total |  1,163,607      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(387,869 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(387,869 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(387,869 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000038 not found)
file /tmp/St20945.000038 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        977       20.00       20.00
       1980 |        977       20.00       40.00
       1990 |        977       20.00       60.00
       2000 |        977       20.00       80.00
       2007 |        977       20.00      100.00
------------+-----------------------------------
      Total |      4,885      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,908 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(977 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(977 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,908 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(977 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(959 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,908 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(977 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,954
        from master                     1,954  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,931  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,954       40.00       40.00
            matched (3) |      2,931       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,885      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       977          0 |       977 
      1980 |         0        977 |       977 
      1990 |         0        977 |       977 
      2000 |         0        977 |       977 
      2007 |       977          0 |       977 
-----------+----------------------+----------
     Total |     1,954      2,931 |     4,885 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,954 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        976
                                                  Wald chi2(1)    =      89.72
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9914

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8425998   .0889546    -9.47   0.000    -1.016948    -.668252
       _cons |  -.5119407   .1140648    -4.49   0.000    -.7355036   -.2883778
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        976
                                                  Wald chi2(1)    =     196.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0851
                                                  Root MSE        =     2.3767

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.983782   .0702423   -14.01   0.000    -1.121454   -.8461095
       _cons |  -1.251451   .1507118    -8.30   0.000     -1.54684    -.956061
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,952
                                                  Wald chi2(2)    =     579.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1297
                                                  Root MSE        =     2.2038

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.946925     .05456   -17.36   0.000    -1.053861   -.8399894
       y2000 |  -.9187113   .1086489    -8.46   0.000    -1.131659   -.7057633
       _cons |  -.4010051   .0913355    -4.39   0.000    -.5800193   -.2219908
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9275
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,154,079      100.00      100.00
------------+-----------------------------------
      Total |  1,154,079      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    384,693       33.33       33.33
          3 |    769,386       66.67      100.00
------------+-----------------------------------
      Total |  1,154,079      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(384,693 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(384,693 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(384,693 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003a not found)
file /tmp/St20945.00003a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        969       20.00       20.00
       1980 |        969       20.00       40.00
       1990 |        969       20.00       60.00
       2000 |        969       20.00       80.00
       2007 |        969       20.00      100.00
------------+-----------------------------------
      Total |      4,845      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,876 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(969 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(969 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,876 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(969 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(953 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,876 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(969 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,938
        from master                     1,938  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,907  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,938       40.00       40.00
            matched (3) |      2,907       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,845      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       969          0 |       969 
      1980 |         0        969 |       969 
      1990 |         0        969 |       969 
      2000 |         0        969 |       969 
      2007 |       969          0 |       969 
-----------+----------------------+----------
     Total |     1,938      2,907 |     4,845 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,938 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        968
                                                  Wald chi2(1)    =      89.25
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9901

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8433029   .0892644    -9.45   0.000    -1.018258   -.6683479
       _cons |  -.5111214   .1144628    -4.47   0.000    -.7354642   -.2867785
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        968
                                                  Wald chi2(1)    =     194.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0850
                                                  Root MSE        =     2.3768

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9841056   .0705542   -13.95   0.000    -1.122389   -.8458219
       _cons |  -1.250907   .1513773    -8.26   0.000    -1.547601   -.9542134
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,936
                                                  Wald chi2(2)    =     575.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1296
                                                  Root MSE        =     2.2032

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9473309   .0547817   -17.29   0.000    -1.054701   -.8399607
       y2000 |  -.9185251   .1090745    -8.42   0.000    -1.132307   -.7047429
       _cons |  -.4004999   .0916965    -4.37   0.000    -.5802218   -.2207781
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9280
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,143,360      100.00      100.00
------------+-----------------------------------
      Total |  1,143,360      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    381,120       33.33       33.33
          3 |    762,240       66.67      100.00
------------+-----------------------------------
      Total |  1,143,360      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(381,120 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(381,120 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(381,120 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003c not found)
file /tmp/St20945.00003c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        960       20.00       20.00
       1980 |        960       20.00       40.00
       1990 |        960       20.00       60.00
       2000 |        960       20.00       80.00
       2007 |        960       20.00      100.00
------------+-----------------------------------
      Total |      4,800      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,840 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(960 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(960 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,840 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(960 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(945 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,840 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(960 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,920
        from master                     1,920  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,880  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,920       40.00       40.00
            matched (3) |      2,880       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,800      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       960          0 |       960 
      1980 |         0        960 |       960 
      1990 |         0        960 |       960 
      2000 |         0        960 |       960 
      2007 |       960          0 |       960 
-----------+----------------------+----------
     Total |     1,920      2,880 |     4,800 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,920 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        959
                                                  Wald chi2(1)    =      88.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.989

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.843603    .089677    -9.41   0.000    -1.019367   -.6678392
       _cons |  -.5109102   .1149782    -4.44   0.000    -.7362633    -.285557
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        959
                                                  Wald chi2(1)    =     192.73
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0853
                                                  Root MSE        =     2.3746

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9828243   .0707947   -13.88   0.000    -1.121579   -.8440692
       _cons |  -1.253507   .1519011    -8.25   0.000    -1.551228   -.9557863
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,918
                                                  Wald chi2(2)    =     570.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1299
                                                  Root MSE        =     2.2015

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9464815    .054986   -17.21   0.000    -1.054252   -.8387109
       y2000 |  -.9193155   .1094908    -8.40   0.000    -1.133913   -.7047175
       _cons |  -.4015055    .092048    -4.36   0.000    -.5819162   -.2210948
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9285
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,133,832      100.00      100.00
------------+-----------------------------------
      Total |  1,133,832      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    377,944       33.33       33.33
          3 |    755,888       66.67      100.00
------------+-----------------------------------
      Total |  1,133,832      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(377,944 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(377,944 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(377,944 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003e not found)
file /tmp/St20945.00003e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        952       20.00       20.00
       1980 |        952       20.00       40.00
       1990 |        952       20.00       60.00
       2000 |        952       20.00       80.00
       2007 |        952       20.00      100.00
------------+-----------------------------------
      Total |      4,760      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,808 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(952 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(952 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,808 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(952 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(937 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,808 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(952 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,904
        from master                     1,904  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,856  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,904       40.00       40.00
            matched (3) |      2,856       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,760      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       952          0 |       952 
      1980 |         0        952 |       952 
      1990 |         0        952 |       952 
      2000 |         0        952 |       952 
      2007 |       952          0 |       952 
-----------+----------------------+----------
     Total |     1,904      2,856 |     4,760 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,904 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        951
                                                  Wald chi2(1)    =      88.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9872

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8437614   .0896945    -9.41   0.000    -1.019559   -.6679634
       _cons |  -.5109652   .1150982    -4.44   0.000    -.7365536   -.2853768
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        951
                                                  Wald chi2(1)    =     191.07
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0858
                                                  Root MSE        =     2.3721

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9815139   .0710064   -13.82   0.000    -1.120684   -.8423439
       _cons |  -1.255995   .1523486    -8.24   0.000    -1.554593   -.9573978
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,902
                                                  Wald chi2(2)    =     567.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1306
                                                  Root MSE        =     2.1991

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9455026   .0551098   -17.16   0.000    -1.053516   -.8374894
       y2000 |  -.9199017   .1098156    -8.38   0.000    -1.135136   -.7046671
       _cons |  -.4027871   .0922961    -4.36   0.000    -.5836841     -.22189
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9290
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,120,731      100.00      100.00
------------+-----------------------------------
      Total |  1,120,731      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    373,577       33.33       33.33
          3 |    747,154       66.67      100.00
------------+-----------------------------------
      Total |  1,120,731      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(373,577 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(373,577 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(373,577 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003g not found)
file /tmp/St20945.00003g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        941       20.00       20.00
       1980 |        941       20.00       40.00
       1990 |        941       20.00       60.00
       2000 |        941       20.00       80.00
       2007 |        941       20.00      100.00
------------+-----------------------------------
      Total |      4,705      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,764 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(941 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(941 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,764 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(941 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(928 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,764 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(941 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,882
        from master                     1,882  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,823  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,882       40.00       40.00
            matched (3) |      2,823       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,705      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       941          0 |       941 
      1980 |         0        941 |       941 
      1990 |         0        941 |       941 
      2000 |         0        941 |       941 
      2007 |       941          0 |       941 
-----------+----------------------+----------
     Total |     1,882      2,823 |     4,705 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,882 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        940
                                                  Wald chi2(1)    =      88.14
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9839

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8453701   .0900459    -9.39   0.000    -1.021857   -.6688834
       _cons |  -.5083104   .1155759    -4.40   0.000    -.7348351   -.2817857
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        940
                                                  Wald chi2(1)    =     193.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0887
                                                  Root MSE        =     2.3462

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9839651   .0706497   -13.93   0.000    -1.122436   -.8454943
       _cons |  -1.251873    .151576    -8.26   0.000    -1.548956   -.9547891
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,880
                                                  Wald chi2(2)    =     570.21
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1326
                                                  Root MSE        =     2.1838

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9477241   .0550476   -17.22   0.000    -1.055615   -.8398327
       y2000 |  -.9195325    .109684    -8.38   0.000    -1.134509   -.7045558
       _cons |  -.3994573   .0921989    -4.33   0.000    -.5801638   -.2187507
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9295
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,111,203      100.00      100.00
------------+-----------------------------------
      Total |  1,111,203      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    370,401       33.33       33.33
          3 |    740,802       66.67      100.00
------------+-----------------------------------
      Total |  1,111,203      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(370,401 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(370,401 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(370,401 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003i not found)
file /tmp/St20945.00003i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        933       20.00       20.00
       1980 |        933       20.00       40.00
       1990 |        933       20.00       60.00
       2000 |        933       20.00       80.00
       2007 |        933       20.00      100.00
------------+-----------------------------------
      Total |      4,665      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,732 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(933 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(933 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,732 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(933 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(920 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,732 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(933 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,866
        from master                     1,866  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,799  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,866       40.00       40.00
            matched (3) |      2,799       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,665      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       933          0 |       933 
      1980 |         0        933 |       933 
      1990 |         0        933 |       933 
      2000 |         0        933 |       933 
      2007 |       933          0 |       933 
-----------+----------------------+----------
     Total |     1,866      2,799 |     4,665 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,866 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        932
                                                  Wald chi2(1)    =      87.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9831

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.84505   .0902595    -9.36   0.000    -1.021955   -.6681446
       _cons |  -.5089454   .1158918    -4.39   0.000    -.7360892   -.2818016
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        932
                                                  Wald chi2(1)    =     192.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0869
                                                  Root MSE        =     2.3458

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9850161   .0709426   -13.88   0.000    -1.124061   -.8459711
       _cons |  -1.249672   .1522018    -8.21   0.000    -1.547982   -.9513616
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,864
                                                  Wald chi2(2)    =     566.17
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1318
                                                  Root MSE        =     2.1831

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9483655   .0552464   -17.17   0.000    -1.056646   -.8400846
       y2000 |  -.9184607   .1101171    -8.34   0.000    -1.134286   -.7026351
       _cons |  -.3990862   .0925464    -4.31   0.000    -.5804738   -.2176985
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9300
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,100,484      100.00      100.00
------------+-----------------------------------
      Total |  1,100,484      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    366,828       33.33       33.33
          3 |    733,656       66.67      100.00
------------+-----------------------------------
      Total |  1,100,484      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(366,828 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(366,828 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(366,828 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003k not found)
file /tmp/St20945.00003k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        924       20.00       20.00
       1980 |        924       20.00       40.00
       1990 |        924       20.00       60.00
       2000 |        924       20.00       80.00
       2007 |        924       20.00      100.00
------------+-----------------------------------
      Total |      4,620      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,696 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(924 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(924 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,696 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(924 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(911 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,696 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(924 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,848
        from master                     1,848  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,772  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,848       40.00       40.00
            matched (3) |      2,772       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,620      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       924          0 |       924 
      1980 |         0        924 |       924 
      1990 |         0        924 |       924 
      2000 |         0        924 |       924 
      2007 |       924          0 |       924 
-----------+----------------------+----------
     Total |     1,848      2,772 |     4,620 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,848 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        923
                                                  Wald chi2(1)    =      86.33
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9804

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8451181   .0909585    -9.29   0.000    -1.023393   -.6668427
       _cons |  -.5087975   .1166349    -4.36   0.000    -.7373977   -.2801973
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        923
                                                  Wald chi2(1)    =     192.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0861
                                                  Root MSE        =     2.3453

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9895579   .0713472   -13.87   0.000    -1.129396   -.8497199
       _cons |  -1.241686   .1530051    -8.12   0.000    -1.541571   -.9418019
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,846
                                                  Wald chi2(2)    =     562.46
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1315
                                                  Root MSE        =     2.1819

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.95167    .055575   -17.12   0.000    -1.060595   -.8427451
       y2000 |   -.916341   .1106089    -8.28   0.000     -1.13313   -.6995516
       _cons |  -.3954972   .0930046    -4.25   0.000     -.577783   -.2132115
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9305
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,088,574      100.00      100.00
------------+-----------------------------------
      Total |  1,088,574      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    362,858       33.33       33.33
          3 |    725,716       66.67      100.00
------------+-----------------------------------
      Total |  1,088,574      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(362,858 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(362,858 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(362,858 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003m not found)
file /tmp/St20945.00003m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        914       20.00       20.00
       1980 |        914       20.00       40.00
       1990 |        914       20.00       60.00
       2000 |        914       20.00       80.00
       2007 |        914       20.00      100.00
------------+-----------------------------------
      Total |      4,570      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,656 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(914 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(914 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,656 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(914 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(901 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,656 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(914 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,828
        from master                     1,828  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,742  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,828       40.00       40.00
            matched (3) |      2,742       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,570      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       914          0 |       914 
      1980 |         0        914 |       914 
      1990 |         0        914 |       914 
      2000 |         0        914 |       914 
      2007 |       914          0 |       914 
-----------+----------------------+----------
     Total |     1,828      2,742 |     4,570 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,828 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        913
                                                  Wald chi2(1)    =      86.14
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.978

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8506058   .0916495    -9.28   0.000    -1.030236   -.6709761
       _cons |  -.5035278    .117364    -4.29   0.000    -.7335569   -.2734986
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        913
                                                  Wald chi2(1)    =     190.70
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0872
                                                  Root MSE        =     2.3342

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9860396   .0714039   -13.81   0.000    -1.125989   -.8460905
       _cons |  -1.247662   .1531248    -8.15   0.000    -1.547781   -.9475426
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,826
                                                  Wald chi2(2)    =     558.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1329
                                                  Root MSE        =     2.1741

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9506151    .055733   -17.06   0.000     -1.05985   -.8413804
       y2000 |   -.916021   .1108453    -8.26   0.000    -1.133274   -.6987682
       _cons |  -.3972322   .0931993    -4.26   0.000    -.5798994    -.214565
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9310
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,079,046      100.00      100.00
------------+-----------------------------------
      Total |  1,079,046      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    359,682       33.33       33.33
          3 |    719,364       66.67      100.00
------------+-----------------------------------
      Total |  1,079,046      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(359,682 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(359,682 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(359,682 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003o not found)
file /tmp/St20945.00003o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        906       20.00       20.00
       1980 |        906       20.00       40.00
       1990 |        906       20.00       60.00
       2000 |        906       20.00       80.00
       2007 |        906       20.00      100.00
------------+-----------------------------------
      Total |      4,530      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,624 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(906 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(906 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,624 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(906 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(893 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,624 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(906 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,812
        from master                     1,812  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,718  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,812       40.00       40.00
            matched (3) |      2,718       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,530      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       906          0 |       906 
      1980 |         0        906 |       906 
      1990 |         0        906 |       906 
      2000 |         0        906 |       906 
      2007 |       906          0 |       906 
-----------+----------------------+----------
     Total |     1,812      2,718 |     4,530 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,812 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        905
                                                  Wald chi2(1)    =      85.65
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.974

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8502806   .0918766    -9.25   0.000    -1.030356   -.6702058
       _cons |  -.5037772   .1176469    -4.28   0.000    -.7343609   -.2731934
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        905
                                                  Wald chi2(1)    =     189.30
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0863
                                                  Root MSE        =     2.3327

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9863946    .071692   -13.76   0.000    -1.126908    -.845881
       _cons |   -1.24667   .1537326    -8.11   0.000     -1.54798   -.9453595
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,810
                                                  Wald chi2(2)    =     555.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1331
                                                  Root MSE        =     2.1714

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9507769   .0559217   -17.00   0.000    -1.060381   -.8411723
       y2000 |  -.9156507   .1112018    -8.23   0.000    -1.133602   -.6976991
       _cons |  -.3969691   .0935011    -4.25   0.000    -.5802278   -.2137103
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9315
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,071,900      100.00      100.00
------------+-----------------------------------
      Total |  1,071,900      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    357,300       33.33       33.33
          3 |    714,600       66.67      100.00
------------+-----------------------------------
      Total |  1,071,900      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(357,300 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(357,300 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(357,300 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003q not found)
file /tmp/St20945.00003q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        900       20.00       20.00
       1980 |        900       20.00       40.00
       1990 |        900       20.00       60.00
       2000 |        900       20.00       80.00
       2007 |        900       20.00      100.00
------------+-----------------------------------
      Total |      4,500      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,600 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(900 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(900 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,600 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(900 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(888 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,600 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(900 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,800
        from master                     1,800  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,700  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,800       40.00       40.00
            matched (3) |      2,700       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,500      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       900          0 |       900 
      1980 |         0        900 |       900 
      1990 |         0        900 |       900 
      2000 |         0        900 |       900 
      2007 |       900          0 |       900 
-----------+----------------------+----------
     Total |     1,800      2,700 |     4,500 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,800 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        899
                                                  Wald chi2(1)    =      85.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9757

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8530791   .0922408    -9.25   0.000    -1.033868   -.6722905
       _cons |  -.5036572   .1181354    -4.26   0.000    -.7351983    -.272116
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        899
                                                  Wald chi2(1)    =     188.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0867
                                                  Root MSE        =     2.3287

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.986143   .0718119   -13.73   0.000    -1.126892   -.8453943
       _cons |  -1.247248    .153999    -8.10   0.000     -1.54908   -.9454153
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,798
                                                  Wald chi2(2)    =     551.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1328
                                                  Root MSE        =     2.1698

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9513171   .0560663   -16.97   0.000    -1.061205   -.8414292
       y2000 |  -.9125059    .111491    -8.18   0.000    -1.131024   -.6939876
       _cons |  -.3992321   .0937497    -4.26   0.000    -.5829782   -.2154859
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9320
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,062,372      100.00      100.00
------------+-----------------------------------
      Total |  1,062,372      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    354,124       33.33       33.33
          3 |    708,248       66.67      100.00
------------+-----------------------------------
      Total |  1,062,372      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(354,124 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(354,124 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(354,124 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003s not found)
file /tmp/St20945.00003s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        892       20.00       20.00
       1980 |        892       20.00       40.00
       1990 |        892       20.00       60.00
       2000 |        892       20.00       80.00
       2007 |        892       20.00      100.00
------------+-----------------------------------
      Total |      4,460      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,568 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(892 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(892 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,568 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(892 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(880 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,568 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(892 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,784
        from master                     1,784  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,676  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,784       40.00       40.00
            matched (3) |      2,676       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,460      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       892          0 |       892 
      1980 |         0        892 |       892 
      1990 |         0        892 |       892 
      2000 |         0        892 |       892 
      2007 |       892          0 |       892 
-----------+----------------------+----------
     Total |     1,784      2,676 |     4,460 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,784 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        891
                                                  Wald chi2(1)    =      85.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9739

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8519668   .0924004    -9.22   0.000    -1.033068   -.6708654
       _cons |  -.5049044    .118406    -4.26   0.000     -.736976   -.2728329
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        891
                                                  Wald chi2(1)    =     187.79
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0860
                                                  Root MSE        =     2.3278

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9902277     .07226   -13.70   0.000    -1.131855   -.8486007
       _cons |  -1.239352   .1548786    -8.00   0.000    -1.542908   -.9357953
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,782
                                                  Wald chi2(2)    =     548.34
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1325
                                                  Root MSE        =     2.1688

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9538971     .05635   -16.93   0.000    -1.064341    -.843453
       y2000 |  -.9100759   .1119574    -8.13   0.000    -1.129508   -.6906435
       _cons |  -.3965537    .094166    -4.21   0.000    -.5811156   -.2119918
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9325
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,044,507      100.00      100.00
------------+-----------------------------------
      Total |  1,044,507      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    348,169       33.33       33.33
          3 |    696,338       66.67      100.00
------------+-----------------------------------
      Total |  1,044,507      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(348,169 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(348,169 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(348,169 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003u not found)
file /tmp/St20945.00003u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        877       20.00       20.00
       1980 |        877       20.00       40.00
       1990 |        877       20.00       60.00
       2000 |        877       20.00       80.00
       2007 |        877       20.00      100.00
------------+-----------------------------------
      Total |      4,385      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,508 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(877 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(877 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,508 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(877 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(866 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,508 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(877 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,754
        from master                     1,754  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,631  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,754       40.00       40.00
            matched (3) |      2,631       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,385      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       877          0 |       877 
      1980 |         0        877 |       877 
      1990 |         0        877 |       877 
      2000 |         0        877 |       877 
      2007 |       877          0 |       877 
-----------+----------------------+----------
     Total |     1,754      2,631 |     4,385 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,754 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        876
                                                  Wald chi2(1)    =      83.79
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9701

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8516223   .0930355    -9.15   0.000    -1.033969    -.669276
       _cons |  -.5052986   .1192326    -4.24   0.000    -.7389903   -.2716069
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        876
                                                  Wald chi2(1)    =     186.34
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0874
                                                  Root MSE        =     2.3156

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9892907   .0724718   -13.65   0.000    -1.131333   -.8472486
       _cons |  -1.241131   .1553539    -7.99   0.000     -1.54562   -.9366434
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,752
                                                  Wald chi2(2)    =     542.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1334
                                                  Root MSE        =     2.1606

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9531049   .0566032   -16.84   0.000    -1.064045   -.8421646
       y2000 |   -.910753   .1124746    -8.10   0.000    -1.131199   -.6903069
       _cons |  -.3973939   .0946099    -4.20   0.000    -.5828259    -.211962
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9330
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,037,361      100.00      100.00
------------+-----------------------------------
      Total |  1,037,361      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    345,787       33.33       33.33
          3 |    691,574       66.67      100.00
------------+-----------------------------------
      Total |  1,037,361      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(345,787 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(345,787 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(345,787 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00003w not found)
file /tmp/St20945.00003w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        871       20.00       20.00
       1980 |        871       20.00       40.00
       1990 |        871       20.00       60.00
       2000 |        871       20.00       80.00
       2007 |        871       20.00      100.00
------------+-----------------------------------
      Total |      4,355      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,484 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(871 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(871 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,484 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(871 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(861 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,484 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(871 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,742
        from master                     1,742  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,613  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,742       40.00       40.00
            matched (3) |      2,613       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,355      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       871          0 |       871 
      1980 |         0        871 |       871 
      1990 |         0        871 |       871 
      2000 |         0        871 |       871 
      2007 |       871          0 |       871 
-----------+----------------------+----------
     Total |     1,742      2,613 |     4,355 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,742 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        870
                                                  Wald chi2(1)    =      83.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9689

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8506682   .0933193    -9.12   0.000    -1.033571   -.6677657
       _cons |  -.5064566   .1196225    -4.23   0.000    -.7409124   -.2720008
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        870
                                                  Wald chi2(1)    =     185.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0868
                                                  Root MSE        =     2.3145

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.988936   .0726884   -13.61   0.000    -1.131403   -.8464693
       _cons |  -1.241888   .1557969    -7.97   0.000    -1.547244   -.9365317
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,740
                                                  Wald chi2(2)    =     539.09
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1330
                                                  Root MSE        =     2.1595

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9525964   .0567737   -16.78   0.000    -1.063871   -.8413221
       y2000 |  -.9111428   .1127907    -8.08   0.000    -1.132208   -.6900771
       _cons |   -.398033   .0949078    -4.19   0.000    -.5840489   -.2120172
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9335
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,026,642      100.00      100.00
------------+-----------------------------------
      Total |  1,026,642      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    342,214       33.33       33.33
          3 |    684,428       66.67      100.00
------------+-----------------------------------
      Total |  1,026,642      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(342,214 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(342,214 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(342,214 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000040 not found)
file /tmp/St20945.000040 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        862       20.00       20.00
       1980 |        862       20.00       40.00
       1990 |        862       20.00       60.00
       2000 |        862       20.00       80.00
       2007 |        862       20.00      100.00
------------+-----------------------------------
      Total |      4,310      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,448 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(862 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(862 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,448 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(862 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(853 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,448 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(862 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,724
        from master                     1,724  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,586  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,724       40.00       40.00
            matched (3) |      2,586       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,310      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       862          0 |       862 
      1980 |         0        862 |       862 
      1990 |         0        862 |       862 
      2000 |         0        862 |       862 
      2007 |       862          0 |       862 
-----------+----------------------+----------
     Total |     1,724      2,586 |     4,310 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,724 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        861
                                                  Wald chi2(1)    =      82.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9665

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8560651   .0940129    -9.11   0.000    -1.040327   -.6718031
       _cons |  -.5031158   .1203584    -4.18   0.000    -.7390139   -.2672178
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        861
                                                  Wald chi2(1)    =     185.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0862
                                                  Root MSE        =      2.302

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9911109   .0728072   -13.61   0.000     -1.13381   -.8484115
       _cons |  -1.239085   .1559448    -7.95   0.000    -1.544731   -.9334384
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,722
                                                  Wald chi2(2)    =     537.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1333
                                                  Root MSE        =     2.1513

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9557106   .0569854   -16.77   0.000      -1.0674   -.8440212
       y2000 |  -.9074613   .1129846    -8.03   0.000    -1.128907   -.6860155
       _cons |  -.3971528   .0951182    -4.18   0.000    -.5835811   -.2107246
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9340
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,018,305      100.00      100.00
------------+-----------------------------------
      Total |  1,018,305      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    339,435       33.33       33.33
          3 |    678,870       66.67      100.00
------------+-----------------------------------
      Total |  1,018,305      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(339,435 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(339,435 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(339,435 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000042 not found)
file /tmp/St20945.000042 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        855       20.00       20.00
       1980 |        855       20.00       40.00
       1990 |        855       20.00       60.00
       2000 |        855       20.00       80.00
       2007 |        855       20.00      100.00
------------+-----------------------------------
      Total |      4,275      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,420 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(855 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(855 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,420 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(855 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(848 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,420 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(855 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,710
        from master                     1,710  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,565  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,710       40.00       40.00
            matched (3) |      2,565       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,275      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       855          0 |       855 
      1980 |         0        855 |       855 
      1990 |         0        855 |       855 
      2000 |         0        855 |       855 
      2007 |       855          0 |       855 
-----------+----------------------+----------
     Total |     1,710      2,565 |     4,275 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,710 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        854
                                                  Wald chi2(1)    =      82.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9659

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.856179   .0943734    -9.07   0.000    -1.041147   -.6712106
       _cons |  -.5033492   .1208168    -4.17   0.000    -.7401458   -.2665526
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        854
                                                  Wald chi2(1)    =     185.00
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0860
                                                  Root MSE        =     2.3008

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9935729    .073048   -13.60   0.000    -1.136744   -.8504014
       _cons |  -1.234881   .1564649    -7.89   0.000    -1.541547   -.9282156
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,708
                                                  Wald chi2(2)    =     534.83
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1332
                                                  Root MSE        =     2.1506

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9575461   .0571877   -16.74   0.000    -1.069632   -.8454602
       y2000 |  -.9060099   .1134028    -7.99   0.000    -1.128275   -.6837445
       _cons |  -.3955575   .0954661    -4.14   0.000    -.5826677   -.2084473
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9345
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |  1,007,586      100.00      100.00
------------+-----------------------------------
      Total |  1,007,586      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    335,862       33.33       33.33
          3 |    671,724       66.67      100.00
------------+-----------------------------------
      Total |  1,007,586      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(335,862 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(335,862 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(335,862 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000044 not found)
file /tmp/St20945.000044 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        846       20.00       20.00
       1980 |        846       20.00       40.00
       1990 |        846       20.00       60.00
       2000 |        846       20.00       80.00
       2007 |        846       20.00      100.00
------------+-----------------------------------
      Total |      4,230      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,384 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(846 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(846 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,384 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(846 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(841 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,384 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(846 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,692
        from master                     1,692  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,538  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,692       40.00       40.00
            matched (3) |      2,538       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,230      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       846          0 |       846 
      1980 |         0        846 |       846 
      1990 |         0        846 |       846 
      2000 |         0        846 |       846 
      2007 |       846          0 |       846 
-----------+----------------------+----------
     Total |     1,692      2,538 |     4,230 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,692 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        845
                                                  Wald chi2(1)    =      84.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9526

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8760164   .0955167    -9.17   0.000    -1.063226   -.6888071
       _cons |  -.4820568   .1217721    -3.96   0.000    -.7207256   -.2433879
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        845
                                                  Wald chi2(1)    =     188.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0893
                                                  Root MSE        =     2.2942

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.029427   .0749317   -13.74   0.000    -1.176291    -.882564
       _cons |  -1.168041   .1596412    -7.32   0.000    -1.480932     -.85515
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,690
                                                  Wald chi2(2)    =     540.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1388
                                                  Root MSE        =     2.1411

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9887075   .0584081   -16.93   0.000    -1.103185   -.8742297
       y2000 |  -.8812271   .1138916    -7.74   0.000    -1.104451   -.6580037
       _cons |  -.3622239   .0963464    -3.76   0.000    -.5510594   -.1733885
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9350
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    996,867      100.00      100.00
------------+-----------------------------------
      Total |    996,867      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    332,289       33.33       33.33
          3 |    664,578       66.67      100.00
------------+-----------------------------------
      Total |    996,867      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(332,289 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(332,289 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(332,289 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000046 not found)
file /tmp/St20945.000046 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        837       20.00       20.00
       1980 |        837       20.00       40.00
       1990 |        837       20.00       60.00
       2000 |        837       20.00       80.00
       2007 |        837       20.00      100.00
------------+-----------------------------------
      Total |      4,185      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,348 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(837 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(837 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,348 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(837 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(833 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,348 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(837 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,674
        from master                     1,674  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,511  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,674       40.00       40.00
            matched (3) |      2,511       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,185      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       837          0 |       837 
      1980 |         0        837 |       837 
      1990 |         0        837 |       837 
      2000 |         0        837 |       837 
      2007 |       837          0 |       837 
-----------+----------------------+----------
     Total |     1,674      2,511 |     4,185 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,674 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        836
                                                  Wald chi2(1)    =      83.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9528

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8781965   .0960491    -9.14   0.000    -1.066449   -.6899437
       _cons |  -.4798005   .1224685    -3.92   0.000    -.7198344   -.2397667
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        836
                                                  Wald chi2(1)    =     186.82
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0886
                                                  Root MSE        =     2.2919

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.029256   .0753025   -13.67   0.000    -1.176846    -.881666
       _cons |  -1.169013   .1604005    -7.29   0.000    -1.483392   -.8546337
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,672
                                                  Wald chi2(2)    =     535.73
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1384
                                                  Root MSE        =     2.1398

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9891628   .0587152   -16.85   0.000    -1.104242    -.874083
       y2000 |  -.8814849   .1144347    -7.70   0.000    -1.105773   -.6571971
       _cons |  -.3617734   .0968347    -3.74   0.000     -.551566   -.1719809
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9355
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    987,339      100.00      100.00
------------+-----------------------------------
      Total |    987,339      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    329,113       33.33       33.33
          3 |    658,226       66.67      100.00
------------+-----------------------------------
      Total |    987,339      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(329,113 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(329,113 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(329,113 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000048 not found)
file /tmp/St20945.000048 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        829       20.00       20.00
       1980 |        829       20.00       40.00
       1990 |        829       20.00       60.00
       2000 |        829       20.00       80.00
       2007 |        829       20.00      100.00
------------+-----------------------------------
      Total |      4,145      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,316 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(829 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(829 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,316 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(829 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(825 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,316 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(829 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,658
        from master                     1,658  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,487  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,658       40.00       40.00
            matched (3) |      2,487       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,145      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       829          0 |       829 
      1980 |         0        829 |       829 
      1990 |         0        829 |       829 
      2000 |         0        829 |       829 
      2007 |       829          0 |       829 
-----------+----------------------+----------
     Total |     1,658      2,487 |     4,145 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,658 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        828
                                                  Wald chi2(1)    =      82.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.946

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8743029   .0961971    -9.09   0.000    -1.062846     -.68576
       _cons |  -.4824553   .1226562    -3.93   0.000     -.722857   -.2420537
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        828
                                                  Wald chi2(1)    =     184.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0908
                                                  Root MSE        =     2.2818

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.024099    .075309   -13.60   0.000    -1.171702   -.8764963
       _cons |  -1.176859    .160431    -7.34   0.000    -1.491298   -.8624201
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,656
                                                  Wald chi2(2)    =     532.15
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1402
                                                  Root MSE        =     2.1312

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9843422   .0587507   -16.75   0.000    -1.099491    -.869193
       y2000 |  -.8850821   .1145208    -7.73   0.000    -1.109539   -.6606255
       _cons |  -.3654021   .0969081    -3.77   0.000    -.5553385   -.1754656
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9360
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    967,092      100.00      100.00
------------+-----------------------------------
      Total |    967,092      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    322,364       33.33       33.33
          3 |    644,728       66.67      100.00
------------+-----------------------------------
      Total |    967,092      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(322,364 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(322,364 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(322,364 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004a not found)
file /tmp/St20945.00004a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        812       20.00       20.00
       1980 |        812       20.00       40.00
       1990 |        812       20.00       60.00
       2000 |        812       20.00       80.00
       2007 |        812       20.00      100.00
------------+-----------------------------------
      Total |      4,060      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,248 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(812 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(812 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,248 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(812 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(808 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,248 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(812 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,624
        from master                     1,624  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,436  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,624       40.00       40.00
            matched (3) |      2,436       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,060      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       812          0 |       812 
      1980 |         0        812 |       812 
      1990 |         0        812 |       812 
      2000 |         0        812 |       812 
      2007 |       812          0 |       812 
-----------+----------------------+----------
     Total |     1,624      2,436 |     4,060 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,624 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        811
                                                  Wald chi2(1)    =      80.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9294

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8638541   .0963582    -8.97   0.000    -1.052713   -.6749955
       _cons |  -.4934621   .1228762    -4.02   0.000    -.7342951   -.2526291
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        811
                                                  Wald chi2(1)    =     184.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0931
                                                  Root MSE        =      2.272

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.046469    .077002   -13.59   0.000     -1.19739   -.8955478
       _cons |  -1.136866   .1633225    -6.96   0.000    -1.456972   -.8167601
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,622
                                                  Wald chi2(2)    =     527.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1426
                                                  Root MSE        =     2.1202

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9973556   .0597549   -16.69   0.000    -1.114473   -.8802381
       y2000 |   -.876325   .1153131    -7.60   0.000    -1.102335   -.6503154
       _cons |   -.351437   .0978992    -3.59   0.000     -.543316   -.1595581
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9365
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    958,755      100.00      100.00
------------+-----------------------------------
      Total |    958,755      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    319,585       33.33       33.33
          3 |    639,170       66.67      100.00
------------+-----------------------------------
      Total |    958,755      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(319,585 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(319,585 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(319,585 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004c not found)
file /tmp/St20945.00004c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        805       20.00       20.00
       1980 |        805       20.00       40.00
       1990 |        805       20.00       60.00
       2000 |        805       20.00       80.00
       2007 |        805       20.00      100.00
------------+-----------------------------------
      Total |      4,025      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,220 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(805 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(805 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,220 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(805 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(801 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,220 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(805 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,610
        from master                     1,610  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,415  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,610       40.00       40.00
            matched (3) |      2,415       60.00      100.00
------------------------+-----------------------------------
                  Total |      4,025      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       805          0 |       805 
      1980 |         0        805 |       805 
      1990 |         0        805 |       805 
      2000 |         0        805 |       805 
      2007 |       805          0 |       805 
-----------+----------------------+----------
     Total |     1,610      2,415 |     4,025 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,610 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        804
                                                  Wald chi2(1)    =      79.87
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9296

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.86498   .0967879    -8.94   0.000    -1.054681   -.6752792
       _cons |    -.49223   .1234215    -3.99   0.000    -.7341318   -.2503282
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        804
                                                  Wald chi2(1)    =     183.12
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0938
                                                  Root MSE        =     2.2693

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.045229   .0772398   -13.53   0.000    -1.196616   -.8938415
       _cons |  -1.139071   .1638335    -6.95   0.000    -1.460179   -.8179635
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,608
                                                  Wald chi2(2)    =     523.36
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1430
                                                  Root MSE        =     2.1188

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9967684   .0599714   -16.62   0.000     -1.11431   -.8792266
       y2000 |  -.8767305   .1157349    -7.58   0.000    -1.103567   -.6498942
       _cons |  -.3520314   .0982536    -3.58   0.000    -.5446049   -.1594579
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9370
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    948,036      100.00      100.00
------------+-----------------------------------
      Total |    948,036      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    316,012       33.33       33.33
          3 |    632,024       66.67      100.00
------------+-----------------------------------
      Total |    948,036      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(316,012 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(316,012 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(316,012 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004e not found)
file /tmp/St20945.00004e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        796       20.00       20.00
       1980 |        796       20.00       40.00
       1990 |        796       20.00       60.00
       2000 |        796       20.00       80.00
       2007 |        796       20.00      100.00
------------+-----------------------------------
      Total |      3,980      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,184 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(796 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(796 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,184 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(796 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(792 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,184 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(796 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,592
        from master                     1,592  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,388  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,592       40.00       40.00
            matched (3) |      2,388       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,980      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       796          0 |       796 
      1980 |         0        796 |       796 
      1990 |         0        796 |       796 
      2000 |         0        796 |       796 
      2007 |       796          0 |       796 
-----------+----------------------+----------
     Total |     1,592      2,388 |     3,980 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,592 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        795
                                                  Wald chi2(1)    =      79.00
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9294

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8658439   .0974167    -8.89   0.000    -1.056777   -.6749107
       _cons |   -.491648   .1241914    -3.96   0.000    -.7350588   -.2482373
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        795
                                                  Wald chi2(1)    =     181.05
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0941
                                                  Root MSE        =     2.2681

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.045673   .0777126   -13.46   0.000    -1.197987   -.8933588
       _cons |  -1.138318    .164815    -6.91   0.000     -1.46135   -.8152867
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,590
                                                  Wald chi2(2)    =     517.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1432
                                                  Root MSE        =      2.118

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9973311   .0603482   -16.53   0.000    -1.115611   -.8790508
       y2000 |  -.8760407    .116369    -7.53   0.000     -1.10412   -.6479617
       _cons |  -.3517615   .0988156    -3.56   0.000    -.5454365   -.1580865
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9375
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    927,789      100.00      100.00
------------+-----------------------------------
      Total |    927,789      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    309,263       33.33       33.33
          3 |    618,526       66.67      100.00
------------+-----------------------------------
      Total |    927,789      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(309,263 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(309,263 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(309,263 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004g not found)
file /tmp/St20945.00004g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        779       20.00       20.00
       1980 |        779       20.00       40.00
       1990 |        779       20.00       60.00
       2000 |        779       20.00       80.00
       2007 |        779       20.00      100.00
------------+-----------------------------------
      Total |      3,895      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,116 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(779 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(779 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,116 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(779 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(777 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,116 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(779 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,558
        from master                     1,558  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,337  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,558       40.00       40.00
            matched (3) |      2,337       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,895      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       779          0 |       779 
      1980 |         0        779 |       779 
      1990 |         0        779 |       779 
      2000 |         0        779 |       779 
      2007 |       779          0 |       779 
-----------+----------------------+----------
     Total |     1,558      2,337 |     3,895 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,558 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        778
                                                  Wald chi2(1)    =      76.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9253

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8652477   .0987695    -8.76   0.000    -1.058832    -.671663
       _cons |  -.4931352   .1258327    -3.92   0.000    -.7397629   -.2465076
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        778
                                                  Wald chi2(1)    =     175.13
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0919
                                                  Root MSE        =     2.2641

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.042333   .0787647   -13.23   0.000    -1.196709   -.8879574
       _cons |  -1.146036   .1669641    -6.86   0.000     -1.47328   -.8187923
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,556
                                                  Wald chi2(2)    =     505.22
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1433
                                                  Root MSE        =     2.1134

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9947395   .0611501   -16.27   0.000    -1.114592   -.8748874
       y2000 |  -.8790015   .1174674    -7.48   0.000    -1.109233   -.6487697
       _cons |  -.3551982   .0999184    -3.55   0.000    -.5510346   -.1593618
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9380
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    909,924      100.00      100.00
------------+-----------------------------------
      Total |    909,924      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    303,308       33.33       33.33
          3 |    606,616       66.67      100.00
------------+-----------------------------------
      Total |    909,924      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(303,308 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(303,308 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(303,308 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004i not found)
file /tmp/St20945.00004i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        764       20.00       20.00
       1980 |        764       20.00       40.00
       1990 |        764       20.00       60.00
       2000 |        764       20.00       80.00
       2007 |        764       20.00      100.00
------------+-----------------------------------
      Total |      3,820      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,056 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(764 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,056 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(762 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,056 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(764 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,528
        from master                     1,528  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,292  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,528       40.00       40.00
            matched (3) |      2,292       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,820      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       764          0 |       764 
      1980 |         0        764 |       764 
      1990 |         0        764 |       764 
      2000 |         0        764 |       764 
      2007 |       764          0 |       764 
-----------+----------------------+----------
     Total |     1,528      2,292 |     3,820 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,528 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        763
                                                  Wald chi2(1)    =      75.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9132

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8629571   .0991752    -8.70   0.000    -1.057337   -.6685773
       _cons |  -.4947223   .1264157    -3.91   0.000    -.7424926    -.246952
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        763
                                                  Wald chi2(1)    =     171.72
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0909
                                                  Root MSE        =     2.2593

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.042135    .079527   -13.10   0.000    -1.198005    -.886265
       _cons |  -1.144621   .1685969    -6.79   0.000    -1.475065   -.8141772
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,526
                                                  Wald chi2(2)    =     497.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1440
                                                  Root MSE        =     2.1053

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9939925   .0616167   -16.13   0.000    -1.114759   -.8732259
       y2000 |  -.8788713   .1182028    -7.44   0.000    -1.110544   -.6471981
       _cons |  -.3549963   .1006266    -3.53   0.000    -.5522208   -.1577718
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9385
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    893,250      100.00      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    297,750       33.33       33.33
          3 |    595,500       66.67      100.00
------------+-----------------------------------
      Total |    893,250      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(297,750 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(297,750 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(297,750 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004k not found)
file /tmp/St20945.00004k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        750       20.00       20.00
       1980 |        750       20.00       40.00
       1990 |        750       20.00       60.00
       2000 |        750       20.00       80.00
       2007 |        750       20.00      100.00
------------+-----------------------------------
      Total |      3,750      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(3,000 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(750 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(749 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(3,000 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(750 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,500
        from master                     1,500  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,250  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,500       40.00       40.00
            matched (3) |      2,250       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,750      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       750          0 |       750 
      1980 |         0        750 |       750 
      1990 |         0        750 |       750 
      2000 |         0        750 |       750 
      2007 |       750          0 |       750 
-----------+----------------------+----------
     Total |     1,500      2,250 |     3,750 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,500 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =      74.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9119

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8770238   .1014639    -8.64   0.000    -1.075889   -.6781581
       _cons |  -.4801703   .1287063    -3.73   0.000      -.73243   -.2279106
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        749
                                                  Wald chi2(1)    =     174.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0906
                                                  Root MSE        =     2.2506

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.050352   .0795033   -13.21   0.000    -1.206175   -.8945284
       _cons |  -1.130059   .1688027    -6.69   0.000    -1.460906   -.7992115
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,498
                                                  Wald chi2(2)    =     497.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1447
                                                  Root MSE        =     2.0992

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.004355   .0619825   -16.20   0.000    -1.125838   -.8828711
       y2000 |  -.8708337   .1189859    -7.32   0.000    -1.104042   -.6376257
       _cons |  -.3445146   .1012129    -3.40   0.001    -.5428884   -.1461409
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9390
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    878,958      100.00      100.00
------------+-----------------------------------
      Total |    878,958      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    292,986       33.33       33.33
          3 |    585,972       66.67      100.00
------------+-----------------------------------
      Total |    878,958      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(292,986 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(292,986 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(292,986 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004m not found)
file /tmp/St20945.00004m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        738       20.00       20.00
       1980 |        738       20.00       40.00
       1990 |        738       20.00       60.00
       2000 |        738       20.00       80.00
       2007 |        738       20.00      100.00
------------+-----------------------------------
      Total |      3,690      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,952 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(738 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(738 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,952 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(738 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(737 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,952 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(738 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,476
        from master                     1,476  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,214  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,476       40.00       40.00
            matched (3) |      2,214       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,690      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       738          0 |       738 
      1980 |         0        738 |       738 
      1990 |         0        738 |       738 
      2000 |         0        738 |       738 
      2007 |       738          0 |       738 
-----------+----------------------+----------
     Total |     1,476      2,214 |     3,690 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,476 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        737
                                                  Wald chi2(1)    =      73.07
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9106

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8745236   .1023041    -8.55   0.000    -1.075036   -.6740113
       _cons |  -.4847374   .1297798    -3.74   0.000    -.7391011   -.2303737
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        737
                                                  Wald chi2(1)    =     176.72
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0887
                                                  Root MSE        =       2.25

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.057458   .0795453   -13.29   0.000    -1.213364   -.9015518
       _cons |   -1.11639   .1692012    -6.60   0.000    -1.448018   -.7847616
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,474
                                                  Wald chi2(2)    =     494.31
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1431
                                                  Root MSE        =     2.0989

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.008799   .0621281   -16.24   0.000    -1.130568   -.8870304
       y2000 |  -.8650031   .1198114    -7.22   0.000    -1.099829    -.630177
       _cons |  -.3416211   .1017943    -3.36   0.001    -.5411342    -.142108
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9395
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    870,621      100.00      100.00
------------+-----------------------------------
      Total |    870,621      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    290,207       33.33       33.33
          3 |    580,414       66.67      100.00
------------+-----------------------------------
      Total |    870,621      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(290,207 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(290,207 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(290,207 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004o not found)
file /tmp/St20945.00004o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        731       20.00       20.00
       1980 |        731       20.00       40.00
       1990 |        731       20.00       60.00
       2000 |        731       20.00       80.00
       2007 |        731       20.00      100.00
------------+-----------------------------------
      Total |      3,655      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,924 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(731 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(731 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,924 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(731 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(730 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,924 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(731 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,462
        from master                     1,462  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,193  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,462       40.00       40.00
            matched (3) |      2,193       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,655      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       731          0 |       731 
      1980 |         0        731 |       731 
      1990 |         0        731 |       731 
      2000 |         0        731 |       731 
      2007 |       731          0 |       731 
-----------+----------------------+----------
     Total |     1,462      2,193 |     3,655 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,462 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        730
                                                  Wald chi2(1)    =      72.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9081

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8713763   .1026197    -8.49   0.000    -1.072507   -.6702454
       _cons |  -.4880545   .1302123    -3.75   0.000     -.743266    -.232843
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        730
                                                  Wald chi2(1)    =     174.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0890
                                                  Root MSE        =     2.2489

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.055896   .0798493   -13.22   0.000    -1.212397   -.8993938
       _cons |  -1.119173    .169883    -6.59   0.000    -1.452137    -.786208
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,460
                                                  Wald chi2(2)    =     489.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1437
                                                  Root MSE        =     2.0971

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.006814   .0623478   -16.15   0.000    -1.129014   -.8846148
       y2000 |   -.866532   .1202787    -7.20   0.000    -1.102274   -.6307902
       _cons |  -.3436713   .1021876    -3.36   0.001    -.5439553   -.1433872
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9400
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    863,475      100.00      100.00
------------+-----------------------------------
      Total |    863,475      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    287,825       33.33       33.33
          3 |    575,650       66.67      100.00
------------+-----------------------------------
      Total |    863,475      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(287,825 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(287,825 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(287,825 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004q not found)
file /tmp/St20945.00004q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        725       20.00       20.00
       1980 |        725       20.00       40.00
       1990 |        725       20.00       60.00
       2000 |        725       20.00       80.00
       2007 |        725       20.00      100.00
------------+-----------------------------------
      Total |      3,625      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,900 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(725 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(725 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,900 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(725 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(725 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,900 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(725 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,450
        from master                     1,450  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,175  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,450       40.00       40.00
            matched (3) |      2,175       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,625      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       725          0 |       725 
      1980 |         0        725 |       725 
      1990 |         0        725 |       725 
      2000 |         0        725 |       725 
      2007 |       725          0 |       725 
-----------+----------------------+----------
     Total |     1,450      2,175 |     3,625 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,450 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        724
                                                  Wald chi2(1)    =      71.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9048

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8703812   .1029245    -8.46   0.000     -1.07211   -.6686528
       _cons |  -.4889272    .130726    -3.74   0.000    -.7451456   -.2327089
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        724
                                                  Wald chi2(1)    =     173.42
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0889
                                                  Root MSE        =      2.241

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.054402   .0800682   -13.17   0.000    -1.211332   -.8974708
       _cons |  -1.123896   .1704094    -6.60   0.000    -1.457892   -.7898996
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,448
                                                  Wald chi2(2)    =     487.44
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1443
                                                  Root MSE        =     2.0914

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.005394   .0625397   -16.08   0.000     -1.12797   -.8828189
       y2000 |  -.8701281   .1204882    -7.22   0.000    -1.106281   -.6339756
       _cons |  -.3447638   .1024724    -3.36   0.001    -.5456059   -.1439216
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9405
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    853,947      100.00      100.00
------------+-----------------------------------
      Total |    853,947      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    284,649       33.33       33.33
          3 |    569,298       66.67      100.00
------------+-----------------------------------
      Total |    853,947      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(284,649 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(284,649 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(284,649 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004s not found)
file /tmp/St20945.00004s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        717       20.00       20.00
       1980 |        717       20.00       40.00
       1990 |        717       20.00       60.00
       2000 |        717       20.00       80.00
       2007 |        717       20.00      100.00
------------+-----------------------------------
      Total |      3,585      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,868 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(717 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(717 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,868 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(717 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(717 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,868 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(717 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,434
        from master                     1,434  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,151  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,434       40.00       40.00
            matched (3) |      2,151       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,585      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       717          0 |       717 
      1980 |         0        717 |       717 
      1990 |         0        717 |       717 
      2000 |         0        717 |       717 
      2007 |       717          0 |       717 
-----------+----------------------+----------
     Total |     1,434      2,151 |     3,585 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,434 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        716
                                                  Wald chi2(1)    =      70.30
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.9011

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8672984   .1034441    -8.38   0.000    -1.070045   -.6645516
       _cons |  -.4940331   .1313164    -3.76   0.000    -.7514085   -.2366577
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        716
                                                  Wald chi2(1)    =     172.37
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0891
                                                  Root MSE        =      2.234

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.05519   .0803712   -13.13   0.000    -1.212715   -.8976657
       _cons |  -1.122084   .1710279    -6.56   0.000    -1.457292   -.7868754
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,432
                                                  Wald chi2(2)    =     483.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1448
                                                  Root MSE        =     2.0861

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.005193   .0628191   -16.00   0.000    -1.128316   -.8820697
       y2000 |  -.8681224   .1208987    -7.18   0.000    -1.105079   -.6311654
       _cons |  -.3468175   .1028387    -3.37   0.001    -.5483776   -.1452574
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9410
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    842,037      100.00      100.00
------------+-----------------------------------
      Total |    842,037      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    280,679       33.33       33.33
          3 |    561,358       66.67      100.00
------------+-----------------------------------
      Total |    842,037      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(280,679 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(280,679 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(280,679 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004u not found)
file /tmp/St20945.00004u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        707       20.00       20.00
       1980 |        707       20.00       40.00
       1990 |        707       20.00       60.00
       2000 |        707       20.00       80.00
       2007 |        707       20.00      100.00
------------+-----------------------------------
      Total |      3,535      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,828 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(707 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(707 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,828 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(707 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(707 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,828 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(707 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,414
        from master                     1,414  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,121  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,414       40.00       40.00
            matched (3) |      2,121       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,535      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       707          0 |       707 
      1980 |         0        707 |       707 
      1990 |         0        707 |       707 
      2000 |         0        707 |       707 
      2007 |       707          0 |       707 
-----------+----------------------+----------
     Total |     1,414      2,121 |     3,535 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,414 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        706
                                                  Wald chi2(1)    =      70.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8832

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.921535    .110061    -8.37   0.000    -1.137251   -.7058193
       _cons |   -.434558   .1372816    -3.17   0.002     -.703625    -.165491
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        706
                                                  Wald chi2(1)    =     182.27
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0945
                                                  Root MSE        =     2.2215

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.084833   .0803537   -13.50   0.000    -1.242323   -.9273427
       _cons |   -1.07306   .1708393    -6.28   0.000    -1.407899   -.7382213
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,412
                                                  Wald chi2(2)    =     497.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1569
                                                  Root MSE        =     2.0672

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.042453   .0636279   -16.38   0.000    -1.167161   -.9177445
       y2000 |  -.8462484   .1208535    -7.00   0.000    -1.083117   -.6093798
       _cons |  -.3053882   .1033086    -2.96   0.003    -.5078693   -.1029071
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9415
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    821,790      100.00      100.00
------------+-----------------------------------
      Total |    821,790      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    273,930       33.33       33.33
          3 |    547,860       66.67      100.00
------------+-----------------------------------
      Total |    821,790      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(273,930 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(273,930 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(273,930 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00004w not found)
file /tmp/St20945.00004w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        690       20.00       20.00
       1980 |        690       20.00       40.00
       1990 |        690       20.00       60.00
       2000 |        690       20.00       80.00
       2007 |        690       20.00      100.00
------------+-----------------------------------
      Total |      3,450      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,760 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(690 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(690 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,760 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(690 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(690 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,760 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(690 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,380
        from master                     1,380  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,070  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,380       40.00       40.00
            matched (3) |      2,070       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,450      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       690          0 |       690 
      1980 |         0        690 |       690 
      1990 |         0        690 |       690 
      2000 |         0        690 |       690 
      2007 |       690          0 |       690 
-----------+----------------------+----------
     Total |     1,380      2,070 |     3,450 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,380 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        689
                                                  Wald chi2(1)    =      68.46
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8793

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9213688   .1113545    -8.27   0.000     -1.13962    -.703118
       _cons |   -.435349   .1388279    -3.14   0.002    -.7074466   -.1632514
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        689
                                                  Wald chi2(1)    =     177.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0951
                                                  Root MSE        =     2.2144

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.087987   .0816182   -13.33   0.000    -1.247956   -.9280186
       _cons |  -1.069064   .1732071    -6.17   0.000    -1.408544   -.7295845
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,378
                                                  Wald chi2(2)    =     486.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1580
                                                  Root MSE        =     2.0616

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.04459   .0645776   -16.18   0.000    -1.171159   -.9180199
       y2000 |  -.8457677   .1221037    -6.93   0.000    -1.085087   -.6064488
       _cons |  -.3037309   .1045317    -2.91   0.004    -.5086093   -.0988524
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9420
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    808,689      100.00      100.00
------------+-----------------------------------
      Total |    808,689      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    269,563       33.33       33.33
          3 |    539,126       66.67      100.00
------------+-----------------------------------
      Total |    808,689      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(269,563 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(269,563 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(269,563 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000050 not found)
file /tmp/St20945.000050 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        679       20.00       20.00
       1980 |        679       20.00       40.00
       1990 |        679       20.00       60.00
       2000 |        679       20.00       80.00
       2007 |        679       20.00      100.00
------------+-----------------------------------
      Total |      3,395      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,716 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(679 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(679 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,716 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(679 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(679 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,716 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(679 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,358
        from master                     1,358  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,037  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,358       40.00       40.00
            matched (3) |      2,037       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,395      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       679          0 |       679 
      1980 |         0        679 |       679 
      1990 |         0        679 |       679 
      2000 |         0        679 |       679 
      2007 |       679          0 |       679 
-----------+----------------------+----------
     Total |     1,358      2,037 |     3,395 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,358 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        678
                                                  Wald chi2(1)    =      66.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8758

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9178469   .1123542    -8.17   0.000    -1.138057   -.6976367
       _cons |  -.4401488   .1400289    -3.14   0.002    -.7146005   -.1656971
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        678
                                                  Wald chi2(1)    =     173.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0923
                                                  Root MSE        =     2.2046

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.087853   .0826528   -13.16   0.000     -1.24985    -.925857
       _cons |  -1.070632   .1750465    -6.12   0.000    -1.413717   -.7275468
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,356
                                                  Wald chi2(2)    =     477.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1564
                                                  Root MSE        =     2.0549

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.043348   .0653659   -15.96   0.000    -1.171462   -.9152327
       y2000 |  -.8471082   .1228351    -6.90   0.000    -1.087861   -.6063558
       _cons |  -.3060211   .1053965    -2.90   0.004    -.5125945   -.0994477
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9425
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    796,779      100.00      100.00
------------+-----------------------------------
      Total |    796,779      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    265,593       33.33       33.33
          3 |    531,186       66.67      100.00
------------+-----------------------------------
      Total |    796,779      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(265,593 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(265,593 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(265,593 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000052 not found)
file /tmp/St20945.000052 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        669       20.00       20.00
       1980 |        669       20.00       40.00
       1990 |        669       20.00       60.00
       2000 |        669       20.00       80.00
       2007 |        669       20.00      100.00
------------+-----------------------------------
      Total |      3,345      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,676 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(669 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(669 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,676 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(669 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(669 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,676 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(669 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,338
        from master                     1,338  (_merge==1)
        from using                          0  (_merge==2)

    matched                             2,007  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,338       40.00       40.00
            matched (3) |      2,007       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,345      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       669          0 |       669 
      1980 |         0        669 |       669 
      1990 |         0        669 |       669 
      2000 |         0        669 |       669 
      2007 |       669          0 |       669 
-----------+----------------------+----------
     Total |     1,338      2,007 |     3,345 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,338 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        668
                                                  Wald chi2(1)    =      65.83
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8644

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.913026    .112533    -8.11   0.000    -1.133587   -.6924653
       _cons |  -.4485816    .140271    -3.20   0.001    -.7235077   -.1736555
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        668
                                                  Wald chi2(1)    =     170.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0910
                                                  Root MSE        =     2.1991

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.086038   .0831673   -13.06   0.000    -1.249043   -.9230334
       _cons |  -1.074799   .1761314    -6.10   0.000     -1.42001   -.7295879
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,336
                                                  Wald chi2(2)    =     471.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1568
                                                  Root MSE        =     2.0468

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.040706   .0656594   -15.85   0.000    -1.169396   -.9120161
       y2000 |  -.8467709   .1232938    -6.87   0.000    -1.088422   -.6051195
       _cons |  -.3120876   .1058223    -2.95   0.003    -.5194955   -.1046797
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9430
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    787,251      100.00      100.00
------------+-----------------------------------
      Total |    787,251      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    262,417       33.33       33.33
          3 |    524,834       66.67      100.00
------------+-----------------------------------
      Total |    787,251      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(262,417 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(262,417 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(262,417 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000054 not found)
file /tmp/St20945.000054 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        661       20.00       20.00
       1980 |        661       20.00       40.00
       1990 |        661       20.00       60.00
       2000 |        661       20.00       80.00
       2007 |        661       20.00      100.00
------------+-----------------------------------
      Total |      3,305      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,644 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(661 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(661 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,644 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(661 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(661 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,644 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(661 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,322
        from master                     1,322  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,983  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,322       40.00       40.00
            matched (3) |      1,983       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,305      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       661          0 |       661 
      1980 |         0        661 |       661 
      1990 |         0        661 |       661 
      2000 |         0        661 |       661 
      2007 |       661          0 |       661 
-----------+----------------------+----------
     Total |     1,322      1,983 |     3,305 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,322 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        660
                                                  Wald chi2(1)    =      68.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8694

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9583954   .1156345    -8.29   0.000    -1.185035   -.7317559
       _cons |  -.4016347   .1433562    -2.80   0.005    -.6826077   -.1206618
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        660
                                                  Wald chi2(1)    =     169.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0886
                                                  Root MSE        =     2.1997

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.105898   .0848466   -13.03   0.000    -1.272194   -.9396017
       _cons |  -1.039808   .1789911    -5.81   0.000    -1.390624   -.6889916
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,320
                                                  Wald chi2(2)    =     470.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1539
                                                  Root MSE        =     2.0483

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.067601   .0671094   -15.91   0.000    -1.199133    -.936069
       y2000 |  -.8257685   .1244378    -6.64   0.000    -1.069662   -.5818748
       _cons |  -.2849866   .1072161    -2.66   0.008    -.4951264   -.0748468
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9435
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    776,532      100.00      100.00
------------+-----------------------------------
      Total |    776,532      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    258,844       33.33       33.33
          3 |    517,688       66.67      100.00
------------+-----------------------------------
      Total |    776,532      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(258,844 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(258,844 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(258,844 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000056 not found)
file /tmp/St20945.000056 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        652       20.00       20.00
       1980 |        652       20.00       40.00
       1990 |        652       20.00       60.00
       2000 |        652       20.00       80.00
       2007 |        652       20.00      100.00
------------+-----------------------------------
      Total |      3,260      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,608 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(652 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(652 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,608 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(652 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(652 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,608 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(652 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,304
        from master                     1,304  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,956  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,304       40.00       40.00
            matched (3) |      1,956       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,260      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       652          0 |       652 
      1980 |         0        652 |       652 
      1990 |         0        652 |       652 
      2000 |         0        652 |       652 
      2007 |       652          0 |       652 
-----------+----------------------+----------
     Total |     1,304      1,956 |     3,260 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,304 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        651
                                                  Wald chi2(1)    =      67.42
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8604

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9508983   .1158115    -8.21   0.000    -1.177885   -.7239119
       _cons |  -.4141654   .1435735    -2.88   0.004    -.6955642   -.1327666
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        651
                                                  Wald chi2(1)    =     167.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0886
                                                  Root MSE        =     2.1961

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.105577   .0853016   -12.96   0.000    -1.272765   -.9383893
       _cons |  -1.039366   .1799142    -5.78   0.000    -1.391991   -.6867407
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,302
                                                  Wald chi2(2)    =     464.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1541
                                                  Root MSE        =     2.0425

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.065418   .0673785   -15.81   0.000    -1.197478   -.9333588
       y2000 |  -.8218814   .1249343    -6.58   0.000    -1.066748   -.5770147
       _cons |  -.2918643   .1076391    -2.71   0.007    -.5028332   -.0808955
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9440
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    758,667      100.00      100.00
------------+-----------------------------------
      Total |    758,667      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    252,889       33.33       33.33
          3 |    505,778       66.67      100.00
------------+-----------------------------------
      Total |    758,667      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(252,889 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(252,889 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(252,889 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000058 not found)
file /tmp/St20945.000058 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        637       20.00       20.00
       1980 |        637       20.00       40.00
       1990 |        637       20.00       60.00
       2000 |        637       20.00       80.00
       2007 |        637       20.00      100.00
------------+-----------------------------------
      Total |      3,185      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,548 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(637 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(637 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,548 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(637 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(637 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,548 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(637 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,274
        from master                     1,274  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,911  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,274       40.00       40.00
            matched (3) |      1,911       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,185      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       637          0 |       637 
      1980 |         0        637 |       637 
      1990 |         0        637 |       637 
      2000 |         0        637 |       637 
      2007 |       637          0 |       637 
-----------+----------------------+----------
     Total |     1,274      1,911 |     3,185 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,274 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        636
                                                  Wald chi2(1)    =      66.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8585

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9540012   .1167667    -8.17   0.000     -1.18286   -.7251427
       _cons |  -.4106149   .1449375    -2.83   0.005    -.6946873   -.1265426
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        636
                                                  Wald chi2(1)    =     163.43
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0888
                                                  Root MSE        =     2.1881

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.100956   .0861198   -12.78   0.000    -1.269747    -.932164
       _cons |   -1.04922    .181633    -5.78   0.000    -1.405214    -.693226
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,272
                                                  Wald chi2(2)    =     454.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1545
                                                  Root MSE        =      2.037

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.062786    .068025   -15.62   0.000    -1.196112   -.9294591
       y2000 |   -.825603   .1260686    -6.55   0.000    -1.072693   -.5785131
       _cons |  -.2943416   .1086776    -2.71   0.007    -.5073459   -.0813374
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9445
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    750,330      100.00      100.00
------------+-----------------------------------
      Total |    750,330      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    250,110       33.33       33.33
          3 |    500,220       66.67      100.00
------------+-----------------------------------
      Total |    750,330      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(250,110 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(250,110 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(250,110 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005a not found)
file /tmp/St20945.00005a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        630       20.00       20.00
       1980 |        630       20.00       40.00
       1990 |        630       20.00       60.00
       2000 |        630       20.00       80.00
       2007 |        630       20.00      100.00
------------+-----------------------------------
      Total |      3,150      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,520 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(630 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(630 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,520 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(630 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(630 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,520 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(630 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,260
        from master                     1,260  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,890  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,260       40.00       40.00
            matched (3) |      1,890       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,150      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       630          0 |       630 
      1980 |         0        630 |       630 
      1990 |         0        630 |       630 
      2000 |         0        630 |       630 
      2007 |       630          0 |       630 
-----------+----------------------+----------
     Total |     1,260      1,890 |     3,150 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,260 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        629
                                                  Wald chi2(1)    =      66.80
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8456

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.952657   .1165601    -8.17   0.000    -1.181111   -.7242034
       _cons |  -.4172511   .1447137    -2.88   0.004    -.7008848   -.1336174
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        629
                                                  Wald chi2(1)    =     162.50
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0915
                                                  Root MSE        =     2.1779

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.099779   .0862739   -12.75   0.000    -1.268872   -.9306851
       _cons |  -1.056371   .1818462    -5.81   0.000    -1.412783   -.6999594
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,258
                                                  Wald chi2(2)    =     453.80
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1571
                                                  Root MSE        =     2.0257

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.061512   .0680606   -15.60   0.000    -1.194908   -.9281153
       y2000 |  -.8263564   .1260407    -6.56   0.000    -1.073392   -.5793211
       _cons |  -.3008826   .1087077    -2.77   0.006    -.5139457   -.0878194
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9450
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    741,993      100.00      100.00
------------+-----------------------------------
      Total |    741,993      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    247,331       33.33       33.33
          3 |    494,662       66.67      100.00
------------+-----------------------------------
      Total |    741,993      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(247,331 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(247,331 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(247,331 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005c not found)
file /tmp/St20945.00005c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        623       20.00       20.00
       1980 |        623       20.00       40.00
       1990 |        623       20.00       60.00
       2000 |        623       20.00       80.00
       2007 |        623       20.00      100.00
------------+-----------------------------------
      Total |      3,115      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,492 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(623 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(623 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,492 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(623 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(623 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,492 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(623 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,246
        from master                     1,246  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,869  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,246       40.00       40.00
            matched (3) |      1,869       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,115      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       623          0 |       623 
      1980 |         0        623 |       623 
      1990 |         0        623 |       623 
      2000 |         0        623 |       623 
      2007 |       623          0 |       623 
-----------+----------------------+----------
     Total |     1,246      1,869 |     3,115 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,246 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        622
                                                  Wald chi2(1)    =      67.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8342

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9615848   .1169379    -8.22   0.000    -1.190779   -.7323907
       _cons |  -.4116347   .1449274    -2.84   0.005    -.6956872   -.1275822
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        622
                                                  Wald chi2(1)    =     159.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0905
                                                  Root MSE        =     2.1753

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.100078   .0869978   -12.64   0.000     -1.27059   -.9295652
       _cons |  -1.057958   .1831596    -5.78   0.000    -1.416944   -.6989714
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,244
                                                  Wald chi2(2)    =     450.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1590
                                                  Root MSE        =     2.0183

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.063977   .0684588   -15.54   0.000    -1.198153   -.9297999
       y2000 |  -.8225022   .1263915    -6.51   0.000    -1.070225   -.5747794
       _cons |  -.3022891   .1090602    -2.77   0.006    -.5160433    -.088535
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9455
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    728,892      100.00      100.00
------------+-----------------------------------
      Total |    728,892      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    242,964       33.33       33.33
          3 |    485,928       66.67      100.00
------------+-----------------------------------
      Total |    728,892      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(242,964 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(242,964 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(242,964 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005e not found)
file /tmp/St20945.00005e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        612       20.00       20.00
       1980 |        612       20.00       40.00
       1990 |        612       20.00       60.00
       2000 |        612       20.00       80.00
       2007 |        612       20.00      100.00
------------+-----------------------------------
      Total |      3,060      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,448 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(612 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(612 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,448 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(612 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(612 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,448 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(612 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,224
        from master                     1,224  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,836  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,224       40.00       40.00
            matched (3) |      1,836       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,060      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       612          0 |       612 
      1980 |         0        612 |       612 
      1990 |         0        612 |       612 
      2000 |         0        612 |       612 
      2007 |       612          0 |       612 
-----------+----------------------+----------
     Total |     1,224      1,836 |     3,060 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,224 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        611
                                                  Wald chi2(1)    =      66.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8242

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.95127   .1170706    -8.13   0.000    -1.180724   -.7218159
       _cons |   -.424865   .1451874    -2.93   0.003     -.709427   -.1403029
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        611
                                                  Wald chi2(1)    =     158.67
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0922
                                                  Root MSE        =     2.1628

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.099858   .0873141   -12.60   0.000     -1.27099   -.9287253
       _cons |  -1.059177   .1837389    -5.76   0.000    -1.419298   -.6990549
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,222
                                                  Wald chi2(2)    =     446.06
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1613
                                                  Root MSE        =     2.0072

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.061021   .0686714   -15.45   0.000    -1.195615   -.9264278
       y2000 |    -.82339   .1267846    -6.49   0.000    -1.071883   -.5748968
       _cons |  -.3076503   .1094197    -2.81   0.005     -.522109   -.0931917
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9460
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    719,364      100.00      100.00
------------+-----------------------------------
      Total |    719,364      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    239,788       33.33       33.33
          3 |    479,576       66.67      100.00
------------+-----------------------------------
      Total |    719,364      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(239,788 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(239,788 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(239,788 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005g not found)
file /tmp/St20945.00005g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        604       20.00       20.00
       1980 |        604       20.00       40.00
       1990 |        604       20.00       60.00
       2000 |        604       20.00       80.00
       2007 |        604       20.00      100.00
------------+-----------------------------------
      Total |      3,020      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,416 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(604 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(604 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,416 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(604 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(604 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,416 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(604 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,208
        from master                     1,208  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,812  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,208       40.00       40.00
            matched (3) |      1,812       60.00      100.00
------------------------+-----------------------------------
                  Total |      3,020      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       604          0 |       604 
      1980 |         0        604 |       604 
      1990 |         0        604 |       604 
      2000 |         0        604 |       604 
      2007 |       604          0 |       604 
-----------+----------------------+----------
     Total |     1,208      1,812 |     3,020 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,208 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        603
                                                  Wald chi2(1)    =      66.24
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8041

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9282191   .1140481    -8.14   0.000    -1.151749    -.704689
       _cons |  -.4541257   .1422394    -3.19   0.001    -.7329097   -.1753417
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        603
                                                  Wald chi2(1)    =     156.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0919
                                                  Root MSE        =     2.1589

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.099435    .087826   -12.52   0.000    -1.271571   -.9272997
       _cons |  -1.062588   .1847894    -5.75   0.000    -1.424768   -.7004072
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,206
                                                  Wald chi2(2)    =     443.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1636
                                                  Root MSE        =     1.9966

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.054493   .0684545   -15.40   0.000    -1.188662   -.9203249
       y2000 |  -.8264873    .126857    -6.52   0.000    -1.075122   -.5778521
       _cons |  -.3192726   .1093403    -2.92   0.004    -.5335757   -.1049695
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9465
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    708,645      100.00      100.00
------------+-----------------------------------
      Total |    708,645      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    236,215       33.33       33.33
          3 |    472,430       66.67      100.00
------------+-----------------------------------
      Total |    708,645      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(236,215 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(236,215 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(236,215 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005i not found)
file /tmp/St20945.00005i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        595       20.00       20.00
       1980 |        595       20.00       40.00
       1990 |        595       20.00       60.00
       2000 |        595       20.00       80.00
       2007 |        595       20.00      100.00
------------+-----------------------------------
      Total |      2,975      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,380 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(595 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(595 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,380 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(595 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(595 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,380 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(595 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,190
        from master                     1,190  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,785  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,190       40.00       40.00
            matched (3) |      1,785       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,975      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       595          0 |       595 
      1980 |         0        595 |       595 
      1990 |         0        595 |       595 
      2000 |         0        595 |       595 
      2007 |       595          0 |       595 
-----------+----------------------+----------
     Total |     1,190      1,785 |     2,975 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,190 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        594
                                                  Wald chi2(1)    =      64.98
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.8017

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9299385   .1153622    -8.06   0.000    -1.156044   -.7038328
       _cons |  -.4538707     .14367    -3.16   0.002    -.7354588   -.1722826
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        594
                                                  Wald chi2(1)    =     154.90
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0922
                                                  Root MSE        =     2.1544

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.101211   .0884787   -12.45   0.000    -1.274626    -.927796
       _cons |   -1.06145   .1860395    -5.71   0.000    -1.426081   -.6968196
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,188
                                                  Wald chi2(2)    =     438.09
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1636
                                                  Root MSE        =     1.9931

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.056376   .0690477   -15.30   0.000    -1.191707   -.9210446
       y2000 |  -.8255493   .1276439    -6.47   0.000    -1.075727    -.575372
       _cons |  -.3188527   .1101107    -2.90   0.004    -.5346657   -.1030398
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9470
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    699,117      100.00      100.00
------------+-----------------------------------
      Total |    699,117      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    233,039       33.33       33.33
          3 |    466,078       66.67      100.00
------------+-----------------------------------
      Total |    699,117      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(233,039 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(233,039 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(233,039 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005k not found)
file /tmp/St20945.00005k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        587       20.00       20.00
       1980 |        587       20.00       40.00
       1990 |        587       20.00       60.00
       2000 |        587       20.00       80.00
       2007 |        587       20.00      100.00
------------+-----------------------------------
      Total |      2,935      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,348 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(587 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(587 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,348 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(587 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(587 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,348 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(587 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,174
        from master                     1,174  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,761  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,174       40.00       40.00
            matched (3) |      1,761       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,935      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       587          0 |       587 
      1980 |         0        587 |       587 
      1990 |         0        587 |       587 
      2000 |         0        587 |       587 
      2007 |       587          0 |       587 
-----------+----------------------+----------
     Total |     1,174      1,761 |     2,935 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,174 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        586
                                                  Wald chi2(1)    =      64.77
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7932

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.937848   .1165358    -8.05   0.000    -1.166254   -.7094421
       _cons |   -.447845   .1446421    -3.10   0.002    -.7313383   -.1643518
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        586
                                                  Wald chi2(1)    =     154.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0892
                                                  Root MSE        =     2.1536

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.11028   .0893675   -12.42   0.000    -1.285437   -.9351224
       _cons |  -1.045077   .1876832    -5.57   0.000    -1.412929   -.6772244
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,172
                                                  Wald chi2(2)    =     435.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1640
                                                  Root MSE        =     1.9883

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.065254   .0696782   -15.29   0.000    -1.201821   -.9286877
       y2000 |  -.8163152   .1283368    -6.36   0.000    -1.067851   -.5647797
       _cons |  -.3120221   .1107431    -2.82   0.005    -.5290746   -.0949695
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9475
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    684,825      100.00      100.00
------------+-----------------------------------
      Total |    684,825      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    228,275       33.33       33.33
          3 |    456,550       66.67      100.00
------------+-----------------------------------
      Total |    684,825      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(228,275 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(228,275 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(228,275 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005m not found)
file /tmp/St20945.00005m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        575       20.00       20.00
       1980 |        575       20.00       40.00
       1990 |        575       20.00       60.00
       2000 |        575       20.00       80.00
       2007 |        575       20.00      100.00
------------+-----------------------------------
      Total |      2,875      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,300 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(575 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(575 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,300 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(575 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(575 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,300 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(575 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,150
        from master                     1,150  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,725  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,150       40.00       40.00
            matched (3) |      1,725       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,875      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       575          0 |       575 
      1980 |         0        575 |       575 
      1990 |         0        575 |       575 
      2000 |         0        575 |       575 
      2007 |       575          0 |       575 
-----------+----------------------+----------
     Total |     1,150      1,725 |     2,875 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,150 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        574
                                                  Wald chi2(1)    =      60.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7753

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9110727   .1170857    -7.78   0.000    -1.140556    -.681589
       _cons |  -.4788144   .1452982    -3.30   0.001    -.7635936   -.1940353
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        574
                                                  Wald chi2(1)    =     146.05
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0905
                                                  Root MSE        =      2.123

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.082562   .0895791   -12.08   0.000    -1.258133   -.9069899
       _cons |  -1.092149   .1880015    -5.81   0.000    -1.460625   -.7236726
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,148
                                                  Wald chi2(2)    =     421.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1673
                                                  Root MSE        =     1.9635

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.037709   .0699293   -14.84   0.000    -1.174768   -.9006503
       y2000 |  -.8315326   .1281996    -6.49   0.000    -1.082799   -.5802661
       _cons |   -.343637   .1108533    -3.10   0.002    -.5609055   -.1263684
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9480
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    672,915      100.00      100.00
------------+-----------------------------------
      Total |    672,915      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    224,305       33.33       33.33
          3 |    448,610       66.67      100.00
------------+-----------------------------------
      Total |    672,915      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(224,305 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(224,305 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(224,305 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005o not found)
file /tmp/St20945.00005o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        565       20.00       20.00
       1980 |        565       20.00       40.00
       1990 |        565       20.00       60.00
       2000 |        565       20.00       80.00
       2007 |        565       20.00      100.00
------------+-----------------------------------
      Total |      2,825      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,260 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(565 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(565 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,260 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(565 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(565 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,260 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(565 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,130
        from master                     1,130  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,695  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,130       40.00       40.00
            matched (3) |      1,695       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,825      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       565          0 |       565 
      1980 |         0        565 |       565 
      1990 |         0        565 |       565 
      2000 |         0        565 |       565 
      2007 |       565          0 |       565 
-----------+----------------------+----------
     Total |     1,130      1,695 |     2,825 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,130 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        564
                                                  Wald chi2(1)    =      59.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7536

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9097196   .1179501    -7.71   0.000    -1.140898   -.6785417
       _cons |  -.4812601   .1459168    -3.30   0.001    -.7672518   -.1952685
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        564
                                                  Wald chi2(1)    =     144.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0866
                                                  Root MSE        =     2.1203

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.091291   .0909162   -12.00   0.000    -1.269483   -.9130984
       _cons |   -1.07832   .1904424    -5.66   0.000     -1.45158   -.7050593
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,128
                                                  Wald chi2(2)    =     418.20
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1672
                                                  Root MSE        =     1.9523

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.043898   .0707247   -14.76   0.000    -1.182516   -.9052799
       y2000 |  -.8279195    .128782    -6.43   0.000    -1.080328   -.5755114
       _cons |  -.3380896   .1115932    -3.03   0.002    -.5568081    -.119371
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9485
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    659,814      100.00      100.00
------------+-----------------------------------
      Total |    659,814      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    219,938       33.33       33.33
          3 |    439,876       66.67      100.00
------------+-----------------------------------
      Total |    659,814      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(219,938 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(219,938 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(219,938 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005q not found)
file /tmp/St20945.00005q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        554       20.00       20.00
       1980 |        554       20.00       40.00
       1990 |        554       20.00       60.00
       2000 |        554       20.00       80.00
       2007 |        554       20.00      100.00
------------+-----------------------------------
      Total |      2,770      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,216 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(554 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(554 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,216 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(554 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(554 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,216 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(554 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,108
        from master                     1,108  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,662  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,108       40.00       40.00
            matched (3) |      1,662       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,770      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       554          0 |       554 
      1980 |         0        554 |       554 
      1990 |         0        554 |       554 
      2000 |         0        554 |       554 
      2007 |       554          0 |       554 
-----------+----------------------+----------
     Total |     1,108      1,662 |     2,770 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,108 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        553
                                                  Wald chi2(1)    =      58.22
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7465

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9019065   .1182052    -7.63   0.000    -1.133585   -.6702286
       _cons |  -.4891453   .1464199    -3.34   0.001    -.7761231   -.2021676
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        553
                                                  Wald chi2(1)    =     142.04
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0839
                                                  Root MSE        =     2.1119

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.091757   .0916058   -11.92   0.000    -1.271301   -.9122126
       _cons |  -1.080685   .1917444    -5.64   0.000    -1.456497   -.7048727
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,106
                                                  Wald chi2(2)    =     412.94
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1679
                                                  Root MSE        =     1.9446

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.042118   .0711694   -14.64   0.000    -1.181608   -.9026288
       y2000 |  -.8330179   .1295101    -6.43   0.000    -1.086853   -.5791828
       _cons |  -.3394671   .1122961    -3.02   0.003    -.5595635   -.1193708
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9490
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    652,668      100.00      100.00
------------+-----------------------------------
      Total |    652,668      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    217,556       33.33       33.33
          3 |    435,112       66.67      100.00
------------+-----------------------------------
      Total |    652,668      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(217,556 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(217,556 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(217,556 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005s not found)
file /tmp/St20945.00005s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        548       20.00       20.00
       1980 |        548       20.00       40.00
       1990 |        548       20.00       60.00
       2000 |        548       20.00       80.00
       2007 |        548       20.00      100.00
------------+-----------------------------------
      Total |      2,740      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,192 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(548 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(548 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,192 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(548 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(548 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,192 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(548 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,096
        from master                     1,096  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,644  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,096       40.00       40.00
            matched (3) |      1,644       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,740      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       548          0 |       548 
      1980 |         0        548 |       548 
      1990 |         0        548 |       548 
      2000 |         0        548 |       548 
      2007 |       548          0 |       548 
-----------+----------------------+----------
     Total |     1,096      1,644 |     2,740 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,096 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        547
                                                  Wald chi2(1)    =      58.44
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7341

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9014598   .1179213    -7.64   0.000    -1.132581   -.6703383
       _cons |  -.4968578   .1460878    -3.40   0.001    -.7831847   -.2105309
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        547
                                                  Wald chi2(1)    =     139.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0859
                                                  Root MSE        =     2.0943

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.081297   .0914157   -11.83   0.000    -1.260469   -.9021257
       _cons |  -1.105685   .1912544    -5.78   0.000    -1.480536    -.730833
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,094
                                                  Wald chi2(2)    =     411.10
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1708
                                                  Root MSE        =     1.9291

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.034187   .0710129   -14.56   0.000    -1.173369   -.8950039
       y2000 |  -.8375957    .129166    -6.48   0.000    -1.090756   -.5844351
       _cons |  -.3551802   .1120224    -3.17   0.002    -.5747401   -.1356203
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9495
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    646,713      100.00      100.00
------------+-----------------------------------
      Total |    646,713      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    215,571       33.33       33.33
          3 |    431,142       66.67      100.00
------------+-----------------------------------
      Total |    646,713      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(215,571 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(215,571 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(215,571 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005u not found)
file /tmp/St20945.00005u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        543       20.00       20.00
       1980 |        543       20.00       40.00
       1990 |        543       20.00       60.00
       2000 |        543       20.00       80.00
       2007 |        543       20.00      100.00
------------+-----------------------------------
      Total |      2,715      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,172 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(543 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(543 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,172 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(543 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(543 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,172 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(543 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,086
        from master                     1,086  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,629  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,086       40.00       40.00
            matched (3) |      1,629       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,715      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       543          0 |       543 
      1980 |         0        543 |       543 
      1990 |         0        543 |       543 
      2000 |         0        543 |       543 
      2007 |       543          0 |       543 
-----------+----------------------+----------
     Total |     1,086      1,629 |     2,715 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,086 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        542
                                                  Wald chi2(1)    =      57.28
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.735

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9247581   .1221861    -7.57   0.000    -1.164238   -.6852778
       _cons |  -.4737638   .1500704    -3.16   0.002    -.7678964   -.1796312
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        542
                                                  Wald chi2(1)    =     136.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0777
                                                  Root MSE        =     2.0986

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.106103    .094663   -11.68   0.000    -1.291639   -.9205665
       _cons |  -1.062344   .1966745    -5.40   0.000    -1.447819    -.676869
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,084
                                                  Wald chi2(2)    =     403.93
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1651
                                                  Root MSE        =     1.9316

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.058532   .0735147   -14.40   0.000    -1.202618   -.9144463
       y2000 |   -.819032   .1306138    -6.27   0.000     -1.07503   -.5630337
       _cons |  -.3311528   .1141308    -2.90   0.004    -.5548452   -.1074605
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9500
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    638,376      100.00      100.00
------------+-----------------------------------
      Total |    638,376      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    212,792       33.33       33.33
          3 |    425,584       66.67      100.00
------------+-----------------------------------
      Total |    638,376      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(212,792 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(212,792 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(212,792 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00005w not found)
file /tmp/St20945.00005w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        536       20.00       20.00
       1980 |        536       20.00       40.00
       1990 |        536       20.00       60.00
       2000 |        536       20.00       80.00
       2007 |        536       20.00      100.00
------------+-----------------------------------
      Total |      2,680      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,144 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(536 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(536 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,144 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(536 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(536 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,144 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(536 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,072
        from master                     1,072  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,608  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,072       40.00       40.00
            matched (3) |      1,608       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,680      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       536          0 |       536 
      1980 |         0        536 |       536 
      1990 |         0        536 |       536 
      2000 |         0        536 |       536 
      2007 |       536          0 |       536 
-----------+----------------------+----------
     Total |     1,072      1,608 |     2,680 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,072 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        535
                                                  Wald chi2(1)    =      54.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.7259

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9034177   .1222393    -7.39   0.000    -1.143002    -.663833
       _cons |  -.4967873   .1502028    -3.31   0.001    -.7911794   -.2023953
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        535
                                                  Wald chi2(1)    =     130.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0891
                                                  Root MSE        =     2.0506

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.064104   .0931414   -11.42   0.000    -1.246658     -.88155
       _cons |  -1.141343   .1935168    -5.90   0.000    -1.520629    -.762057
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,070
                                                  Wald chi2(2)    =     397.52
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1747
                                                  Root MSE        =      1.901

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.022019   .0728378   -14.03   0.000    -1.164779     -.87926
       y2000 |   -.848757   .1293847    -6.56   0.000    -1.102346   -.5951677
       _cons |  -.3703083   .1130846    -3.27   0.001      -.59195   -.1486667
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9505
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    625,275      100.00      100.00
------------+-----------------------------------
      Total |    625,275      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    208,425       33.33       33.33
          3 |    416,850       66.67      100.00
------------+-----------------------------------
      Total |    625,275      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(208,425 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(208,425 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(208,425 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000060 not found)
file /tmp/St20945.000060 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        525       20.00       20.00
       1980 |        525       20.00       40.00
       1990 |        525       20.00       60.00
       2000 |        525       20.00       80.00
       2007 |        525       20.00      100.00
------------+-----------------------------------
      Total |      2,625      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,100 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(525 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(525 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,100 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(525 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(525 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,100 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(525 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,050
        from master                     1,050  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,575  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,050       40.00       40.00
            matched (3) |      1,575       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,625      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       525          0 |       525 
      1980 |         0        525 |       525 
      1990 |         0        525 |       525 
      2000 |         0        525 |       525 
      2007 |       525          0 |       525 
-----------+----------------------+----------
     Total |     1,050      1,575 |     2,625 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,050 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        524
                                                  Wald chi2(1)    =      53.13
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6935

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8845106   .1213433    -7.29   0.000    -1.122339   -.6466822
       _cons |   -.519995   .1490189    -3.49   0.000    -.8120667   -.2279234
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        524
                                                  Wald chi2(1)    =     128.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0957
                                                  Root MSE        =     2.0327

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.055184   .0932272   -11.32   0.000    -1.237906   -.8724617
       _cons |  -1.161498   .1936472    -6.00   0.000     -1.54104   -.7819568
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,048
                                                  Wald chi2(2)    =     395.14
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1834
                                                  Root MSE        =     1.8767

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.01061   .0726474   -13.91   0.000    -1.152996   -.8682233
       y2000 |  -.8582106   .1290448    -6.65   0.000    -1.111134   -.6052874
       _cons |   -.385567     .11278    -3.42   0.001    -.6066118   -.1645221
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9510
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    614,556      100.00      100.00
------------+-----------------------------------
      Total |    614,556      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    204,852       33.33       33.33
          3 |    409,704       66.67      100.00
------------+-----------------------------------
      Total |    614,556      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(204,852 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(204,852 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(204,852 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000062 not found)
file /tmp/St20945.000062 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        516       20.00       20.00
       1980 |        516       20.00       40.00
       1990 |        516       20.00       60.00
       2000 |        516       20.00       80.00
       2007 |        516       20.00      100.00
------------+-----------------------------------
      Total |      2,580      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,064 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(516 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(516 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,064 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(516 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(516 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,064 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(516 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,032
        from master                     1,032  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,548  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,032       40.00       40.00
            matched (3) |      1,548       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,580      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       516          0 |       516 
      1980 |         0        516 |       516 
      1990 |         0        516 |       516 
      2000 |         0        516 |       516 
      2007 |       516          0 |       516 
-----------+----------------------+----------
     Total |     1,032      1,548 |     2,580 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,032 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        515
                                                  Wald chi2(1)    =      52.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6888

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8831838   .1222071    -7.23   0.000    -1.122705   -.6436623
       _cons |  -.5206597   .1501443    -3.47   0.001    -.8149372   -.2263822
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        515
                                                  Wald chi2(1)    =     126.30
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0948
                                                  Root MSE        =     2.0253

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.053844   .0937726   -11.24   0.000    -1.237635   -.8700531
       _cons |  -1.162253   .1948424    -5.97   0.000    -1.544137   -.7803691
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,030
                                                  Wald chi2(2)    =     390.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1841
                                                  Root MSE        =     1.8703

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.009257   .0730923   -13.81   0.000    -1.152515   -.8659987
       y2000 |  -.8584762   .1297483    -6.62   0.000    -1.112778   -.6041742
       _cons |  -.3861309     .11347    -3.40   0.001     -.608528   -.1637338
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9515
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    607,410      100.00      100.00
------------+-----------------------------------
      Total |    607,410      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    202,470       33.33       33.33
          3 |    404,940       66.67      100.00
------------+-----------------------------------
      Total |    607,410      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(202,470 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(202,470 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(202,470 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000064 not found)
file /tmp/St20945.000064 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        510       20.00       20.00
       1980 |        510       20.00       40.00
       1990 |        510       20.00       60.00
       2000 |        510       20.00       80.00
       2007 |        510       20.00      100.00
------------+-----------------------------------
      Total |      2,550      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(2,040 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(510 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(510 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(2,040 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(510 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(510 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(2,040 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(510 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,020
        from master                     1,020  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,530  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |      1,020       40.00       40.00
            matched (3) |      1,530       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,550      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       510          0 |       510 
      1980 |         0        510 |       510 
      1990 |         0        510 |       510 
      2000 |         0        510 |       510 
      2007 |       510          0 |       510 
-----------+----------------------+----------
     Total |     1,020      1,530 |     2,550 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(1,020 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        509
                                                  Wald chi2(1)    =      52.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.679

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8995538   .1235804    -7.28   0.000    -1.141767   -.6573406
       _cons |  -.5047039    .151367    -3.33   0.001    -.8013777     -.20803
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        509
                                                  Wald chi2(1)    =     123.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0918
                                                  Root MSE        =     2.0175

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.050804   .0943701   -11.13   0.000    -1.235766   -.8658417
       _cons |  -1.168514   .1959329    -5.96   0.000    -1.552535   -.7844923
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =      1,018
                                                  Wald chi2(2)    =     388.07
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1862
                                                  Root MSE        =     1.8604

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.011409   .0735782   -13.75   0.000     -1.15562   -.8671988
       y2000 |  -.8558883        .13    -6.58   0.000    -1.110684   -.6010929
       _cons |  -.3854012   .1138351    -3.39   0.001    -.6085138   -.1622885
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9520
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    590,736      100.00      100.00
------------+-----------------------------------
      Total |    590,736      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    196,912       33.33       33.33
          3 |    393,824       66.67      100.00
------------+-----------------------------------
      Total |    590,736      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(196,912 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(196,912 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(196,912 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000066 not found)
file /tmp/St20945.000066 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        496       20.00       20.00
       1980 |        496       20.00       40.00
       1990 |        496       20.00       60.00
       2000 |        496       20.00       80.00
       2007 |        496       20.00      100.00
------------+-----------------------------------
      Total |      2,480      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,984 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(496 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(496 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,984 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(496 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(496 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,984 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(496 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           992
        from master                       992  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,488  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        992       40.00       40.00
            matched (3) |      1,488       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,480      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       496          0 |       496 
      1980 |         0        496 |       496 
      1990 |         0        496 |       496 
      2000 |         0        496 |       496 
      2007 |       496          0 |       496 
-----------+----------------------+----------
     Total |       992      1,488 |     2,480 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(992 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        495
                                                  Wald chi2(1)    =      51.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6639

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.898403   .1257669    -7.14   0.000    -1.144902   -.6519044
       _cons |  -.5074985   .1536129    -3.30   0.001    -.8085743   -.2064228
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        495
                                                  Wald chi2(1)    =     121.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0988
                                                  Root MSE        =     2.0026

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.049756   .0951913   -11.03   0.000    -1.236328   -.8631847
       _cons |  -1.169182   .1978467    -5.91   0.000    -1.556955   -.7814098
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        990
                                                  Wald chi2(2)    =     381.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1930
                                                  Root MSE        =     1.8452

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -1.0106   .0743616   -13.59   0.000    -1.156346   -.8648544
       y2000 |  -.8538585   .1309794    -6.52   0.000    -1.110573   -.5971437
       _cons |  -.3877962    .114772    -3.38   0.001    -.6127452   -.1628473
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9525
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    581,208      100.00      100.00
------------+-----------------------------------
      Total |    581,208      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    193,736       33.33       33.33
          3 |    387,472       66.67      100.00
------------+-----------------------------------
      Total |    581,208      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(193,736 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(193,736 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(193,736 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000068 not found)
file /tmp/St20945.000068 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        488       20.00       20.00
       1980 |        488       20.00       40.00
       1990 |        488       20.00       60.00
       2000 |        488       20.00       80.00
       2007 |        488       20.00      100.00
------------+-----------------------------------
      Total |      2,440      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,952 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(488 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(488 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,952 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(488 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(488 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,952 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(488 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           976
        from master                       976  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,464  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        976       40.00       40.00
            matched (3) |      1,464       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,440      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       488          0 |       488 
      1980 |         0        488 |       488 
      1990 |         0        488 |       488 
      2000 |         0        488 |       488 
      2007 |       488          0 |       488 
-----------+----------------------+----------
     Total |       976      1,464 |     2,440 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(976 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        487
                                                  Wald chi2(1)    =      50.90
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.653

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9021442   .1264506    -7.13   0.000    -1.149983   -.6543056
       _cons |  -.5082607   .1543668    -3.29   0.001     -.810814   -.2057073
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        487
                                                  Wald chi2(1)    =     117.76
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0989
                                                  Root MSE        =     1.9947

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.041667   .0959891   -10.85   0.000    -1.229802   -.8535314
       _cons |  -1.186053   .1994532    -5.95   0.000    -1.576974   -.7951317
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        974
                                                  Wald chi2(2)    =     375.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1941
                                                  Root MSE        =     1.8357

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.00544   .0748782   -13.43   0.000    -1.152198    -.858681
       y2000 |   -.855153   .1315019    -6.50   0.000    -1.112892   -.5974142
       _cons |  -.3980015   .1153593    -3.45   0.001    -.6241017   -.1719014
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9530
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    571,680      100.00      100.00
------------+-----------------------------------
      Total |    571,680      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    190,560       33.33       33.33
          3 |    381,120       66.67      100.00
------------+-----------------------------------
      Total |    571,680      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(190,560 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(190,560 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(190,560 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006a not found)
file /tmp/St20945.00006a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        480       20.00       20.00
       1980 |        480       20.00       40.00
       1990 |        480       20.00       60.00
       2000 |        480       20.00       80.00
       2007 |        480       20.00      100.00
------------+-----------------------------------
      Total |      2,400      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,920 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(480 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(480 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,920 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(480 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(480 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,920 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(480 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           960
        from master                       960  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,440  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        960       40.00       40.00
            matched (3) |      1,440       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,400      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       480          0 |       480 
      1980 |         0        480 |       480 
      1990 |         0        480 |       480 
      2000 |         0        480 |       480 
      2007 |       480          0 |       480 
-----------+----------------------+----------
     Total |       960      1,440 |     2,400 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(960 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        479
                                                  Wald chi2(1)    =      49.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6401

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8906027   .1264821    -7.04   0.000    -1.138503   -.6427023
       _cons |  -.5237981   .1544144    -3.39   0.001    -.8264448   -.2211513
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        479
                                                  Wald chi2(1)    =     116.18
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0970
                                                  Root MSE        =     1.9912

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.052313   .0976308   -10.78   0.000    -1.243666   -.8609603
       _cons |  -1.167158   .2024252    -5.77   0.000    -1.563904   -.7704115
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        958
                                                  Wald chi2(2)    =     370.87
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1955
                                                  Root MSE        =      1.828

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.009646   .0757411   -13.33   0.000    -1.158095   -.8611958
       y2000 |  -.8494558    .132231    -6.42   0.000    -1.108624   -.5902877
       _cons |  -.3967284    .116244    -3.41   0.001    -.6245623   -.1688944
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9535
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    564,534      100.00      100.00
------------+-----------------------------------
      Total |    564,534      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    188,178       33.33       33.33
          3 |    376,356       66.67      100.00
------------+-----------------------------------
      Total |    564,534      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(188,178 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(188,178 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(188,178 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006c not found)
file /tmp/St20945.00006c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        474       20.00       20.00
       1980 |        474       20.00       40.00
       1990 |        474       20.00       60.00
       2000 |        474       20.00       80.00
       2007 |        474       20.00      100.00
------------+-----------------------------------
      Total |      2,370      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,896 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(474 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(474 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,896 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(474 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(474 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,896 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(474 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           948
        from master                       948  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,422  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        948       40.00       40.00
            matched (3) |      1,422       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,370      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       474          0 |       474 
      1980 |         0        474 |       474 
      1990 |         0        474 |       474 
      2000 |         0        474 |       474 
      2007 |       474          0 |       474 
-----------+----------------------+----------
     Total |       948      1,422 |     2,370 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(948 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        473
                                                  Wald chi2(1)    =      49.33
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6365

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8921653   .1270219    -7.02   0.000    -1.141124   -.6432068
       _cons |  -.5240837   .1551056    -3.38   0.001     -.828085   -.2200824
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        473
                                                  Wald chi2(1)    =     114.74
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0967
                                                  Root MSE        =     1.9869

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.051511   .0981638   -10.71   0.000    -1.243909   -.8591138
       _cons |  -1.168879   .2034187    -5.75   0.000    -1.567572   -.7701854
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        946
                                                  Wald chi2(2)    =     366.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1948
                                                  Root MSE        =     1.8241

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.009448   .0761339   -13.26   0.000    -1.158668   -.8602287
       y2000 |   -.847906   .1327729    -6.39   0.000    -1.108136   -.5876759
       _cons |  -.3988523   .1168025    -3.41   0.001    -.6277811   -.1699235
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9540
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    557,388      100.00      100.00
------------+-----------------------------------
      Total |    557,388      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    185,796       33.33       33.33
          3 |    371,592       66.67      100.00
------------+-----------------------------------
      Total |    557,388      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(185,796 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(185,796 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(185,796 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006e not found)
file /tmp/St20945.00006e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        468       20.00       20.00
       1980 |        468       20.00       40.00
       1990 |        468       20.00       60.00
       2000 |        468       20.00       80.00
       2007 |        468       20.00      100.00
------------+-----------------------------------
      Total |      2,340      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,872 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(468 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(468 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,872 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(468 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(468 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,872 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(468 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           936
        from master                       936  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,404  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        936       40.00       40.00
            matched (3) |      1,404       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,340      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       468          0 |       468 
      1980 |         0        468 |       468 
      1990 |         0        468 |       468 
      2000 |         0        468 |       468 
      2007 |       468          0 |       468 
-----------+----------------------+----------
     Total |       936      1,404 |     2,340 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(936 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        467
                                                  Wald chi2(1)    =      50.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6109

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8972181   .1268524    -7.07   0.000    -1.145844   -.6485919
       _cons |  -.5190323   .1547927    -3.35   0.001    -.8224204   -.2156441
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        467
                                                  Wald chi2(1)    =     116.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0872
                                                  Root MSE        =     1.9817

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.071163   .0991615   -10.80   0.000    -1.265516   -.8768096
       _cons |  -1.134674   .2056231    -5.52   0.000    -1.537688   -.7316603
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        934
                                                  Wald chi2(2)    =     372.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1976
                                                  Root MSE        =     1.8088

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.025155   .0764905   -13.40   0.000    -1.175073   -.8752361
       y2000 |  -.8378519    .132783    -6.31   0.000    -1.098102   -.5776021
       _cons |  -.3822122   .1170357    -3.27   0.001    -.6115979   -.1528265
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9545
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    546,669      100.00      100.00
------------+-----------------------------------
      Total |    546,669      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    182,223       33.33       33.33
          3 |    364,446       66.67      100.00
------------+-----------------------------------
      Total |    546,669      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(182,223 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(182,223 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(182,223 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006g not found)
file /tmp/St20945.00006g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        459       20.00       20.00
       1980 |        459       20.00       40.00
       1990 |        459       20.00       60.00
       2000 |        459       20.00       80.00
       2007 |        459       20.00      100.00
------------+-----------------------------------
      Total |      2,295      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,836 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(459 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(459 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,836 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(459 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(459 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,836 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(459 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           918
        from master                       918  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,377  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        918       40.00       40.00
            matched (3) |      1,377       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,295      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       459          0 |       459 
      1980 |         0        459 |       459 
      1990 |         0        459 |       459 
      2000 |         0        459 |       459 
      2007 |       459          0 |       459 
-----------+----------------------+----------
     Total |       918      1,377 |     2,295 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(918 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        458
                                                  Wald chi2(1)    =      48.95
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.6075

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.90902   .1299302    -7.00   0.000    -1.163678   -.6543615
       _cons |  -.5062587   .1577936    -3.21   0.001    -.8155285   -.1969888
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        458
                                                  Wald chi2(1)    =     114.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0862
                                                  Root MSE        =     1.9734

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.070403   .1000176   -10.70   0.000    -1.266434   -.8743718
       _cons |  -1.135628   .2072097    -5.48   0.000    -1.541752   -.7295043
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        916
                                                  Wald chi2(2)    =     366.83
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1989
                                                  Root MSE        =     1.8022

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.028173   .0774642   -13.27   0.000    -1.180001   -.8763463
       y2000 |  -.8349755   .1337971    -6.24   0.000    -1.097213    -.572738
       _cons |  -.3789997   .1180516    -3.21   0.001    -.6103765   -.1476228
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9550
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    535,950      100.00      100.00
------------+-----------------------------------
      Total |    535,950      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    178,650       33.33       33.33
          3 |    357,300       66.67      100.00
------------+-----------------------------------
      Total |    535,950      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(178,650 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(178,650 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(178,650 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006i not found)
file /tmp/St20945.00006i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        450       20.00       20.00
       1980 |        450       20.00       40.00
       1990 |        450       20.00       60.00
       2000 |        450       20.00       80.00
       2007 |        450       20.00      100.00
------------+-----------------------------------
      Total |      2,250      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,800 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(450 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(450 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,800 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(450 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(450 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,800 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(450 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           900
        from master                       900  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,350  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        900       40.00       40.00
            matched (3) |      1,350       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,250      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       450          0 |       450 
      1980 |         0        450 |       450 
      1990 |         0        450 |       450 
      2000 |         0        450 |       450 
      2007 |       450          0 |       450 
-----------+----------------------+----------
     Total |       900      1,350 |     2,250 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(900 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        449
                                                  Wald chi2(1)    =      48.02
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.602

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9043231    .130496    -6.93   0.000    -1.160091   -.6485556
       _cons |  -.5155619   .1585168    -3.25   0.001    -.8262491   -.2048746
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        449
                                                  Wald chi2(1)    =     112.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0863
                                                  Root MSE        =     1.9705

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.071266   .1008884   -10.62   0.000    -1.269003   -.8735282
       _cons |  -1.133968   .2089534    -5.43   0.000    -1.543509    -.724427
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        898
                                                  Wald chi2(2)    =     360.06
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1982
                                                  Root MSE        =     1.7982

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.027546    .078037   -13.17   0.000    -1.180496   -.8745964
       y2000 |  -.8310551   .1348187    -6.16   0.000    -1.095295   -.5668153
       _cons |  -.3840007   .1189273    -3.23   0.001     -.617094   -.1509074
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9555
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    529,995      100.00      100.00
------------+-----------------------------------
      Total |    529,995      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    176,665       33.33       33.33
          3 |    353,330       66.67      100.00
------------+-----------------------------------
      Total |    529,995      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(176,665 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(176,665 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(176,665 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006k not found)
file /tmp/St20945.00006k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        445       20.00       20.00
       1980 |        445       20.00       40.00
       1990 |        445       20.00       60.00
       2000 |        445       20.00       80.00
       2007 |        445       20.00      100.00
------------+-----------------------------------
      Total |      2,225      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,780 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(445 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(445 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,780 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(445 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(445 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,780 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(445 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           890
        from master                       890  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,335  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        890       40.00       40.00
            matched (3) |      1,335       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,225      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       445          0 |       445 
      1980 |         0        445 |       445 
      1990 |         0        445 |       445 
      2000 |         0        445 |       445 
      2007 |       445          0 |       445 
-----------+----------------------+----------
     Total |       890      1,335 |     2,225 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(890 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        444
                                                  Wald chi2(1)    =      46.30
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.595

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8885114   .1305774    -6.80   0.000    -1.144438   -.6325844
       _cons |  -.5322458   .1586972    -3.35   0.001    -.8432866    -.221205
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        444
                                                  Wald chi2(1)    =     109.54
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0893
                                                  Root MSE        =     1.9596

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.057488   .1010386   -10.47   0.000     -1.25552    -.859456
       _cons |  -1.160967   .2092296    -5.55   0.000    -1.571049   -.7508841
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        888
                                                  Wald chi2(2)    =     354.88
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2016
                                                  Root MSE        =     1.7892

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.013112   .0781484   -12.96   0.000     -1.16628   -.8599437
       y2000 |  -.8441358   .1349077    -6.26   0.000     -1.10855   -.5797215
       _cons |  -.3991489    .119072    -3.35   0.001    -.6325258   -.1657719
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9560
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    520,467      100.00      100.00
------------+-----------------------------------
      Total |    520,467      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    173,489       33.33       33.33
          3 |    346,978       66.67      100.00
------------+-----------------------------------
      Total |    520,467      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(173,489 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(173,489 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(173,489 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006m not found)
file /tmp/St20945.00006m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        437       20.00       20.00
       1980 |        437       20.00       40.00
       1990 |        437       20.00       60.00
       2000 |        437       20.00       80.00
       2007 |        437       20.00      100.00
------------+-----------------------------------
      Total |      2,185      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,748 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(437 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(437 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,748 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(437 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(437 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,748 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(437 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           874
        from master                       874  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,311  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        874       40.00       40.00
            matched (3) |      1,311       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,185      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       437          0 |       437 
      1980 |         0        437 |       437 
      1990 |         0        437 |       437 
      2000 |         0        437 |       437 
      2007 |       437          0 |       437 
-----------+----------------------+----------
     Total |       874      1,311 |     2,185 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(874 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        436
                                                  Wald chi2(1)    =      45.00
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5853

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8777254   .1308367    -6.71   0.000    -1.134161     -.62129
       _cons |  -.5462952   .1590291    -3.44   0.001    -.8579866   -.2346039
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        436
                                                  Wald chi2(1)    =     108.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0954
                                                  Root MSE        =     1.9341

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.052327   .1008986   -10.43   0.000    -1.250084   -.8545691
       _cons |   -1.17269   .2087865    -5.62   0.000    -1.581904   -.7634758
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        872
                                                  Wald chi2(2)    =     352.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2069
                                                  Root MSE        =     1.7711

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.006426   .0781973   -12.87   0.000     -1.15969   -.8531622
       y2000 |  -.8489707   .1348008    -6.30   0.000    -1.113176    -.584766
       _cons |   -.408841   .1190355    -3.43   0.001    -.6421463   -.1755358
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9565
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    504,984      100.00      100.00
------------+-----------------------------------
      Total |    504,984      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    168,328       33.33       33.33
          3 |    336,656       66.67      100.00
------------+-----------------------------------
      Total |    504,984      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(168,328 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(168,328 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(168,328 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006o not found)
file /tmp/St20945.00006o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        424       20.00       20.00
       1980 |        424       20.00       40.00
       1990 |        424       20.00       60.00
       2000 |        424       20.00       80.00
       2007 |        424       20.00      100.00
------------+-----------------------------------
      Total |      2,120      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,696 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(424 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(424 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,696 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(424 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(424 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,696 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(424 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           848
        from master                       848  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,272  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        848       40.00       40.00
            matched (3) |      1,272       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,120      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       424          0 |       424 
      1980 |         0        424 |       424 
      1990 |         0        424 |       424 
      2000 |         0        424 |       424 
      2007 |       424          0 |       424 
-----------+----------------------+----------
     Total |       848      1,272 |     2,120 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(848 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        423
                                                  Wald chi2(1)    =      39.95
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5593

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8220798   .1300583    -6.32   0.000    -1.076989   -.5671703
       _cons |  -.6092922   .1585286    -3.84   0.000    -.9200025   -.2985819
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        423
                                                  Wald chi2(1)    =     117.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0936
                                                  Root MSE        =     1.9204

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.061171   .0978504   -10.84   0.000    -1.252954   -.8693873
       _cons |   -1.15675   .2041125    -5.67   0.000    -1.556803   -.7566967
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        846
                                                  Wald chi2(2)    =     355.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2098
                                                  Root MSE        =     1.7525

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9984016   .0762185   -13.10   0.000    -1.147787   -.8490161
       y2000 |  -.8526372   .1345204    -6.34   0.000    -1.116292   -.5889819
       _cons |  -.4205433   .1179727    -3.56   0.000    -.6517657    -.189321
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9570
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    499,029      100.00      100.00
------------+-----------------------------------
      Total |    499,029      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    166,343       33.33       33.33
          3 |    332,686       66.67      100.00
------------+-----------------------------------
      Total |    499,029      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(166,343 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(166,343 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(166,343 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006q not found)
file /tmp/St20945.00006q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        419       20.00       20.00
       1980 |        419       20.00       40.00
       1990 |        419       20.00       60.00
       2000 |        419       20.00       80.00
       2007 |        419       20.00      100.00
------------+-----------------------------------
      Total |      2,095      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,676 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(419 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(419 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,676 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(419 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(419 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,676 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(419 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           838
        from master                       838  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,257  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        838       40.00       40.00
            matched (3) |      1,257       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,095      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       419          0 |       419 
      1980 |         0        419 |       419 
      1990 |         0        419 |       419 
      2000 |         0        419 |       419 
      2007 |       419          0 |       419 
-----------+----------------------+----------
     Total |       838      1,257 |     2,095 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(838 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        418
                                                  Wald chi2(1)    =      41.85
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5147

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8241406   .1273978    -6.47   0.000    -1.073836   -.5744455
       _cons |   -.608917   .1551135    -3.93   0.000    -.9129339   -.3049001
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        418
                                                  Wald chi2(1)    =     115.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0915
                                                  Root MSE        =     1.9175

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.060677   .0986742   -10.75   0.000    -1.254075   -.8672793
       _cons |  -1.157778   .2056182    -5.63   0.000    -1.560783   -.7547742
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        836
                                                  Wald chi2(2)    =     358.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2128
                                                  Root MSE        =     1.7309

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9984101   .0759975   -13.14   0.000    -1.147363   -.8494577
       y2000 |  -.8507459    .133762    -6.36   0.000    -1.112914   -.5885772
       _cons |  -.4225021   .1173735    -3.60   0.000    -.6525499   -.1924543
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9575
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    493,074      100.00      100.00
------------+-----------------------------------
      Total |    493,074      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    164,358       33.33       33.33
          3 |    328,716       66.67      100.00
------------+-----------------------------------
      Total |    493,074      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(164,358 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(164,358 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(164,358 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006s not found)
file /tmp/St20945.00006s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        414       20.00       20.00
       1980 |        414       20.00       40.00
       1990 |        414       20.00       60.00
       2000 |        414       20.00       80.00
       2007 |        414       20.00      100.00
------------+-----------------------------------
      Total |      2,070      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,656 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(414 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(414 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,656 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(414 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(414 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,656 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(414 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           828
        from master                       828  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,242  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        828       40.00       40.00
            matched (3) |      1,242       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,070      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       414          0 |       414 
      1980 |         0        414 |       414 
      1990 |         0        414 |       414 
      2000 |         0        414 |       414 
      2007 |       414          0 |       414 
-----------+----------------------+----------
     Total |       828      1,242 |     2,070 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(828 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        413
                                                  Wald chi2(1)    =      41.55
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5111

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8239181     .12782    -6.45   0.000    -1.074441   -.5733954
       _cons |  -.6085523   .1556555    -3.91   0.000    -.9136315   -.3034731
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        413
                                                  Wald chi2(1)    =     114.57
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0916
                                                  Root MSE        =     1.9145

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.058787   .0989167   -10.70   0.000     -1.25266   -.8649133
       _cons |  -1.161285   .2062258    -5.63   0.000     -1.56548   -.7570897
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        826
                                                  Wald chi2(2)    =     356.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2133
                                                  Root MSE        =     1.7277

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9968232   .0761905   -13.08   0.000    -1.146154   -.8474926
       y2000 |  -.8526308    .134276    -6.35   0.000    -1.115807   -.5894546
       _cons |  -.4235707   .1177786    -3.60   0.000    -.6544125    -.192729
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9580
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    489,501      100.00      100.00
------------+-----------------------------------
      Total |    489,501      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    163,167       33.33       33.33
          3 |    326,334       66.67      100.00
------------+-----------------------------------
      Total |    489,501      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(163,167 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(163,167 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(163,167 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006u not found)
file /tmp/St20945.00006u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        411       20.00       20.00
       1980 |        411       20.00       40.00
       1990 |        411       20.00       60.00
       2000 |        411       20.00       80.00
       2007 |        411       20.00      100.00
------------+-----------------------------------
      Total |      2,055      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,644 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(411 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(411 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,644 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(411 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(411 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,644 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(411 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           822
        from master                       822  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,233  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        822       40.00       40.00
            matched (3) |      1,233       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,055      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       411          0 |       411 
      1980 |         0        411 |       411 
      1990 |         0        411 |       411 
      2000 |         0        411 |       411 
      2007 |       411          0 |       411 
-----------+----------------------+----------
     Total |       822      1,233 |     2,055 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(822 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        410
                                                  Wald chi2(1)    =      44.78
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5119

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8346997   .1247413    -6.69   0.000    -1.079188   -.5902113
       _cons |  -.5981865   .1529455    -3.91   0.000    -.8979542   -.2984188
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        410
                                                  Wald chi2(1)    =     113.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0920
                                                  Root MSE        =     1.9065

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.056218    .099093   -10.66   0.000    -1.250437   -.8619998
       _cons |  -1.168143   .2065328    -5.66   0.000     -1.57294   -.7633462
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        820
                                                  Wald chi2(2)    =     357.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2134
                                                  Root MSE        =     1.7237

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9979222   .0758861   -13.15   0.000    -1.146656   -.8491882
       y2000 |  -.8527567   .1343207    -6.35   0.000     -1.11602    -.589493
       _cons |  -.4235291   .1176459    -3.60   0.000    -.6541107   -.1929474
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9585
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    483,546      100.00      100.00
------------+-----------------------------------
      Total |    483,546      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    161,182       33.33       33.33
          3 |    322,364       66.67      100.00
------------+-----------------------------------
      Total |    483,546      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(161,182 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(161,182 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(161,182 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00006w not found)
file /tmp/St20945.00006w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        406       20.00       20.00
       1980 |        406       20.00       40.00
       1990 |        406       20.00       60.00
       2000 |        406       20.00       80.00
       2007 |        406       20.00      100.00
------------+-----------------------------------
      Total |      2,030      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,624 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(406 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(406 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,624 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(406 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(406 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,624 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(406 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           812
        from master                       812  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,218  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        812       40.00       40.00
            matched (3) |      1,218       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,030      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       406          0 |       406 
      1980 |         0        406 |       406 
      1990 |         0        406 |       406 
      2000 |         0        406 |       406 
      2007 |       406          0 |       406 
-----------+----------------------+----------
     Total |       812      1,218 |     2,030 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(812 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        405
                                                  Wald chi2(1)    =      42.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5045

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8195794   .1251155    -6.55   0.000    -1.064801   -.5743575
       _cons |  -.6152895   .1532665    -4.01   0.000    -.9156864   -.3148926
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        405
                                                  Wald chi2(1)    =     111.81
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0887
                                                  Root MSE        =     1.9019

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.058908   .1001433   -10.57   0.000    -1.255185   -.8626308
       _cons |  -1.165667   .2083926    -5.59   0.000    -1.574109   -.7572253
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        810
                                                  Wald chi2(2)    =     353.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2137
                                                  Root MSE        =     1.7178

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.995897   .0765192   -13.01   0.000    -1.145872   -.8459221
       y2000 |  -.8557957   .1348429    -6.35   0.000    -1.120083   -.5915085
       _cons |   -.426736   .1182457    -3.61   0.000    -.6584934   -.1949786
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9590
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    481,164      100.00      100.00
------------+-----------------------------------
      Total |    481,164      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    160,388       33.33       33.33
          3 |    320,776       66.67      100.00
------------+-----------------------------------
      Total |    481,164      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(160,388 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(160,388 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(160,388 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000070 not found)
file /tmp/St20945.000070 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        404       20.00       20.00
       1980 |        404       20.00       40.00
       1990 |        404       20.00       60.00
       2000 |        404       20.00       80.00
       2007 |        404       20.00      100.00
------------+-----------------------------------
      Total |      2,020      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,616 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(404 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(404 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,616 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(404 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(404 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,616 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(404 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           808
        from master                       808  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,212  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        808       40.00       40.00
            matched (3) |      1,212       60.00      100.00
------------------------+-----------------------------------
                  Total |      2,020      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       404          0 |       404 
      1980 |         0        404 |       404 
      1990 |         0        404 |       404 
      2000 |         0        404 |       404 
      2007 |       404          0 |       404 
-----------+----------------------+----------
     Total |       808      1,212 |     2,020 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(808 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        403
                                                  Wald chi2(1)    =      43.63
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.5048

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8453382    .127979    -6.61   0.000    -1.096173    -.594504
       _cons |  -.5897698   .1559921    -3.78   0.000    -.8955088   -.2840308
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        403
                                                  Wald chi2(1)    =     111.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0873
                                                  Root MSE        =      1.902

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.060438   .1005792   -10.54   0.000     -1.25757   -.8633068
       _cons |  -1.163453   .2092317    -5.56   0.000    -1.573539   -.7533659
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        806
                                                  Wald chi2(2)    =     352.34
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2129
                                                  Root MSE        =     1.7177

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.004817   .0772151   -13.01   0.000    -1.156155   -.8534777
       y2000 |  -.8473201   .1353669    -6.26   0.000    -1.112634   -.5820059
       _cons |  -.4192978   .1188854    -3.53   0.000    -.6523088   -.1862867
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9595
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    469,254      100.00      100.00
------------+-----------------------------------
      Total |    469,254      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    156,418       33.33       33.33
          3 |    312,836       66.67      100.00
------------+-----------------------------------
      Total |    469,254      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(156,418 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(156,418 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(156,418 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000072 not found)
file /tmp/St20945.000072 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        394       20.00       20.00
       1980 |        394       20.00       40.00
       1990 |        394       20.00       60.00
       2000 |        394       20.00       80.00
       2007 |        394       20.00      100.00
------------+-----------------------------------
      Total |      1,970      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,576 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(394 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(394 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,576 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(394 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(394 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,576 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(394 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           788
        from master                       788  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,182  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        788       40.00       40.00
            matched (3) |      1,182       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,970      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       394          0 |       394 
      1980 |         0        394 |       394 
      1990 |         0        394 |       394 
      2000 |         0        394 |       394 
      2007 |       394          0 |       394 
-----------+----------------------+----------
     Total |       788      1,182 |     1,970 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(788 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        393
                                                  Wald chi2(1)    =      41.05
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4958

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8390078   .1309564    -6.41   0.000    -1.095678    -.582338
       _cons |  -.5967092   .1588426    -3.76   0.000     -.908035   -.2853835
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        393
                                                  Wald chi2(1)    =     106.80
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0898
                                                  Root MSE        =     1.8866

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.046224   .1012389   -10.33   0.000    -1.244648    -.847799
       _cons |   -1.18841    .210402    -5.65   0.000     -1.60079   -.7760296
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        786
                                                  Wald chi2(2)    =     342.56
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2149
                                                  Root MSE        =     1.7054

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9934826   .0780907   -12.72   0.000    -1.146538   -.8404277
       y2000 |  -.8543379   .1362697    -6.27   0.000    -1.121422   -.5872541
       _cons |  -.4318289   .1197814    -3.61   0.000    -.6665961   -.1970616
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9600
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    464,490      100.00      100.00
------------+-----------------------------------
      Total |    464,490      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    154,830       33.33       33.33
          3 |    309,660       66.67      100.00
------------+-----------------------------------
      Total |    464,490      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(154,830 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(154,830 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(154,830 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000074 not found)
file /tmp/St20945.000074 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        390       20.00       20.00
       1980 |        390       20.00       40.00
       1990 |        390       20.00       60.00
       2000 |        390       20.00       80.00
       2007 |        390       20.00      100.00
------------+-----------------------------------
      Total |      1,950      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,560 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(390 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(390 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,560 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(390 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(390 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,560 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(390 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           780
        from master                       780  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,170  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        780       40.00       40.00
            matched (3) |      1,170       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,950      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       390          0 |       390 
      1980 |         0        390 |       390 
      1990 |         0        390 |       390 
      2000 |         0        390 |       390 
      2007 |       390          0 |       390 
-----------+----------------------+----------
     Total |       780      1,170 |     1,950 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(780 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        389
                                                  Wald chi2(1)    =      40.06
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4942

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8519804   .1346057    -6.33   0.000    -1.115803    -.588158
       _cons |  -.5840566   .1621036    -3.60   0.000    -.9017739   -.2663394
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        389
                                                  Wald chi2(1)    =     104.96
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0885
                                                  Root MSE        =      1.885

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.044457   .1019483   -10.24   0.000    -1.244272   -.8446418
       _cons |  -1.192065   .2116817    -5.63   0.000    -1.606954   -.7771767
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        778
                                                  Wald chi2(2)    =     338.41
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2153
                                                  Root MSE        =     1.7032

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9963778   .0790241   -12.61   0.000    -1.151262   -.8414933
       y2000 |  -.8508196   .1370883    -6.21   0.000    -1.119508   -.5821315
       _cons |  -.4303205   .1205671    -3.57   0.000    -.6666276   -.1940133
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9605
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    456,153      100.00      100.00
------------+-----------------------------------
      Total |    456,153      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    152,051       33.33       33.33
          3 |    304,102       66.67      100.00
------------+-----------------------------------
      Total |    456,153      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(152,051 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(152,051 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(152,051 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000076 not found)
file /tmp/St20945.000076 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        383       20.00       20.00
       1980 |        383       20.00       40.00
       1990 |        383       20.00       60.00
       2000 |        383       20.00       80.00
       2007 |        383       20.00      100.00
------------+-----------------------------------
      Total |      1,915      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,532 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(383 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,532 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(383 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,532 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(383 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           766
        from master                       766  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,149  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        766       40.00       40.00
            matched (3) |      1,149       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,915      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       383          0 |       383 
      1980 |         0        383 |       383 
      1990 |         0        383 |       383 
      2000 |         0        383 |       383 
      2007 |       383          0 |       383 
-----------+----------------------+----------
     Total |       766      1,149 |     1,915 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(766 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        382
                                                  Wald chi2(1)    =      38.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4917

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8480765   .1358519    -6.24   0.000    -1.114341   -.5818117
       _cons |  -.5892323   .1635976    -3.60   0.000    -.9098776   -.2685869
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        382
                                                  Wald chi2(1)    =     103.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0875
                                                  Root MSE        =     1.8851

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.049248   .1032123   -10.17   0.000    -1.251541   -.8469558
       _cons |  -1.182068   .2141943    -5.52   0.000    -1.601881   -.7622552
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        764
                                                  Wald chi2(2)    =     332.16
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2146
                                                  Root MSE        =     1.7022

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.998944   .0799251   -12.50   0.000    -1.155594   -.8422937
       y2000 |   -.846747   .1383295    -6.12   0.000    -1.117868   -.5756262
       _cons |  -.4285341   .1217898    -3.52   0.000    -.6672377   -.1898305
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9610
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    450,198      100.00      100.00
------------+-----------------------------------
      Total |    450,198      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    150,066       33.33       33.33
          3 |    300,132       66.67      100.00
------------+-----------------------------------
      Total |    450,198      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(150,066 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(150,066 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(150,066 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000078 not found)
file /tmp/St20945.000078 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        378       20.00       20.00
       1980 |        378       20.00       40.00
       1990 |        378       20.00       60.00
       2000 |        378       20.00       80.00
       2007 |        378       20.00      100.00
------------+-----------------------------------
      Total |      1,890      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,512 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(378 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(378 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,512 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(378 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(378 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,512 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(378 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           756
        from master                       756  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,134  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        756       40.00       40.00
            matched (3) |      1,134       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,890      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       378          0 |       378 
      1980 |         0        378 |       378 
      1990 |         0        378 |       378 
      2000 |         0        378 |       378 
      2007 |       378          0 |       378 
-----------+----------------------+----------
     Total |       756      1,134 |     1,890 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(756 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        377
                                                  Wald chi2(1)    =      38.18
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4833

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8505158    .137655    -6.18   0.000    -1.120315   -.5807169
       _cons |  -.5900796   .1657174    -3.56   0.000    -.9148797   -.2652795
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        377
                                                  Wald chi2(1)    =     100.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0813
                                                  Root MSE        =     1.8801

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.046666   .1046525   -10.00   0.000    -1.251781   -.8415509
       _cons |  -1.196509   .2171003    -5.51   0.000    -1.622018   -.7710001
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        754
                                                  Wald chi2(2)    =     328.35
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2138
                                                  Root MSE        =     1.6956

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9977396     .08099   -12.32   0.000    -1.156477   -.8390021
       y2000 |  -.8545542   .1390326    -6.15   0.000    -1.127053   -.5820553
       _cons |  -.4327977   .1229336    -3.52   0.000    -.6737432   -.1918522
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9615
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    440,670      100.00      100.00
------------+-----------------------------------
      Total |    440,670      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    146,890       33.33       33.33
          3 |    293,780       66.67      100.00
------------+-----------------------------------
      Total |    440,670      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(146,890 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(146,890 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(146,890 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007a not found)
file /tmp/St20945.00007a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        370       20.00       20.00
       1980 |        370       20.00       40.00
       1990 |        370       20.00       60.00
       2000 |        370       20.00       80.00
       2007 |        370       20.00      100.00
------------+-----------------------------------
      Total |      1,850      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,480 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(370 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(370 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,480 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(370 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(370 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,480 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(370 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           740
        from master                       740  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,110  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        740       40.00       40.00
            matched (3) |      1,110       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,850      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       370          0 |       370 
      1980 |         0        370 |       370 
      1990 |         0        370 |       370 
      2000 |         0        370 |       370 
      2007 |       370          0 |       370 
-----------+----------------------+----------
     Total |       740      1,110 |     1,850 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(740 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        369
                                                  Wald chi2(1)    =      36.50
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4626

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8254812   .1366254    -6.04   0.000    -1.093262   -.5577002
       _cons |  -.6201698    .164573    -3.77   0.000    -.9427269   -.2976127
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        369
                                                  Wald chi2(1)    =     104.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1528
                                                  Root MSE        =      1.785

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.075859   .1051173   -10.23   0.000    -1.281885   -.8698324
       _cons |  -1.149427   .2158084    -5.33   0.000    -1.572403     -.72645
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        738
                                                  Wald chi2(2)    =     337.88
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2536
                                                  Root MSE        =      1.639

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.011322   .0817927   -12.36   0.000    -1.171633   -.8510112
       y2000 |  -.8472966   .1366897    -6.20   0.000    -1.115204   -.5793896
       _cons |  -.4217138   .1221044    -3.45   0.001     -.661034   -.1823936
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9620
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    433,524      100.00      100.00
------------+-----------------------------------
      Total |    433,524      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    144,508       33.33       33.33
          3 |    289,016       66.67      100.00
------------+-----------------------------------
      Total |    433,524      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(144,508 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(144,508 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(144,508 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007c not found)
file /tmp/St20945.00007c saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        364       20.00       20.00
       1980 |        364       20.00       40.00
       1990 |        364       20.00       60.00
       2000 |        364       20.00       80.00
       2007 |        364       20.00      100.00
------------+-----------------------------------
      Total |      1,820      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,456 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(364 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(364 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,456 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(364 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(364 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,456 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(364 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           728
        from master                       728  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,092  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        728       40.00       40.00
            matched (3) |      1,092       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,820      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       364          0 |       364 
      1980 |         0        364 |       364 
      1990 |         0        364 |       364 
      2000 |         0        364 |       364 
      2007 |       364          0 |       364 
-----------+----------------------+----------
     Total |       728      1,092 |     1,820 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(728 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        363
                                                  Wald chi2(1)    =      36.66
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4488

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8325769   .1374989    -6.06   0.000     -1.10207   -.5630839
       _cons |  -.6136518   .1651146    -3.72   0.000    -.9372705   -.2900331
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        363
                                                  Wald chi2(1)    =     104.26
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1508
                                                  Root MSE        =     1.7848

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.082397   .1060065   -10.21   0.000    -1.290166   -.8746286
       _cons |  -1.138011   .2175095    -5.23   0.000    -1.564322   -.7117001
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        726
                                                  Wald chi2(2)    =     336.50
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2544
                                                  Root MSE        =     1.6325

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.01838   .0823209   -12.37   0.000    -1.179726   -.8570336
       y2000 |   -.840957   .1373639    -6.12   0.000    -1.110185   -.5717288
       _cons |  -.4156027   .1226423    -3.39   0.001    -.6559772   -.1752281
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9625
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    425,187      100.00      100.00
------------+-----------------------------------
      Total |    425,187      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    141,729       33.33       33.33
          3 |    283,458       66.67      100.00
------------+-----------------------------------
      Total |    425,187      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(141,729 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(141,729 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(141,729 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007e not found)
file /tmp/St20945.00007e saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        357       20.00       20.00
       1980 |        357       20.00       40.00
       1990 |        357       20.00       60.00
       2000 |        357       20.00       80.00
       2007 |        357       20.00      100.00
------------+-----------------------------------
      Total |      1,785      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,428 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(357 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(357 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,428 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(357 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(357 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,428 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(357 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           714
        from master                       714  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,071  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        714       40.00       40.00
            matched (3) |      1,071       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,785      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       357          0 |       357 
      1980 |         0        357 |       357 
      1990 |         0        357 |       357 
      2000 |         0        357 |       357 
      2007 |       357          0 |       357 
-----------+----------------------+----------
     Total |       714      1,071 |     1,785 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(714 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        356
                                                  Wald chi2(1)    =      36.44
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4441

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8341113   .1381861    -6.04   0.000    -1.104951   -.5632715
       _cons |  -.6128332   .1660436    -3.69   0.000    -.9382728   -.2873937
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        356
                                                  Wald chi2(1)    =     100.69
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1468
                                                  Root MSE        =     1.7735

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.071687   .1067992   -10.03   0.000    -1.281009    -.862364
       _cons |  -1.157901   .2191388    -5.28   0.000    -1.587405   -.7283965
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        712
                                                  Wald chi2(2)    =     330.68
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2546
                                                  Root MSE        =     1.6236

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -1.01057   .0828944   -12.19   0.000     -1.17304   -.8481001
       y2000 |  -.8465121    .138088    -6.13   0.000     -1.11716   -.5758647
       _cons |  -.4246707    .123362    -3.44   0.001    -.6664558   -.1828856
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9630
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    419,232      100.00      100.00
------------+-----------------------------------
      Total |    419,232      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    139,744       33.33       33.33
          3 |    279,488       66.67      100.00
------------+-----------------------------------
      Total |    419,232      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(139,744 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(139,744 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(139,744 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007g not found)
file /tmp/St20945.00007g saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        352       20.00       20.00
       1980 |        352       20.00       40.00
       1990 |        352       20.00       60.00
       2000 |        352       20.00       80.00
       2007 |        352       20.00      100.00
------------+-----------------------------------
      Total |      1,760      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,408 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(352 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(352 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,408 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(352 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(352 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,408 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(352 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           704
        from master                       704  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,056  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        704       40.00       40.00
            matched (3) |      1,056       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,760      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       352          0 |       352 
      1980 |         0        352 |       352 
      1990 |         0        352 |       352 
      2000 |         0        352 |       352 
      2007 |       352          0 |       352 
-----------+----------------------+----------
     Total |       704      1,056 |     1,760 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(704 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        351
                                                  Wald chi2(1)    =      37.89
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4432

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8691884   .1412001    -6.16   0.000    -1.145935   -.5924412
       _cons |  -.5796813    .168943    -3.43   0.001    -.9108035   -.2485592
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        351
                                                  Wald chi2(1)    =     102.86
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1498
                                                  Root MSE        =     1.7599

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.083693   .1068518   -10.14   0.000    -1.293119   -.8742671
       _cons |  -1.138751    .219108    -5.20   0.000    -1.568195   -.7093072
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        702
                                                  Wald chi2(2)    =     333.25
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2562
                                                  Root MSE        =     1.6154

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -1.029589    .083477   -12.33   0.000    -1.193201   -.8659772
       y2000 |  -.8301062   .1385402    -5.99   0.000     -1.10164   -.5585724
       _cons |  -.4088758   .1238411    -3.30   0.001    -.6515998   -.1661518
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9635
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    412,086      100.00      100.00
------------+-----------------------------------
      Total |    412,086      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    137,362       33.33       33.33
          3 |    274,724       66.67      100.00
------------+-----------------------------------
      Total |    412,086      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(137,362 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(137,362 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(137,362 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007i not found)
file /tmp/St20945.00007i saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        346       20.00       20.00
       1980 |        346       20.00       40.00
       1990 |        346       20.00       60.00
       2000 |        346       20.00       80.00
       2007 |        346       20.00      100.00
------------+-----------------------------------
      Total |      1,730      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,384 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(346 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(346 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,384 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(346 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(346 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,384 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(346 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           692
        from master                       692  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,038  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        692       40.00       40.00
            matched (3) |      1,038       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,730      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       346          0 |       346 
      1980 |         0        346 |       346 
      1990 |         0        346 |       346 
      2000 |         0        346 |       346 
      2007 |       346          0 |       346 
-----------+----------------------+----------
     Total |       692      1,038 |     1,730 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(692 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        345
                                                  Wald chi2(1)    =      35.71
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4246

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8712656   .1457993    -5.98   0.000    -1.157027   -.5855042
       _cons |  -.5777156   .1738695    -3.32   0.001    -.9184935   -.2369378
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        345
                                                  Wald chi2(1)    =      84.67
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1464
                                                  Root MSE        =     1.7072

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9889519    .107473    -9.20   0.000    -1.199595   -.7783087
       _cons |  -1.321136   .2200409    -6.00   0.000    -1.752408   -.8898641
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        690
                                                  Wald chi2(2)    =     317.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2641
                                                  Root MSE        =     1.5754

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9579918   .0845019   -11.34   0.000    -1.123612   -.7923712
       y2000 |  -.8938309   .1372729    -6.51   0.000    -1.162881   -.6247809
       _cons |  -.4848989   .1239852    -3.91   0.000    -.7279054   -.2418924
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9640
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    404,940      100.00      100.00
------------+-----------------------------------
      Total |    404,940      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    134,980       33.33       33.33
          3 |    269,960       66.67      100.00
------------+-----------------------------------
      Total |    404,940      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(134,980 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(134,980 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(134,980 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007k not found)
file /tmp/St20945.00007k saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        340       20.00       20.00
       1980 |        340       20.00       40.00
       1990 |        340       20.00       60.00
       2000 |        340       20.00       80.00
       2007 |        340       20.00      100.00
------------+-----------------------------------
      Total |      1,700      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,360 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(340 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(340 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,360 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(340 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(340 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,360 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(340 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           680
        from master                       680  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,020  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        680       40.00       40.00
            matched (3) |      1,020       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,700      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       340          0 |       340 
      1980 |         0        340 |       340 
      1990 |         0        340 |       340 
      2000 |         0        340 |       340 
      2007 |       340          0 |       340 
-----------+----------------------+----------
     Total |       680      1,020 |     1,700 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(680 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        339
                                                  Wald chi2(1)    =      35.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.422

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.877402   .1481452    -5.92   0.000    -1.167761   -.5870428
       _cons |  -.5707003   .1762985    -3.24   0.001     -.916239   -.2251615
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        339
                                                  Wald chi2(1)    =      80.26
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1437
                                                  Root MSE        =     1.6954

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9700717   .1082838    -8.96   0.000    -1.182304   -.7578393
       _cons |  -1.351706   .2215168    -6.10   0.000    -1.785871   -.9175412
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        678
                                                  Wald chi2(2)    =     310.05
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2639
                                                  Root MSE        =     1.5671

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9457571   .0853574   -11.08   0.000    -1.113054   -.7784597
       y2000 |  -.8993698   .1380046    -6.52   0.000    -1.169854   -.6288857
       _cons |  -.4975759   .1248295    -3.99   0.000    -.7422373   -.2529146
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9645
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    401,367      100.00      100.00
------------+-----------------------------------
      Total |    401,367      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    133,789       33.33       33.33
          3 |    267,578       66.67      100.00
------------+-----------------------------------
      Total |    401,367      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(133,789 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(133,789 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(133,789 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007m not found)
file /tmp/St20945.00007m saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        337       20.00       20.00
       1980 |        337       20.00       40.00
       1990 |        337       20.00       60.00
       2000 |        337       20.00       80.00
       2007 |        337       20.00      100.00
------------+-----------------------------------
      Total |      1,685      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,348 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(337 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(337 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,348 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(337 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(337 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,348 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(337 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           674
        from master                       674  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,011  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        674       40.00       40.00
            matched (3) |      1,011       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,685      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       337          0 |       337 
      1980 |         0        337 |       337 
      1990 |         0        337 |       337 
      2000 |         0        337 |       337 
      2007 |       337          0 |       337 
-----------+----------------------+----------
     Total |       674      1,011 |     1,685 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(674 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        336
                                                  Wald chi2(1)    =      34.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4155

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8695144   .1480173    -5.87   0.000    -1.159623   -.5794059
       _cons |  -.5795828   .1762029    -3.29   0.001    -.9249342   -.2342314
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        336
                                                  Wald chi2(1)    =      80.57
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1450
                                                  Root MSE        =     1.6916

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9795994   .1091322    -8.98   0.000    -1.193495   -.7657042
       _cons |  -1.333989     .22313    -5.98   0.000    -1.771316   -.8966619
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        672
                                                  Wald chi2(2)    =     309.50
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2662
                                                  Root MSE        =     1.5624

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9505246   .0858137   -11.08   0.000    -1.118716   -.7823328
       y2000 |  -.8952112   .1383618    -6.47   0.000    -1.166395   -.6240271
       _cons |  -.4929008    .125286    -3.93   0.000    -.7384569   -.2473448
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9650
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    397,794      100.00      100.00
------------+-----------------------------------
      Total |    397,794      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    132,598       33.33       33.33
          3 |    265,196       66.67      100.00
------------+-----------------------------------
      Total |    397,794      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(132,598 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(132,598 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(132,598 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007o not found)
file /tmp/St20945.00007o saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        334       20.00       20.00
       1980 |        334       20.00       40.00
       1990 |        334       20.00       60.00
       2000 |        334       20.00       80.00
       2007 |        334       20.00      100.00
------------+-----------------------------------
      Total |      1,670      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,336 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(334 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(334 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,336 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(334 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(334 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,336 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(334 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           668
        from master                       668  (_merge==1)
        from using                          0  (_merge==2)

    matched                             1,002  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        668       40.00       40.00
            matched (3) |      1,002       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,670      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       334          0 |       334 
      1980 |         0        334 |       334 
      1990 |         0        334 |       334 
      2000 |         0        334 |       334 
      2007 |       334          0 |       334 
-----------+----------------------+----------
     Total |       668      1,002 |     1,670 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(668 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        333
                                                  Wald chi2(1)    =      34.48
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4118

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8723599   .1485684    -5.87   0.000    -1.163548   -.5811712
       _cons |  -.5772982   .1768663    -3.26   0.001    -.9239498   -.2306467
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        333
                                                  Wald chi2(1)    =      78.58
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1421
                                                  Root MSE        =     1.6887

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9746499   .1099526    -8.86   0.000    -1.190153   -.7591469
       _cons |  -1.343677   .2247089    -5.98   0.000    -1.784098   -.9032553
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        666
                                                  Wald chi2(2)    =     306.44
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2665
                                                  Root MSE        =     1.5589

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9475427   .0863422   -10.97   0.000     -1.11677   -.7783152
       y2000 |  -.8973467   .1388122    -6.46   0.000    -1.169414   -.6252798
       _cons |  -.4968129   .1258611    -3.95   0.000    -.7434962   -.2501296
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9655
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    389,457      100.00      100.00
------------+-----------------------------------
      Total |    389,457      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    129,819       33.33       33.33
          3 |    259,638       66.67      100.00
------------+-----------------------------------
      Total |    389,457      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(129,819 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(129,819 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(129,819 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007q not found)
file /tmp/St20945.00007q saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        327       20.00       20.00
       1980 |        327       20.00       40.00
       1990 |        327       20.00       60.00
       2000 |        327       20.00       80.00
       2007 |        327       20.00      100.00
------------+-----------------------------------
      Total |      1,635      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,308 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(327 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,308 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(327 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,308 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(327 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           654
        from master                       654  (_merge==1)
        from using                          0  (_merge==2)

    matched                               981  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        654       40.00       40.00
            matched (3) |        981       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,635      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       327          0 |       327 
      1980 |         0        327 |       327 
      1990 |         0        327 |       327 
      2000 |         0        327 |       327 
      2007 |       327          0 |       327 
-----------+----------------------+----------
     Total |       654        981 |     1,635 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(654 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        326
                                                  Wald chi2(1)    =      33.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.4003

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8592929   .1488559    -5.77   0.000    -1.151045   -.5675407
       _cons |  -.5921358   .1772456    -3.34   0.001    -.9395308   -.2447408
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        326
                                                  Wald chi2(1)    =      76.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1418
                                                  Root MSE        =     1.6855

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9724465   .1110004    -8.76   0.000    -1.190003   -.7548896
       _cons |  -1.348409   .2268451    -5.94   0.000    -1.793017   -.9038006
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        652
                                                  Wald chi2(2)    =     301.23
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2685
                                                  Root MSE        =      1.552

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9424426   .0869216   -10.84   0.000    -1.112806   -.7720793
       y2000 |  -.9011845   .1397001    -6.45   0.000    -1.174992   -.6273774
       _cons |  -.5031093   .1266889    -3.97   0.000     -.751415   -.2548036
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9660
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    382,311      100.00      100.00
------------+-----------------------------------
      Total |    382,311      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    127,437       33.33       33.33
          3 |    254,874       66.67      100.00
------------+-----------------------------------
      Total |    382,311      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(127,437 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(127,437 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(127,437 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007s not found)
file /tmp/St20945.00007s saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        321       20.00       20.00
       1980 |        321       20.00       40.00
       1990 |        321       20.00       60.00
       2000 |        321       20.00       80.00
       2007 |        321       20.00      100.00
------------+-----------------------------------
      Total |      1,605      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,284 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(321 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(321 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,284 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(321 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(321 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,284 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(321 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           642
        from master                       642  (_merge==1)
        from using                          0  (_merge==2)

    matched                               963  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        642       40.00       40.00
            matched (3) |        963       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,605      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       321          0 |       321 
      1980 |         0        321 |       321 
      1990 |         0        321 |       321 
      2000 |         0        321 |       321 
      2007 |       321          0 |       321 
-----------+----------------------+----------
     Total |       642        963 |     1,605 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(642 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        320
                                                  Wald chi2(1)    =      37.07
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.3562

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8941047   .1468467    -6.09   0.000    -1.181919   -.6062905
       _cons |  -.5686225   .1745236    -3.26   0.001    -.9106826   -.2265625
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        320
                                                  Wald chi2(1)    =      76.36
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1398
                                                  Root MSE        =     1.6199

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9528026   .1090369    -8.74   0.000    -1.166511   -.7390943
       _cons |  -1.412335   .2228228    -6.34   0.000    -1.849059   -.9756101
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        640
                                                  Wald chi2(2)    =     318.72
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2837
                                                  Root MSE        =     1.4951

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9372543   .0855093   -10.96   0.000    -1.104849   -.7696591
       y2000 |  -.9189346   .1364264    -6.74   0.000    -1.186325   -.6515438
       _cons |  -.5224317   .1239534    -4.21   0.000    -.7653759   -.2794874
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9665
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    376,356      100.00      100.00
------------+-----------------------------------
      Total |    376,356      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    125,452       33.33       33.33
          3 |    250,904       66.67      100.00
------------+-----------------------------------
      Total |    376,356      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(125,452 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(125,452 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(125,452 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007u not found)
file /tmp/St20945.00007u saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        316       20.00       20.00
       1980 |        316       20.00       40.00
       1990 |        316       20.00       60.00
       2000 |        316       20.00       80.00
       2007 |        316       20.00      100.00
------------+-----------------------------------
      Total |      1,580      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,264 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(316 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(316 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,264 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(316 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(316 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,264 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(316 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           632
        from master                       632  (_merge==1)
        from using                          0  (_merge==2)

    matched                               948  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        632       40.00       40.00
            matched (3) |        948       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,580      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       316          0 |       316 
      1980 |         0        316 |       316 
      1990 |         0        316 |       316 
      2000 |         0        316 |       316 
      2007 |       316          0 |       316 
-----------+----------------------+----------
     Total |       632        948 |     1,580 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(632 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        315
                                                  Wald chi2(1)    =      36.88
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.3404

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8926588   .1469972    -6.07   0.000    -1.180768   -.6045495
       _cons |    -.56941   .1745399    -3.26   0.001    -.9115018   -.2273182
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        315
                                                  Wald chi2(1)    =      75.19
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1440
                                                  Root MSE        =     1.6133

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9601001   .1107244    -8.67   0.000    -1.177116   -.7430841
       _cons |  -1.400177   .2258056    -6.20   0.000    -1.842747   -.9576059
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        630
                                                  Wald chi2(2)    =     317.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2901
                                                  Root MSE        =     1.4845

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9421625   .0864162   -10.90   0.000    -1.111535   -.7727898
       y2000 |  -.9172438   .1368504    -6.70   0.000    -1.185466   -.6490219
       _cons |  -.5164188   .1247121    -4.14   0.000    -.7608501   -.2719875
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9670
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    372,783      100.00      100.00
------------+-----------------------------------
      Total |    372,783      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    124,261       33.33       33.33
          3 |    248,522       66.67      100.00
------------+-----------------------------------
      Total |    372,783      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(124,261 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(124,261 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(124,261 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00007w not found)
file /tmp/St20945.00007w saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        313       20.00       20.00
       1980 |        313       20.00       40.00
       1990 |        313       20.00       60.00
       2000 |        313       20.00       80.00
       2007 |        313       20.00      100.00
------------+-----------------------------------
      Total |      1,565      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,252 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(313 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(313 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,252 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(313 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(313 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,252 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(313 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           626
        from master                       626  (_merge==1)
        from using                          0  (_merge==2)

    matched                               939  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        626       40.00       40.00
            matched (3) |        939       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,565      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       313          0 |       313 
      1980 |         0        313 |       313 
      1990 |         0        313 |       313 
      2000 |         0        313 |       313 
      2007 |       313          0 |       313 
-----------+----------------------+----------
     Total |       626        939 |     1,565 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(626 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        312
                                                  Wald chi2(1)    =      36.08
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =       1.33

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8823923   .1469113    -6.01   0.000    -1.170333   -.5944514
       _cons |    -.58186   .1741559    -3.34   0.001    -.9231993   -.2405207
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        312
                                                  Wald chi2(1)    =      74.43
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1451
                                                  Root MSE        =     1.6109

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9567196   .1108983    -8.63   0.000    -1.174076   -.7393628
       _cons |  -1.406407   .2262313    -6.22   0.000    -1.849812   -.9630013
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        624
                                                  Wald chi2(2)    =     316.03
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2943
                                                  Root MSE        =     1.4783

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |    -.93705     .08642   -10.84   0.000     -1.10643   -.7676699
       y2000 |  -.9196927   .1369844    -6.71   0.000    -1.188177   -.6512083
       _cons |  -.5234348    .124652    -4.20   0.000    -.7677483   -.2791213
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9675
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    369,210      100.00      100.00
------------+-----------------------------------
      Total |    369,210      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    123,070       33.33       33.33
          3 |    246,140       66.67      100.00
------------+-----------------------------------
      Total |    369,210      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(123,070 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(123,070 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(123,070 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000080 not found)
file /tmp/St20945.000080 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        310       20.00       20.00
       1980 |        310       20.00       40.00
       1990 |        310       20.00       60.00
       2000 |        310       20.00       80.00
       2007 |        310       20.00      100.00
------------+-----------------------------------
      Total |      1,550      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,240 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(310 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(310 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,240 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(310 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(310 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,240 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(310 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           620
        from master                       620  (_merge==1)
        from using                          0  (_merge==2)

    matched                               930  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        620       40.00       40.00
            matched (3) |        930       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,550      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       310          0 |       310 
      1980 |         0        310 |       310 
      1990 |         0        310 |       310 
      2000 |         0        310 |       310 
      2007 |       310          0 |       310 
-----------+----------------------+----------
     Total |       620        930 |     1,550 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(620 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        309
                                                  Wald chi2(1)    =      35.27
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.3264

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.875676   .1474473    -5.94   0.000    -1.164667   -.5866846
       _cons |  -.5890781   .1747402    -3.37   0.001    -.9315626   -.2465936
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        309
                                                  Wald chi2(1)    =      70.97
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1398
                                                  Root MSE        =      1.608

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9505539   .1128374    -8.42   0.000    -1.171711   -.7293968
       _cons |  -1.418784   .2296365    -6.18   0.000    -1.868863   -.9687047
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        618
                                                  Wald chi2(2)    =     310.38
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2927
                                                  Root MSE        =     1.4752

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9307495   .0876239   -10.62   0.000    -1.102489   -.7590098
       y2000 |  -.9255429   .1377368    -6.72   0.000    -1.195502   -.6555838
       _cons |  -.5302096   .1257577    -4.22   0.000    -.7766901   -.2837291
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9680
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    366,828      100.00      100.00
------------+-----------------------------------
      Total |    366,828      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    122,276       33.33       33.33
          3 |    244,552       66.67      100.00
------------+-----------------------------------
      Total |    366,828      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(122,276 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(122,276 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(122,276 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000082 not found)
file /tmp/St20945.000082 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        308       20.00       20.00
       1980 |        308       20.00       40.00
       1990 |        308       20.00       60.00
       2000 |        308       20.00       80.00
       2007 |        308       20.00      100.00
------------+-----------------------------------
      Total |      1,540      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,232 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(308 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(308 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,232 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(308 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(308 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,232 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(308 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           616
        from master                       616  (_merge==1)
        from using                          0  (_merge==2)

    matched                               924  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        616       40.00       40.00
            matched (3) |        924       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,540      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       308          0 |       308 
      1980 |         0        308 |       308 
      1990 |         0        308 |       308 
      2000 |         0        308 |       308 
      2007 |       308          0 |       308 
-----------+----------------------+----------
     Total |       616        924 |     1,540 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(616 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        307
                                                  Wald chi2(1)    =      35.14
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =      1.326

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8786271   .1482128    -5.93   0.000    -1.169119   -.5881353
       _cons |  -.5859831   .1756693    -3.34   0.001    -.9302887   -.2416776
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        307
                                                  Wald chi2(1)    =      69.75
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1382
                                                  Root MSE        =     1.6073

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9492412   .1136596    -8.35   0.000     -1.17201   -.7264724
       _cons |  -1.422611   .2313509    -6.15   0.000     -1.87605   -.9691715
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        614
                                                  Wald chi2(2)    =     308.32
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2925
                                                  Root MSE        =     1.4745

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9305134   .0882082   -10.55   0.000    -1.103398   -.7576286
       y2000 |  -.9271215   .1383168    -6.70   0.000    -1.198217   -.6560256
       _cons |  -.5304845   .1264274    -4.20   0.000    -.7782776   -.2826914
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9685
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    359,682      100.00      100.00
------------+-----------------------------------
      Total |    359,682      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    119,894       33.33       33.33
          3 |    239,788       66.67      100.00
------------+-----------------------------------
      Total |    359,682      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(119,894 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(119,894 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(119,894 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000084 not found)
file /tmp/St20945.000084 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        302       20.00       20.00
       1980 |        302       20.00       40.00
       1990 |        302       20.00       60.00
       2000 |        302       20.00       80.00
       2007 |        302       20.00      100.00
------------+-----------------------------------
      Total |      1,510      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,208 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(302 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,208 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(302 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,208 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(302 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           604
        from master                       604  (_merge==1)
        from using                          0  (_merge==2)

    matched                               906  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        604       40.00       40.00
            matched (3) |        906       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,510      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       302          0 |       302 
      1980 |         0        302 |       302 
      1990 |         0        302 |       302 
      2000 |         0        302 |       302 
      2007 |       302          0 |       302 
-----------+----------------------+----------
     Total |       604        906 |     1,510 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(604 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        301
                                                  Wald chi2(1)    =      34.18
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.3181

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.870653   .1489269    -5.85   0.000    -1.162544   -.5787617
       _cons |  -.5936811   .1765388    -3.36   0.001    -.9396907   -.2476714
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        301
                                                  Wald chi2(1)    =      68.11
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1387
                                                  Root MSE        =     1.5983

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9426313   .1142146    -8.25   0.000    -1.166488   -.7187748
       _cons |  -1.434298   .2324447    -6.17   0.000    -1.889881   -.9787147
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        602
                                                  Wald chi2(2)    =     303.91
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2946
                                                  Root MSE        =     1.4661

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9235686   .0886382   -10.42   0.000    -1.097296   -.7498409
       y2000 |  -.9328557   .1388929    -6.72   0.000    -1.205081   -.6606306
       _cons |  -.5370608   .1270288    -4.23   0.000    -.7860326    -.288089
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9690
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    358,491      100.00      100.00
------------+-----------------------------------
      Total |    358,491      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    119,497       33.33       33.33
          3 |    238,994       66.67      100.00
------------+-----------------------------------
      Total |    358,491      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(119,497 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(119,497 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(119,497 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000086 not found)
file /tmp/St20945.000086 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        301       20.00       20.00
       1980 |        301       20.00       40.00
       1990 |        301       20.00       60.00
       2000 |        301       20.00       80.00
       2007 |        301       20.00      100.00
------------+-----------------------------------
      Total |      1,505      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,204 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(301 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(301 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,204 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(301 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(301 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,204 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(301 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           602
        from master                       602  (_merge==1)
        from using                          0  (_merge==2)

    matched                               903  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        602       40.00       40.00
            matched (3) |        903       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,505      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       301          0 |       301 
      1980 |         0        301 |       301 
      1990 |         0        301 |       301 
      2000 |         0        301 |       301 
      2007 |       301          0 |       301 
-----------+----------------------+----------
     Total |       602        903 |     1,505 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(602 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        300
                                                  Wald chi2(1)    =      33.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0012
                                                  Root MSE        =     1.3119

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8592575   .1481374    -5.80   0.000    -1.149602   -.5689136
       _cons |  -.6082237   .1756502    -3.46   0.001    -.9524918   -.2639556
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        300
                                                  Wald chi2(1)    =      67.92
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1398
                                                  Root MSE        =     1.5899

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9380826    .113827    -8.24   0.000    -1.161179   -.7149858
       _cons |  -1.444944   .2316802    -6.24   0.000    -1.899029   -.9908593
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        600
                                                  Wald chi2(2)    =     304.61
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2974
                                                  Root MSE        =     1.4587

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9171873   .0883043   -10.39   0.000    -1.090261   -.7441141
       y2000 |  -.9377446   .1384326    -6.77   0.000    -1.209068   -.6664216
       _cons |  -.5462489   .1265604    -4.32   0.000    -.7943026   -.2981951
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9695
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    356,109      100.00      100.00
------------+-----------------------------------
      Total |    356,109      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    118,703       33.33       33.33
          3 |    237,406       66.67      100.00
------------+-----------------------------------
      Total |    356,109      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(118,703 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(118,703 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(118,703 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.000088 not found)
file /tmp/St20945.000088 saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        299       20.00       20.00
       1980 |        299       20.00       40.00
       1990 |        299       20.00       60.00
       2000 |        299       20.00       80.00
       2007 |        299       20.00      100.00
------------+-----------------------------------
      Total |      1,495      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,196 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(299 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(299 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,196 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(299 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(299 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,196 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(299 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           598
        from master                       598  (_merge==1)
        from using                          0  (_merge==2)

    matched                               897  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        598       40.00       40.00
            matched (3) |        897       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,495      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       299          0 |       299 
      1980 |         0        299 |       299 
      1990 |         0        299 |       299 
      2000 |         0        299 |       299 
      2007 |       299          0 |       299 
-----------+----------------------+----------
     Total |       598        897 |     1,495 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(598 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        298
                                                  Wald chi2(1)    =      33.45
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.0027
                                                  Root MSE        =      1.308

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.8566987   .1481328    -5.78   0.000    -1.147034   -.5663637
       _cons |  -.6125322    .175575    -3.49   0.000    -.9566529   -.2684116
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        298
                                                  Wald chi2(1)    =      68.99
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1394
                                                  Root MSE        =      1.576

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9403952   .1132159    -8.31   0.000    -1.162294    -.718496
       _cons |  -1.442165   .2303135    -6.26   0.000    -1.893571   -.9907591
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        596
                                                  Wald chi2(2)    =     306.60
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2993
                                                  Root MSE        =     1.4494

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |   -.918204   .0880281   -10.43   0.000    -1.090736   -.7456721
       y2000 |    -.93684   .1379823    -6.79   0.000     -1.20728   -.6663997
       _cons |  -.5467702   .1261281    -4.34   0.000    -.7939767   -.2995637
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit
9700
file /ssgprojects/project0002/MobZ.new/data/interwrk/czones_cutoff.dta saved

. /******************************
> This do-file takes the commuting
> zone file (fed from on high), 
> collapses everything according to
> czone, and then merges it all together
> to get del_M and IPW, the key
> parts of the estimation
> *******************************/
. 
. use "$interwrk/industry_data.dta", clear

. 
. drop if fips == "30113" | (substr(fips,1,2)=="02" | substr(fips,1,2) == "15")
(794 observations deleted)

. sort fips 

. merge fips using "$czone_iteration"
(note: you are using old merge syntax; see [D] merge for new syntax)
variable fips does not uniquely identify observations in the master data
(note: variable fips was str5, now str10 to accommodate using data's values)

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          2 |         30        0.00        0.00
          3 |  3,703,216      100.00      100.00
------------+-----------------------------------
      Total |  3,703,246      100.00

. drop if _merge == 2
(30 observations deleted)

.  
. collapse (sum) emp tot_emp_cty, by(czone sic87dd year)

. 
. rename emp L_ijt

. rename tot_emp_cty L_it 

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_industrydata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    350,154      100.00      100.00
------------+-----------------------------------
      Total |    350,154      100.00

. 
. drop _merge

. 
. sort sic87dd year

. merge sic87dd year using "$interwrk/tmp_tradedata.dta"
(note: you are using old merge syntax; see [D] merge for new syntax)
variables sic87dd year do not uniquely identify observations in the master
    data

. 
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |    116,718       33.33       33.33
          3 |    233,436       66.67      100.00
------------+-----------------------------------
      Total |    350,154      100.00

. *drop _merge
. 
. sort czone sic87dd year 

. 
. gen first_frac_u = L_ijt/L_ujt

. gen second_frac_u = del_M_ucjt/L_it
(116,718 missing values generated)

. 
. gen first_frac_o = L_ijt[_n-1]/L_ujt[_n-1] if year!=1980
(116,718 missing values generated)

. gen second_frac_o = del_M_ocjt/L_it[_n-1] if year!=1980
(116,718 missing values generated)

. 
. bys czone year: egen IPW_uit =  sum(first_frac_u*second_frac_u)

. bys czone year: egen IPW_oit = sum(first_frac_o*second_frac_o)

. 
. collapse (first) IPW*, by(czone year) 

. 
. label variable IPW_uit "Import Competition from China for county i"

. label variable IPW_oit "Import Flows to Other Rich Nations (instrument)"

. 
. sort czone year 

. 
. tempfile IPW

. save `IPW', replace
(note: file /tmp/St20945.00008a not found)
file /tmp/St20945.00008a saved

. 
. /****************************
> Manufacturing employment and
> Census data
> *****************************/
. 
. use  "$interwrk/cty_censusdata.dta", clear

. 
. sort fips 

. merge m:1 fips using "$czone_iteration"

    Result                           # of obs.
    -----------------------------------------
    not matched                            33
        from master                         3  (_merge==1)
        from using                         30  (_merge==2)

    matched                            15,540  (_merge==3)
    -----------------------------------------

. tab _merge 

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |          3        0.02        0.02
         using only (2) |         30        0.19        0.21
            matched (3) |     15,540       99.79      100.00
------------------------+-----------------------------------
                  Total |     15,573      100.00

. tab fips if _merge == 1

                                   fips |      Freq.     Percent        Cum.
----------------------------------------+-----------------------------------
                                  08014 |          1       33.33       33.33
                                  46131 |          1       33.33       66.67
                                  51123 |          1       33.33      100.00
----------------------------------------+-----------------------------------
                                  Total |          3      100.00

. drop if _merge != 3 
(33 observations deleted)

. drop _merge

. 
. drop if substr(fips,1,2) == "02" | substr(fips,1,2) == "15" 
(0 observations deleted)

. 
. #delimit ;
delimiter now ;
. collapse (sum) manuemp_adh manufacturing_emp totalpop total_employment 
>                                 pop_16_65 population_census_1665 female_emp m
> anu_emp 
>                                 bachelors total_emp female_pop_16_65 foreign 
>                                 manu_emp_cbp , by(czone year);

. #delimit cr
delimiter now cr
. 
. label variable manufacturing_emp "Manufacturing Employment, QCEW"

. label variable manu_emp "Manufacturing Employment, Census"

. 
. label variable total_employment "Total Employment, QCEW"

. label variable total_emp "Total Employment, Census"

. tab year

       year |      Freq.     Percent        Cum.
------------+-----------------------------------
       1970 |        294       20.00       20.00
       1980 |        294       20.00       40.00
       1990 |        294       20.00       60.00
       2000 |        294       20.00       80.00
       2007 |        294       20.00      100.00
------------+-----------------------------------
      Total |      1,470      100.00

. 
. xtset czone year
       panel variable:  czone (strongly balanced)
        time variable:  year, 1970 to 2007, but with gaps
                delta:  1 unit

. 
. gen L_m = 100*manu_emp/population_census_1665

. 
. gen del_L_m = F10.L_m - L_m if year == 1990
(1,176 missing values generated)

.         replace del_L_m = F7.L_m - L_m if year == 2000
(294 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_m = 10*del_L_m/7 if year == 2000
(294 real changes made)

.         
.         
. gen L_mprime = 100*manufacturing_emp/population_census_1665

. 
. gen del_L_mprime = F10.L_mprime - L_mprime if year == 1990
(1,176 missing values generated)

.         replace del_L_mprime = F7.L_mprime - L_mprime if year == 2000
(294 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime = 10*del_L_mprime/7 if year == 2000
(294 real changes made)

.         
. gen L_mprime2 = 100*manu_emp_cbp/population_census_1665

. 
. gen del_L_mprime2 = F10.L_mprime2 - L_mprime2 if year == 1990
(1,176 missing values generated)

.         replace del_L_mprime2 = F7.L_mprime2 - L_mprime2 if year == 2000
(294 real changes made)

.         /***** CONVERTING TO DECADAL CHANGE *****/
.         replace del_L_mprime2 = 10*del_L_mprime2/7 if year == 2000
(0 real changes made)

.         
. 
. sort czone year

. merge 1:1 czone year using `IPW'

    Result                           # of obs.
    -----------------------------------------
    not matched                           588
        from master                       588  (_merge==1)
        from using                          0  (_merge==2)

    matched                               882  (_merge==3)
    -----------------------------------------

. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
        master only (1) |        588       40.00       40.00
            matched (3) |        882       60.00      100.00
------------------------+-----------------------------------
                  Total |      1,470      100.00

. tab year _merge 

           |        _merge
      year | master on  matched ( |     Total
-----------+----------------------+----------
      1970 |       294          0 |       294 
      1980 |         0        294 |       294 
      1990 |         0        294 |       294 
      2000 |         0        294 |       294 
      2007 |       294          0 |       294 
-----------+----------------------+----------
     Total |       588        882 |     1,470 


. 
. bys year: egen tot_pop_16_65 = sum(pop_16_65)

. gen share_czpop = pop_16_65/tot_pop_16_65
(588 missing values generated)

. 
. gen y2000 = year==2000

. 
. erase `IPW' 

. /* Now run regression on it, and then get the coefficient and store it */
. (analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        293
                                                  Wald chi2(1)    =      30.77
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =          .
                                                  Root MSE        =     1.2974

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9058305   .1633006    -5.55   0.000    -1.225894   -.5857673
       _cons |  -.5594973   .1909669    -2.93   0.003    -.9337855    -.185209
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   1.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        293
                                                  Wald chi2(1)    =      64.64
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1234
                                                  Root MSE        =      1.544

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9480485   .1179218    -8.04   0.000    -1.179171    -.716926
       _cons |  -1.429786   .2383936    -6.00   0.000    -1.897029   -.9625433
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   IPW_oit
(analytic weights assumed)
(sum of wgt is   2.0000e+00)

Instrumental variables (2SLS) regression          Number of obs   =        586
                                                  Wald chi2(2)    =     302.51
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.2968
                                                  Root MSE        =     1.4264

------------------------------------------------------------------------------
del_L_mprime |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     IPW_uit |  -.9370562   .0931518   -10.06   0.000     -1.11963   -.7544819
       y2000 |  -.9243759   .1393303    -6.63   0.000    -1.197458   -.6512936
       _cons |  -.5259805   .1301589    -4.04   0.000    -.7810873   -.2708737
------------------------------------------------------------------------------
Instrumented:  IPW_uit
Instruments:   y2000 IPW_oit

.  postclose `czoneresults' ;

. log close ;
      name:  <unnamed>
       log:  /ssgprojects/project0002/MobZ.new/programs/07_adh/cutoff_loop.log
  log type:  text
 closed on:  19 Aug 2020, 22:18:04
-------------------------------------------------------------------------------

. 
end of do-file
